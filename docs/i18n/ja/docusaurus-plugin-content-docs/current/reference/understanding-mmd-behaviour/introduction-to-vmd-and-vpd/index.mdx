---
sidebar_position: 2
sidebar_label: VMDとVPDの概要
---

# VMDとVPDの概要

このセクションでは、VMDとVPDファイルがどのような情報で構成されているか、MMDがその情報をどのように解釈するか、
そしてbabylon-mmdがどのようにMMDの挙動を実装しているかについて説明します。

:::note
このドキュメントでは、babylon-mmdがMMDの挙動をどのように実装しているかに関する内容はこのブロックで区別されています。
:::

import TOCInline from "@theme/TOCInline";

<TOCInline toc={toc} />

## VMD/VPDファイルの概要

VMD（Vocaloid Motion Data）とVPD（Vocaloid Pose Data）ファイルは、MMD（MikuMikuDance）で使用されるアニメーションデータフォーマットです。

これらのファイルは、それぞれMMDモデルのモーションとポーズの情報を保存するために使用されます。

これらのファイル形式には**ドキュメント化された仕様がない**ため、**リバースエンジニアリング分析**によって知られている情報のみが存在し、多少の誤りがある可能性があります。

また、各情報に対する**公式名称がない**ため、
このドキュメントでは説明のために各情報に一般的な名称を任意に割り当てています。

### VMDファイル

VMDファイルはMMDモデルの**ボーン**、**モーフ**、**セルフシャドウ**、**プロパティ**のアニメーションデータを保存します。

また、**カメラ**や**ライト**情報など、モデル自体に紐づいていないアニメーションデータも保存します。

### VPDファイル

VPDファイルは、バインドする対象（**ボーン**または**モーフ**）の名前と、それらの対象の現在の状態（**ポーズ**）を保存します。

VMDと異なり、VPDはMMDモデルの**ボーン**と**モーフ**の状態のみを保存し、**カメラ**、**ライト**、**セルフシャドウ**、**プロパティ**のキーフレームは含みません。

モーフ情報に関しては、MMD自体はVPDにおけるモーフデータの処理をサポートしていません。VPDにモーフデータを保存するのは**MMM（MikuMikuMoving）**によって提供される拡張機能です。

:::note
MMDはVPDファイル内のモーフデータの処理をサポートしていませんが、MMMとBlender MMD ToolsはVPDにモーフ情報を保存する仕様をサポートしています。

MMD自体がサポートしていなくても、MMD互換ソフトウェアがサポートしているため、babylon-mmdもVPDファイル内のモーフデータを読み取り処理します。
:::

:::note
babylon-mmdはVPDを1フレームのアニメーションとして扱い、VMDファイルとVPDファイルを同じ方法で処理します。
:::

### VMDファイル構造と解析方法

VMDファイルは様々なデータタイプを含む**リトルエンディアン**の**バイナリファイル**です。

データは一般的な**長さプレフィックス形式**で構成されています。例えば、ボーンキーフレームデータを表現する場合、
まずキーフレームの数が示され、その後に各ボーンキーフレームの情報が順次リストされます。
各データのサイズは固定長または可変長で、データの順序は常に同じです。

データのアライメントは**強制されず**、各フィールドはバイナリファイル内に連続して格納されます。

VMDファイルには**明示的なバージョン**がヘッダーに含まれていません。
代わりに、データは**ボーン**、**モーフ**、**カメラ**、**ライト**、**セルフシャドウ**、**プロパティ**キーフレームの順に表示され、
古いバージョンでは、この順序で後に来るキーフレームセクションが省略されている場合があります。

例えば、[WAVEFILE fullver. モーション](https://bowlroll.net/file/5983)にはプロパティキーフレームが含まれていません。

### VPDファイル構造と解析方法

VPDファイルは**Shift_JIS**エンコーディングで保存された**プレーンテキストファイル**です。

以下はボーンとモーフキーフレームを含むVPDファイルの例です。
```
Vocaloid Pose Data file

YYB式初音ミク_10th_v1.02.osm;		// 親ファイル名
4;				// 総ポーズボーン数

Bone0{右腕捩
  0.000000,0.000000,0.000000;				// trans x,y,z
  -0.000000,-0.000000,0.000000,1.000000;		// Quaternion x,y,z,w
}

Bone1{右ひじ
  0.000000,0.000000,0.000000;				// trans x,y,z
  0.176789,-0.061290,0.747712,0.637114;		// Quaternion x,y,z,w
}

Bone2{右手捩
  0.000000,0.000000,0.000000;				// trans x,y,z
  -0.000000,-0.000000,-0.000000,1.000000;		// Quaternion x,y,z,w
}

Bone3{右手首
  0.000000,0.000000,0.000000;				// trans x,y,z
  -0.574374,-0.615622,0.113957,0.527368;		// Quaternion x,y,z,w
}

Morph0{う
  0.200000;
}

Morph1{え
  0;
}
```
4行目の`4;`は**ボーン状態**の数を示しています。MMDはちょうどその数のボーンエントリを読み込み、それ以降の情報は無視します。

そのため、モーフ状態情報を含む**MMM拡張**では、常にモーフ状態情報をボーン状態情報の後に配置します。

:::note
VPDファイルを処理するために、babylon-mmdはレキサーベースのトークン化アプローチを使用しています。

テキストベースのフォーマットであるため、様々なエッジケースを柔軟に処理できるように設計されています。
:::

## ヘッダー

VMDとVPDファイルのヘッダーには**モデル名**が含まれています。

MMDがアニメーションをエクスポートする際、アニメーションが適用されたモデルの名前をヘッダーに保存します。

この名前は後でMMDがアニメーションをモデルにバインドする際に、バインド対象がアニメーションがエクスポートされたモデルと一致するかどうかをチェックするために使用されます。

しかし、**テキストエンコーディングの問題**と**モデル名の保存の長さ制限**（VMDでは20バイト、VPDでは制限なし）のため、実際にはこのメカニズムは確実に機能しません。

:::note
モデル名が実質的に機能していないため、babylon-mmdは解析中にそれを無視してスキップします。
:::

VMDファイルは**カメラアニメーション**または**3Dモデルアニメーション**のいずれかを保存できます。

カメラアニメーションを保存する場合、モデル名は「**カメラ・照明**」に設定され、モデルアニメーションを保存する場合はモデルの名前に設定されます。
- アニメーションを読み込む際、MMDがモデル名「カメラ・照明」を読み込むと、それをカメラアニメーションとして扱い、**モデルへの適用を許可しません**。
- モデル名がモデルの名前に設定されている場合、MMDは**カメラへの適用を許可せず**、モデルに適用する際に**名前が一致するかどうかをチェックします**。
一致しない場合、MMDはアニメーションを適用する前に**警告**を出力します。前述のように、エンコーディングの違いとモデル名の長さ制限により、この機能は同じモデルからエクスポートされたアニメーションでも誤動作する可能性があります。

:::note
**VPDファイル**では、ヘッダーは**ボーンポーズエントリの数**を指定していますが、**babylon-mmdはこれを無視**し、見つけられるすべてのボーンポーズ情報を解析します。

できるだけ**許容的**であることで、**多くの異なるソース**からのVPDファイルを処理できるようになります。
:::

:::note
VMDの仕様では**カメラ**と**3Dモデルアニメーション**の両方を一緒に保存できますが、**モデル名の検証**プロセスにより、最終的にはカメラまたは3Dモデルアニメーションのいずれかにバインドが制限され、両方には適用できません。

しかし、**babylon-mmdはVMDファイルを読み込む際にモデル名を無視する**ため、カメラアニメーションと3Dモデルアニメーションの両方を含むVMDファイルを読み込み、両方を適用できます。

このメカニズムは、後で紹介するVMDの最適化フォーマットである**BVMD**にも適用されます。
:::

## ボーンキーフレーム

VMDファイルはMMDモデルの**ボーンキーフレーム**を保存します。ボーンキーフレームはモデル内のボーンの動きを定義し、具体的には各キーフレームにはバインドされたボーンの名前、位置、回転などが含まれます。

VMDファイル内のボーンキーフレームには以下が含まれます：
- **ボーン名**：キーフレームが適用されるボーンの名前。
- **フレーム番号**：キーフレームが適用されるフレームのインデックス。
- **位置**：ボーンの移動（x, y, z）。
- **回転**：クォータニオンとしてのボーンの回転（x, y, z, w）。
- **補間**：ベジェ曲線パラメータ（位置 x, y, z および回転（slerp t に適用される）について、それぞれ2つの制御点ベクトルで表される）。
- **物理トグル**：ボーンに物理が適用されるかどうかを示すフラグ。

**VMDファイル**では、**ボーン名**は**15バイト**に制限されており、より長いボーン名は**切り捨てられます**。

そのため、15バイトを超える名前を持つボーンのアニメーションはVMDファイルに保存されますが、再読み込み時に**正しくバインドされません**。

:::tip
**物理ボーン**をVMDアニメーションにベイクして読み込む際、物理ボーンの名前が**15バイトを超える**ためにバインドが失敗することがよくあります。
:::

VPDファイルは**ボーン名**とその現在の**状態（位置、回転）**のみを保存します。

## モーフキーフレーム

VMDファイルは**モーフキーフレーム**を保存します。モーフキーフレームはMMDモデルのモーフの状態を定義し、各キーフレームには**モーフの名前**とその**値**が含まれます。

VMDファイル内のモーフキーフレームには以下が含まれます：
- **モーフ名**：キーフレームが適用されるモーフの名前。
- **フレーム番号**：キーフレームが適用されるフレームのインデックス。
- **値**：モーフの値（0.0から1.0）。

**VMDファイル**では、**モーフ名**も**15バイト**に制限されており、より長いモーフ名は**切り捨てられます**。

しかし、MMDモデルのモーフ名は一般的に**ボーン名より短い**ため、長いモーフ名によりバインドが失敗することは**まれ**です。

**VPDファイル**にモーフの状態を保存することは、**MMMの拡張機能**であり、**MMDによって処理されません**。

**VPDファイル**は**モーフの名前**とその現在の**状態（値）**を保存します。
:::note
**babylon-mmd**は**VPDファイル**からモーフの状態を読み取り処理することをサポートしています。
:::

## カメラキーフレーム

**VMDファイル**は**カメラキーフレーム**を保存します。カメラキーフレームには、カメラの**位置**、**回転**、**視野角**などの情報が含まれます。

MMDにはシーン内に**1つのカメラ**しかないため、カメラキーフレームにはバインド対象に関する情報は含まれていません。

MMDのカメラは**オービットカメラ**として動作し、**中心位置**を中心に回転します。

VMDファイル内のカメラキーフレームには以下が含まれます：
- **フレーム番号**：キーフレームが適用されるフレームのインデックス。
- **距離**：カメラから中心（カメラの軌道の中心）までの距離。
- **位置**：カメラの中心位置（x, y, z）。
- **回転**：ヨー、ピッチ、ロールとしてのカメラの回転（x, y, z）。
- **補間**：ベジェ曲線パラメータ（距離、位置 x, y, z、回転 x, y, z および視野角について、それぞれ2つの制御点ベクトルで表される）。
- **視野角**：視野角（度単位）。
- **投影タイプ**：投影タイプ（カメラがパースペクティブかオルソグラフィックか）。

:::note
**babylon-mmd**は**パースペクティブ投影**のみをサポートしています。

**オルソグラフィック投影**のサポートは、要望があれば将来追加される可能性があります。存在しない理由は単に、オルソグラフィック投影が**ほとんど使用されない**からです。
:::

**VPDファイル**はカメラキーフレームの保存をサポートしていません。

## ライトキーフレーム

**VMDファイル**は**ライトキーフレーム**を保存します。ライトキーフレームには、ライトの**方向**と**色**に関する情報が含まれます。

MMDにはシーン内に**1つのディレクショナルライト**しかないため、ライトキーフレームにはバインド対象に関する情報は含まれていません。

一般的に、**ライトキーフレーム**は**ほとんど使用されません**。

:::note
現代の3Dレンダリングエンジンは、通常、単一の固定ライトではなく、**複数のライト**を使用します。

3DレンダリングエンジンとMMDのシェーディング方法の違いにより、**babylon-mmdはライトキーフレームをサポートしていません**。

これは技術的に実装が不可能というわけではなく、**単一ライトモデルが現代のアプリケーションで使用されていない**ためです。

**ライトキーフレーム**のサポートは、要望があれば将来追加される可能性があります。
:::

**VPDファイル**はライトキーフレームの保存をサポートしていません。

## セルフシャドウキーフレーム

**VMDファイル**は**セルフシャドウキーフレーム**を保存します。セルフシャドウキーフレームには、MMDモデルが自身の影をどのように生成するかに関する情報が含まれています。

これは**ほとんど使用されない**機能です。

:::note
**babylon-mmdはセルフシャドウキーフレームをサポートしていません**。

**セルフシャドウキーフレーム**のサポートは、要望があれば将来追加される可能性があります。
:::

**VPDファイル**はセルフシャドウキーフレームの保存をサポートしていません。

## プロパティキーフレーム

**VMDファイル**は**プロパティキーフレーム**を保存します。プロパティキーフレームにはMMDモデルの**可視性**と**IKボーンの有効状態**が含まれます。

VMDファイル内のプロパティキーフレームには以下の情報が含まれます：
- **フレーム番号**：キーフレームが適用されるフレームのインデックス。
- **可視**：モデルが可視かどうか（true/false）。
- **IK有効テーブル**：モデルの各IKボーンの有効状態（true/false）。

**VPDファイル**はプロパティキーフレームの保存をサポートしていません。
