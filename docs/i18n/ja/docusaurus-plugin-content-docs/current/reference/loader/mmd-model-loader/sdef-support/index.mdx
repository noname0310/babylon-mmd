---
sidebar_position: 2
sidebar_label: SDEFサポート
---

# SDEFサポート

このセクションでは、**球状変形（SDEF）を使用するMMDモデルを正しく読み込む方法**について説明します。

## SDEFとは何ですか？

一般的に、スキニングには**リニアブレンドスキニング（LBS）**が使用されます。

このメソッドは、複数のボーンが各頂点に影響を与える場合、各ボーンの影響の重みに基づいて**線形補間**によって頂点位置を決定します。

このメソッドは**シンプルで高速**ですが、**キャンディラッパーアーティファクト**のような問題を引き起こす可能性があります。

import YouTube from "react-youtube";

<YouTube
    videoId="ksDgnOYzWM0"
    opts={{ width: "100%" }} />

**球状変形（SDEF）**はこれらの問題を解決するために提案されたメソッドです。SDEFは頂点位置を決定する際に、**線形補間の代わりに球面補間**を使用し、頂点位置をより自然に補正します。

## babylon-mmdにおけるSDEFサポート

**多くのMMDモデルはSDEFを使用しています**。対照的に、ほとんどの現代的なソフトウェアはLBSのみをサポートしています。

**MMDモデルの仕様とMMDがSDEFをサポートしている**ため、babylon-mmdはMMDの動作と同じ結果を達成するためにSDEFをサポートしています。

**Babylon.jsもSDEFをサポートしていない**ため、babylon-mmdは少し変わった方法を使用しています。

SDEFを処理するために**4つのオプション**が提供されています。

### オプション1：LBSを使用する

**SDEFスキニングを使用するモデルはLBSでレンダリングすることができます**。

このメソッドは、Babylon.jsのデフォルトのスキニングメソッドをそのまま使用するため、**互換性が最も高い**です。

モデルを読み込む際に**`pluginOptions.mmdmodel.useSdef`の値を`false`に設定する**だけでLBSメソッドを使用できます。（デフォルト値は`true`です。）

```typescript
const assetContainer: AssetContainer = await LoadAssetContainerAsync(
    modelFileOrUrl,
    scene,
    {
        pluginOptions: {
            mmdmodel: {
                useSdef: false
            }
        }
    }
);
```

ただし、**以下のようなアーティファクトが発生する可能性があります**。

import Ldef from "@site/docs/reference/loader/mmd-model-loader/sdef-support/ldef.mp4";

<video controls style={{ width: "100%", height: "100%" }}>
  <source src={Ldef} type="video/mp4"/>
</video>

*この動画は**SDEFを使用するMMDモデルをLBSでレンダリングした結果**を示しています。モデル：YYB式初音ミク_10th_v1.02（制作者：SANMUYYB）*

### オプション2：MmdStandardMaterialにのみSDEFを適用する

**`MmdStandardMaterial`を使用してレンダリングする場合**、SDEFを適用できます。

**`MmdStandardMaterial`はbabylon-mmdが提供するマテリアル**で、MMDモデルをレンダリングするために使用されます。
このマテリアルは、`MaterialPlugin`を使用してBabylon.jsの`StandardMaterial`を**修正して作成されています**。
**`MmdStandardMaterial`は様々なMMDマテリアルプロパティ**を提供し、SDEFをサポートしています。

**このマテリアルを使用してMMDモデルを読み込み、SDEFを適用する**には、以下のように読み込みます：

```typescript
const assetContainer: AssetContainer = await LoadAssetContainerAsync(
    modelFileOrUrl,
    scene,
    {
        pluginOptions: {
            mmdmodel: {
                materialBuilder: new MmdStandardMaterialBuilder(),
                useSdef: true
            }
        }
    }
);
```

**このマテリアルを使用するとSDEFが適用できますが**、マテリアル以外の**レンダーパイプラインの残りの部分には影響しません**。

したがって、以下の動画に示すように、**SDEFが適用されていても、シャドウマップには適用されず**、代わりにLBSでレンダリングされた結果が表示されます。

import Sdef from "@site/docs/reference/loader/mmd-model-loader/sdef-support/sdef.mp4";

<video controls style={{ width: "100%", height: "100%" }}>
  <source src={Sdef} type="video/mp4"/>
</video>

*この動画は**`MmdStandardMaterial`を使用してSDEFが適用されたMMDモデルをレンダリングした結果**を示しています。モデル：YYB式初音ミク_10th_v1.02（制作者：SANMUYYB）*

### オプション3：シェーダーインジェクションを使用してSDEFを適用する

このメソッドは**Babylon.jsのシェーダーコンパイルのエントリーポイントを修正してSDEFを適用**し、**babylon-mmdが提供する最も強力なSDEFサポートメソッド**です。

**このメソッドはオプション2と一緒に使用するのが最適**ですが、他のケースでもSDEFを適用できます。

**`Scene`を作成する前に**、以下のコードを実行して`Engine.createEffect`関数を修正します：

```
SdefInjector.OverrideEngineCreateEffect(engine);
```

**これはプロトタイプを修正せず**、`Engine`インスタンスにcreateEffect関数を追加することで機能します。

import SdefWithInjection from "@site/docs/reference/loader/mmd-model-loader/sdef-support/sdef_with_injection.mp4";

<video controls style={{ width: "100%", height: "100%" }}>
  <source src={SdefWithInjection} type="video/mp4"/>
</video>

*この動画は**シェーダーインジェクションを通じてSDEFを使用するMMDモデルをレンダリングした結果**を示しています。モデル：YYB式初音ミク_10th_v1.02（制作者：SANMUYYB）*

### オプション4：CPUバウンドSDEFスキニング

このメソッドは**CPUでSDEFスキニングを実行**し、**非常に低いパフォーマンス**ですが、どのレンダリングパイプラインでもSDEFを適用できます。

**`pluginOptions.mmdmodel.useSdef`を`true`に設定**し、すべてのメッシュの**`computeBonesUsingShaders`の値を`false`に設定**します。

```typescript
const assetContainer: AssetContainer = await LoadAssetContainerAsync(
    modelFileOrUrl,
    scene,
    {
        pluginOptions: {
            mmdmodel: {
                useSdef: true
            }
        }
    }
);
assetContainer.addAllToScene();
const modelMesh = assetContainer.meshes[0] as MmdMesh;
for (const mesh of modelMesh.metadata.meshes) mesh.computeBonesUsingShaders = false;
```

**Babylon.jsの`Mesh`は、シェーダーでスキニングができない場合のフォールバックとしてCPUバウンドスキニングをサポート**しています。ただし、**Babylon.jsのCPUバウンドスキニングはSDEFをサポートしていない**ため、babylon-mmdはこれをオーバーライドしてSDEFをサポートしています。

**`useSdef`が`true`に設定されている**場合、CPUスキニングの実装がオーバーライドされ、SDEFサポートが必要なメッシュには`Mesh`の代わりに**`Mesh`を継承した`SdefMesh`が使用されます**。

ただし、この場合、**モーフターゲットを同時に使用することはできません**。
これは、変形を適用する際、**モーフターゲットはスキニングの前に適用されるべき**ですが、CPUバウンドでスキニングが先に処理される場合、**モーフターゲットは後でシェーダーで適用される**ため、変換順序が正しくなくなるためです。
したがって、**ランタイムエラーは発生しません**が、**非常に奇妙な結果**を生み出す可能性があります。

## SDEFシェーダーインジェクションの実装詳細

**SDEFをサポートするためには、Babylon.jsの内部シェーダーコードを修正**し、Babylon.js内のすべてのレンダーパイプラインを適切に修正する必要があります。

例えば、**SDEFを使用するMMDモデルを被写界深度エフェクトで使用する**には、**深度レンダラーの頂点シェーダーを修正**し、さらにレンダーパイプラインを修正して**SDEFを適用するために必要な属性を追加でバインド**する必要があります。

**そのような作業は実質的に不可能**なため、babylon-mmdは代わりに**Babylon.jsのシェーダーコンパイルのエントリーポイントを修正してSDEFコードを挿入する**メソッドを使用しています。

**Babylon.jsはシェーダーを実行するために必要な属性、ユニフォームなどと一緒にシェーダーコード**を`Engine.createEffect`関数に渡します。**babylon-mmdはこのプロセスを傍受してSDEF関連のコードを挿入**します。

**修正された`createEffect`関数は以下のプロセスを経ます**：

1. **現在コンパイルされているシェーダーがスケルトンをサポートしているかチェック**する。
2. スケルトンがサポートされている場合、**SDEF用の属性を追加**する。
3. **SDEFスキニングコードを挿入**する。
4. **修正されたパラメータを元の`createEffect`関数に渡す**。

**このアプローチの副作用**として、**スケルトンをサポートしているがSDEFをサポートしていないシェーダーにもSDEFコードが挿入される**ことです。

この場合、**シェーダーの分岐発散により、LBSを使用するスケルトンをレンダリングする場合でも、SDEFを適用する場合と同じ計算コストが発生**します。
