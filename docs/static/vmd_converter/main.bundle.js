"use strict";(self.webpackChunkbabylon_mmd=self.webpackChunkbabylon_mmd||[]).push([[63],{215:(e,t,i)=>{i.d(t,{I:()=>r});class r{static SetMatrixPrecision(e){if(r.MatrixTrackPrecisionChange=!1,e&&!r.MatrixUse64Bits&&r.MatrixTrackedMatrices)for(let e=0;e<r.MatrixTrackedMatrices.length;++e){const t=r.MatrixTrackedMatrices[e],i=t._m;t._m=new Array(16);for(let e=0;e<16;++e)t._m[e]=i[e]}r.MatrixUse64Bits=e,r.MatrixCurrentType=r.MatrixUse64Bits?Array:Float32Array,r.MatrixTrackedMatrices=null}}r.MatrixUse64Bits=!1,r.MatrixTrackPrecisionChange=!0,r.MatrixCurrentType=Float32Array,r.MatrixTrackedMatrices=[]},350:(e,t,i)=>{i.d(t,{S0:()=>m});var r=i(9848),s=i(8790),n=i(1137);const a=(e,t,i)=>e?e.getClassName&&"Mesh"===e.getClassName()?null:!e.getClassName||"SubMesh"!==e.getClassName()&&"PhysicsBody"!==e.getClassName()?e.clone?e.clone():Array.isArray(e)?e.slice():i&&"object"==typeof e?{...e}:null:e.clone(t):null;class o{static DeepCopy(e,t,i,r,s=!1){const o=function(e){const t=[];do{const i=Object.getOwnPropertyNames(e);for(const e of i)-1===t.indexOf(e)&&t.push(e)}while(e=Object.getPrototypeOf(e));return t}(e);for(const h of o){if("_"===h[0]&&(!r||-1===r.indexOf(h)))continue;if(h.endsWith("Observable"))continue;if(i&&-1!==i.indexOf(h))continue;const o=e[h],l=typeof o;if("function"!==l)try{if("object"===l)if(o instanceof Uint8Array)t[h]=Uint8Array.from(o);else if(o instanceof Array){if(t[h]=[],o.length>0)if("object"==typeof o[0])for(let e=0;e<o.length;e++){const i=a(o[e],t,s);-1===t[h].indexOf(i)&&t[h].push(i)}else t[h]=o.slice(0)}else t[h]=a(o,t,s);else t[h]=o}catch(e){n.V.Warn(e.message)}}}}var h=i(6237),l=i(5503),c=i(2366),u=i(6315),_=i(9492),d=i(2940),f=i(9337),p=i(8688),g=i(1597);class m{static get BaseUrl(){return _.eC.BaseUrl}static set BaseUrl(e){_.eC.BaseUrl=e}static get CleanUrl(){return _.eC.CleanUrl}static set CleanUrl(e){_.eC.CleanUrl=e}static IsAbsoluteUrl(e){return 0===e.indexOf("//")||-1!==e.indexOf("://")&&-1!==e.indexOf(".")&&-1!==e.indexOf("/")&&!(e.indexOf(":")>e.indexOf("/"))&&(e.indexOf("://")<e.indexOf(".")||0===e.indexOf("data:")||0===e.indexOf("blob:"))}static set ScriptBaseUrl(e){_.eC.ScriptBaseUrl=e}static get ScriptBaseUrl(){return _.eC.ScriptBaseUrl}static set CDNBaseUrl(e){m.ScriptBaseUrl=e,m.AssetBaseUrl=e}static set ScriptPreprocessUrl(e){_.eC.ScriptPreprocessUrl=e}static get ScriptPreprocessUrl(){return _.eC.ScriptPreprocessUrl}static get DefaultRetryStrategy(){return _.eC.DefaultRetryStrategy}static set DefaultRetryStrategy(e){_.eC.DefaultRetryStrategy=e}static get CorsBehavior(){return _.eC.CorsBehavior}static set CorsBehavior(e){_.eC.CorsBehavior=e}static get UseFallbackTexture(){return u.q.UseFallbackTexture}static set UseFallbackTexture(e){u.q.UseFallbackTexture=e}static get RegisteredExternalClasses(){return f.n.RegisteredExternalClasses}static set RegisteredExternalClasses(e){f.n.RegisteredExternalClasses=e}static get fallbackTexture(){return u.q.FallbackTexture}static set fallbackTexture(e){u.q.FallbackTexture=e}static FetchToRef(e,t,i,r,s,n){const a=4*((Math.abs(e)*i%i|0)+(Math.abs(t)*r%r|0)*i);n.r=s[a]/255,n.g=s[a+1]/255,n.b=s[a+2]/255,n.a=s[a+3]/255}static Mix(e,t,i){return 0}static Instantiate(e){return f.n.Instantiate(e)}static SetImmediate(e){d._.SetImmediate(e)}static IsExponentOfTwo(e){return!0}static FloatRound(e){return Math.fround(e)}static GetFilename(e){const t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){const i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}static ToDegrees(e){return 180*e/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,i=.9){const r=this.ToRadians(e),s=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(s)+i*Math.sin(r),(1-i)*Math.cos(s)+i*Math.cos(r)))}static MakeArray(e,t){return!0===t||void 0!==e&&null!=e?Array.isArray(e)?e:[e]:null}static GetPointerPrefix(e){return(0,s.BA)()&&!window.PointerEvent?"mouse":"pointer"}static SetCorsBehavior(e,t){(0,_.M1)(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static get PreprocessUrl(){return _.eC.PreprocessUrl}static set PreprocessUrl(e){_.eC.PreprocessUrl=e}static LoadImage(e,t,i,r,s,n){return(0,_.W$)(e,t,i,r,s,n)}static LoadFile(e,t,i,r,s,n){return(0,_.zU)(e,t,i,r,s,n)}static async LoadFileAsync(e,t=!0){return await new Promise(((i,r)=>{(0,_.zU)(e,(e=>{i(e)}),void 0,void 0,t,((e,t)=>{r(t)}))}))}static GetAssetUrl(e){if(!e)return"";if(m.AssetBaseUrl&&e.startsWith(m._DefaultAssetsUrl)){const t="/"===m.AssetBaseUrl[m.AssetBaseUrl.length-1]?m.AssetBaseUrl.substring(0,m.AssetBaseUrl.length-1):m.AssetBaseUrl;return e.replace(m._DefaultAssetsUrl,t)}return e}static GetBabylonScriptURL(e,t){if(!e)return"";if(m.ScriptBaseUrl&&e.startsWith(m._DefaultCdnUrl)){const t="/"===m.ScriptBaseUrl[m.ScriptBaseUrl.length-1]?m.ScriptBaseUrl.substring(0,m.ScriptBaseUrl.length-1):m.ScriptBaseUrl;e=e.replace(m._DefaultCdnUrl,t)}return e=m.ScriptPreprocessUrl(e),t&&(e=m.GetAbsoluteUrl(e)),e}static LoadBabylonScript(e,t,i,r){e=m.GetBabylonScriptURL(e),m.LoadScript(e,t,i)}static async LoadBabylonScriptAsync(e){return e=m.GetBabylonScriptURL(e),await m.LoadScriptAsync(e)}static LoadScript(e,t,i,r,n=!1){if("function"==typeof importScripts){try{importScripts(e),t&&t()}catch(t){i?.(`Unable to load script '${e}' in worker`,t)}return}if(!(0,s.BA)())return void i?.(`Cannot load script '${e}' outside of a window or a worker`);const a=document.getElementsByTagName("head")[0],o=document.createElement("script");n?(o.setAttribute("type","module"),o.innerText=e):(o.setAttribute("type","text/javascript"),o.setAttribute("src",e)),r&&(o.id=r),o.onload=()=>{t&&t()},o.onerror=t=>{i&&i(`Unable to load script '${e}'`,t)},a.appendChild(o)}static async LoadScriptAsync(e,t){return await new Promise(((i,r)=>{this.LoadScript(e,(()=>{i()}),((e,t)=>{r(t||new Error(e))}),t)}))}static ReadFileAsDataURL(e,t,i){const s=new FileReader,n={onCompleteObservable:new r.cP,abort:()=>s.abort()};return s.onloadend=()=>{n.onCompleteObservable.notifyObservers(n)},s.onload=e=>{t(e.target.result)},s.onprogress=i,s.readAsDataURL(e),n}static ReadFile(e,t,i,r,s){return(0,_.NJ)(e,t,i,r,s)}static FileAsURL(e){const t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,i,r){o.DeepCopy(e,t,i,r)}static IsEmpty(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const r=t[i];e.addEventListener(r.name,r.handler,!1);try{window.parent&&window.parent.addEventListener(r.name,r.handler,!1)}catch(e){}}}static UnregisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const r=t[i];e.removeEventListener(r.name,r.handler);try{e.parent&&e.parent.removeEventListener(r.name,r.handler)}catch(e){}}}static async DumpFramebuffer(e,t,i,r,s="image/png",n,a){throw(0,l.n)("DumpTools")}static DumpData(e,t,i,r,s="image/png",n,a=!1,o=!1,h){throw(0,l.n)("DumpTools")}static async DumpDataAsync(e,t,i,r="image/png",s,n=!1,a=!1,o){throw(0,l.n)("DumpTools")}static _IsOffScreenCanvas(e){return void 0!==e.convertToBlob}static ToBlob(e,t,i="image/png",r){m._IsOffScreenCanvas(e)||e.toBlob||(e.toBlob=function(e,t,i){setTimeout((()=>{const r=atob(this.toDataURL(t,i).split(",")[1]),s=r.length,n=new Uint8Array(s);for(let e=0;e<s;e++)n[e]=r.charCodeAt(e);e(new Blob([n]))}))}),m._IsOffScreenCanvas(e)?e.convertToBlob({type:i,quality:r}).then((e=>t(e))):e.toBlob((function(e){t(e)}),i,r)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){const e=new Date;t="screenshot_"+(e.getFullYear()+"-"+(e.getMonth()+1)).slice(2)+"-"+e.getDate()+"_"+e.getHours()+"-"+("0"+e.getMinutes()).slice(-2)+".png"}m.Download(e,t)}else if(e&&"undefined"!=typeof URL){const t=URL.createObjectURL(e),i=window.open("");if(!i)return;const r=i.document.createElement("img");r.onload=function(){URL.revokeObjectURL(t)},r.src=t,i.document.body.appendChild(r)}}static EncodeScreenshotCanvasData(e,t,i="image/png",r,s){if("string"!=typeof r&&t){if(t){if(m._IsOffScreenCanvas(e))return void e.convertToBlob({type:i,quality:s}).then((e=>{const i=new FileReader;i.readAsDataURL(e),i.onloadend=()=>{const e=i.result;t(e)}}));const r=e.toDataURL(i,s);t(r)}}else this.ToBlob(e,(function(e){e&&m.DownloadBlob(e,r),t&&t("")}),i,s)}static Download(e,t){if("undefined"==typeof URL)return;const i=window.URL.createObjectURL(e),r=document.createElement("a");document.body.appendChild(r),r.style.display="none",r.href=i,r.download=t,r.addEventListener("click",(()=>{r.parentElement&&r.parentElement.removeChild(r)})),r.click(),window.URL.revokeObjectURL(i)}static BackCompatCameraNoPreventDefault(e){return"boolean"==typeof e[0]?e[0]:"boolean"==typeof e[1]&&e[1]}static CreateScreenshot(e,t,i,r,s="image/png",n=!1,a){throw(0,l.n)("ScreenshotTools")}static async CreateScreenshotAsync(e,t,i,r="image/png",s){throw(0,l.n)("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,i,r,s="image/png",n=1,a=!1,o,h=!1,c=!1,u=!0,_,d){throw(0,l.n)("ScreenshotTools")}static async CreateScreenshotUsingRenderTargetAsync(e,t,i,r="image/png",s=1,n=!1,a,o=!1,h=!1,c=!0,u,_){throw(0,l.n)("ScreenshotTools")}static RandomId(){return(0,p.z)()}static IsBase64(e){return(0,_.f2)(e)}static DecodeBase64(e){return(0,_.rz)(e)}static get errorsCount(){return n.V.errorsCount}static Log(e){n.V.Log(e)}static Warn(e){n.V.Warn(e)}static Error(e){n.V.Error(e)}static get LogCache(){return n.V.LogCache}static ClearLogCache(){n.V.ClearLogCache()}static set LogLevels(e){n.V.LogLevels=e}static set PerformanceLogLevel(e){return(e&m.PerformanceUserMarkLogLevel)===m.PerformanceUserMarkLogLevel?(m.StartPerformanceCounter=m._StartUserMark,void(m.EndPerformanceCounter=m._EndUserMark)):(e&m.PerformanceConsoleLogLevel)===m.PerformanceConsoleLogLevel?(m.StartPerformanceCounter=m._StartPerformanceConsole,void(m.EndPerformanceCounter=m._EndPerformanceConsole)):(m.StartPerformanceCounter=m._StartPerformanceCounterDisabled,void(m.EndPerformanceCounter=m._EndPerformanceCounterDisabled))}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!m._Performance){if(!(0,s.BA)())return;m._Performance=window.performance}t&&m._Performance.mark&&m._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){t&&m._Performance.mark&&(m._Performance.mark(e+"-End"),m._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){t&&(m._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){t&&(m._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return h.j.Now}static GetClassName(e,t=!1){let i=null;return!t&&e.getClassName?i=e.getClassName():(e instanceof Object&&(i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),i||(i=typeof e)),i}static First(e,t){for(const i of e)if(t(i))return i;return null}static getFullClassName(e,t=!1){let i=null,r=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){const s=t?e:Object.getPrototypeOf(e);i=s.constructor.__bjsclassName__,r=s.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(null!=r?r+".":"")+i:null}static async DelayAsync(e){await new Promise((t=>{setTimeout((()=>{t()}),e)}))}static IsSafari(){return!!(0,s.XD)()&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}}m.AssetBaseUrl="",m.UseCustomRequestHeaders=!1,m.CustomRequestHeaders=c.u.CustomRequestHeaders,m.GetDOMTextContent=s.Zl,m._DefaultCdnUrl="https://cdn.babylonjs.com",m._DefaultAssetsUrl="https://assets.babylonjs.com/core",m.GetAbsoluteUrl="object"==typeof document?e=>{const t=document.createElement("a");return t.href=e,t.href}:"function"==typeof URL&&"object"==typeof location?e=>new URL(e,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")},m.NoneLogLevel=n.V.NoneLogLevel,m.MessageLogLevel=n.V.MessageLogLevel,m.WarningLogLevel=n.V.WarningLogLevel,m.ErrorLogLevel=n.V.ErrorLogLevel,m.AllLogLevel=n.V.AllLogLevel,m.IsWindowObjectExist=s.BA,m.PerformanceNoneLogLevel=0,m.PerformanceUserMarkLogLevel=1,m.PerformanceConsoleLogLevel=2,m.StartPerformanceCounter=m._StartPerformanceCounterDisabled,m.EndPerformanceCounter=m._EndPerformanceCounterDisabled,m.Mix=g.zF,m.IsExponentOfTwo=g.L8,u.q.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z"},521:(e,t,i)=>{i.d(t,{o:()=>r});class r{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=0|this.width;return e=397*e^this.height,e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new r(this.width*e,this.height*t)}clone(){return new r(this.width,this.height)}equals(e){return!!e&&this.width===e.width&&this.height===e.height}get surface(){return this.width*this.height}static Zero(){return new r(0,0)}add(e){return new r(this.width+e.width,this.height+e.height)}subtract(e){return new r(this.width-e.width,this.height-e.height)}scale(e){return new r(this.width*e,this.height*e)}static Lerp(e,t,i){const s=e.width+(t.width-e.width)*i,n=e.height+(t.height-e.height)*i;return new r(s,n)}}},854:(e,t,i)=>{i.d(t,{h:()=>a});var r,s=i(9848);class n{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,i=1,r=1,s=2,n=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=r,this.samplingMode=s,this._comparisonFunction=n,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}!function(e){e[e.Unknown=0]="Unknown",e[e.Url=1]="Url",e[e.Temp=2]="Temp",e[e.Raw=3]="Raw",e[e.Dynamic=4]="Dynamic",e[e.RenderTarget=5]="RenderTarget",e[e.MultiRenderTarget=6]="MultiRenderTarget",e[e.Cube=7]="Cube",e[e.CubeRaw=8]="CubeRaw",e[e.CubePrefiltered=9]="CubePrefiltered",e[e.Raw3D=10]="Raw3D",e[e.Raw2DArray=11]="Raw2DArray",e[e.DepthStencil=12]="DepthStencil",e[e.CubeRawRGBD=13]="CubeRawRGBD",e[e.Depth=14]="Depth"}(r||(r={}));class a extends n{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(e,t,i=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new s.cP,this.onErrorObservable=new s.cP,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=0,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._creationFlags=0,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._premulAlpha=!1,this._dynamicTextureSource=null,this._autoMSAAManagement=!1,this._engine=e,this._source=t,this._uniqueId=a._Counter++,i||(this._hardwareTexture=e._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,t,i=1){this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i}_rebuild(){if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const e=this.onRebuildCallback(this),t=t=>{t._swapAndDie(this,!1),this.isReady=e.isReady};return void(e.isAsync?e.proxy.then(t):t(e.proxy))}let e;switch(this.source){case 2:case 12:case 14:break;case 1:return void(e=this._engine.createTexture(this._originalUrl??this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,(e=>{e._swapAndDie(this,!1),this.isReady=!0}),null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer));case 3:e=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,this._creationFlags,this._useSRGBBuffer),e._swapAndDie(this,!1),this.isReady=!0;break;case 10:e=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 11:e=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 4:e=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),e._swapAndDie(this,!1),this._dynamicTextureSource&&this._engine.updateDynamicTexture(this,this._dynamicTextureSource,this.invertY,this._premulAlpha,this.format,!0);break;case 7:return void(e=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,(()=>{e._swapAndDie(this,!1),this.isReady=!0}),null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer,ArrayBuffer.isView(this._buffer)?this._buffer:null));case 8:e=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this._originalFormat??this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),e._swapAndDie(this,!1),this.isReady=!0;break;case 13:return;case 9:return e=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,(e=>{e&&e._swapAndDie(this,!1),this.isReady=!0}),null,this.format,this._extension),void(e._sphericalPolynomial=this._sphericalPolynomial)}}_swapAndDie(e,t=!0){this._hardwareTexture?.setUsage(e._source,this.generateMipMaps,this.is2DArray,this.isCube,this.is3D,this.width,this.height,this.depth),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);const i=this._engine.getLoadedTexturesCache();let r=i.indexOf(this);-1!==r&&i.splice(r,1),r=i.indexOf(e),-1===r&&i.push(e)}dispose(){this._references--,0===this._references&&(this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._engine._releaseTexture(this),this._hardwareTexture=null,this._dynamicTextureSource=null)}}a._Counter=0},1137:(e,t,i)=>{i.d(t,{V:()=>r});class r{static _CheckLimit(e,t){let i=r._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},r._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){const i=r._LogLimitOutputs[e];if(!i||!r.MessageLimitReached)return;const s=this._Levels[t];i.current===i.limit&&r[s.name](r.MessageLimitReached.replace(/%LIMIT%/g,""+i.limit).replace(/%TYPE%/g,s.name??""))}static _AddLogEntry(e){r._LogCache=e+r._LogCache,r.OnNewCacheEntry&&r.OnNewCacheEntry(e)}static _FormatMessage(e){const t=e=>e<10?"0"+e:""+e,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){const s=Array.isArray(t)?t[0]:t;if(void 0!==i&&!r._CheckLimit(s,i))return;const n=r._FormatMessage(s),a=this._Levels[e],o=Array.isArray(t)?t.slice(1):[];a.logFunc&&a.logFunc("BJS - "+n,...o);const h=`<div style='color:${a.color}'>${n}</div><br>`;r._AddLogEntry(h),r._GenerateLimitMessage(s,e)}static get LogCache(){return r._LogCache}static ClearLogCache(){r._LogCache="",r._LogLimitOutputs={},r.errorsCount=0}static set LogLevels(e){r.Log=r._LogDisabled,r.Warn=r._LogDisabled,r.Error=r._LogDisabled;const t=[r.MessageLogLevel,r.WarningLogLevel,r.ErrorLogLevel];for(const i of t)if((e&i)===i){const e=this._Levels[i];r[e.name]=r._LogEnabled.bind(r,i)}}}r.NoneLogLevel=0,r.MessageLogLevel=1,r.WarningLogLevel=2,r.ErrorLogLevel=4,r.AllLogLevel=7,r.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.",r._LogCache="",r._LogLimitOutputs={},r._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}],r.errorsCount=0,r.Log=r._LogEnabled.bind(r,r.MessageLogLevel),r.Warn=r._LogEnabled.bind(r,r.WarningLogLevel),r.Error=r._LogEnabled.bind(r,r.ErrorLogLevel)},1504:(e,t,i)=>{i.d(t,{n:()=>r});class r{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=r._Counter++}}r._Counter=0},1597:(e,t,i)=>{function r(e){let t=1;do{t*=2}while(t<e);return t===e}function s(e,t,i){return e*(1-i)+t*i}function n(e){const t=a(e),i=o(e);return t-e>e-i?i:t}function a(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function o(e){return e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)-(e>>1)}function h(e,t,i=2){let r;switch(i){case 1:r=o(e);break;case 2:r=n(e);break;default:r=a(e)}return Math.min(r,t)}i.d(t,{C4:()=>o,L8:()=>r,OG:()=>n,R:()=>h,zF:()=>s})},2366:(e,t,i)=>{i.d(t,{u:()=>r});class r{constructor(){this._xhr="undefined"!=typeof _native&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest,this._requestURL=""}static get IsCustomRequestAvailable(){return Object.keys(r.CustomRequestHeaders).length>0||r.CustomRequestModifiers.length>0}get requestURL(){return this._requestURL}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in r.CustomRequestHeaders){const t=r.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return r.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,i){this._xhr.addEventListener(e,t,i)}removeEventListener(e,t,i){this._xhr.removeEventListener(e,t,i)}abort(){this._xhr.abort()}send(e){r.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(const e of r.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;t=e(this._xhr,t)||t}t=(t=t.replace("file:http:","http:")).replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}}r.CustomRequestHeaders={},r.CustomRequestModifiers=new Array,r.SkipRequestModificationForBabylonCDN=!0},2572:(e,t,i)=>{i.d(t,{P:()=>s});var r=i(4100);class s{static GetPlanes(e){const t=[];for(let e=0;e<6;e++)t.push(new r.Z(0,0,0,0));return s.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}static GetFarPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}static GetLeftPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}static GetRightPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}static GetTopPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}static GetBottomPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}static GetPlanesToRef(e,t){s.GetNearPlaneToRef(e,t[0]),s.GetFarPlaneToRef(e,t[1]),s.GetLeftPlaneToRef(e,t[2]),s.GetRightPlaneToRef(e,t[3]),s.GetTopPlaneToRef(e,t[4]),s.GetBottomPlaneToRef(e,t[5])}static IsPointInFrustum(e,t){for(let i=0;i<6;i++)if(t[i].dotCoordinate(e)<0)return!1;return!0}}},2667:(e,t,i)=>{i.d(t,{t:()=>_});var r=i(5524),s=i(9259),n=i(9848),a=i(4037),o=i(6315),h=i(8688),l=(i(9492),i(521));class c{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return!!this._texture&&this._texture.isCube}set isCube(e){this._texture&&(this._texture.isCube=e)}get is3D(){return!!this._texture&&this._texture.is3D}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return!!this._texture&&this._texture.is2DArray}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return void 0!==e?.shareDepth}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=l.o.Zero(),this._cachedBaseSize=l.o.Zero(),this._initialSamplingMode=2,this._texture=c._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine())}isReady(){return 4===this.delayLoadState?(this.delayLoad(),!1):!!this._texture&&this._texture.isReady}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return this.isReady()&&this._texture?this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize):(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture,this._texture.generateMipMaps)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}var u=i(6877);class _ extends c{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return!!this._texture&&this._texture.is3D}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return!!this._texture&&this._texture.is2DArray}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}get gammaSpace(){return this._texture?(null===this._texture._gammaSpace&&(this._texture._gammaSpace=this._gammaSpace),this._texture._gammaSpace&&!this._texture._useSRGBBuffer):this._gammaSpace}set gammaSpace(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}this.getScene()?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this)))}get isRGBD(){return null!=this._texture&&this._texture._isRGBD}set isRGBD(e){e!==this.isRGBD&&(this._texture&&(this._texture._isRGBD=e),this.getScene()?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return!!this._texture&&this._texture._linearSpecularLOD}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=(0,h.z)()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=_.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this._dominantDirection=null,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=[],this.onDisposeObservable=new n.cP,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?_._IsScene(e)?this._scene=e:this._engine=e:this._scene=o.q.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}getTextureMatrix(){return a.uq.IdentityReadOnly}getReflectionTextureMatrix(){return a.uq.IdentityReadOnly}getRefractionTextureMatrix(){return this.getReflectionTextureMatrix()}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,i,r,s,n){const a=this._getEngine();if(!a)return null;const o=a._getUseSRGBBuffer(!!s,t),h=a.getLoadedTexturesCache();for(let a=0;a<h.length;a++){const l=h[a];if(!(void 0!==s&&o!==l._useSRGBBuffer||void 0!==r&&r!==l.invertY||l.url!==e||l.generateMipMaps!==!t||i&&i!==l.samplingMode||void 0!==n&&n!==l.isCube))return l.incrementReferences(),l}return null}_rebuild(e=!1){}clone(){return null}get textureType(){return this._texture&&void 0!==this._texture.type?this._texture.type:0}get textureFormat(){return this._texture&&void 0!==this._texture.format?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,i=null,r=!0,s=!1,n=0,a=0,o=Number.MAX_VALUE,h=Number.MAX_VALUE){if(!this._texture)return null;const l=this._getEngine();if(!l)return null;const c=this.getSize();let u=c.width,_=c.height;0!==t&&(u/=Math.pow(2,t),_/=Math.pow(2,t),u=Math.round(u),_=Math.round(_)),o=Math.min(u,o),h=Math.min(_,h);try{return this._texture.isCube?l._readTexturePixels(this._texture,o,h,e,t,i,r,s,n,a):l._readTexturePixels(this._texture,o,h,-1,t,i,r,s,n,a)}catch(e){return null}}_readPixelsSync(e=0,t=0,i=null,r=!0,s=!1){if(!this._texture)return null;const n=this.getSize();let a=n.width,o=n.height;const h=this._getEngine();if(!h)return null;0!=t&&(a/=Math.pow(2,t),o/=Math.pow(2,t),a=Math.round(a),o=Math.round(o));try{return this._texture.isCube?h._readTexturePixelsSync(this._texture,a,o,e,t,i,r,s):h._readTexturePixelsSync(this._texture,a,o,-1,t,i,r,s)}catch(e){return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const e=this._parentContainer.textures.indexOf(this);e>-1&&this._parentContainer.textures.splice(e,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;const t=u.p.Serialize(this);return u.p.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let i=e.length;if(0!==i)for(let r=0;r<e.length;r++){const s=e[r];if(s.isReady())0===--i&&t();else{const e=s.onLoadObservable;e?e.addOnce((()=>{0===--i&&t()})):0===--i&&t()}}else t()}static _IsScene(e){return"Scene"===e.getClassName()}}_.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,(0,r.Cg)([(0,s.lK)()],_.prototype,"uniqueId",void 0),(0,r.Cg)([(0,s.lK)()],_.prototype,"name",void 0),(0,r.Cg)([(0,s.lK)()],_.prototype,"displayName",void 0),(0,r.Cg)([(0,s.lK)()],_.prototype,"metadata",void 0),(0,r.Cg)([(0,s.lK)("hasAlpha")],_.prototype,"_hasAlpha",void 0),(0,r.Cg)([(0,s.lK)("getAlphaFromRGB")],_.prototype,"_getAlphaFromRGB",void 0),(0,r.Cg)([(0,s.lK)()],_.prototype,"level",void 0),(0,r.Cg)([(0,s.lK)("coordinatesIndex")],_.prototype,"_coordinatesIndex",void 0),(0,r.Cg)([(0,s.lK)()],_.prototype,"optimizeUVAllocation",void 0),(0,r.Cg)([(0,s.lK)("coordinatesMode")],_.prototype,"_coordinatesMode",void 0),(0,r.Cg)([(0,s.lK)()],_.prototype,"wrapU",null),(0,r.Cg)([(0,s.lK)()],_.prototype,"wrapV",null),(0,r.Cg)([(0,s.lK)()],_.prototype,"wrapR",void 0),(0,r.Cg)([(0,s.lK)()],_.prototype,"anisotropicFilteringLevel",void 0),(0,r.Cg)([(0,s.lK)()],_.prototype,"isCube",null),(0,r.Cg)([(0,s.lK)()],_.prototype,"is3D",null),(0,r.Cg)([(0,s.lK)()],_.prototype,"is2DArray",null),(0,r.Cg)([(0,s.lK)()],_.prototype,"gammaSpace",null),(0,r.Cg)([(0,s.lK)()],_.prototype,"invertZ",void 0),(0,r.Cg)([(0,s.lK)()],_.prototype,"lodLevelInAlpha",void 0),(0,r.Cg)([(0,s.lK)()],_.prototype,"lodGenerationOffset",null),(0,r.Cg)([(0,s.lK)()],_.prototype,"lodGenerationScale",null),(0,r.Cg)([(0,s.lK)()],_.prototype,"linearSpecularLOD",null),(0,r.Cg)([(0,s.uM)()],_.prototype,"irradianceTexture",null),(0,r.Cg)([(0,s.lK)()],_.prototype,"isRenderTarget",void 0)},2940:(e,t,i)=>{i.d(t,{B:()=>a,_:()=>s});let r=[];class s{static SetImmediate(e){0===r.length&&setTimeout((()=>{const e=r;r=[];for(const t of e)t()}),1),r.push(e)}}function n(e,t,i){try{if(e())return t(),!0}catch(e){return i?.(e),!0}return!1}const a=(e,t,i,r=16,s=3e4,a=!0,o)=>{if(a&&n(e,t,i))return null;const h=setInterval((()=>{n(e,t,i)?clearInterval(h):(s-=r)<0&&(clearInterval(h),i?.(new Error("Operation timed out after maximum retries. "+(o||"")),!0))}),r);return()=>clearInterval(h)}},3099:(e,t,i)=>{i.d(t,{m:()=>o});var r=i(7931),s=i(4037);class n{set opaqueSortCompareFn(e){this._opaqueSortCompareFn=e||n.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){this._alphaTestSortCompareFn=e||n.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){this._transparentSortCompareFn=e||n.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,i=null,s=null,n=null){this.index=e,this._opaqueSubMeshes=new r.L(256),this._transparentSubMeshes=new r.L(256),this._alphaTestSubMeshes=new r.L(256),this._depthOnlySubMeshes=new r.L(256),this._particleSystems=new r.L(256),this._spriteManagers=new r.L(256),this._empty=!0,this._edgesRenderers=new r.b(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=s,this.transparentSortCompareFn=n}render(e,t,i,r){if(e)return void e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);const s=this._scene.getEngine();0!==this._depthOnlySubMeshes.length&&(s.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),s.setColorWrite(!0)),0!==this._opaqueSubMeshes.length&&this._renderOpaque(this._opaqueSubMeshes),0!==this._alphaTestSubMeshes.length&&this._renderAlphaTest(this._alphaTestSubMeshes);const n=s.getStencilBuffer();if(s.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(r),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),0!==this._transparentSubMeshes.length||this._scene.useOrderIndependentTransparency){if(s.setStencilBuffer(n),this._scene.useOrderIndependentTransparency){const e=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);e.length&&this._renderTransparent(e)}else this._renderTransparent(this._transparentSubMeshes);s.setAlphaMode(0)}if(s.setStencilBuffer(!1),this._edgesRenderers.length){for(let e=0;e<this._edgesRenderers.length;e++)this._edgesRenderers.data[e].render();s.setAlphaMode(0)}s.setStencilBuffer(n)}_renderOpaqueSorted(e){n._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){n._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){n._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,i,r){let a,o=0;const h=i?i.globalPosition:n._ZeroVector;if(r)for(;o<e.length;o++)a=e.data[o],a._alphaIndex=a.getMesh().alphaIndex,a._distanceToCamera=s.Pq.Distance(a.getBoundingInfo().boundingSphere.centerWorld,h);const l=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&l.sort(t);const c=l[0].getMesh().getScene();for(o=0;o<l.length;o++)if(a=l[o],!c._activeMeshesFrozenButKeepClipping||a.isInFrustum(c._frustumPlanes)){if(r){const e=a.getMaterial();if(e&&e.needDepthPrePass){const t=e.getScene().getEngine();t.setColorWrite(!1),t.setAlphaMode(0),a.render(!1),t.setColorWrite(!0)}}a.render(r)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:n.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const i=e.getMesh(),r=t.getMesh();return i.material&&r.material?i.material.uniqueId-r.material.uniqueId:i.uniqueId-r.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,i){void 0===t&&(t=e.getMesh()),void 0===i&&(i=e.getMaterial()),null!=i&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTestingForMesh(t)?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t.isEnabled()&&t.isVisible&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(0===this._particleSystems.length)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){const r=this._particleSystems.data[i];if(0===(t&&t.layerMask&r.layerMask))continue;const s=r.emitter;s.position&&e&&-1===e.indexOf(s)||this._scene._activeParticles.addCount(r.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||0===this._spriteManagers.length)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const i=this._spriteManagers.data[t];0!==(e&&e.layerMask&i.layerMask)&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}n._ZeroVector=s.Pq.Zero();class a{}class o{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(const e of this._scene.meshes)if(e.subMeshes)for(const t of e.subMeshes)t._wasDispatched=!1;if(this._scene.spriteManagers)for(const e of this._scene.spriteManagers)e._wasDispatched=!1;for(const e of this._scene.particleSystems)e._wasDispatched=!1}constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new a,this._maintainStateBetweenFrames=!1,this._scene=e;for(let e=o.MIN_RENDERINGGROUPS;e<o.MAX_RENDERINGGROUPS;e++)this._autoClearDepthStencil[e]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){const t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,i,r){const s=this._renderingGroupInfo;if(s.scene=this._scene,s.camera=this._scene.activeCamera,s.renderingManager=this,this._scene.spriteManagers&&r)for(let e=0;e<this._scene.spriteManagers.length;e++){const t=this._scene.spriteManagers[e];this.dispatchSprites(t)}for(let n=o.MIN_RENDERINGGROUPS;n<o.MAX_RENDERINGGROUPS;n++){this._depthStencilBufferAlreadyCleaned=n===o.MIN_RENDERINGGROUPS;const a=this._renderingGroups[n];if(!a||a._empty)continue;const h=1<<n;if(s.renderingGroupId=n,this._scene.onBeforeRenderingGroupObservable.notifyObservers(s,h),o.AUTOCLEAR){const e=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(n):this._autoClearDepthStencil[n];e&&e.autoClear&&this._clearDepthStencilBuffer(e.depth,e.stencil)}for(const e of this._scene._beforeRenderingGroupDrawStage)e.action(n);a.render(e,r,i,t);for(const e of this._scene._afterRenderingGroupDrawStage)e.action(n);this._scene.onAfterRenderingGroupObservable.notifyObservers(s,h)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=o.MIN_RENDERINGGROUPS;e<o.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=o.MIN_RENDERINGGROUPS;e<o.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=o.MIN_RENDERINGGROUPS;e<o.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){void 0===this._renderingGroups[e]&&(this._renderingGroups[e]=new n(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,i){void 0===t&&(t=e.getMesh()),this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,i))}setRenderingOrder(e,t=null,i=null,r=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=r,this._renderingGroups[e]){const t=this._renderingGroups[e];t.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],t.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],t.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,i=!0,r=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:r}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}o.MAX_RENDERINGGROUPS=4,o.MIN_RENDERINGGROUPS=0,o.AUTOCLEAR=!0},3327:(e,t,i)=>{i.d(t,{O:()=>l,Q:()=>c});var r,s=i(4037);i(8733),i(6041),i(5559),i(2572),i(4867),function(e){e[e.CW=0]="CW",e[e.CCW=1]="CCW"}(r||(r={})),i(4100),i(521),i(4494);const n=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],a=[()=>1,e=>e.y,e=>e.z,e=>e.x,e=>e.x*e.y,e=>e.y*e.z,e=>3*e.z*e.z-1,e=>e.x*e.z,e=>e.x*e.x-e.y*e.y],o=(e,t)=>n[e]*a[e](t),h=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class l{constructor(){this.preScaled=!1,this.l00=s.Pq.Zero(),this.l1_1=s.Pq.Zero(),this.l10=s.Pq.Zero(),this.l11=s.Pq.Zero(),this.l2_2=s.Pq.Zero(),this.l2_1=s.Pq.Zero(),this.l20=s.Pq.Zero(),this.l21=s.Pq.Zero(),this.l22=s.Pq.Zero()}addLight(e,t,i){s.AA.Vector3[0].set(t.r,t.g,t.b);const r=s.AA.Vector3[0],n=s.AA.Vector3[1];r.scaleToRef(i,n),n.scaleToRef(o(0,e),s.AA.Vector3[2]),this.l00.addInPlace(s.AA.Vector3[2]),n.scaleToRef(o(1,e),s.AA.Vector3[2]),this.l1_1.addInPlace(s.AA.Vector3[2]),n.scaleToRef(o(2,e),s.AA.Vector3[2]),this.l10.addInPlace(s.AA.Vector3[2]),n.scaleToRef(o(3,e),s.AA.Vector3[2]),this.l11.addInPlace(s.AA.Vector3[2]),n.scaleToRef(o(4,e),s.AA.Vector3[2]),this.l2_2.addInPlace(s.AA.Vector3[2]),n.scaleToRef(o(5,e),s.AA.Vector3[2]),this.l2_1.addInPlace(s.AA.Vector3[2]),n.scaleToRef(o(6,e),s.AA.Vector3[2]),this.l20.addInPlace(s.AA.Vector3[2]),n.scaleToRef(o(7,e),s.AA.Vector3[2]),this.l21.addInPlace(s.AA.Vector3[2]),n.scaleToRef(o(8,e),s.AA.Vector3[2]),this.l22.addInPlace(s.AA.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(h[0]),this.l1_1.scaleInPlace(h[1]),this.l10.scaleInPlace(h[2]),this.l11.scaleInPlace(h[3]),this.l2_2.scaleInPlace(h[4]),this.l2_1.scaleInPlace(h[5]),this.l20.scaleInPlace(h[6]),this.l21.scaleInPlace(h[7]),this.l22.scaleInPlace(h[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(n[0]),this.l1_1.scaleInPlace(n[1]),this.l10.scaleInPlace(n[2]),this.l11.scaleInPlace(n[3]),this.l2_2.scaleInPlace(n[4]),this.l2_1.scaleInPlace(n[5]),this.l20.scaleInPlace(n[6]),this.l21.scaleInPlace(n[7]),this.l22.scaleInPlace(n[8])}updateFromArray(e){return s.Pq.FromArrayToRef(e[0],0,this.l00),s.Pq.FromArrayToRef(e[1],0,this.l1_1),s.Pq.FromArrayToRef(e[2],0,this.l10),s.Pq.FromArrayToRef(e[3],0,this.l11),s.Pq.FromArrayToRef(e[4],0,this.l2_2),s.Pq.FromArrayToRef(e[5],0,this.l2_1),s.Pq.FromArrayToRef(e[6],0,this.l20),s.Pq.FromArrayToRef(e[7],0,this.l21),s.Pq.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return s.Pq.FromFloatsToRef(e[0],e[1],e[2],this.l00),s.Pq.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),s.Pq.FromFloatsToRef(e[6],e[7],e[8],this.l10),s.Pq.FromFloatsToRef(e[9],e[10],e[11],this.l11),s.Pq.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),s.Pq.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),s.Pq.FromFloatsToRef(e[18],e[19],e[20],this.l20),s.Pq.FromFloatsToRef(e[21],e[22],e[23],this.l21),s.Pq.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return(new l).updateFromArray(e)}static FromPolynomial(e){const t=new l;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}}class c{constructor(){this.x=s.Pq.Zero(),this.y=s.Pq.Zero(),this.z=s.Pq.Zero(),this.xx=s.Pq.Zero(),this.yy=s.Pq.Zero(),this.zz=s.Pq.Zero(),this.xy=s.Pq.Zero(),this.yz=s.Pq.Zero(),this.zx=s.Pq.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=l.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){s.AA.Vector3[0].copyFromFloats(e.r,e.g,e.b);const t=s.AA.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),s.AA.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),s.AA.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(s.AA.Vector3[0]).addInPlace(s.AA.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(s.AA.Vector3[0]).subtractInPlace(s.AA.Vector3[1]),this.zz.copyFrom(e.l00),s.AA.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(s.AA.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return(new c).updateFromHarmonics(e)}static FromArray(e){const t=new c;return s.Pq.FromArrayToRef(e[0],0,t.x),s.Pq.FromArrayToRef(e[1],0,t.y),s.Pq.FromArrayToRef(e[2],0,t.z),s.Pq.FromArrayToRef(e[3],0,t.xx),s.Pq.FromArrayToRef(e[4],0,t.yy),s.Pq.FromArrayToRef(e[5],0,t.zz),s.Pq.FromArrayToRef(e[6],0,t.yz),s.Pq.FromArrayToRef(e[7],0,t.zx),s.Pq.FromArrayToRef(e[8],0,t.xy),t}}},3951:(e,t,i)=>{i.d(t,{Z:()=>ae});var r=i(350),s=i(6237),n=i(9848),a=i(7931);class o{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach(((e,t)=>this.add(e,t)))}get(e){const t=this._data[e];if(void 0!==t)return t}getOrAddWithFactory(e,t){let i=this.get(e);return void 0!==i||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){const i=this.get(e);return void 0!==i?i:(this.add(e,t),t)}contains(e){return void 0!==this._data[e]}add(e,t){return void 0===this._data[e]&&(this._data[e]=t,++this._count,!0)}set(e,t){return void 0!==this._data[e]&&(this._data[e]=t,!0)}getAndRemove(e){const t=this.get(e);return void 0!==t?(delete this._data[e],--this._count,t):null}remove(e){return!!this.contains(e)&&(delete this._data[e],--this._count,!0)}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(const t in this._data)e(t,this._data[t])}first(e){for(const t in this._data){const i=e(t,this._data[t]);if(i)return i}return null}}var h=i(7503),l=i(4037),c=i(5524),u=i(9259),_=i(6041),d=i(6877);function f(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}class p{constructor(){this._dirty=!0,this._tempColor=new _.ov(0,0,0,0),this._globalCurve=new _.ov(0,0,0,0),this._highlightsCurve=new _.ov(0,0,0,0),this._midtonesCurve=new _.ov(0,0,0,0),this._shadowsCurve=new _.ov(0,0,0,0),this._positiveCurve=new _.ov(0,0,0,0),this._negativeCurve=new _.ov(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",r="vCameraColorCurveNeutral",s="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(r,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(s,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}_getColorGradingDataToRef(e,t,i,r,s){null!=e&&(e=p._Clamp(e,0,360),t=p._Clamp(t,-100,100),i=p._Clamp(i,-100,100),r=p._Clamp(r,-100,100),t=p._ApplyColorGradingSliderNonlinear(t),t*=.5,r=p._ApplyColorGradingSliderNonlinear(r),t<0&&(t*=-1,e=(e+180)%360),p._FromHSBToRef(e,t,50+.25*r,s),s.scaleToRef(2,s),s.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,r){let s=p._Clamp(e,0,360);const n=p._Clamp(t/100,0,1),a=p._Clamp(i/100,0,1);if(0===n)r.r=a,r.g=a,r.b=a;else{s/=60;const e=Math.floor(s),t=s-e,i=a*(1-n),o=a*(1-n*t),h=a*(1-n*(1-t));switch(e){case 0:r.r=a,r.g=h,r.b=i;break;case 1:r.r=o,r.g=a,r.b=i;break;case 2:r.r=i,r.g=a,r.b=h;break;case 3:r.r=i,r.g=o,r.b=a;break;case 4:r.r=h,r.g=i,r.b=a;break;default:r.r=a,r.g=i,r.b=o}}r.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return d.p.Clone((()=>new p),this)}serialize(){return d.p.Serialize(this)}static Parse(e){return d.p.Parse((()=>new p),e,null,null)}}p.PrepareUniforms=f,(0,c.Cg)([(0,u.lK)()],p.prototype,"_globalHue",void 0),(0,c.Cg)([(0,u.lK)()],p.prototype,"_globalDensity",void 0),(0,c.Cg)([(0,u.lK)()],p.prototype,"_globalSaturation",void 0),(0,c.Cg)([(0,u.lK)()],p.prototype,"_globalExposure",void 0),(0,c.Cg)([(0,u.lK)()],p.prototype,"_highlightsHue",void 0),(0,c.Cg)([(0,u.lK)()],p.prototype,"_highlightsDensity",void 0),(0,c.Cg)([(0,u.lK)()],p.prototype,"_highlightsSaturation",void 0),(0,c.Cg)([(0,u.lK)()],p.prototype,"_highlightsExposure",void 0),(0,c.Cg)([(0,u.lK)()],p.prototype,"_midtonesHue",void 0),(0,c.Cg)([(0,u.lK)()],p.prototype,"_midtonesDensity",void 0),(0,c.Cg)([(0,u.lK)()],p.prototype,"_midtonesSaturation",void 0),(0,c.Cg)([(0,u.lK)()],p.prototype,"_midtonesExposure",void 0),d.p._ColorCurvesParser=p.Parse;var g=i(1597),m=i(6552);class T{constructor(){this.colorCurves=new p,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=T.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new _.ov(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=T.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.outputTextureWidth=0,this.outputTextureHeight=0,this.onUpdateParameters=new n.cP}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled)return e.VIGNETTE=!1,e.TONEMAPPING=0,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,void(e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled);if(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===T._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,this._toneMappingEnabled)switch(this._toneMappingType){case T.TONEMAPPING_KHR_PBR_NEUTRAL:e.TONEMAPPING=3;break;case T.TONEMAPPING_ACES:e.TONEMAPPING=2;break;default:e.TONEMAPPING=1}else e.TONEMAPPING=0;e.CONTRAST=1!==this.contrast,e.EXPOSURE=1!==this.exposure,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||!!e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&p.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const i=1/(this.outputTextureWidth||e.getEngine().getRenderWidth()),r=1/(this.outputTextureHeight||e.getEngine().getRenderHeight());if(e.setFloat2("vInverseScreenSize",i,r),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const s=null!=t?t:r/i;let n=Math.tan(.5*this.vignetteCameraFov),a=n*s;const o=Math.sqrt(a*n);a=(0,g.zF)(a,o,this.vignetteStretch),n=(0,g.zF)(n,o,this.vignetteStretch),e.setFloat4("vignetteSettings1",a,n,-a*this.vignetteCenterX,-n*this.vignetteCenterY);const h=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,h)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const t=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(t-1)/t,.5/t,t,this.colorGradingTexture.level)}}clone(){return d.p.Clone((()=>new T),this)}serialize(){return d.p.Serialize(this)}static Parse(e){const t=d.p.Parse((()=>new T),e,null,null);return void 0!==e.vignetteCentreX&&(t.vignetteCenterX=e.vignetteCentreX),void 0!==e.vignetteCentreY&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}T.TONEMAPPING_STANDARD=0,T.TONEMAPPING_ACES=1,T.TONEMAPPING_KHR_PBR_NEUTRAL=2,T.PrepareUniforms=function(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),(t.VIGNETTE||t.DITHER)&&e.push("vInverseScreenSize"),t.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&f(e),t.DITHER&&e.push("ditherIntensity")},T.PrepareSamplers=function(e,t){t.COLORGRADING&&e.push("txColorTransform")},T._VIGNETTEMODE_MULTIPLY=0,T._VIGNETTEMODE_OPAQUE=1,(0,c.Cg)([(0,u.wL)()],T.prototype,"colorCurves",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"_colorCurvesEnabled",void 0),(0,c.Cg)([(0,u.uM)("colorGradingTexture")],T.prototype,"_colorGradingTexture",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"_colorGradingEnabled",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"_colorGradingWithGreenDepth",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"_colorGradingBGR",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"_exposure",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"_toneMappingEnabled",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"_toneMappingType",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"_contrast",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"vignetteStretch",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"vignetteCenterX",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"vignetteCenterY",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"vignetteWeight",void 0),(0,c.Cg)([(0,u.qK)()],T.prototype,"vignetteColor",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"vignetteCameraFov",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"_vignetteBlendMode",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"_vignetteEnabled",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"_ditheringEnabled",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"_ditheringIntensity",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"_skipFinalColorClamp",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"_applyByPostProcess",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"_isEnabled",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"outputTextureWidth",void 0),(0,c.Cg)([(0,u.lK)()],T.prototype,"outputTextureHeight",void 0),d.p._ImageProcessingConfigurationParser=T.Parse,(0,m.Y5)("BABYLON.ImageProcessingConfiguration",T);var R=i(1137);class y{constructor(e,t,i,r,s=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||s,this._dynamic=i,this._name=r??"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return void 0!==this._dynamic}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(t=e<=2?e:4,this._uniformLocationPointer%t!==0){const e=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const i=this._uniformLocationPointer-e;for(let e=0;e<i;e++)this._data.push(0)}}addUniform(e,t,i=0){if(this._noUBO)return;if(void 0!==this._uniformLocations[e])return;let r;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},16==t?t*=i:t=t*i+(4-t)*i,r=[];for(let e=0;e<t;e++)r.push(0)}else{if(t instanceof Array)r=t,t=r.length;else{r=[];for(let e=0;e<t;e++)r.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let e=0;e<t;e++)this._data.push(r[e]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.asArray()))}addFloat2(e,t,i){const r=[t,i];this.addUniform(e,r)}addFloat3(e,t,i,r){const s=[t,i,r];this.addUniform(e,s)}addColor3(e,t){const i=[t.r,t.g,t.b];this.addUniform(e,i)}addColor4(e,t,i){const r=[t.r,t.g,t.b,i];this.addUniform(e,r)}addVector3(e,t){const i=[t.x,t.y,t.z];this.addUniform(e,i)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_getNames(){const e=[];let t=0;for(const i in this._uniformLocations)if(e.push(i),10===++t)break;return e.join(",")}_rebuild(){!this._noUBO&&this._bufferData&&(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()):this._buffer=this._engine.createUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}_rebuildAfterContextLost(){this._engine._features.trackUbosInFrame&&(this._buffers=[],this._currentFrameId=0),this._rebuild()}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO)if(this.bindUniformBuffer(),this._buffer)if(this._dynamic||this._needSync){if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1]){if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1]))return this._needSync=!1,void(this._createBufferOnWrite=this._engine._features.trackUbosInFrame);this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1])}this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(y._UpdatedUbosInFrame[this._name]||(y._UpdatedUbosInFrame[this._name]=0),y._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}else this._createBufferOnWrite=this._engine._features.trackUbosInFrame;else this.create()}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=0!==this._bufferIndex,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let r=this._uniformLocations[e];if(void 0===r){if(this._buffer)return void R.V.Error("Cannot add an uniform after UBO has been created. uniformName="+e);this.addUniform(e,i),r=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let e=0;e<i;e++)this._bufferData[r+e]=t[e];else{let e=!1;for(let s=0;s<i;s++)(16===i&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[r+s]!==Math.fround(t[s]))&&(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+s]=t[s]);this._needSync=this._needSync||e}}updateUniformArray(e,t,i){this._checkNewFrame();const s=this._uniformLocations[e];if(void 0===s)return void R.V.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");this._buffer||this.create();const n=this._uniformArraySizes[e];if(this._dynamic)for(let e=0;e<i;e++)this._bufferData[s+e]=t[e];else{let e=!1,a=0,o=0;for(let h=0;h<i;h++)if(this._bufferData[s+4*o+a]!==r.S0.FloatRound(t[h])&&(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+4*o+a]=t[h]),a++,a===n.strideSize){for(;a<4;a++)this._bufferData[s+4*o+a]=0;a=0,o++}this._needSync=this._needSync||e}}_cacheMatrix(e,t){this._checkNewFrame();const i=this._valueCache[e],r=t.updateFlag;return(void 0===i||i!==r)&&(this._valueCache[e]=r,!0)}_updateMatrix3x3ForUniform(e,t){for(let e=0;e<3;e++)y._TempBuffer[4*e]=t[3*e],y._TempBuffer[4*e+1]=t[3*e+1],y._TempBuffer[4*e+2]=t[3*e+2],y._TempBuffer[4*e+3]=0;this.updateUniform(e,y._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let e=0;e<2;e++)y._TempBuffer[4*e]=t[2*e],y._TempBuffer[4*e+1]=t[2*e+1],y._TempBuffer[4*e+2]=0,y._TempBuffer[4*e+3]=0;this.updateUniform(e,y._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){y._TempBuffer[0]=t,this.updateUniform(e,y._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,r=""){this._currentEffect.setFloat2(e+r,t,i)}_updateFloat2ForUniform(e,t,i){y._TempBuffer[0]=t,y._TempBuffer[1]=i,this.updateUniform(e,y._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,r,s=""){this._currentEffect.setFloat3(e+s,t,i,r)}_updateFloat3ForUniform(e,t,i,r){y._TempBuffer[0]=t,y._TempBuffer[1]=i,y._TempBuffer[2]=r,this.updateUniform(e,y._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,r,s,n=""){this._currentEffect.setFloat4(e+n,t,i,r,s)}_updateFloat4ForUniform(e,t,i,r,s){y._TempBuffer[0]=t,y._TempBuffer[1]=i,y._TempBuffer[2]=r,y._TempBuffer[3]=s,this.updateUniform(e,y._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){y._TempBufferInt32View.set(t),this.updateUniformArray(e,y._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){y._TempBufferUInt32View.set(t),this.updateUniformArray(e,y._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.asArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){y._TempBuffer[0]=t.x,y._TempBuffer[1]=t.y,y._TempBuffer[2]=t.z,this.updateUniform(e,y._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){y._TempBuffer[0]=t.x,y._TempBuffer[1]=t.y,y._TempBuffer[2]=t.z,y._TempBuffer[3]=t.w,this.updateUniform(e,y._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){y._TempBuffer[0]=t.r,y._TempBuffer[1]=t.g,y._TempBuffer[2]=t.b,this.updateUniform(e,y._TempBuffer,3)}_updateColor4ForEffect(e,t,i,r=""){this._currentEffect.setColor4(e+r,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){y._TempBuffer[0]=t.r,y._TempBuffer[1]=t.g,y._TempBuffer[2]=t.b,y._TempBuffer[3]=i,this.updateUniform(e,y._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){y._TempBuffer[0]=t.r,y._TempBuffer[1]=t.g,y._TempBuffer[2]=t.b,y._TempBuffer[3]=t.a,this.updateUniform(e,y._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){y._TempBufferInt32View[0]=t,this.updateUniform(e,y._TempBuffer,1)}_updateInt2ForEffect(e,t,i,r=""){this._currentEffect.setInt2(e+r,t,i)}_updateInt2ForUniform(e,t,i){y._TempBufferInt32View[0]=t,y._TempBufferInt32View[1]=i,this.updateUniform(e,y._TempBuffer,2)}_updateInt3ForEffect(e,t,i,r,s=""){this._currentEffect.setInt3(e+s,t,i,r)}_updateInt3ForUniform(e,t,i,r){y._TempBufferInt32View[0]=t,y._TempBufferInt32View[1]=i,y._TempBufferInt32View[2]=r,this.updateUniform(e,y._TempBuffer,3)}_updateInt4ForEffect(e,t,i,r,s,n=""){this._currentEffect.setInt4(e+n,t,i,r,s)}_updateInt4ForUniform(e,t,i,r,s){y._TempBufferInt32View[0]=t,y._TempBufferInt32View[1]=i,y._TempBufferInt32View[2]=r,y._TempBufferInt32View[3]=s,this.updateUniform(e,y._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){y._TempBufferUInt32View[0]=t,this.updateUniform(e,y._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,r=""){this._currentEffect.setUInt2(e+r,t,i)}_updateUInt2ForUniform(e,t,i){y._TempBufferUInt32View[0]=t,y._TempBufferUInt32View[1]=i,this.updateUniform(e,y._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,r,s=""){this._currentEffect.setUInt3(e+s,t,i,r)}_updateUInt3ForUniform(e,t,i,r){y._TempBufferUInt32View[0]=t,y._TempBufferUInt32View[1]=i,y._TempBufferUInt32View[2]=r,this.updateUniform(e,y._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,r,s,n=""){this._currentEffect.setUInt4(e+n,t,i,r,s)}_updateUInt4ForUniform(e,t,i,r,s){y._TempBufferUInt32View[0]=t,y._TempBufferUInt32View[1]=i,y._TempBufferUInt32View[2]=r,y._TempBufferUInt32View[3]=s,this.updateUniform(e,y._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}setTextureArray(e,t){this._currentEffect.setTextureArray(e,t)}bindTexture(e,t){this._currentEffect._bindTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,this._buffers[t][1]&&this._bufferData.set(this._buffers[t][1]),this._valueCache={},this._currentFrameId=this._engine.frameId,!0;return!1}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(-1!==t&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let e=0;e<this._buffers.length;++e){const t=this._buffers[e][0];this._engine._releaseBuffer(t)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}y._UpdatedUbosInFrame={},y._MAX_UNIFORM_SIZE=256,y._TempBuffer=new Float32Array(y._MAX_UNIFORM_SIZE),y._TempBufferInt32View=new Int32Array(y._TempBuffer.buffer),y._TempBufferUInt32View=new Uint32Array(y._TempBuffer.buffer);var b=i(4700);class E{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(b.R.NormalKind))return null;let i,r=this.pickedMesh.getIndices();0===r?.length&&(r=null);const s=l.AA.Vector3[0],n=l.AA.Vector3[1],a=l.AA.Vector3[2];if(t){const e=this.pickedMesh.getVerticesData(b.R.NormalKind);let t=r?l.Pq.FromArrayToRef(e,3*r[3*this.faceId],s):s.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),o=r?l.Pq.FromArrayToRef(e,3*r[3*this.faceId+1],n):n.copyFromFloats(e[3*(3*this.faceId+1)],e[3*(3*this.faceId+1)+1],e[3*(3*this.faceId+1)+2]),h=r?l.Pq.FromArrayToRef(e,3*r[3*this.faceId+2],a):a.copyFromFloats(e[3*(3*this.faceId+2)],e[3*(3*this.faceId+2)+1],e[3*(3*this.faceId+2)+2]);t=t.scale(this.bu),o=o.scale(this.bv),h=h.scale(1-this.bu-this.bv),i=new l.Pq(t.x+o.x+h.x,t.y+o.y+h.y,t.z+o.z+h.z)}else{const e=this.pickedMesh.getVerticesData(b.R.PositionKind),t=r?l.Pq.FromArrayToRef(e,3*r[3*this.faceId],s):s.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),o=r?l.Pq.FromArrayToRef(e,3*r[3*this.faceId+1],n):n.copyFromFloats(e[3*(3*this.faceId+1)],e[3*(3*this.faceId+1)+1],e[3*(3*this.faceId+1)+2]),h=r?l.Pq.FromArrayToRef(e,3*r[3*this.faceId+2],a):a.copyFromFloats(e[3*(3*this.faceId+2)],e[3*(3*this.faceId+2)+1],e[3*(3*this.faceId+2)+2]),c=t.subtract(o),u=h.subtract(o);i=l.Pq.Cross(c,u)}const o=(e,t)=>{if(-1!==this.thinInstanceIndex){const i=e.thinInstanceGetWorldMatrices()[this.thinInstanceIndex];i&&l.Pq.TransformNormalToRef(t,i,t)}let i=e.getWorldMatrix();e.nonUniformScaling&&(l.AA.Matrix[0].copyFrom(i),i=l.AA.Matrix[0],i.setTranslationFromFloats(0,0,0),i.invert(),i.transposeToRef(l.AA.Matrix[1]),i=l.AA.Matrix[1]),l.Pq.TransformNormalToRef(t,i,t)};if(e&&o(this.pickedMesh,i),this.ray){const t=l.AA.Vector3[0].copyFrom(i);e||o(this.pickedMesh,t),l.Pq.Dot(t,this.ray.direction)>0&&i.negateInPlace()}return i.normalize(),i}getTextureCoordinates(e=b.R.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;const t=this.pickedMesh.getIndices();if(!t)return null;const i=this.pickedMesh.getVerticesData(e);if(!i)return null;let r=l.I9.FromArray(i,2*t[3*this.faceId]),s=l.I9.FromArray(i,2*t[3*this.faceId+1]),n=l.I9.FromArray(i,2*t[3*this.faceId+2]);return r=r.scale(this.bu),s=s.scale(this.bv),n=n.scale(1-this.bu-this.bv),new l.I9(r.x+s.x+n.x,r.y+s.y+n.y)}}class x{constructor(e,t,i,r,s,n){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=r,this.sourceEvent=s,this.additionalData=n}static CreateNew(e,t,i){const r=e.getScene();return new x(e,r.pointerX,r.pointerY,r.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,r){return new x(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,r)}static CreateNewFromScene(e,t){return new x(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,r){return new x(e,t.x,t.y,null,i,r)}}var v=i(6096),C=i(3099);class A{}A.NAME_EFFECTLAYER="EffectLayer",A.NAME_LAYER="Layer",A.NAME_LENSFLARESYSTEM="LensFlareSystem",A.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",A.NAME_PARTICLESYSTEM="ParticleSystem",A.NAME_GAMEPAD="Gamepad",A.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",A.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",A.NAME_PREPASSRENDERER="PrePassRenderer",A.NAME_DEPTHRENDERER="DepthRenderer",A.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",A.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",A.NAME_SPRITE="Sprite",A.NAME_SUBSURFACE="SubSurface",A.NAME_OUTLINERENDERER="Outline",A.NAME_PROCEDURALTEXTURE="ProceduralTexture",A.NAME_SHADOWGENERATOR="ShadowGenerator",A.NAME_OCTREE="Octree",A.NAME_PHYSICSENGINE="PhysicsEngine",A.NAME_AUDIO="Audio",A.NAME_FLUIDRENDERER="FluidRenderer",A.NAME_IBLCDFGENERATOR="iblCDFGenerator",A.STEP_ISREADYFORMESH_EFFECTLAYER=0,A.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,A.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,A.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,A.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,A.STEP_BEFORECAMERADRAW_PREPASS=0,A.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,A.STEP_BEFORECAMERADRAW_LAYER=2,A.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,A.STEP_BEFORERENDERTARGETDRAW_LAYER=1,A.STEP_BEFORERENDERINGMESH_PREPASS=0,A.STEP_BEFORERENDERINGMESH_OUTLINE=1,A.STEP_AFTERRENDERINGMESH_PREPASS=0,A.STEP_AFTERRENDERINGMESH_OUTLINE=1,A.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,A.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,A.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,A.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,A.STEP_BEFORECLEAR_PREPASS=1,A.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,A.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,A.STEP_AFTERRENDERTARGETDRAW_LAYER=1,A.STEP_AFTERCAMERADRAW_PREPASS=0,A.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,A.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,A.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,A.STEP_AFTERCAMERADRAW_LAYER=4,A.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,A.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,A.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,A.STEP_AFTERRENDER_AUDIO=0,A.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,A.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,A.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,A.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,A.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,A.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,A.STEP_POINTERMOVE_SPRITE=0,A.STEP_POINTERDOWN_SPRITE=0,A.STEP_POINTERUP_SPRITE=0;class P extends Array{constructor(e){super(...e)}static Create(){return Object.create(P.prototype)}registerStep(e,t,i){let r=0,s=Number.MAX_VALUE;for(;r<this.length&&(s=this[r].index,!(e<s));r++);this.splice(r,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}var M=i(8790),S=i(6315),F=i(5503),I=i(6240);class w{constructor(){this.hoverCursor="",this.actions=[],this.isRecursive=!1,this.disposeWhenUnowned=!0}static get HasTriggers(){for(const e in w.Triggers)if(Object.prototype.hasOwnProperty.call(w.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(const e in w.Triggers)if(Object.prototype.hasOwnProperty.call(w.Triggers,e)){const t=parseInt(e);if(t>=1&&t<=7)return!0}return!1}static HasSpecificTrigger(e){for(const t in w.Triggers)if(Object.prototype.hasOwnProperty.call(w.Triggers,t)&&parseInt(t)===e)return!0;return!1}}w.Triggers={};var D,O,B,U,L,N,k,G=i(4146);!function(e){e[e.Generic=0]="Generic",e[e.Keyboard=1]="Keyboard",e[e.Mouse=2]="Mouse",e[e.Touch=3]="Touch",e[e.DualShock=4]="DualShock",e[e.Xbox=5]="Xbox",e[e.Switch=6]="Switch",e[e.DualSense=7]="DualSense"}(D||(D={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.Move=12]="Move"}(O||(O={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.DeltaHorizontal=10]="DeltaHorizontal",e[e.DeltaVertical=11]="DeltaVertical"}(B||(B={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(U||(U={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Create=8]="Create",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(L||(L={})),function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.LT=6]="LT",e[e.RT=7]="RT",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.LStickXAxis=17]="LStickXAxis",e[e.LStickYAxis=18]="LStickYAxis",e[e.RStickXAxis=19]="RStickXAxis",e[e.RStickYAxis=20]="RStickYAxis"}(N||(N={})),function(e){e[e.B=0]="B",e[e.A=1]="A",e[e.Y=2]="Y",e[e.X=3]="X",e[e.L=4]="L",e[e.R=5]="R",e[e.ZL=6]="ZL",e[e.ZR=7]="ZR",e[e.Minus=8]="Minus",e[e.Plus=9]="Plus",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.Capture=17]="Capture",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(k||(k={}));var V=i(8123);class z{static CreateDeviceEvent(e,t,i,r,s,n,a){switch(e){case D.Keyboard:return this._CreateKeyboardEvent(i,r,s,n);case D.Mouse:if(i===O.MouseWheelX||i===O.MouseWheelY||i===O.MouseWheelZ)return this._CreateWheelEvent(e,t,i,r,s,n);case D.Touch:return this._CreatePointerEvent(e,t,i,r,s,n,a);default:throw`Unable to generate event for device ${D[e]}`}}static _CreatePointerEvent(e,t,i,r,s,n,a){const o=this._CreateMouseEvent(e,t,i,r,s,n);e===D.Mouse?(o.deviceType=D.Mouse,o.pointerId=1,o.pointerType="mouse"):(o.deviceType=D.Touch,o.pointerId=a??t,o.pointerType="touch");let h=0;return h+=s.pollInput(e,t,O.LeftClick),h+=2*s.pollInput(e,t,O.RightClick),h+=4*s.pollInput(e,t,O.MiddleClick),o.buttons=h,i===O.Move?o.type="pointermove":i>=O.LeftClick&&i<=O.RightClick&&(o.type=1===r?"pointerdown":"pointerup",o.button=i-2),o}static _CreateWheelEvent(e,t,i,r,s,n){const a=this._CreateMouseEvent(e,t,i,r,s,n);switch(a.pointerId=1,a.type="wheel",a.deltaMode=V.s.DOM_DELTA_PIXEL,a.deltaX=0,a.deltaY=0,a.deltaZ=0,i){case O.MouseWheelX:a.deltaX=r;break;case O.MouseWheelY:a.deltaY=r;break;case O.MouseWheelZ:a.deltaZ=r}return a}static _CreateMouseEvent(e,t,i,r,s,n){const a=this._CreateEvent(n),o=s.pollInput(e,t,O.Horizontal),h=s.pollInput(e,t,O.Vertical);return n?(a.movementX=0,a.movementY=0,a.offsetX=a.movementX-n.getBoundingClientRect().x,a.offsetY=a.movementY-n.getBoundingClientRect().y):(a.movementX=s.pollInput(e,t,10),a.movementY=s.pollInput(e,t,11),a.offsetX=0,a.offsetY=0),this._CheckNonCharacterKeys(a,s),a.clientX=o,a.clientY=h,a.x=o,a.y=h,a.deviceType=e,a.deviceSlot=t,a.inputIndex=i,a}static _CreateKeyboardEvent(e,t,i,r){const s=this._CreateEvent(r);return this._CheckNonCharacterKeys(s,i),s.deviceType=D.Keyboard,s.deviceSlot=0,s.inputIndex=e,s.type=1===t?"keydown":"keyup",s.key=String.fromCharCode(e),s.keyCode=e,s}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(D.Keyboard),r=i&&1===t.pollInput(D.Keyboard,0,18),s=i&&1===t.pollInput(D.Keyboard,0,17),n=i&&(1===t.pollInput(D.Keyboard,0,91)||1===t.pollInput(D.Keyboard,0,92)||1===t.pollInput(D.Keyboard,0,93)),a=i&&1===t.pollInput(D.Keyboard,0,16);e.altKey=r,e.ctrlKey=s,e.metaKey=n,e.shiftKey=a}static _CreateEvent(e){const t={preventDefault:()=>{}};return t.target=e,t}}class X{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,((e,t,r,s)=>{const n=z.CreateDeviceEvent(e,t,r,s,this);i(e,t,n)})):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===D.Mouse||e===D.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}const H=Object.keys(O).length/2;class q{constructor(e,t,i,s){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=r.S0.IsSafari(),this._usingMacOs=(0,M.XD)()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=e=>{},this._keyboardUpEvent=e=>{},this._keyboardBlurEvent=e=>{},this._pointerMoveEvent=e=>{},this._pointerDownEvent=e=>{},this._pointerUpEvent=e=>{},this._pointerCancelEvent=e=>{},this._pointerCancelTouch=e=>{},this._pointerLeaveEvent=e=>{},this._pointerWheelEvent=e=>{},this._pointerBlurEvent=e=>{},this._pointerMacOsChromeOutEvent=e=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=(0,M.XD)()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Firefox"),this._isUsingChromium=(0,M.XD)()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Chrome"),this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=e=>{},this._gamepadDisconnectedEvent=e=>{},this._eventPrefix=r.S0.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=s,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOs&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){const s=this._inputs[e][t];if(!s)throw`Unable to find device ${D[e]}`;e>=D.DualShock&&e<=D.DualSense&&this._updateDevice(e,t,i);const n=s[i];if(void 0===n)throw`Unable to find input ${i} for device ${D[e]} in slot ${t}`;return i===O.Move&&r.S0.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),n}isDeviceAvailable(e){return void 0!==this._inputs[e]}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=this?._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs)for(const e of this._inputs)if(e)for(const t in e){const i=e[+t];if(i)for(let e=0;e<i.length;e++)i[e]=0}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=-1!==this._elementToAttachTo.tabIndex?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"leave",this._pointerLeaveEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),this._usingMacOs&&this._isUsingChromium&&this._elementToAttachTo.removeEventListener("lostpointercapture",this._pointerMacOsChromeOutEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}"function"==typeof matchMedia&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(D.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,r){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,H);const s=this._inputs[e][t];s[0]=i,s[1]=r}_registerDevice(e,t,i){if(void 0===t)throw`Unable to register device ${D[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const r=new Array(i);r.fill(0),this._inputs[e][t]=r,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(D.Keyboard,0,255));const t=this._inputs[D.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOs&&e.metaKey&&"Meta"!==e.key&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(D.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(D.Keyboard,0,255));const t=this._inputs[D.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOs&&"Meta"===e.key&&this._metaKeys.length>0){for(const e of this._metaKeys){const i=z.CreateDeviceEvent(D.Keyboard,0,e,0,this,this._elementToAttachTo);t[e]=0,this._onInputChanged(D.Keyboard,0,i)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(D.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[D.Keyboard][0];for(let t=0;t<e.length;t++)if(0!==e[t]){e[t]=0;const i=z.CreateDeviceEvent(D.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(D.Keyboard,0,i)}this._usingMacOs&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=(0,M.XD)()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let e=0;e<this._maxTouchPoints;e++)this._activeTouchIds[e]=-1;this._pointerMoveEvent=e=>{const t=this._getPointerType(e);let i=t===D.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(t===D.Touch&&-1===i){const s=this._activeTouchIds.indexOf(-1);if(!(s>=0))return void r.S0.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=s,this._activeTouchIds[s]=e.pointerId,this._onDeviceConnected(t,i)}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]||this._addPointerDevice(t,i,e.clientX,e.clientY);const s=this._inputs[t][i];if(s){const r=e;r.inputIndex=O.Move,s[O.Horizontal]=e.clientX,s[O.Vertical]=e.clientY,t===D.Touch&&0===s[O.LeftClick]&&(s[O.LeftClick]=1),void 0===e.pointerId&&(e.pointerId=this._mouseId),this._onInputChanged(t,i,r),this._usingSafari||-1===e.button||(r.inputIndex=e.button+2,s[e.button+2]=s[e.button+2]?0:1,this._onInputChanged(t,i,r))}},this._pointerDownEvent=e=>{const t=this._getPointerType(e);let i=t===D.Mouse?0:e.pointerId;if(t===D.Touch){let t=this._activeTouchIds.indexOf(e.pointerId);if(-1===t&&(t=this._activeTouchIds.indexOf(-1)),!(t>=0))return void r.S0.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=t,this._activeTouchIds[t]=e.pointerId}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]?t===D.Touch&&this._onDeviceConnected(t,i):this._addPointerDevice(t,i,e.clientX,e.clientY);const s=this._inputs[t][i];if(s){const r=s[O.Horizontal],n=s[O.Vertical];if(t===D.Mouse){if(void 0===e.pointerId&&(e.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch(e){}}else if(e.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(e.pointerId)}catch(e){}s[O.Horizontal]=e.clientX,s[O.Vertical]=e.clientY,s[e.button+2]=1;const a=e;a.inputIndex=e.button+2,this._onInputChanged(t,i,a),r===e.clientX&&n===e.clientY||(a.inputIndex=O.Move,this._onInputChanged(t,i,a))}},this._pointerUpEvent=e=>{const t=this._getPointerType(e),i=t===D.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(t===D.Touch){if(-1===i)return;this._activeTouchIds[i]=-1}const r=this._inputs[t]?.[i];let s=e.button,n=r&&0!==r[s+2];if(!n&&this._isUsingFirefox&&this._usingMacOs&&r&&(s=2===s?0:2,n=0!==r[s+2]),n){const n=r[O.Horizontal],a=r[O.Vertical];r[O.Horizontal]=e.clientX,r[O.Vertical]=e.clientY,r[s+2]=0;const o=e;void 0===e.pointerId&&(e.pointerId=this._mouseId),n===e.clientX&&a===e.clientY||(o.inputIndex=O.Move,this._onInputChanged(t,i,o)),o.inputIndex=s+2,t===D.Mouse&&this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)?this._elementToAttachTo.releasePointerCapture(this._mouseId):e.pointerId&&this._elementToAttachTo.hasPointerCapture?.(e.pointerId)&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._onInputChanged(t,i,o),t===D.Touch&&this._onDeviceDisconnected(t,i)}},this._pointerCancelTouch=e=>{const t=this._activeTouchIds.indexOf(e);if(-1===t)return;this._elementToAttachTo.hasPointerCapture?.(e)&&this._elementToAttachTo.releasePointerCapture(e),this._inputs[D.Touch][t][O.LeftClick]=0;const i=z.CreateDeviceEvent(D.Touch,t,O.LeftClick,0,this,this._elementToAttachTo,e);this._onInputChanged(D.Touch,t,i),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(D.Touch,t)},this._pointerCancelEvent=e=>{if("mouse"===e.pointerType){const e=this._inputs[D.Mouse][0];this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=O.LeftClick;t<=O.BrowserForward;t++)if(1===e[t]){e[t]=0;const i=z.CreateDeviceEvent(D.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(D.Mouse,0,i)}}else this._pointerCancelTouch(e.pointerId)},this._pointerLeaveEvent=e=>{"pen"===e.pointerType&&this._pointerCancelTouch(e.pointerId)},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch(e){}this._pointerBlurEvent=()=>{if(this.isDeviceAvailable(D.Mouse)){const e=this._inputs[D.Mouse][0];this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=O.LeftClick;t<=O.BrowserForward;t++)if(1===e[t]){e[t]=0;const i=z.CreateDeviceEvent(D.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(D.Mouse,0,i)}}if(this.isDeviceAvailable(D.Touch)){const e=this._inputs[D.Touch];for(let t=0;t<this._activeTouchIds.length;t++){const i=this._activeTouchIds[t];if(this._elementToAttachTo.hasPointerCapture?.(i)&&this._elementToAttachTo.releasePointerCapture(i),-1!==i&&1===e[t]?.[O.LeftClick]){e[t][O.LeftClick]=0;const r=z.CreateDeviceEvent(D.Touch,t,O.LeftClick,0,this,this._elementToAttachTo,i);this._onInputChanged(D.Touch,t,r),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(D.Touch,t)}}}},this._pointerWheelEvent=e=>{const t=D.Mouse;this._inputs[t]||(this._inputs[t]=[]),this._inputs[t][0]||(this._pointerActive=!0,this._registerDevice(t,0,H));const i=this._inputs[t][0];if(i){i[O.MouseWheelX]=e.deltaX||0,i[O.MouseWheelY]=e.deltaY||e.wheelDelta||0,i[O.MouseWheelZ]=e.deltaZ||0;const r=e;void 0===e.pointerId&&(e.pointerId=this._mouseId),0!==i[O.MouseWheelX]&&(r.inputIndex=O.MouseWheelX,this._onInputChanged(t,0,r)),0!==i[O.MouseWheelY]&&(r.inputIndex=O.MouseWheelY,this._onInputChanged(t,0,r)),0!==i[O.MouseWheelZ]&&(r.inputIndex=O.MouseWheelZ,this._onInputChanged(t,0,r))}},this._usingMacOs&&this._isUsingChromium&&(this._pointerMacOsChromeOutEvent=e=>{e.buttons>1&&this._pointerCancelEvent(e)},this._elementToAttachTo.addEventListener("lostpointercapture",this._pointerMacOsChromeOutEvent)),this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"leave",this._pointerLeaveEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,!!e&&{passive:!1}),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add((()=>{if(this.isDeviceAvailable(D.Mouse)){const e=this._inputs[D.Mouse][0];e[O.MouseWheelX]=0,e[O.MouseWheelY]=0,e[O.MouseWheelZ]=0}}))}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){const r=navigator.getGamepads()[t];if(r&&e===this._gamepads[t]){const s=this._inputs[e][t];i>=r.buttons.length?s[i]=r.axes[i-r.buttons.length].valueOf():s[i]=r.buttons[i].value}}_getGamepadDeviceType(e){return-1!==e.indexOf("054c")?-1!==e.indexOf("0ce6")?D.DualSense:D.DualShock:-1!==e.indexOf("Xbox One")||-1!==e.search("Xbox 360")||-1!==e.search("xinput")?D.Xbox:-1!==e.indexOf("057e")?D.Switch:D.Generic}_getPointerType(e){let t=D.Mouse;return("touch"===e.pointerType||"pen"===e.pointerType||e.touches)&&(t=D.Touch),t}}class W{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new n.cP,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}class K{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=e=>{for(let t=0;t<this._devices.length;t++){const i=this._devices[t];for(const r in i){const i=+r;e._addDevice(new W(this._deviceInputSystem,t,i))}}this._registeredManagers.push(e)},this.unregisterManager=e=>{const t=this._registeredManagers.indexOf(e);t>-1&&this._registeredManagers.splice(t,1)};const t=Object.keys(D).length/2;this._devices=new Array(t);const i=(e,t)=>{this._devices[e]||(this._devices[e]=new Array),this._devices[e][t]||(this._devices[e][t]=t);for(const i of this._registeredManagers){const r=new W(this._deviceInputSystem,e,t);i._addDevice(r)}},r=(e,t)=>{this._devices[e]?.[t]&&delete this._devices[e][t];for(const i of this._registeredManagers)i._removeDevice(e,t)},s=(e,t,i)=>{if(i)for(const r of this._registeredManagers)r._onInputChanged(e,t,i)};"undefined"!=typeof _native?this._deviceInputSystem=new X(i,r,s):this._deviceInputSystem=new q(e,i,r,s)}dispose(){this._deviceInputSystem.dispose()}}class Y{getDeviceSource(e,t){if(void 0===t){if(void 0===this._firstDevice[e])return null;t=this._firstDevice[e]}return this._devices[e]&&void 0!==this._devices[e][t]?this._devices[e][t]:null}getDeviceSources(e){return this._devices[e]?this._devices[e].filter((e=>!!e)):[]}constructor(e){const t=Object.keys(D).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new K(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new n.cP((e=>{for(const t of this._devices)if(t)for(const i of t)i&&this.onDeviceConnectedObservable.notifyObserver(e,i)})),this.onDeviceDisconnectedObservable=new n.cP,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add((()=>{this.dispose()}))}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=[]),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){const i=this._devices[e]?.[t];this.onDeviceDisconnectedObservable.notifyObservers(i),this._devices[e]?.[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){this._devices[e]?.[t]?.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case D.Keyboard:case D.Mouse:this._firstDevice[e]=0;break;case D.Touch:case D.DualSense:case D.DualShock:case D.Xbox:case D.Switch:case D.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t)for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}break}}}}class j{}j._IsPickingAvailable=!1;class Z{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}}class Q{constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._activePointerIds=new Array,this._activePointerIdsCount=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new l.I9(0,0),this._previousStartingPointerPosition=new l.I9(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=e||S.q.LastCreatedScene,this._scene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new l.I9(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){const t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,t){const i=this._scene,r=i.getEngine(),s=r.getInputElement();s&&(s.tabIndex=r.canvasTabIndex,i.doNotHandleCursors||(s.style.cursor=i.defaultCursor)),this._setCursorAndPointerOverMesh(e,t,i);for(const r of i._pointerMoveStage){e=e||this._pickMove(t);const i=!!e?.pickedMesh;e=r.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,i,s)}const n=t.inputIndex>=O.MouseWheelX&&t.inputIndex<=O.MouseWheelZ?I.Zp.POINTERWHEEL:I.Zp.POINTERMOVE;let a;i.onPointerMove&&(e=e||this._pickMove(t),i.onPointerMove(t,e,n)),e?(a=new I.mx(n,t,e),this._setRayOnPointerInfo(e,t)):(a=new I.mx(n,t,null,this),this._movePointerInfo=a),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(a,n)}_setRayOnPointerInfo(e,t){const i=this._scene;e&&j._IsPickingAvailable&&(e.ray||(e.ray=i.createPickingRay(t.offsetX,t.offsetY,l.uq.Identity(),i.activeCamera)))}_addCameraPointerObserver(e,t){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,t)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,t,i){const r=this._scene,s=new I.tT(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(s.originalPickingInfo=e,s.ray=e.ray,"xr-near"===t.pointerType&&e.originMesh&&(s.nearInteractionPickingInfo=e)),r.onPrePointerObservable.notifyObservers(s,i),!!s.skipOnPointerObservable}_pickMove(e){const t=this._scene,i=t.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,t.pointerMovePredicate,t.pointerMoveFastCheck,t.cameraToUseForPointers,t.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(i,e,t),i}_setCursorAndPointerOverMesh(e,t,i){const r=i.getEngine().getInputElement();if(e?.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,t.pointerId,e,t),!i.doNotHandleCursors&&r&&this._pointerOverMesh){const e=this._pointerOverMesh._getActionManagerForTrigger();e&&e.hasPointerTriggers&&(r.style.cursor=e.hoverCursor||i.hoverCursor)}}else this.setPointerOverMesh(null,t.pointerId,e,t)}simulatePointerMove(e,t){const i=new PointerEvent("pointermove",t);i.inputIndex=O.Move,this._checkPrePointerObservable(e,i,I.Zp.POINTERMOVE)||this._processPointerMove(e,i)}simulatePointerDown(e,t){const i=new PointerEvent("pointerdown",t);i.inputIndex=i.button+2,this._checkPrePointerObservable(e,i,I.Zp.POINTERDOWN)||this._processPointerDown(e,i)}_processPointerDown(e,t){const i=this._scene;if(e?.pickedMesh){this._pickedDownMesh=e.pickedMesh;const r=e.pickedMesh._getActionManagerForTrigger();if(r){if(r.hasPickTriggers)switch(r.processTrigger(5,new x(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e)),t.button){case 0:r.processTrigger(2,new x(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e));break;case 1:r.processTrigger(4,new x(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e));break;case 2:r.processTrigger(3,new x(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e))}r.hasSpecificTrigger(8)&&window.setTimeout((()=>{const e=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,(e=>e.isPickable&&e.isVisible&&e.isReady()&&e.actionManager&&e.actionManager.hasSpecificTrigger(8)&&e===this._pickedDownMesh),!1,i.cameraToUseForPointers);e?.pickedMesh&&r&&0!==this._activePointerIdsCount&&Date.now()-this._startingPointerTime>Q.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,r.processTrigger(8,x.CreateNew(e.pickedMesh,t)))}),Q.LongPressDelay)}}else for(const r of i._pointerDownStage)e=r.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,!1);let r;const s=I.Zp.POINTERDOWN;e?(i.onPointerDown&&i.onPointerDown(t,e,s),r=new I.mx(s,t,e),this._setRayOnPointerInfo(e,t)):r=new I.mx(s,t,null,this),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(r,s)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,t,i){const r=new PointerEvent("pointerup",t);r.inputIndex=O.Move;const s=new Z;i?s.doubleClick=!0:s.singleClick=!0,this._checkPrePointerObservable(e,r,I.Zp.POINTERUP)||this._processPointerUp(e,r,s)}_processPointerUp(e,t,i){const r=this._scene;if(e?.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(r.onPointerPick&&r.onPointerPick(t,e),i.singleClick&&!i.ignore&&r.onPointerObservable.observers.length>this._cameraObserverCount)){const i=I.Zp.POINTERPICK,s=new I.mx(i,t,e);this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(s,i)}const s=e.pickedMesh._getActionManagerForTrigger();if(s&&!i.ignore){s.processTrigger(7,x.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&s.processTrigger(1,x.CreateNew(e.pickedMesh,t,e));const r=e.pickedMesh._getActionManagerForTrigger(6);i.doubleClick&&r&&r.processTrigger(6,x.CreateNew(e.pickedMesh,t,e))}}else if(!i.ignore)for(const s of r._pointerUpStage)e=s.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,i.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const e=this._pickedDownMesh._getActionManagerForTrigger(16);e&&e.processTrigger(16,x.CreateNew(this._pickedDownMesh,t))}if(!i.ignore){const s=new I.mx(I.Zp.POINTERUP,t,e);if(this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(s,I.Zp.POINTERUP),r.onPointerUp&&r.onPointerUp(t,e,I.Zp.POINTERUP),!i.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let s=0;if(i.singleClick?s=I.Zp.POINTERTAP:i.doubleClick&&(s=I.Zp.POINTERDOUBLETAP),s){const i=new I.mx(s,t,e);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(s)&&r.onPointerObservable.notifyObservers(i,s)}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=!0,t=!0,i=!0,r=null){const s=this._scene,n=s.getEngine();r||(r=n.getInputElement()),this._alreadyAttached&&this.detachControl(),r&&(this._alreadyAttachedTo=r),this._deviceSourceManager=new Y(n),this._initActionManager=e=>{if(!this._meshPickProceed){const t=s.skipPointerUpPicking||0===s._registeredActions&&!this._checkForPicking()&&!s.onPointerUp?null:s.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,s.pointerUpPredicate,s.pointerUpFastCheck,s.cameraToUseForPointers,s.pointerUpTrianglePredicate);this._currentPickResult=t,t&&(e=t.hit&&t.pickedMesh?t.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return e},this._delayedSimpleClick=(e,t,i)=>{if((Date.now()-this._previousStartingPointerTime>Q.DoubleClickDelay&&!this._doubleClickOccured||e!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,t.singleClick=!0,t.ignore=!1,this._delayedClicks[e])){const t=this._delayedClicks[e].evt,i=I.Zp.POINTERTAP,r=new I.mx(i,t,this._currentPickResult);s.onPointerObservable.hasObservers()&&s.onPointerObservable.hasSpecificMask(i)&&s.onPointerObservable.notifyObservers(r,i),this._delayedClicks[e]=null}},this._initClickEvent=(e,t,i,r)=>{const s=new Z;this._currentPickResult=null;let n=null,a=e.hasSpecificMask(I.Zp.POINTERPICK)||t.hasSpecificMask(I.Zp.POINTERPICK)||e.hasSpecificMask(I.Zp.POINTERTAP)||t.hasSpecificMask(I.Zp.POINTERTAP)||e.hasSpecificMask(I.Zp.POINTERDOUBLETAP)||t.hasSpecificMask(I.Zp.POINTERDOUBLETAP);!a&&w&&(n=this._initActionManager(n,s),n&&(a=n.hasPickTriggers));let o=!1;if(a=a&&!this._isMultiTouchGesture,a){const a=i.button;if(s.hasSwiped=this._isPointerSwiping(),!s.hasSwiped){let h=!Q.ExclusiveDoubleClickMode;if(h||(h=!e.hasSpecificMask(I.Zp.POINTERDOUBLETAP)&&!t.hasSpecificMask(I.Zp.POINTERDOUBLETAP),h&&!w.HasSpecificTrigger(6)&&(n=this._initActionManager(n,s),n&&(h=!n.hasSpecificTrigger(6)))),h)(Date.now()-this._previousStartingPointerTime>Q.DoubleClickDelay||a!==this._previousButtonPressed)&&(s.singleClick=!0,r(s,this._currentPickResult),o=!0);else{const e={evt:i,clickInfo:s,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,a,s,r),Q.DoubleClickDelay)};this._delayedClicks[a]=e}let l=e.hasSpecificMask(I.Zp.POINTERDOUBLETAP)||t.hasSpecificMask(I.Zp.POINTERDOUBLETAP);!l&&w.HasSpecificTrigger(6)&&(n=this._initActionManager(n,s),n&&(l=n.hasSpecificTrigger(6))),l&&(a===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<Q.DoubleClickDelay&&!this._doubleClickOccured?(s.hasSwiped||this._isPointerSwiping()?(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=a,Q.ExclusiveDoubleClickMode?(this._delayedClicks[a]&&(clearTimeout(this._delayedClicks[a]?.timeoutId),this._delayedClicks[a]=null),r(s,this._previousPickResult)):r(s,this._currentPickResult)):(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,s.doubleClick=!0,s.ignore=!1,Q.ExclusiveDoubleClickMode&&this._delayedClicks[a]&&(clearTimeout(this._delayedClicks[a]?.timeoutId),this._delayedClicks[a]=null),r(s,this._currentPickResult)),o=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=a))}}o||r(s,this._currentPickResult)},this._onPointerMove=e=>{if(this._updatePointerPosition(e),this._isSwiping||-1===this._swipeButtonPressed||(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>Q.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>Q.DragMovementThreshold),n.isPointerLock&&n._verifyPointerLock(),this._checkPrePointerObservable(null,e,e.inputIndex>=O.MouseWheelX&&e.inputIndex<=O.MouseWheelZ?I.Zp.POINTERWHEEL:I.Zp.POINTERMOVE))return;if(!s.cameraToUseForPointers&&!s.activeCamera)return;if(s.skipPointerMovePicking)return void this._processPointerMove(new E,e);s.pointerMovePredicate||(s.pointerMovePredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(e.enablePointerMoveEvents||s.constantlyUpdateMeshUnderPointer||null!==e._getActionManagerForTrigger())&&(!s.cameraToUseForPointers||0!==(s.cameraToUseForPointers.layerMask&e.layerMask)));const t=s._registeredActions>0||s.constantlyUpdateMeshUnderPointer?this._pickMove(e):null;this._processPointerMove(t,e)},this._onPointerDown=e=>{const t=this._activePointerIds.indexOf(-1);if(-1===t?this._activePointerIds.push(e.pointerId):this._activePointerIds[t]=e.pointerId,this._activePointerIdsCount++,this._pickedDownMesh=null,this._meshPickProceed=!1,Q.ExclusiveDoubleClickMode)for(let t=0;t<this._delayedClicks.length;t++)if(this._delayedClicks[t])if(e.button===t)clearTimeout(this._delayedClicks[t]?.timeoutId);else{const e=this._delayedClicks[t].clickInfo;this._doubleClickOccured=!1,e.singleClick=!0,e.ignore=!1;const i=this._delayedClicks[t].evt,r=I.Zp.POINTERTAP,n=new I.mx(r,i,this._currentPickResult);s.onPointerObservable.hasObservers()&&s.onPointerObservable.hasSpecificMask(r)&&s.onPointerObservable.notifyObservers(n,r),this._delayedClicks[t]=null}if(this._updatePointerPosition(e),-1===this._swipeButtonPressed&&(this._swipeButtonPressed=e.button),s.preventDefaultOnPointerDown&&r&&(e.preventDefault(),r.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,e,I.Zp.POINTERDOWN))return;if(!s.cameraToUseForPointers&&!s.activeCamera)return;let i;this._pointerCaptures[e.pointerId]=!0,s.pointerDownPredicate||(s.pointerDownPredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!s.cameraToUseForPointers||0!==(s.cameraToUseForPointers.layerMask&e.layerMask))),this._pickedDownMesh=null,i=s.skipPointerDownPicking||0===s._registeredActions&&!this._checkForPicking()&&!s.onPointerDown?new E:s.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,s.pointerDownPredicate,s.pointerDownFastCheck,s.cameraToUseForPointers,s.pointerDownTrianglePredicate),this._processPointerDown(i,e)},this._onPointerUp=e=>{const t=this._activePointerIds.indexOf(e.pointerId);-1!==t&&(this._activePointerIds[t]=-1,this._activePointerIdsCount--,this._pickedUpMesh=null,this._meshPickProceed=!1,this._updatePointerPosition(e),s.preventDefaultOnPointerUp&&r&&(e.preventDefault(),r.focus()),this._initClickEvent(s.onPrePointerObservable,s.onPointerObservable,e,((t,i)=>{if(s.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!t.ignore)){if(this._checkPrePointerObservable(null,e,I.Zp.POINTERUP))return this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1),void(0===e.buttons&&(this._pointerCaptures[e.pointerId]=!1));t.hasSwiped||(t.singleClick&&s.onPrePointerObservable.hasSpecificMask(I.Zp.POINTERTAP)&&this._checkPrePointerObservable(null,e,I.Zp.POINTERTAP)&&(this._skipPointerTap=!0),t.doubleClick&&s.onPrePointerObservable.hasSpecificMask(I.Zp.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,e,I.Zp.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}this._pointerCaptures[e.pointerId]?(0===e.buttons&&(this._pointerCaptures[e.pointerId]=!1),(s.cameraToUseForPointers||s.activeCamera)&&(s.pointerUpPredicate||(s.pointerUpPredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!s.cameraToUseForPointers||0!==(s.cameraToUseForPointers.layerMask&e.layerMask))),!this._meshPickProceed&&(w&&w.HasTriggers||this._checkForPicking()||s.onPointerUp)&&this._initActionManager(null,t),i||(i=this._currentPickResult),this._processPointerUp(i,e,t),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))):this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1)})))},this._onKeyDown=e=>{const t=G.TB.KEYDOWN;if(s.onPreKeyboardObservable.hasObservers()){const i=new G.Bu(t,e);if(s.onPreKeyboardObservable.notifyObservers(i,t),i.skipOnKeyboardObservable)return}if(s.onKeyboardObservable.hasObservers()){const i=new G.W0(t,e);s.onKeyboardObservable.notifyObservers(i,t)}s.actionManager&&s.actionManager.processTrigger(14,x.CreateNewFromScene(s,e))},this._onKeyUp=e=>{const t=G.TB.KEYUP;if(s.onPreKeyboardObservable.hasObservers()){const i=new G.Bu(t,e);if(s.onPreKeyboardObservable.notifyObservers(i,t),i.skipOnKeyboardObservable)return}if(s.onKeyboardObservable.hasObservers()){const i=new G.W0(t,e);s.onKeyboardObservable.notifyObservers(i,t)}s.actionManager&&s.actionManager.processTrigger(15,x.CreateNewFromScene(s,e))},this._deviceSourceManager.onDeviceConnectedObservable.add((r=>{r.deviceType===D.Mouse?r.onInputChangedObservable.add((s=>{this._originMouseEvent=s,s.inputIndex===O.LeftClick||s.inputIndex===O.MiddleClick||s.inputIndex===O.RightClick||s.inputIndex===O.BrowserBack||s.inputIndex===O.BrowserForward?t&&1===r.getInput(s.inputIndex)?this._onPointerDown(s):e&&0===r.getInput(s.inputIndex)&&this._onPointerUp(s):i&&(s.inputIndex===O.Move?this._onPointerMove(s):s.inputIndex!==O.MouseWheelX&&s.inputIndex!==O.MouseWheelY&&s.inputIndex!==O.MouseWheelZ||this._onPointerMove(s))})):r.deviceType===D.Touch?r.onInputChangedObservable.add((s=>{s.inputIndex===O.LeftClick&&(t&&1===r.getInput(s.inputIndex)?(this._onPointerDown(s),this._activePointerIdsCount>1&&(this._isMultiTouchGesture=!0)):e&&0===r.getInput(s.inputIndex)&&(this._onPointerUp(s),0===this._activePointerIdsCount&&(this._isMultiTouchGesture=!1))),i&&s.inputIndex===O.Move&&this._onPointerMove(s)})):r.deviceType===D.Keyboard&&r.onInputChangedObservable.add((e=>{"keydown"===e.type?this._onKeyDown(e):"keyup"===e.type&&this._onKeyUp(e)}))})),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,t=0,i,r){if(!(this._meshUnderPointerId[t]!==e||e&&e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const s=this._meshUnderPointerId[t];let n;s&&(n=s._getActionManagerForTrigger(10),n&&n.processTrigger(10,new x(s,this._pointerX,this._pointerY,e,r,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,n=e._getActionManagerForTrigger(9),n&&n.processTrigger(9,new x(e,this._pointerX,this._pointerY,e,r,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null),this._scene.onMeshUnderPointerUpdatedObservable.hasObservers()&&this._scene.onMeshUnderPointerUpdatedObservable.notifyObservers({mesh:e,pointerId:t})}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(const t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]}}Q.DragMovementThreshold=10,Q.LongPressDelay=500,Q.DoubleClickDelay=300,Q.ExclusiveDoubleClickMode=!1;var $=i(4296),J=i(2572);class ee{static get UniqueId(){const e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}ee._UniqueIdCounter=1;var te=i(9492);class ie{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}ie.FALLOFF_DEFAULT=0,ie.FALLOFF_PHYSICAL=1,ie.FALLOFF_GLTF=2,ie.FALLOFF_STANDARD=3,ie.LIGHTMAP_DEFAULT=0,ie.LIGHTMAP_SPECULAR=1,ie.LIGHTMAP_SHADOWSONLY=2,ie.INTENSITYMODE_AUTOMATIC=0,ie.INTENSITYMODE_LUMINOUSPOWER=1,ie.INTENSITYMODE_LUMINOUSINTENSITY=2,ie.INTENSITYMODE_ILLUMINANCE=3,ie.INTENSITYMODE_LUMINANCE=4,ie.LIGHTTYPEID_POINTLIGHT=0,ie.LIGHTTYPEID_DIRECTIONALLIGHT=1,ie.LIGHTTYPEID_SPOTLIGHT=2,ie.LIGHTTYPEID_HEMISPHERICLIGHT=3,ie.LIGHTTYPEID_RECT_AREALIGHT=4;var re,se=i(7309);class ne{constructor(){this.pointerDownFastCheck=!1,this.pointerUpFastCheck=!1,this.pointerMoveFastCheck=!1,this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1}}!function(e){e[e.BackwardCompatible=0]="BackwardCompatible",e[e.Intermediate=1]="Intermediate",e[e.Aggressive=2]="Aggressive"}(re||(re={}));class ae{static DefaultMaterialFactory(e){throw(0,F.n)("StandardMaterial")}static CollisionCoordinatorFactory(){throw(0,F.n)("DefaultCollisionCoordinator")}get clearColor(){return this._clearColor}set clearColor(e){e!==this._clearColor&&(this._clearColor=e,this.onClearColorChangedObservable.notifyObservers(this._clearColor))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case 0:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case 1:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case 2:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1}this.onScenePerformancePriorityChangedObservable.notifyObservers(e)}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.onEnvironmentTextureChangedObservable.notifyObservers(e),this.markAllMaterialsAsDirty(1))}getNodes(){let e=[];e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes);for(const t of this.skeletons)e=e.concat(t.bones);return e}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get pointerDownPredicate(){return this._pointerPickingConfiguration.pointerDownPredicate}set pointerDownPredicate(e){this._pointerPickingConfiguration.pointerDownPredicate=e}get pointerUpPredicate(){return this._pointerPickingConfiguration.pointerUpPredicate}set pointerUpPredicate(e){this._pointerPickingConfiguration.pointerUpPredicate=e}get pointerMovePredicate(){return this._pointerPickingConfiguration.pointerMovePredicate}set pointerMovePredicate(e){this._pointerPickingConfiguration.pointerMovePredicate=e}get pointerDownFastCheck(){return this._pointerPickingConfiguration.pointerDownFastCheck}set pointerDownFastCheck(e){this._pointerPickingConfiguration.pointerDownFastCheck=e}get pointerUpFastCheck(){return this._pointerPickingConfiguration.pointerUpFastCheck}set pointerUpFastCheck(e){this._pointerPickingConfiguration.pointerUpFastCheck=e}get pointerMoveFastCheck(){return this._pointerPickingConfiguration.pointerMoveFastCheck}set pointerMoveFastCheck(e){this._pointerPickingConfiguration.pointerMoveFastCheck=e}get skipPointerMovePicking(){return this._pointerPickingConfiguration.skipPointerMovePicking}set skipPointerMovePicking(e){this._pointerPickingConfiguration.skipPointerMovePicking=e}get skipPointerDownPicking(){return this._pointerPickingConfiguration.skipPointerDownPicking}set skipPointerDownPicking(e){this._pointerPickingConfiguration.skipPointerDownPicking=e}get skipPointerUpPicking(){return this._pointerPickingConfiguration.skipPointerUpPicking}set skipPointerUpPicking(e){this._pointerPickingConfiguration.skipPointerUpPicking=e}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return Q.DragMovementThreshold}static set DragMovementThreshold(e){Q.DragMovementThreshold=e}static get LongPressDelay(){return Q.LongPressDelay}static set LongPressDelay(e){Q.LongPressDelay=e}static get DoubleClickDelay(){return Q.DoubleClickDelay}static set DoubleClickDelay(e){Q.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return Q.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){Q.ExclusiveDoubleClickMode=e}bindEyePosition(e,t="vEyePosition",i=!1){const r=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:this.activeCamera?.globalPosition??l.Pq.ZeroReadOnly,s=this.useRightHandedSystem===(null!=this._mirroredCameraPosition);return l.AA.Vector4[0].set(r.x,r.y,r.z,s?-1:1),e&&(i?e.setFloat3(t,l.AA.Vector4[0].x,l.AA.Vector4[0].y,l.AA.Vector4[0].z):e.setVector4(t,l.AA.Vector4[0])),l.AA.Vector4[0]}finalizeSceneUbo(){const e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",t.x,t.y,t.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=(0,se.lL)(e,(()=>{this.onActiveCamerasChanged.notifyObservers(this)}))),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get _hasDefaultMaterial(){return ae.DefaultMaterialFactory!==ae._OriginalDefaultMaterialFactory}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=ae.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}get frameGraph(){return this._frameGraph}set frameGraph(e){if(this._frameGraph)return this._frameGraph=e,void(e||(this.customRenderFunction=this._currentCustomRenderFunction));this._frameGraph=e,e&&(this._currentCustomRenderFunction=this.customRenderFunction,this.customRenderFunction=this._renderWithFrameGraph)}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=ae.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);const t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(e){for(const t of this._components)if(t.name===e)return t;return null}constructor(e,t){this._inputManager=new Q(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this._clearColor=new _.ov(.2,.2,.3,1),this.onClearColorChangedObservable=new n.cP,this.ambientColor=new _.v9(0,0,0),this.environmentIntensity=1,this.iblIntensity=1,this._performancePriority=0,this.onScenePerformancePriorityChangedObservable=new n.cP,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.effectLayers=[],this.sounds=null,this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=[],this.onDisposeObservable=new n.cP,this._onDisposeObserver=null,this.onBeforeRenderObservable=new n.cP,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new n.cP,this.onAfterRenderCameraObservable=new n.cP,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new n.cP,this.onAfterAnimationsObservable=new n.cP,this.onBeforeDrawPhaseObservable=new n.cP,this.onAfterDrawPhaseObservable=new n.cP,this.onReadyObservable=new n.cP,this.onBeforeCameraRenderObservable=new n.cP,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new n.cP,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new n.cP,this.onAfterActiveMeshesEvaluationObservable=new n.cP,this.onBeforeParticlesRenderingObservable=new n.cP,this.onAfterParticlesRenderingObservable=new n.cP,this.onDataLoadedObservable=new n.cP,this.onNewCameraAddedObservable=new n.cP,this.onCameraRemovedObservable=new n.cP,this.onNewLightAddedObservable=new n.cP,this.onLightRemovedObservable=new n.cP,this.onNewGeometryAddedObservable=new n.cP,this.onGeometryRemovedObservable=new n.cP,this.onNewTransformNodeAddedObservable=new n.cP,this.onTransformNodeRemovedObservable=new n.cP,this.onNewMeshAddedObservable=new n.cP,this.onMeshRemovedObservable=new n.cP,this.onNewSkeletonAddedObservable=new n.cP,this.onSkeletonRemovedObservable=new n.cP,this.onNewMaterialAddedObservable=new n.cP,this.onNewMultiMaterialAddedObservable=new n.cP,this.onMaterialRemovedObservable=new n.cP,this.onMultiMaterialRemovedObservable=new n.cP,this.onNewTextureAddedObservable=new n.cP,this.onTextureRemovedObservable=new n.cP,this.onBeforeRenderTargetsRenderObservable=new n.cP,this.onAfterRenderTargetsRenderObservable=new n.cP,this.onBeforeStepObservable=new n.cP,this.onAfterStepObservable=new n.cP,this.onActiveCameraChanged=new n.cP,this.onActiveCamerasChanged=new n.cP,this.onBeforeRenderingGroupObservable=new n.cP,this.onAfterRenderingGroupObservable=new n.cP,this.onMeshImportedObservable=new n.cP,this.onAnimationFileImportedObservable=new n.cP,this.onEnvironmentTextureChangedObservable=new n.cP,this.onMeshUnderPointerUpdatedObservable=new n.cP,this._registeredForLateAnimationBindings=new a.b(256),this._pointerPickingConfiguration=new ne,this.onPrePointerObservable=new n.cP,this.onPointerObservable=new n.cP,this.onPreKeyboardObservable=new n.cP,this.onKeyboardObservable=new n.cP,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=ae.FOGMODE_NONE,this.fogColor=new _.v9(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this._frameGraph=null,this.frameGraphs=[],this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new l.Pq(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=[],this.importedMeshesFiles=[],this.probesEnabled=!0,this._meshesForIntersections=new a.b(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new $.A,this._activeIndices=new $.A,this._activeParticles=new $.A,this._activeBones=new $.A,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=[],this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new a.L(256),this._processedMaterials=new a.L(256),this._renderTargets=new a.b(256),this._materialsRenderTargets=new a.b(256),this._activeParticleSystems=new a.L(256),this._activeSkeletons=new a.b(32),this._softwareSkinnedMeshes=new a.b(32),this._activeAnimatables=new Array,this._transformMatrix=l.uq.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=P.Create(),this._beforeClearStage=P.Create(),this._beforeRenderTargetClearStage=P.Create(),this._gatherRenderTargetsStage=P.Create(),this._gatherActiveCameraRenderTargetsStage=P.Create(),this._isReadyForMeshStage=P.Create(),this._beforeEvaluateActiveMeshStage=P.Create(),this._evaluateSubMeshStage=P.Create(),this._preActiveMeshStage=P.Create(),this._cameraDrawRenderTargetStage=P.Create(),this._beforeCameraDrawStage=P.Create(),this._beforeRenderTargetDrawStage=P.Create(),this._beforeRenderingGroupDrawStage=P.Create(),this._beforeRenderingMeshStage=P.Create(),this._afterRenderingMeshStage=P.Create(),this._afterRenderingGroupDrawStage=P.Create(),this._afterCameraDrawStage=P.Create(),this._afterCameraPostProcessStage=P.Create(),this._afterRenderTargetDrawStage=P.Create(),this._afterRenderTargetPostProcessStage=P.Create(),this._afterRenderStage=P.Create(),this._pointerMoveStage=P.Create(),this._pointerDownStage=P.Create(),this._pointerUpStage=P.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._useCurrentFrameBuffer=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=[];const i={useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1,...t};e=this._engine=e||S.q.LastCreatedEngine,i.virtual?e._virtualScenes.push(this):(S.q._LastCreatedScene=this,e.scenes.push(this)),this._uid=null,this._renderingManager=new C.m(this),v.X&&(this.postProcessManager=new v.X(this)),(0,M.BA)()&&this.attachControl(),this._createUbo(),T&&(this._imageProcessingConfiguration=new T),this.setDefaultCandidateProviders(),i.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=i.useMaterialMeshMap,this.useClonedMeshMap=i.useClonedMeshMap,t&&t.virtual||e.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=()=>this._getDefaultMeshCandidates(),this.getActiveSubMeshCandidates=e=>this._getDefaultSubMeshCandidates(e),this.getIntersectingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e),this.getCollidingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,i=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return void 0!==this._animationRatio?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,i=!0){this._inputManager.attachControl(e,t,i)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){if(this._isDisposed)return!1;let t;const i=this.getEngine(),r=i.currentRenderPassId;i.currentRenderPassId=this.activeCamera?.renderPassId??r;let s=!0;for(this._pendingData.length>0&&(s=!1),this.prePassRenderer?.update(),this.useOrderIndependentTransparency&&this.depthPeelingRenderer&&s&&(s=this.depthPeelingRenderer.isReady()),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),t=0;t<this.meshes.length;t++){const r=this.meshes[t];if(!r.subMeshes||0===r.subMeshes.length)continue;if(!r.isReady(!0)){s=!1;continue}const n=r.hasThinInstances||"InstancedMesh"===r.getClassName()||"InstancedLinesMesh"===r.getClassName()||i.getCaps().instancedArrays&&r.instances.length>0;for(const e of this._isReadyForMeshStage)e.action(r,n)||(s=!1);if(!e)continue;const a=r.material||this.defaultMaterial;if(a)if(a._storeEffectOnSubMeshes)for(const e of r.subMeshes){const t=e.getMaterial();t&&t.hasRenderTargetTextures&&null!=t.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(t)&&(this._processedMaterials.push(t),this._materialsRenderTargets.concatWithNoDuplicate(t.getRenderTargetTextures()))}else a.hasRenderTargetTextures&&null!=a.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(a)&&(this._processedMaterials.push(a),this._materialsRenderTargets.concatWithNoDuplicate(a.getRenderTargetTextures()))}if(e)for(t=0;t<this._materialsRenderTargets.length;++t)this._materialsRenderTargets.data[t].isReadyForRendering()||(s=!1);for(t=0;t<this.geometries.length;t++)2===this.geometries[t].delayLoadState&&(s=!1);if(this.activeCameras&&this.activeCameras.length>0)for(const e of this.activeCameras)e.isReady(!0)||(s=!1);else this.activeCamera&&(this.activeCamera.isReady(!0)||(s=!1));for(const e of this.particleSystems)e.isReady()||(s=!1);if(this.layers)for(const e of this.layers)e.isReady()||(s=!1);if(this.effectLayers)for(const e of this.effectLayers)e.isLayerReady()||(s=!1);return i.areAllEffectsReady()||(s=!1),i.currentRenderPassId=r,s}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){const t=()=>{e(),setTimeout((()=>{this.unregisterBeforeRender(t)}))};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){void 0!==t?setTimeout((()=>{this._executeOnceBeforeRender(e)}),t):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){const t=this.isLoading,i=this._pendingData.indexOf(e);-1!==i&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.addOnce(e),null===this._executeWhenReadyTimeoutId&&this._checkIsReady(t)}async whenReadyAsync(e=!1){return await new Promise((t=>{this.executeWhenReady((()=>{t()}),e)}))}_checkIsReady(e=!1){return this._registerTransientComponents(),this.isReady(e)?(this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):this._isDisposed?(this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):void(this._executeWhenReadyTimeoutId=setTimeout((()=>{this.incrementRenderId(),this._checkIsReady(e)}),100))}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=s.j.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,i,r){i||r||!this._multiviewSceneUbo||(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag||(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?J.P.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=J.P.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,r):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e){const t=new y(this._engine,void 0,!1,e??"scene");return t.addUniform("viewProjection",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return ee.UniqueId}addMesh(e,t=!1){if(!this._blockEntityCollection&&(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),r.S0.SetImmediate((()=>{this.onNewMeshAddedObservable.notifyObservers(e)})),t)){const t=e.getChildMeshes();for(const e of t)this.addMesh(e)}}removeMesh(e,t=!1){const i=this.meshes.indexOf(e);if(-1!==i&&(this.meshes.splice(i,1),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t){const t=e.getChildMeshes();for(const e of t)this.removeMesh(e)}return i}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneTransformNodesArray||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){const t=e._indexInSceneTransformNodesArray;if(-1!==t){if(t!==this.transformNodes.length-1){const e=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=e,e._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){const t=this.skeletons.indexOf(e);return-1!==t&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){const t=this.morphTargetManagers.indexOf(e);return-1!==t&&this.morphTargetManagers.splice(t,1),t}removeLight(e){const t=this.lights.indexOf(e);if(-1!==t){for(const t of this.meshes)t._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){const t=this.cameras.indexOf(e);if(-1!==t&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){const t=this.activeCameras.indexOf(e);-1!==t&&this.activeCameras.splice(t,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){const t=this.particleSystems.indexOf(e);return-1!==t&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),t}removeAnimation(e){const t=this.animations.indexOf(e);return-1!==t&&this.animations.splice(t,1),t}stopAnimation(e,t,i){}removeAnimationGroup(e){const t=this.animationGroups.indexOf(e);return-1!==t&&this.animationGroups.splice(t,1),t}removeMultiMaterial(e){const t=this.multiMaterials.indexOf(e);return-1!==t&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){const t=e._indexInSceneMaterialArray;if(-1!==t&&t<this.materials.length){if(t!==this.materials.length-1){const e=this.materials[this.materials.length-1];this.materials[t]=e,e._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){const t=this.actionManagers.indexOf(e);return-1!==t&&this.actionManagers.splice(t,1),t}removeTexture(e){const t=this.textures.indexOf(e);return-1!==t&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(const t of this.meshes)-1===t.lightSources.indexOf(e)&&(t.lightSources.push(e),t._resyncLightSources());r.S0.SetImmediate((()=>{this.onNewLightAddedObservable.notifyObservers(e)}))}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(ie.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),r.S0.SetImmediate((()=>{this.onNewCameraAddedObservable.notifyObservers(e)})),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),r.S0.SetImmediate((()=>{this.onNewSkeletonAddedObservable.notifyObservers(e)})))}addParticleSystem(e){this._blockEntityCollection||this.particleSystems.push(e)}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||this.animationGroups.push(e)}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),r.S0.SetImmediate((()=>{this.onNewMultiMaterialAddedObservable.notifyObservers(e)})))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneMaterialArray||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),r.S0.SetImmediate((()=>{this.onNewMaterialAddedObservable.notifyObservers(e)})))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}switchActiveCamera(e,t=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){const t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){const t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let e=0;e<this.materials.length;e++){const i=this.materials[e];if(t(i))return i}if(e)for(let e=0;e<this.multiMaterials.length;e++){const i=this.multiMaterials[e];if(t(i))return i}return null}getMaterialByUniqueID(e,t=!1){return this.getMaterialByUniqueId(e,t)}getMaterialByUniqueId(e,t=!1){return this._getMaterial(t,(t=>t.uniqueId===e))}getMaterialById(e,t=!1){return this._getMaterial(t,(t=>t.id===e))}getMaterialByName(e,t=!1){return this._getMaterial(t,(t=>t.name===e))}getLastMaterialById(e,t=!1){for(let t=this.materials.length-1;t>=0;t--)if(this.materials[t].id===e)return this.materials[t];if(t)for(let t=this.multiMaterials.length-1;t>=0;t--)if(this.multiMaterials[t].id===e)return this.multiMaterials[t];return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let t=0;t<i.bones.length;t++)if(i.bones[t].id===e)return i.bones[t]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let t=0;t<i.bones.length;t++)if(i.bones[t].name===e)return i.bones[t]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){const t=this._geometriesByUniqueId[e];if(void 0!==t)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}getFrameGraphByName(e){for(let t=0;t<this.frameGraphs.length;t++)if(this.frameGraphs[t].name===e)return this.frameGraphs[t];return null}pushGeometry(e,t){return!(!t&&this._getGeometryByUniqueId(e.uniqueId)||(this.addGeometry(e),r.S0.SetImmediate((()=>{this.onNewGeometryAddedObservable.notifyObservers(e)})),0))}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(t=this._geometriesByUniqueId[e.uniqueId],void 0===t)return!1}else if(t=this.geometries.indexOf(e),t<0)return!1;if(t!==this.geometries.length-1){const e=this.geometries[this.geometries.length-1];e&&(this.geometries[t]=e,this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter((function(t){return t.id===e}))}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter((function(t){return t.id===e}))}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastTransformNodeById(e){for(let t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){const t=this.getMeshById(e);if(t)return t;const i=this.getTransformNodeById(e);if(i)return i;const r=this.getLightById(e);if(r)return r;const s=this.getCameraById(e);if(s)return s;return this.getBoneById(e)||null}getNodeByName(e){const t=this.getMeshByName(e);if(t)return t;const i=this.getTransformNodeByName(e);if(i)return i;const r=this.getLightByName(e);if(r)return r;const s=this.getCameraByName(e);if(s)return s;return this.getBoneByName(e)||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let t=0;t<i.numTargets;++t){const r=i.getTarget(t);if(r.id===e)return r}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let t=0;t<i.numTargets;++t){const r=i.getTarget(t);if(r.name===e)return r}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){const i=this.postProcesses[t];if(i.name===e)return i}return null}isActiveMesh(e){return-1!==this._activeMeshes.indexOf(e)}get uid(){return this._uid||(this._uid=r.S0.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new o),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new o),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,i,r){if(r||e.isInFrustum(this._frustumPlanes)){for(const i of this._evaluateSubMeshStage)i.action(t,e);const i=e.getMaterial();null!=i&&(i.hasRenderTargetTextures&&null!=i.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(i)&&(this._processedMaterials.push(i),this._materialsRenderTargets.concatWithNoDuplicate(i.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,i))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){const t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,i,r=!0,s=!1){return this.executeWhenReady((()=>{if(this.activeCamera){if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=s,this._skipEvaluateActiveMeshesCompletely=e,r)for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._freeze();t&&t()}else i&&i("No active camera found")})),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){(!this._engine.snapshotRendering||1!==this._engine.snapshotRenderingMode)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce((()=>e.dispose()))}_evaluateActiveMeshes(){if(this._engine.snapshotRendering&&1===this._engine.snapshotRenderingMode)return void(this._activeMeshes.length>0&&(this.activeCamera?._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset()));if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const e=this._activeMeshes.length;for(let t=0;t<e;t++)this._activeMeshes.data[t].computeWorldMatrix()}if(this._activeParticleSystems){const e=this._activeParticleSystems.length;for(let t=0;t<e;t++)this._activeParticleSystems.data[t].animate()}return void this._renderingManager.resetSprites()}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const e of this._beforeEvaluateActiveMeshStage)e.action();const e=this.getActiveMeshCandidates(),t=e.length;for(let i=0;i<t;i++){const t=e.data[i];let r=t._internalAbstractMeshDataInfo._currentLOD.get(this.activeCamera);if(r?r[1]=-1:(r=[t,-1],t._internalAbstractMeshDataInfo._currentLOD.set(this.activeCamera,r)),t.isBlocked)continue;if(this._totalVertices.addCount(t.getTotalVertices(),!1),!t.isReady()||!t.isEnabled()||t.scaling.hasAZeroComponent)continue;t.computeWorldMatrix(),t.actionManager&&t.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(t);let s=this.customLODSelector?this.customLODSelector(t,this.activeCamera):t.getLOD(this.activeCamera);if(r[0]=s,r[1]=this._frameId,null!=s&&(s!==t&&0!==s.billboardMode&&s.computeWorldMatrix(),t._preActivate(),t.isVisible&&t.visibility>0&&0!==(t.layerMask&this.activeCamera.layerMask)&&(this._skipFrustumClipping||t.alwaysSelectAsActiveMesh||t.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(t),this.activeCamera._activeMeshes.push(t),s!==t&&s._activate(this._renderId,!1);for(const e of this._preActiveMeshStage)e.action(t);t._activate(this._renderId,!1)&&(t.isAnInstance?t._internalAbstractMeshDataInfo._actAsRegularMesh&&(s=t):s._internalAbstractMeshDataInfo._onlyForInstances=!1,s._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(t,s)),t._postActivate()}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let e=0;e<this.particleSystems.length;e++){const t=this.particleSystems[e];if(!t.isStarted()||!t.emitter)continue;const i=t.emitter;i.position&&!i.isEnabled()||(this._activeParticleSystems.push(t),t.animate(),this._renderingManager.dispatchParticles(t))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_prepareSkeleton(e){this._skeletonsEnabled&&e.skeleton&&(this._activeSkeletons.pushNoDuplicate(e.skeleton)&&(e.skeleton.prepare(),this._activeBones.addCount(e.skeleton.bones.length,!1)),e.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(e)&&this.frameGraph&&e.applySkeleton(e.skeleton))}_activeMesh(e,t){this._prepareSkeleton(t);let i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){const r=this.getActiveSubMeshCandidates(t),s=r.length;i=i||1===s;for(let n=0;n<s;n++){const s=r.data[n];this._evaluateSubMesh(s,t,e,i)}}}updateTransformMatrix(e){const t=this.activeCamera;if(t)if(t._renderingMultiview){const i=t._rigCameras[0],r=t._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(e),r.getViewMatrix(),r.getProjectionMatrix(e))}else this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){this._useCurrentFrameBuffer||(e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer()),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(e&&e._multiviewTexture);else if(e&&e.outputRenderTarget&&!e._renderingMultiview){const t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):t.skipInitialClear||e.isRightCamera||(this.autoClear&&this._engine.clear(t.clearColor||this._clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,i=!0){if(e&&e._skipRendering)return;const s=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(s.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i){let t=!0;e._renderingMultiview&&e.outputRenderTarget&&(t=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=t)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let e=0;e<this._softwareSkinnedMeshes.length;e++){const t=this._softwareSkinnedMeshes.data[e];t.applySkeleton(t.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const e of this._gatherActiveCameraRenderTargetsStage)e.action(this._renderTargets);let n=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){r.S0.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let e=0;e<this._renderTargets.length;e++){const t=this._renderTargets.data[e];if(t._shouldRender()){this._renderId++;const e=t.activeCamera&&t.activeCamera!==this.activeCamera;t.render(e,this.dumpNextRenderTargets),n=!0}}r.S0.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(const e of this._cameraDrawRenderTargetStage)n=e.action(this.activeCamera)||n;this._intermediateRendering=!1}this._engine.currentRenderPassId=e.outputRenderTarget?.renderPassId??e.renderPassId??0,n&&!this.prePass&&(this._bindFrameBuffer(this._activeCamera,!1),this.updateTransformMatrix()),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),!this.postProcessManager||e._multiviewTexture||this.prePass||this.postProcessManager._prepareFrame();for(const e of this._beforeCameraDrawStage)e.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),s.snapshotRendering&&1===s.snapshotRenderingMode&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const e of this._afterCameraDrawStage)e.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){const t=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,t)}for(const e of this._afterCameraPostProcessStage)e.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(0===e.cameraRigMode||e._renderingMultiview)return e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),void this.onAfterRenderCameraObservable.notifyObservers(e);if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let t=0;t<e._rigCameras.length;t++)this._renderForCamera(e._rigCameras[t],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){const t=this._meshesForIntersections.data[e];if(t.actionManager)for(let e=0;t.actionManager&&e<t.actionManager.actions.length;e++){const i=t.actionManager.actions[e];if(12===i.trigger||13===i.trigger){const e=i.getTriggerParameter(),r=e.mesh?e.mesh:e,s=r.intersectsMesh(t,e.usePreciseIntersection),n=t._intersectionsInProgress.indexOf(r);s&&-1===n?12===i.trigger?(i._executeCurrent(x.CreateNew(t,void 0,r)),t._intersectionsInProgress.push(r)):13===i.trigger&&t._intersectionsInProgress.push(r):!s&&n>-1&&(13===i.trigger&&i._executeCurrent(x.CreateNew(t,void 0,r)),t.actionManager.hasSpecificTrigger(13,(e=>{const t=e.mesh?e.mesh:e;return r===t}))&&13!==i.trigger||t._intersectionsInProgress.splice(n,1))}}}}_advancePhysicsEngineStep(e){}_animate(e){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(ae.MinDeltaTime,Math.min(this._engine.getDeltaTime(),ae.MaxDeltaTime))+this._timeAccumulator;const t=this._engine.getTimeStep(),i=1e3/t/1e3;let r=0;const s=this._engine.getLockstepMaxSteps();let n=Math.floor(e/t);for(n=Math.min(n,s);e>0&&r<n;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*i,this._animate(t),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,r++,e-=t;this._timeAccumulator=e<0?0:e}else{const e=this.useConstantAnimationDeltaTime?16:Math.max(ae.MinDeltaTime,Math.min(this._engine.getDeltaTime(),ae.MaxDeltaTime));this._animationRatio=.06*e,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this._clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){if(e?.outputRenderTarget&&!e?.isRigCamera&&(e.outputRenderTarget._cleared=!1),e?.rigCameras?.length)for(let t=0;t<e.rigCameras.length;++t){const i=e.rigCameras[t].outputRenderTarget;i&&(i._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(const t of this.meshes)t.resetDrawCache(e)}_renderWithFrameGraph(e=!0,t=!1){if(this.activeCamera=null,this._activeParticleSystems.reset(),this._activeSkeletons.reset(),e)for(const e of this.cameras)if(e.update(),0!==e.cameraRigMode)for(let t=0;t<e._rigCameras.length;t++)e._rigCameras[t].update();for(const e of this._beforeClearStage)e.action();const i=this.getActiveMeshCandidates(),r=i.length;for(let e=0;e<r;e++){const t=i.data[e];t.isBlocked||(this._totalVertices.addCount(t.getTotalVertices(),!1),t.isReady()&&t.isEnabled()&&!t.scaling.hasAZeroComponent&&(t.computeWorldMatrix(),t.actionManager&&t.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(t)))}if(this.particlesEnabled)for(let e=0;e<this.particleSystems.length;e++){const t=this.particleSystems[e];if(!t.isStarted()||!t.emitter)continue;const i=t.emitter;i.position&&!i.isEnabled()||(this._activeParticleSystems.push(t),t.animate())}this.frameGraph?.execute()}_renderRenderTarget(e,t,i=!1,r=!1){if(this._intermediateRendering=!0,e._shouldRender()){if(this._renderId++,this.activeCamera=t,!this.activeCamera)throw new Error("Active camera not set");this._engine.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),e.render(i,r)}this._intermediateRendering=!1}render(e=!0,t=!1){if(!this.isDisposed){if(this.onReadyObservable.hasObservers()&&null===this._executeWhenReadyTimeoutId&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),this.activeCameras?.length)for(const e of this.activeCameras)this._checkCameraRenderTarget(e);this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate();for(const e of this._beforeCameraUpdateStage)e.action();if(e)if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];if(t.update(),0!==t.cameraRigMode)for(let e=0;e<t._rigCameras.length;e++)t._rigCameras[e].update()}else if(this.activeCamera&&(this.activeCamera.update(),0!==this.activeCamera.cameraRigMode))for(let e=0;e<this.activeCamera._rigCameras.length;e++)this.activeCamera._rigCameras[e].update();if(this.onBeforeRenderObservable.notifyObservers(this),this.customRenderFunction)this._renderId++,this._engine.currentRenderPassId=0,this.customRenderFunction(e,t);else{this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const e=this.activeCameras?.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){r.S0.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0);for(let t=0;t<this.customRenderTargets.length;t++){const i=this.customRenderTargets[t],r=i.activeCamera||this.activeCamera;this._renderRenderTarget(i,r,e!==r,this.dumpNextRenderTargets)}r.S0.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._renderId++}this._engine.currentRenderPassId=e?.renderPassId??0,this.activeCamera=e,this._activeCamera&&22!==this._activeCamera.cameraRigMode&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const e of this._beforeClearStage)e.action();this._clearFrameBuffer(this.activeCamera);for(const e of this._gatherRenderTargetsStage)e.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++)this._processSubCameras(this.activeCameras[e],e>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}}this._checkIntersections();for(const e of this._afterRenderStage)e.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let e=0;e<this._toBeDisposed.length;e++){const t=this._toBeDisposed[e];t&&t.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;if(this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=[],this._activeAnimatables&&this.stopAllAnimations){for(const e of this._activeAnimatables)e.onAnimationEndObservable.clear(),e.onAnimationEnd=null;this.stopAllAnimations()}this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const e=this._activeRequests.slice();for(const t of e)t.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(e){R.V.Error("An error occurred while calling onDisposeObservable!",e)}if(this.detachControl(),this._engine.getInputElement())for(let e=0;e<this.cameras.length;e++)this.cameras[e].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.meshes,(e=>e.dispose(!0))),this._disposeList(this.transformNodes,(e=>e.dispose(!0)));const t=this.cameras;this._disposeList(t),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let i=this._engine.scenes.indexOf(this);if(i>-1&&this._engine.scenes.splice(i,1),S.q._LastCreatedScene===this){S.q._LastCreatedScene=null;let e=S.q.Instances.length-1;for(;e>=0;){const t=S.q.Instances[e];if(t.scenes.length>0){S.q._LastCreatedScene=t.scenes[this._engine.scenes.length-1];break}e--}}i=this._engine._virtualScenes.indexOf(this),i>-1&&this._engine._virtualScenes.splice(i,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this.onClearColorChangedObservable.clear(),this.onEnvironmentTextureChangedObservable.clear(),this.onMeshUnderPointerUpdatedObservable.clear(),this._isDisposed=!0}_disposeList(e,t){const i=e.slice(0);t=t??(e=>e.dispose());for(const e of i)t(e);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e].geometry;t&&t.clearCachedData()}}cleanCachedTextureBuffer(){for(const e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){const t=new l.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new l.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);e=e||(()=>!0);const r=this.meshes.filter(e);for(const e of r){if(e.computeWorldMatrix(!0),!e.subMeshes||0===e.subMeshes.length||e.infiniteDistance)continue;const r=e.getBoundingInfo(),s=r.boundingBox.minimumWorld,n=r.boundingBox.maximumWorld;l.Pq.CheckExtends(s,t,i),l.Pq.CheckExtends(n,t,i)}return{min:t,max:i}}createPickingRay(e,t,i,r,s=!1){throw(0,F.n)("Ray")}createPickingRayToRef(e,t,i,r,s,n=!1,a=!1){throw(0,F.n)("Ray")}createPickingRayInCameraSpace(e,t,i){throw(0,F.n)("Ray")}createPickingRayInCameraSpaceToRef(e,t,i,r){throw(0,F.n)("Ray")}pick(e,t,i,r,s,n){const a=(0,F.n)("Ray",!0);return a&&R.V.Warn(a),new E}pickWithBoundingInfo(e,t,i,r,s){const n=(0,F.n)("Ray",!0);return n&&R.V.Warn(n),new E}pickWithRay(e,t,i,r){throw(0,F.n)("Ray")}multiPick(e,t,i,r,s){throw(0,F.n)("Ray")}multiPickWithRay(e,t,i){throw(0,F.n)("Ray")}setPointerOverMesh(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const e of this._components)e.rebuild();for(const e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(const e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(const e of this.textures)e._rebuild(!0);this.markAllMaterialsAsDirty(1)}_getByTags(e,t,i){if(void 0===t)return e;const r=[];for(const s in e){const n=e[s];h.Y&&h.Y.MatchesQuery(n,t)&&(!i||i(n))&&r.push(n)}return r}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,i=null,r=null){this._renderingManager.setRenderingOrder(e,t,i,r)}setRenderingAutoClearDepthStencil(e,t,i=!0,r=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,r)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}_forceBlockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism=e}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(127))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(const i of this.materials)t&&!t(i)||i.markAsDirty(e)}_loadFile(e,t,i,r,s,n,a){const o=(0,te.zU)(e,t,i,r?this.offlineProvider:void 0,s,n,a);return this._activeRequests.push(o),o.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)})),o}async _loadFileAsync(e,t,i,r,s){return await new Promise(((n,a)=>{this._loadFile(e,(e=>{n(e)}),t,i,r,((e,t)=>{a(t)}),s)}))}_requestFile(e,t,i,r,s,n,a){const o=(0,te.sh)(e,t,i,r?this.offlineProvider:void 0,s,n,a);return this._activeRequests.push(o),o.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)})),o}async _requestFileAsync(e,t,i,r,s){return await new Promise(((n,a)=>{this._requestFile(e,(e=>{n(e)}),t,i,r,(e=>{a(e)}),s)}))}_readFile(e,t,i,r,s){const n=(0,te.NJ)(e,t,i,r,s);return this._activeRequests.push(n),n.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)})),n}async _readFileAsync(e,t,i){return await new Promise(((r,s)=>{this._readFile(e,(e=>{r(e)}),t,i,(e=>{s(e)}))}))}getPerfCollector(){throw(0,F.n)("performanceViewerSceneExtension")}setActiveCameraByID(e){return this.setActiveCameraById(e)}getMaterialByID(e){return this.getMaterialById(e)}getLastMaterialByID(e){return this.getLastMaterialById(e)}getTextureByUniqueID(e){return this.getTextureByUniqueId(e)}getCameraByID(e){return this.getCameraById(e)}getCameraByUniqueID(e){return this.getCameraByUniqueId(e)}getBoneByID(e){return this.getBoneById(e)}getLightByID(e){return this.getLightById(e)}getLightByUniqueID(e){return this.getLightByUniqueId(e)}getParticleSystemByID(e){return this.getParticleSystemById(e)}getGeometryByID(e){return this.getGeometryById(e)}getMeshByID(e){return this.getMeshById(e)}getMeshByUniqueID(e){return this.getMeshByUniqueId(e)}getLastMeshByID(e){return this.getLastMeshById(e)}getMeshesByID(e){return this.getMeshesById(e)}getTransformNodeByID(e){return this.getTransformNodeById(e)}getTransformNodeByUniqueID(e){return this.getTransformNodeByUniqueId(e)}getTransformNodesByID(e){return this.getTransformNodesById(e)}getNodeByID(e){return this.getNodeById(e)}getLastEntryByID(e){return this.getLastEntryById(e)}getLastSkeletonByID(e){return this.getLastSkeletonById(e)}}ae.FOGMODE_NONE=0,ae.FOGMODE_EXP=1,ae.FOGMODE_EXP2=2,ae.FOGMODE_LINEAR=3,ae.MinDeltaTime=1,ae.MaxDeltaTime=1e3,ae._OriginalDefaultMaterialFactory=ae.DefaultMaterialFactory,(0,m.Y5)("BABYLON.Scene",ae)},4037:(e,t,i)=>{i.d(t,{uq:()=>p,PT:()=>f,AA:()=>m,I9:()=>u,Pq:()=>_});var r=i(5559),s=i(7309),n=i(6552),a=i(215),o=i(6315),h=i(4867);class l{}l._UpdateFlagSeed=0;const c=e=>parseInt(e.toString().replace(/\W/g,""));class u{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){let e=c(this.x);return e=397*e^c(this.y),e}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return u.FromArrayToRef(e,t,this),this}asArray(){return[this.x,this.y]}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}setAll(e){return this.copyFromFloats(e,e)}add(e){return new u(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addInPlaceFromFloats(e,t){return this.x+=e,this.y+=t,this}addVector3(e){return new u(this.x+e.x,this.y+e.y)}subtract(e){return new u(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new u(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new u(this.x*e,this.y*t)}divide(e){return new u(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.x,e.y)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.x,e.y)}minimizeInPlaceFromFloats(e,t){return this.x=Math.min(e,this.x),this.y=Math.min(t,this.y),this}maximizeInPlaceFromFloats(e,t){return this.x=Math.max(e,this.x),this.y=Math.max(t,this.y),this}subtractFromFloats(e,t){return new u(this.x-e,this.y-t)}subtractFromFloatsToRef(e,t,i){return i.x=this.x-e,i.y=this.y-t,i}negate(){return new u(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.x=-this.x,e.y=-this.y,e}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){return new u(this.x*e,this.y*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=r.bH){return e&&(0,h.Mj)(this.x,e.x,t)&&(0,h.Mj)(this.y,e.y,t)}equalsToFloats(e,t){return this.x===e&&this.y===t}floor(){return new u(Math.floor(this.x),Math.floor(this.y))}floorToRef(e){return e.x=Math.floor(this.x),e.y=Math.floor(this.y),e}fract(){return new u(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}fractToRef(e){return e.x=this.x-Math.floor(this.x),e.y=this.y-Math.floor(this.y),e}rotateToRef(e,t){const i=Math.cos(e),r=Math.sin(e),s=i*this.x-r*this.y,n=r*this.x+i*this.y;return t.x=s,t.y=n,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new u;return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t&&(e.x=this.x,e.y=this.y),this.scaleToRef(1/t,e)}clone(){return new u(this.x,this.y)}dot(e){return this.x*e.x+this.y*e.y}static Zero(){return new u(0,0)}static One(){return new u(1,1)}static Random(e=0,t=1){return new u((0,h.VD)(e,t),(0,h.VD)(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats((0,h.VD)(e,t),(0,h.VD)(e,t))}static get ZeroReadOnly(){return u._ZeroReadOnly}static FromArray(e,t=0){return new u(e[t],e[t+1])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i}static FromFloatsToRef(e,t,i){return i.copyFromFloats(e,t),i}static CatmullRom(e,t,i,r,s){const n=s*s,a=s*n,o=.5*(2*t.x+(-e.x+i.x)*s+(2*e.x-5*t.x+4*i.x-r.x)*n+(-e.x+3*t.x-3*i.x+r.x)*a),h=.5*(2*t.y+(-e.y+i.y)*s+(2*e.y-5*t.y+4*i.y-r.y)*n+(-e.y+3*t.y-3*i.y+r.y)*a);return new u(o,h)}static ClampToRef(e,t,i,r){return r.x=(0,h.OQ)(e.x,t.x,i.x),r.y=(0,h.OQ)(e.y,t.y,i.y),r}static Clamp(e,t,i){const r=(0,h.OQ)(e.x,t.x,i.x),s=(0,h.OQ)(e.y,t.y,i.y);return new u(r,s)}static Hermite(e,t,i,r,s){const n=s*s,a=s*n,o=2*a-3*n+1,h=-2*a+3*n,l=a-2*n+s,c=a-n,_=e.x*o+i.x*h+t.x*l+r.x*c,d=e.y*o+i.y*h+t.y*l+r.y*c;return new u(_,d)}static Hermite1stDerivative(e,t,i,r,s){return this.Hermite1stDerivativeToRef(e,t,i,r,s,new u)}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const a=s*s;return n.x=6*(a-s)*e.x+(3*a-4*s+1)*t.x+6*(-a+s)*i.x+(3*a-2*s)*r.x,n.y=6*(a-s)*e.y+(3*a-4*s+1)*t.y+6*(-a+s)*i.y+(3*a-2*s)*r.y,n}static Lerp(e,t,i){return u.LerpToRef(e,t,i,new u)}static LerpToRef(e,t,i,r){return r.x=e.x+(t.x-e.x)*i,r.y=e.y+(t.y-e.y)*i,r}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){return u.NormalizeToRef(e,new u)}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=e.x<t.x?e.x:t.x,r=e.y<t.y?e.y:t.y;return new u(i,r)}static Maximize(e,t){const i=e.x>t.x?e.x:t.x,r=e.y>t.y?e.y:t.y;return new u(i,r)}static Transform(e,t){return u.TransformToRef(e,t,new u)}static TransformToRef(e,t,i){const r=t.m,s=e.x*r[0]+e.y*r[4]+r[12],n=e.x*r[1]+e.y*r[5]+r[13];return i.x=s,i.y=n,i}static PointInTriangle(e,t,i,r){const s=.5*(-i.y*r.x+t.y*(-i.x+r.x)+t.x*(i.y-r.y)+i.x*r.y),n=s<0?-1:1,a=(t.y*r.x-t.x*r.y+(r.y-t.y)*e.x+(t.x-r.x)*e.y)*n,o=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*n;return a>0&&o>0&&a+o<2*s*n}static Distance(e,t){return Math.sqrt(u.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,r=e.y-t.y;return i*i+r*r}static Center(e,t){return u.CenterToRef(e,t,new u)}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,i){const r=u.DistanceSquared(t,i);if(0===r)return u.Distance(e,t);const s=i.subtract(t),n=Math.max(0,Math.min(1,u.Dot(e.subtract(t),s)/r)),a=t.add(s.multiplyByFloats(n,n));return u.Distance(e,a)}}u._V8PerformanceHack=new u(.5,.5),u._ZeroReadOnly=u.Zero(),Object.defineProperties(u.prototype,{dimension:{value:[2]},rank:{value:1}});class _{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,t=0,i=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){let e=c(this._x);return e=397*e^c(this._y),e=397*e^c(this._z),e}asArray(){return[this._x,this._y,this._z]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return _.FromArrayToRef(e,t,this),this}toQuaternion(){return f.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._isDirty=!0,this}addInPlaceFromFloats(e,t,i){return this._x+=e,this._y+=t,this._z+=i,this._isDirty=!0,this}add(e){return new _(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t._x=this._x+e._x,t._y=this._y+e._y,t._z=this._z+e._z,t._isDirty=!0,t}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new _(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,i){return new _(this._x-e,this._y-t,this._z-i)}subtractFromFloatsToRef(e,t,i,r){return r._x=this._x-e,r._y=this._y-t,r._z=this._z-i,r._isDirty=!0,r}negate(){return new _(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e._x=-1*this._x,e._y=-1*this._y,e._z=-1*this._z,e._isDirty=!0,e}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new _(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._isDirty=!0,t}getNormalToRef(e){const t=this.length();let i=Math.acos(this._y/t);const r=Math.atan2(this._z,this._x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;const s=t*Math.sin(i)*Math.cos(r),n=t*Math.cos(i),a=t*Math.sin(i)*Math.sin(r);return e.set(s,n,a),e}applyRotationQuaternionToRef(e,t){const i=this._x,r=this._y,s=this._z,n=e._x,a=e._y,o=e._z,h=e._w,l=2*(a*s-o*r),c=2*(o*i-n*s),u=2*(n*r-a*i);return t._x=i+h*l+a*u-o*c,t._y=r+h*c+o*l-n*u,t._z=s+h*u+n*c-a*l,t._isDirty=!0,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new _)}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._isDirty=!0,t}projectOnPlane(e,t){return this.projectOnPlaneToRef(e,t,new _)}projectOnPlaneToRef(e,t,i){const r=e.normal,s=e.d,n=g.Vector3[0];this.subtractToRef(t,n),n.normalize();const a=_.Dot(n,r);if(Math.abs(a)<1e-10)i.setAll(1/0);else{const e=-(_.Dot(t,r)+s)/a,o=n.scaleInPlace(e);t.addToRef(o,i)}return i}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=r.bH){return e&&(0,h.Mj)(this._x,e._x,t)&&(0,h.Mj)(this._y,e._y,t)&&(0,h.Mj)(this._z,e._z,t)}equalsToFloats(e,t,i){return this._x===e&&this._y===t&&this._z===i}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t._x=this._x*e._x,t._y=this._y*e._y,t._z=this._z*e._z,t._isDirty=!0,t}multiplyByFloats(e,t,i){return new _(this._x*e,this._y*t,this._z*i)}divide(e){return new _(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t._x=this._x/e._x,t._y=this._y/e._y,t._z=this._z/e._z,t._isDirty=!0,t}divideInPlace(e){return this._x=this._x/e._x,this._y=this._y/e._y,this._z=this._z/e._z,this._isDirty=!0,this}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(e){const t=Math.abs(this._x),i=Math.abs(this._y);if(!(0,h.Mj)(t,i,e))return!0;const r=Math.abs(this._z);return!(0,h.Mj)(t,r,e)||!(0,h.Mj)(i,r,e)}get isNonUniform(){const e=Math.abs(this._x);return e!==Math.abs(this._y)||e!==Math.abs(this._z)}floorToRef(e){return e._x=Math.floor(this._x),e._y=Math.floor(this._y),e._z=Math.floor(this._z),e._isDirty=!0,e}floor(){return new _(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}fractToRef(e){return e._x=this._x-Math.floor(this._x),e._y=this._y-Math.floor(this._y),e._z=this._z-Math.floor(this._z),e._isDirty=!0,e}fract(){return new _(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z===0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){if("xyz"===(e=e.toLowerCase()))return this;const t=g.Vector3[0].copyFrom(this);return this.x=t[e[0]],this.y=t[e[1]],this.z=t[e[2]],this}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(g.Matrix[0]),_.TransformCoordinatesToRef(this,g.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,i){return this.subtractToRef(t,g.Vector3[0]),g.Vector3[0].rotateByQuaternionToRef(e,g.Vector3[0]),t.addToRef(g.Vector3[0],i),i}cross(e){return _.CrossToRef(this,e,new _)}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){return this.normalizeToRef(new _)}normalizeToRef(e){const t=this.length();return 0===t||1===t?(e._x=this._x,e._y=this._y,e._z=this._z,e._isDirty=!0,e):this.scaleToRef(1/t,e)}clone(){return new _(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,i){return this._x=e,this._y=t,this._z=i,this._isDirty=!0,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(e,t,i,r){const s=_.Dot(e,i);return(s-r)/(s-_.Dot(t,i))}static GetAngleBetweenVectors(e,t,i){const r=e.normalizeToRef(g.Vector3[1]),s=t.normalizeToRef(g.Vector3[2]);let n=_.Dot(r,s);n=(0,h.OQ)(n,-1,1);const a=Math.acos(n),o=g.Vector3[3];return _.CrossToRef(r,s,o),_.Dot(o,i)>0?isNaN(a)?0:a:isNaN(a)?-Math.PI:-Math.acos(n)}static GetAngleBetweenVectorsOnPlane(e,t,i){g.Vector3[0].copyFrom(e);const r=g.Vector3[0];g.Vector3[1].copyFrom(t);const s=g.Vector3[1];g.Vector3[2].copyFrom(i);const n=g.Vector3[2],a=g.Vector3[3],o=g.Vector3[4];r.normalize(),s.normalize(),n.normalize(),_.CrossToRef(n,r,a),_.CrossToRef(a,n,o);const l=Math.atan2(_.Dot(s,a),_.Dot(s,o));return(0,h.ed)(l)}static PitchYawRollToMoveBetweenPointsToRef(e,t,i){const r=m.Vector3[0];return t.subtractToRef(e,r),i._y=Math.atan2(r.x,r.z)||0,i._x=Math.atan2(Math.sqrt(r.x**2+r.z**2),r.y)||0,i._z=0,i._isDirty=!0,i}static PitchYawRollToMoveBetweenPoints(e,t){const i=_.Zero();return _.PitchYawRollToMoveBetweenPointsToRef(e,t,i)}static SlerpToRef(e,t,i,s){i=(0,h.OQ)(i,0,1);const n=g.Vector3[0],a=g.Vector3[1];n.copyFrom(e);const o=n.length();n.normalizeFromLength(o),a.copyFrom(t);const l=a.length();a.normalizeFromLength(l);const c=_.Dot(n,a);let u,d;if(c<1-r.bH){const e=Math.acos(c),t=1/Math.sin(e);u=Math.sin((1-i)*e)*t,d=Math.sin(i*e)*t}else u=1-i,d=i;return n.scaleInPlace(u),a.scaleInPlace(d),s.copyFrom(n).addInPlace(a),s.scaleInPlace((0,h.cP)(o,l,i)),s}static SmoothToRef(e,t,i,r,s){return _.SlerpToRef(e,t,0===r?1:i/r,s),s}static FromArray(e,t=0){return new _(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return _.FromArray(e,t)}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._isDirty=!0,i}static FromFloatArrayToRef(e,t,i){return _.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,r){return r.copyFromFloats(e,t,i),r}static Zero(){return new _(0,0,0)}static One(){return new _(1,1,1)}static Up(){return new _(0,1,0)}static get UpReadOnly(){return _._UpReadOnly}static get DownReadOnly(){return _._DownReadOnly}static get RightReadOnly(){return _._RightReadOnly}static get LeftReadOnly(){return _._LeftReadOnly}static get LeftHandedForwardReadOnly(){return _._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return _._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return _._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return _._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return _._ZeroReadOnly}static get OneReadOnly(){return _._OneReadOnly}static Down(){return new _(0,-1,0)}static Forward(e=!1){return new _(0,0,e?-1:1)}static Backward(e=!1){return new _(0,0,e?1:-1)}static Right(){return new _(1,0,0)}static Left(){return new _(-1,0,0)}static Random(e=0,t=1){return new _((0,h.VD)(e,t),(0,h.VD)(e,t),(0,h.VD)(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats((0,h.VD)(e,t),(0,h.VD)(e,t),(0,h.VD)(e,t))}static TransformCoordinates(e,t){const i=_.Zero();return _.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return _.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,r,s){const n=r.m,a=e*n[0]+t*n[4]+i*n[8]+n[12],o=e*n[1]+t*n[5]+i*n[9]+n[13],h=e*n[2]+t*n[6]+i*n[10]+n[14],l=1/(e*n[3]+t*n[7]+i*n[11]+n[15]);return s._x=a*l,s._y=o*l,s._z=h*l,s._isDirty=!0,s}static TransformNormal(e,t){const i=_.Zero();return _.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformNormalFromFloatsToRef(e,t,i,r,s){const n=r.m;return s._x=e*n[0]+t*n[4]+i*n[8],s._y=e*n[1]+t*n[5]+i*n[9],s._z=e*n[2]+t*n[6]+i*n[10],s._isDirty=!0,s}static CatmullRom(e,t,i,r,s){const n=s*s,a=s*n,o=.5*(2*t._x+(-e._x+i._x)*s+(2*e._x-5*t._x+4*i._x-r._x)*n+(-e._x+3*t._x-3*i._x+r._x)*a),h=.5*(2*t._y+(-e._y+i._y)*s+(2*e._y-5*t._y+4*i._y-r._y)*n+(-e._y+3*t._y-3*i._y+r._y)*a),l=.5*(2*t._z+(-e._z+i._z)*s+(2*e._z-5*t._z+4*i._z-r._z)*n+(-e._z+3*t._z-3*i._z+r._z)*a);return new _(o,h,l)}static Clamp(e,t,i){const r=new _;return _.ClampToRef(e,t,i,r),r}static ClampToRef(e,t,i,r){let s=e._x;s=s>i._x?i._x:s,s=s<t._x?t._x:s;let n=e._y;n=n>i._y?i._y:n,n=n<t._y?t._y:n;let a=e._z;return a=a>i._z?i._z:a,a=a<t._z?t._z:a,r.copyFromFloats(s,n,a),r}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static Hermite(e,t,i,r,s){const n=s*s,a=s*n,o=2*a-3*n+1,h=-2*a+3*n,l=a-2*n+s,c=a-n,u=e._x*o+i._x*h+t._x*l+r._x*c,d=e._y*o+i._y*h+t._y*l+r._y*c,f=e._z*o+i._z*h+t._z*l+r._z*c;return new _(u,d,f)}static Hermite1stDerivative(e,t,i,r,s){const n=new _;return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const a=s*s;return n._x=6*(a-s)*e._x+(3*a-4*s+1)*t._x+6*(-a+s)*i._x+(3*a-2*s)*r._x,n._y=6*(a-s)*e._y+(3*a-4*s+1)*t._y+6*(-a+s)*i._y+(3*a-2*s)*r._y,n._z=6*(a-s)*e._z+(3*a-4*s+1)*t._z+6*(-a+s)*i._z+(3*a-2*s)*r._z,n._isDirty=!0,n}static Lerp(e,t,i){const r=new _(0,0,0);return _.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){return r._x=e._x+(t._x-e._x)*i,r._y=e._y+(t._y-e._y)*i,r._z=e._z+(t._z-e._z)*i,r._isDirty=!0,r}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z}static Cross(e,t){const i=new _;return _.CrossToRef(e,t,i),i}static CrossToRef(e,t,i){const r=e._y*t._z-e._z*t._y,s=e._z*t._x-e._x*t._z,n=e._x*t._y-e._y*t._x;return i.copyFromFloats(r,s,n),i}static Normalize(e){const t=_.Zero();return _.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(e,t,i,r){const s=new _;return _.ProjectToRef(e,t,i,r,s),s}static ProjectToRef(e,t,i,r,s){const n=r.width,a=r.height,h=r.x,l=r.y,c=g.Matrix[1],u=o.q.LastCreatedEngine?.isNDCHalfZRange,d=u?1:.5,f=u?0:.5;p.FromValuesToRef(n/2,0,0,0,0,-a/2,0,0,0,0,d,0,h+n/2,a/2+l,f,1,c);const m=g.Matrix[0];return t.multiplyToRef(i,m),m.multiplyToRef(c,m),_.TransformCoordinatesToRef(e,m,s),s}static Reflect(e,t){return this.ReflectToRef(e,t,new _)}static ReflectToRef(e,t,i){const r=m.Vector3[0];return r.copyFrom(t).scaleInPlace(2*_.Dot(e,t)),i.copyFrom(e).subtractInPlace(r)}static _UnprojectFromInvertedMatrixToRef(e,t,i){_.TransformCoordinatesToRef(e,t,i);const r=t.m,s=e._x*r[3]+e._y*r[7]+e._z*r[11]+r[15];return(0,h.Mj)(s,1)&&i.scaleInPlace(1/s),i}static UnprojectFromTransform(e,t,i,r,s){return this.Unproject(e,t,i,r,s,p.IdentityReadOnly)}static Unproject(e,t,i,r,s,n){const a=new _;return _.UnprojectToRef(e,t,i,r,s,n,a),a}static UnprojectToRef(e,t,i,r,s,n,a){return _.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,r,s,n,a),a}static UnprojectFloatsToRef(e,t,i,r,s,n,a,h,l){const c=g.Matrix[0];n.multiplyToRef(a,c),c.multiplyToRef(h,c),c.invert();const u=g.Vector3[0];return u.x=e/r*2-1,u.y=-(t/s*2-1),o.q.LastCreatedEngine?.isNDCHalfZRange?u.z=i:u.z=2*i-1,_._UnprojectFromInvertedMatrixToRef(u,c,l),l}static Minimize(e,t){const i=new _;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new _;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(_.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e._x-t._x,r=e._y-t._y,s=e._z-t._z;return i*i+r*r+s*s}static ProjectOnTriangleToRef(e,t,i,s,n){const a=g.Vector3[0],o=g.Vector3[1],l=g.Vector3[2],c=g.Vector3[3],u=g.Vector3[4];i.subtractToRef(t,a),s.subtractToRef(t,o),s.subtractToRef(i,l);const d=a.length(),f=o.length(),p=l.length();if(d<r.bH||f<r.bH||p<r.bH)return n.copyFrom(t),_.Distance(e,t);e.subtractToRef(t,u),_.CrossToRef(a,o,c);const m=c.length();if(m<r.bH)return n.copyFrom(t),_.Distance(e,t);c.normalizeFromLength(m);let T=u.length();if(T<r.bH)return n.copyFrom(t),0;u.normalizeFromLength(T);const R=_.Dot(c,u),y=g.Vector3[5],b=g.Vector3[6];y.copyFrom(c).scaleInPlace(-T*R),b.copyFrom(e).addInPlace(y);const E=g.Vector3[4],x=g.Vector3[5],v=g.Vector3[7],C=g.Vector3[8];E.copyFrom(a).scaleInPlace(1/d),C.copyFrom(o).scaleInPlace(1/f),E.addInPlace(C).scaleInPlace(-1),x.copyFrom(a).scaleInPlace(-1/d),C.copyFrom(l).scaleInPlace(1/p),x.addInPlace(C).scaleInPlace(-1),v.copyFrom(l).scaleInPlace(-1/p),C.copyFrom(o).scaleInPlace(-1/f),v.addInPlace(C).scaleInPlace(-1);const A=g.Vector3[9];let P;A.copyFrom(b).subtractInPlace(t),_.CrossToRef(E,A,C),P=_.Dot(C,c);const M=P;A.copyFrom(b).subtractInPlace(i),_.CrossToRef(x,A,C),P=_.Dot(C,c);const S=P;A.copyFrom(b).subtractInPlace(s),_.CrossToRef(v,A,C),P=_.Dot(C,c);const F=P,I=g.Vector3[10];let w,D;M>0&&S<0?(I.copyFrom(a),w=t,D=i):S>0&&F<0?(I.copyFrom(l),w=i,D=s):(I.copyFrom(o).scaleInPlace(-1),w=s,D=t);const O=g.Vector3[9],B=g.Vector3[4];if(w.subtractToRef(b,C),D.subtractToRef(b,O),_.CrossToRef(C,O,B),!(_.Dot(B,c)<0))return n.copyFrom(b),Math.abs(T*R);const U=g.Vector3[5];_.CrossToRef(I,B,U),U.normalize();const L=g.Vector3[9];L.copyFrom(w).subtractInPlace(b);const N=L.length();if(N<r.bH)return n.copyFrom(w),_.Distance(e,w);L.normalizeFromLength(N);const k=_.Dot(U,L),G=g.Vector3[7];G.copyFrom(b).addInPlace(U.scaleInPlace(N*k)),C.copyFrom(G).subtractInPlace(w),T=I.length(),I.normalizeFromLength(T);let V=_.Dot(C,I)/Math.max(T,r.bH);return V=(0,h.OQ)(V,0,1),G.copyFrom(w).addInPlace(I.scaleInPlace(V*T)),n.copyFrom(G),_.Distance(e,G)}static Center(e,t){return _.CenterToRef(e,t,_.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,i){const r=new _;return _.RotationFromAxisToRef(e,t,i,r),r}static RotationFromAxisToRef(e,t,i,r){const s=g.Quaternion[0];return f.RotationQuaternionFromAxisToRef(e,t,i,s),s.toEulerAnglesToRef(r),r}}_._V8PerformanceHack=new _(.5,.5,.5),_._UpReadOnly=_.Up(),_._DownReadOnly=_.Down(),_._LeftHandedForwardReadOnly=_.Forward(!1),_._RightHandedForwardReadOnly=_.Forward(!0),_._LeftHandedBackwardReadOnly=_.Backward(!1),_._RightHandedBackwardReadOnly=_.Backward(!0),_._RightReadOnly=_.Right(),_._LeftReadOnly=_.Left(),_._ZeroReadOnly=_.Zero(),_._OneReadOnly=_.One(),Object.defineProperties(_.prototype,{dimension:{value:[3]},rank:{value:1}});class d{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,i=0,r=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=r}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Vector4"}getHashCode(){let e=c(this._x);return e=397*e^c(this._y),e=397*e^c(this._z),e=397*e^c(this._w),e}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t){return void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}fromArray(e,t=0){return d.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e._x,this.y+=e._y,this.z+=e._z,this.w+=e._w,this}addInPlaceFromFloats(e,t,i,r){return this.x+=e,this.y+=t,this.z+=i,this.w+=r,this}add(e){return new d(this._x+e.x,this._y+e.y,this._z+e.z,this._w+e.w)}addToRef(e,t){return t.x=this._x+e.x,t.y=this._y+e.y,t.z=this._z+e.z,t.w=this._w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new d(this._x-e.x,this._y-e.y,this._z-e.z,this._w-e.w)}subtractToRef(e,t){return t.x=this._x-e.x,t.y=this._y-e.y,t.z=this._z-e.z,t.w=this._w-e.w,t}subtractFromFloats(e,t,i,r){return new d(this._x-e,this._y-t,this._z-i,this._w-r)}subtractFromFloatsToRef(e,t,i,r,s){return s.x=this._x-e,s.y=this._y-t,s.z=this._z-i,s.w=this._w-r,s}negate(){return new d(-this._x,-this._y,-this._z,-this._w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.x=-this._x,e.y=-this._y,e.z=-this._z,e.w=-this._w,e}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new d(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t.x=this._x*e,t.y=this._y*e,t.z=this._z*e,t.w=this._w*e,t}scaleAndAddToRef(e,t){return t.x+=this._x*e,t.y+=this._y*e,t.z+=this._z*e,t.w+=this._w*e,t}equals(e){return e&&this._x===e.x&&this._y===e.y&&this._z===e.z&&this._w===e.w}equalsWithEpsilon(e,t=r.bH){return e&&(0,h.Mj)(this._x,e.x,t)&&(0,h.Mj)(this._y,e.y,t)&&(0,h.Mj)(this._z,e.z,t)&&(0,h.Mj)(this._w,e.w,t)}equalsToFloats(e,t,i,r){return this._x===e&&this._y===t&&this._z===i&&this._w===r}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new d(this._x*e.x,this._y*e.y,this._z*e.z,this._w*e.w)}multiplyToRef(e,t){return t.x=this._x*e.x,t.y=this._y*e.y,t.z=this._z*e.z,t.w=this._w*e.w,t}multiplyByFloats(e,t,i,r){return new d(this._x*e,this._y*t,this._z*i,this._w*r)}divide(e){return new d(this._x/e.x,this._y/e.y,this._z/e.z,this._w/e.w)}divideToRef(e,t){return t.x=this._x/e.x,t.y=this._y/e.y,t.z=this._z/e.z,t.w=this._w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this._x&&(this.x=e.x),e.y<this._y&&(this.y=e.y),e.z<this._z&&(this.z=e.z),e.w<this._w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this._x&&(this.x=e.x),e.y>this._y&&(this.y=e.y),e.z>this._z&&(this.z=e.z),e.w>this._w&&(this.w=e.w),this}minimizeInPlaceFromFloats(e,t,i,r){return this.x=Math.min(e,this._x),this.y=Math.min(t,this._y),this.z=Math.min(i,this._z),this.w=Math.min(r,this._w),this}maximizeInPlaceFromFloats(e,t,i,r){return this.x=Math.max(e,this._x),this.y=Math.max(t,this._y),this.z=Math.max(i,this._z),this.w=Math.max(r,this._w),this}floorToRef(e){return e.x=Math.floor(this._x),e.y=Math.floor(this._y),e.z=Math.floor(this._z),e.w=Math.floor(this._w),e}floor(){return new d(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z),Math.floor(this._w))}fractToRef(e){return e.x=this._x-Math.floor(this._x),e.y=this._y-Math.floor(this._y),e.z=this._z-Math.floor(this._z),e.w=this._w-Math.floor(this._w),e}fract(){return new d(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z),this._w-Math.floor(this._w))}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){return this.normalizeToRef(new d)}normalizeToRef(e){const t=this.length();return 0===t||1===t?(e.x=this._x,e.y=this._y,e.z=this._z,e.w=this._w,e):this.scaleToRef(1/t,e)}toVector3(){return new _(this._x,this._y,this._z)}clone(){return new d(this._x,this._y,this._z,this._w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}setAll(e){return this.x=this.y=this.z=this.w=e,this}dot(e){return this._x*e.x+this._y*e.y+this._z*e.z+this._w*e.w}static FromArray(e,t){return t||(t=0),new d(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}static FromFloatArrayToRef(e,t,i){return d.FromArrayToRef(e,t,i),i}static FromFloatsToRef(e,t,i,r,s){return s.x=e,s.y=t,s.z=i,s.w=r,s}static Zero(){return new d(0,0,0,0)}static One(){return new d(1,1,1,1)}static Random(e=0,t=1){return new d((0,h.VD)(e,t),(0,h.VD)(e,t),(0,h.VD)(e,t),(0,h.VD)(e,t))}static RandomToRef(e=0,t=1,i){return i.x=(0,h.VD)(e,t),i.y=(0,h.VD)(e,t),i.z=(0,h.VD)(e,t),i.w=(0,h.VD)(e,t),i}static Clamp(e,t,i){return d.ClampToRef(e,t,i,new d)}static ClampToRef(e,t,i,r){return r.x=(0,h.OQ)(e.x,t.x,i.x),r.y=(0,h.OQ)(e.y,t.y,i.y),r.z=(0,h.OQ)(e.z,t.z,i.z),r.w=(0,h.OQ)(e.w,t.w,i.w),r}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static get ZeroReadOnly(){return d._ZeroReadOnly}static Normalize(e){return d.NormalizeToRef(e,new d)}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=new d;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new d;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(d.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,r=e.y-t.y,s=e.z-t.z,n=e.w-t.w;return i*i+r*r+s*s+n*n}static Center(e,t){return d.CenterToRef(e,t,new d)}static CenterToRef(e,t,i){return i.x=(e.x+t.x)/2,i.y=(e.y+t.y)/2,i.z=(e.z+t.z)/2,i.w=(e.w+t.w)/2,i}static TransformCoordinates(e,t){return d.TransformCoordinatesToRef(e,t,new d)}static TransformCoordinatesToRef(e,t,i){return d.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,r,s){const n=r.m,a=e*n[0]+t*n[4]+i*n[8]+n[12],o=e*n[1]+t*n[5]+i*n[9]+n[13],h=e*n[2]+t*n[6]+i*n[10]+n[14],l=e*n[3]+t*n[7]+i*n[11]+n[15];return s.x=a,s.y=o,s.z=h,s.w=l,s}static TransformNormal(e,t){return d.TransformNormalToRef(e,t,new d)}static TransformNormalToRef(e,t,i){const r=t.m,s=e.x*r[0]+e.y*r[4]+e.z*r[8],n=e.x*r[1]+e.y*r[5]+e.z*r[9],a=e.x*r[2]+e.y*r[6]+e.z*r[10];return i.x=s,i.y=n,i.z=a,i.w=e.w,i}static TransformNormalFromFloatsToRef(e,t,i,r,s,n){const a=s.m;return n.x=e*a[0]+t*a[4]+i*a[8],n.y=e*a[1]+t*a[5]+i*a[9],n.z=e*a[2]+t*a[6]+i*a[10],n.w=r,n}static FromVector3(e,t=0){return new d(e._x,e._y,e._z,t)}static Dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}}d._V8PerformanceHack=new d(.5,.5,.5,.5),d._ZeroReadOnly=d.Zero(),Object.defineProperties(d.prototype,{dimension:{value:[4]},rank:{value:1}});class f{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,i=0,r=1){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=r}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){let e=c(this._x);return e=397*e^c(this._y),e=397*e^c(this._z),e=397*e^c(this._w),e}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}fromArray(e,t=0){return f.FromArrayToRef(e,t,this)}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=r.bH){return e&&(0,h.Mj)(this._x,e._x,t)&&(0,h.Mj)(this._y,e._y,t)&&(0,h.Mj)(this._z,e._z,t)&&(0,h.Mj)(this._w,e._w,t)}isApprox(e,t=r.bH){return e&&((0,h.Mj)(this._x,e._x,t)&&(0,h.Mj)(this._y,e._y,t)&&(0,h.Mj)(this._z,e._z,t)&&(0,h.Mj)(this._w,e._w,t)||(0,h.Mj)(this._x,-e._x,t)&&(0,h.Mj)(this._y,-e._y,t)&&(0,h.Mj)(this._z,-e._z,t)&&(0,h.Mj)(this._w,-e._w,t))}clone(){return new f(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,t,i,r){return this._x=e,this._y=t,this._z=i,this._w=r,this._isDirty=!0,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}setAll(e){return this.copyFromFloats(e,e,e,e)}add(e){return new f(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}addToRef(e,t){return t._x=this._x+e._x,t._y=this._y+e._y,t._z=this._z+e._z,t._w=this._w+e._w,t._isDirty=!0,t}addInPlaceFromFloats(e,t,i,r){return this._x+=e,this._y+=t,this._z+=i,this._w+=r,this._isDirty=!0,this}subtractToRef(e,t){return t._x=this._x-e._x,t._y=this._y-e._y,t._z=this._z-e._z,t._w=this._w-e._w,t._isDirty=!0,t}subtractFromFloats(e,t,i,r){return this.subtractFromFloatsToRef(e,t,i,r,new f)}subtractFromFloatsToRef(e,t,i,r,s){return s._x=this._x-e,s._y=this._y-t,s._z=this._z-i,s._w=this._w-r,s._isDirty=!0,s}subtract(e){return new f(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new f(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=!0,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=!0,t}multiply(e){const t=new f(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){const i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,r=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,s=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,n=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,r,s,n),t}multiplyInPlace(e){return this.multiplyToRef(e,this)}multiplyByFloats(e,t,i,r){return this._x*=e,this._y*=t,this._z*=i,this._w*=r,this._isDirty=!0,this}divide(e){throw new ReferenceError("Can not divide a quaternion")}divideToRef(e,t){throw new ReferenceError("Can not divide a quaternion")}divideInPlace(e){throw new ReferenceError("Can not divide a quaternion")}minimizeInPlace(){throw new ReferenceError("Can not minimize a quaternion")}minimizeInPlaceFromFloats(){throw new ReferenceError("Can not minimize a quaternion")}maximizeInPlace(){throw new ReferenceError("Can not maximize a quaternion")}maximizeInPlaceFromFloats(){throw new ReferenceError("Can not maximize a quaternion")}negate(){return this.negateToRef(new f)}negateInPlace(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._w=-this._w,this._isDirty=!0,this}negateToRef(e){return e._x=-this._x,e._y=-this._y,e._z=-this._z,e._w=-this._w,e._isDirty=!0,e}equalsToFloats(e,t,i,r){return this._x===e&&this._y===t&&this._z===i&&this._w===r}floorToRef(e){throw new ReferenceError("Can not floor a quaternion")}floor(){throw new ReferenceError("Can not floor a quaternion")}fractToRef(e){throw new ReferenceError("Can not fract a quaternion")}fract(){throw new ReferenceError("Can not fract a quaternion")}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new f(-this._x,-this._y,-this._z,this._w)}invert(){const e=this.conjugate(),t=this.lengthSquared();return 0==t||1==t||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();const e=this.lengthSquared();return 0==e||1==e||this.scaleInPlace(1/e),this}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new f(0,0,0,1);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t||1===t?e.copyFromFloats(this._x,this._y,this._z,this._w):this.scaleToRef(1/t,e)}toEulerAngles(){const e=_.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){const t=this._z,i=this._x,r=this._y,s=this._w,n=r*t-i*s,a=.4999999;if(n<-a)e._y=2*Math.atan2(r,s),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(n>a)e._y=2*Math.atan2(r,s),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{const a=s*s,o=t*t,h=i*i,l=r*r;e._z=Math.atan2(2*(i*r+t*s),-o-h+l+a),e._x=Math.asin(-2*n),e._y=Math.atan2(2*(t*i+r*s),o-h-l+a),e._isDirty=!0}return e}toAlphaBetaGammaToRef(e){const t=this._z,i=this._x,r=this._y,s=this._w,n=Math.sqrt(i*i+r*r),a=Math.sqrt(t*t+s*s),o=2*Math.atan2(n,a),h=2*Math.atan2(t,s),l=2*Math.atan2(r,i),c=(h+l)/2,u=(h-l)/2;return e.set(u,o,c),e}toRotationMatrix(e){return p.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return f.FromRotationMatrixToRef(e,this),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}static FromRotationMatrix(e){const t=new f;return f.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){const i=e.m,r=i[0],s=i[4],n=i[8],a=i[1],o=i[5],h=i[9],l=i[2],c=i[6],u=i[10],_=r+o+u;let d;return _>0?(d=.5/Math.sqrt(_+1),t._w=.25/d,t._x=(c-h)*d,t._y=(n-l)*d,t._z=(a-s)*d,t._isDirty=!0):r>o&&r>u?(d=2*Math.sqrt(1+r-o-u),t._w=(c-h)/d,t._x=.25*d,t._y=(s+a)/d,t._z=(n+l)/d,t._isDirty=!0):o>u?(d=2*Math.sqrt(1+o-r-u),t._w=(n-l)/d,t._x=(s+a)/d,t._y=.25*d,t._z=(h+c)/d,t._isDirty=!0):(d=2*Math.sqrt(1+u-r-o),t._w=(a-s)/d,t._x=(n+l)/d,t._y=(h+c)/d,t._z=.25*d,t._isDirty=!0),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,i=.1){const r=f.Dot(e,t);return 1-r*r<=i}static SmoothToRef(e,t,i,r,s){let n=0===r?1:i/r;return n=(0,h.OQ)(n,0,1),f.SlerpToRef(e,t,n,s),s}static Zero(){return new f(0,0,0,0)}static Inverse(e){return new f(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new f(0,0,0,1)}static IsIdentity(e){return e&&0===e._x&&0===e._y&&0===e._z&&1===e._w}static RotationAxis(e,t){return f.RotationAxisToRef(e,t,new f)}static RotationAxisToRef(e,t,i){i._w=Math.cos(t/2);const r=Math.sin(t/2)/e.length();return i._x=e._x*r,i._y=e._y*r,i._z=e._z*r,i._isDirty=!0,i}static FromArray(e,t){return t||(t=0),new f(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._w=e[t+3],i._isDirty=!0,i}static FromFloatsToRef(e,t,i,r,s){return s.copyFromFloats(e,t,i,r),s}static FromEulerAngles(e,t,i){const r=new f;return f.RotationYawPitchRollToRef(t,e,i,r),r}static FromEulerAnglesToRef(e,t,i,r){return f.RotationYawPitchRollToRef(t,e,i,r),r}static FromEulerVector(e){const t=new f;return f.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return f.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,i,s=r.bH){const n=_.Dot(e,t)+1;return n<s?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(_.CrossToRef(e,t,m.Vector3[0]),i.set(m.Vector3[0].x,m.Vector3[0].y,m.Vector3[0].z,n)),i.normalize()}static RotationYawPitchRoll(e,t,i){const r=new f;return f.RotationYawPitchRollToRef(e,t,i,r),r}static RotationYawPitchRollToRef(e,t,i,r){const s=.5*i,n=.5*t,a=.5*e,o=Math.sin(s),h=Math.cos(s),l=Math.sin(n),c=Math.cos(n),u=Math.sin(a),_=Math.cos(a);return r._x=_*l*h+u*c*o,r._y=u*c*h-_*l*o,r._z=_*c*o-u*l*h,r._w=_*c*h+u*l*o,r._isDirty=!0,r}static RotationAlphaBetaGamma(e,t,i){const r=new f;return f.RotationAlphaBetaGammaToRef(e,t,i,r),r}static RotationAlphaBetaGammaToRef(e,t,i,r){const s=.5*(i+e),n=.5*(i-e),a=.5*t;return r._x=Math.cos(n)*Math.sin(a),r._y=Math.sin(n)*Math.sin(a),r._z=Math.sin(s)*Math.cos(a),r._w=Math.cos(s)*Math.cos(a),r._isDirty=!0,r}static RotationQuaternionFromAxis(e,t,i){const r=new f(0,0,0,0);return f.RotationQuaternionFromAxisToRef(e,t,i,r),r}static RotationQuaternionFromAxisToRef(e,t,i,r){const s=g.Matrix[0];return e=e.normalizeToRef(g.Vector3[0]),t=t.normalizeToRef(g.Vector3[1]),i=i.normalizeToRef(g.Vector3[2]),p.FromXYZAxesToRef(e,t,i,s),f.FromRotationMatrixToRef(s,r),r}static FromLookDirectionLH(e,t){const i=new f;return f.FromLookDirectionLHToRef(e,t,i),i}static FromLookDirectionLHToRef(e,t,i){const r=g.Matrix[0];return p.LookDirectionLHToRef(e,t,r),f.FromRotationMatrixToRef(r,i),i}static FromLookDirectionRH(e,t){const i=new f;return f.FromLookDirectionRHToRef(e,t,i),i}static FromLookDirectionRHToRef(e,t,i){const r=g.Matrix[0];return p.LookDirectionRHToRef(e,t,r),f.FromRotationMatrixToRef(r,i)}static Slerp(e,t,i){const r=f.Identity();return f.SlerpToRef(e,t,i,r),r}static SlerpToRef(e,t,i,r){let s,n,a=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,o=!1;if(a<0&&(o=!0,a=-a),a>.999999)n=1-i,s=o?-i:i;else{const e=Math.acos(a),t=1/Math.sin(e);n=Math.sin((1-i)*e)*t,s=o?-Math.sin(i*e)*t:Math.sin(i*e)*t}return r._x=n*e._x+s*t._x,r._y=n*e._y+s*t._y,r._z=n*e._z+s*t._z,r._w=n*e._w+s*t._w,r._isDirty=!0,r}static Hermite(e,t,i,r,s){const n=s*s,a=s*n,o=2*a-3*n+1,h=-2*a+3*n,l=a-2*n+s,c=a-n,u=e._x*o+i._x*h+t._x*l+r._x*c,_=e._y*o+i._y*h+t._y*l+r._y*c,d=e._z*o+i._z*h+t._z*l+r._z*c,p=e._w*o+i._w*h+t._w*l+r._w*c;return new f(u,_,d,p)}static Hermite1stDerivative(e,t,i,r,s){const n=new f;return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const a=s*s;return n._x=6*(a-s)*e._x+(3*a-4*s+1)*t._x+6*(-a+s)*i._x+(3*a-2*s)*r._x,n._y=6*(a-s)*e._y+(3*a-4*s+1)*t._y+6*(-a+s)*i._y+(3*a-2*s)*r._y,n._z=6*(a-s)*e._z+(3*a-4*s+1)*t._z+6*(-a+s)*i._z+(3*a-2*s)*r._z,n._w=6*(a-s)*e._w+(3*a-4*s+1)*t._w+6*(-a+s)*i._w+(3*a-2*s)*r._w,n._isDirty=!0,n}static Normalize(e){const t=f.Zero();return f.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Clamp(e,t,i){const r=new f;return f.ClampToRef(e,t,i,r),r}static ClampToRef(e,t,i,r){return r.copyFromFloats((0,h.OQ)(e.x,t.x,i.x),(0,h.OQ)(e.y,t.y,i.y),(0,h.OQ)(e.z,t.z,i.z),(0,h.OQ)(e.w,t.w,i.w))}static Random(e=0,t=1){return new f((0,h.VD)(e,t),(0,h.VD)(e,t),(0,h.VD)(e,t),(0,h.VD)(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats((0,h.VD)(e,t),(0,h.VD)(e,t),(0,h.VD)(e,t),(0,h.VD)(e,t))}static Minimize(){throw new ReferenceError("Quaternion.Minimize does not make sense")}static Maximize(){throw new ReferenceError("Quaternion.Maximize does not make sense")}static Distance(e,t){return Math.sqrt(f.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,r=e.y-t.y,s=e.z-t.z,n=e.w-t.w;return i*i+r*r+s*s+n*n}static Center(e,t){return f.CenterToRef(e,t,f.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}}f._V8PerformanceHack=new f(.5,.5,.5,.5),Object.defineProperties(f.prototype,{dimension:{value:[4]},rank:{value:1}});class p{static get Use64Bits(){return a.I.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=l._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,i=!1,r=!0){this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=!this._isIdentity&&t,this._isIdentity3x2Dirty=!this._isIdentity3x2&&r}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,a.I.MatrixTrackPrecisionChange&&a.I.MatrixTrackedMatrices.push(this),this._m=new a.I.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;const e=this._m;this._isIdentity=1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,1!==this._m[0]||1!==this._m[5]||1!==this._m[15]||0!==this._m[1]||0!==this._m[2]||0!==this._m[3]||0!==this._m[4]||0!==this._m[6]||0!==this._m[7]||0!==this._m[8]||0!==this._m[9]||0!==this._m[10]||0!==this._m[11]||0!==this._m[12]||0!==this._m[13]||0!==this._m[14]?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(!0===this._isIdentity)return 1;const e=this._m,t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],a=e[5],o=e[6],h=e[7],l=e[8],c=e[9],u=e[10],_=e[11],d=e[12],f=e[13],p=e[14],g=e[15],m=u*g-p*_,T=c*g-f*_,R=c*p-f*u,y=l*g-d*_,b=l*p-u*d,E=l*f-d*c;return t*+(a*m-o*T+h*R)+i*-(n*m-o*y+h*b)+r*+(n*T-a*y+h*E)+s*-(n*R-a*b+o*E)}toString(){return`{${this.m[0]}, ${this.m[1]}, ${this.m[2]}, ${this.m[3]}\n${this.m[4]}, ${this.m[5]}, ${this.m[6]}, ${this.m[7]}\n${this.m[8]}, ${this.m[9]}, ${this.m[10]}, ${this.m[11]}\n${this.m[12]}, ${this.m[13]}, ${this.m[14]}, ${this.m[15]}}`}toArray(e=null,t=0){if(!e)return this._m;const i=this._m;for(let r=0;r<16;r++)e[t+r]=i[r];return this}asArray(){return this._m}fromArray(e,t=0){return p.FromArrayToRef(e,t,this)}copyFromFloats(...e){return p.FromArrayToRef(e,0,this)}set(...e){const t=this._m;for(let i=0;i<16;i++)t[i]=e[i];return this.markAsUpdated(),this}setAll(e){const t=this._m;for(let i=0;i<16;i++)t[i]=e;return this.markAsUpdated(),this}invert(){return this.invertToRef(this),this}reset(){return p.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){const t=new p;return this.addToRef(e,t),t}addToRef(e,t){const i=this._m,r=t._m,s=e.m;for(let e=0;e<16;e++)r[e]=i[e]+s[e];return t.markAsUpdated(),t}addToSelf(e){const t=this._m,i=e.m;return t[0]+=i[0],t[1]+=i[1],t[2]+=i[2],t[3]+=i[3],t[4]+=i[4],t[5]+=i[5],t[6]+=i[6],t[7]+=i[7],t[8]+=i[8],t[9]+=i[9],t[10]+=i[10],t[11]+=i[11],t[12]+=i[12],t[13]+=i[13],t[14]+=i[14],t[15]+=i[15],this.markAsUpdated(),this}addInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]+=i[e];return this.markAsUpdated(),this}addInPlaceFromFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]+=e[i];return this.markAsUpdated(),this}subtract(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]-=i[e];return this.markAsUpdated(),this}subtractToRef(e,t){const i=this._m,r=e.m,s=t._m;for(let e=0;e<16;e++)s[e]=i[e]-r[e];return t.markAsUpdated(),t}subtractInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]-=i[e];return this.markAsUpdated(),this}subtractFromFloats(...e){return this.subtractFromFloatsToRef(...e,new p)}subtractFromFloatsToRef(...e){const t=e.pop(),i=this._m,r=t._m,s=e;for(let e=0;e<16;e++)r[e]=i[e]-s[e];return t.markAsUpdated(),t}invertToRef(e){return!0===this._isIdentity?(p.IdentityToRef(e),e):(function(e,t){const i=e.asArray(),r=i[0],s=i[1],n=i[2],a=i[3],o=i[4],h=i[5],l=i[6],c=i[7],u=i[8],_=i[9],d=i[10],f=i[11],p=i[12],g=i[13],m=i[14],T=i[15],R=d*T-m*f,y=_*T-g*f,b=_*m-g*d,E=u*T-p*f,x=u*m-d*p,v=u*g-p*_,C=+(h*R-l*y+c*b),A=-(o*R-l*E+c*x),P=+(o*y-h*E+c*v),M=-(o*b-h*x+l*v),S=r*C+s*A+n*P+a*M;if(0===S)return!1;const F=1/S,I=l*T-m*c,w=h*T-g*c,D=h*m-g*l,O=o*T-p*c,B=o*m-p*l,U=o*g-p*h,L=l*f-d*c,N=h*f-_*c,k=h*d-_*l,G=o*f-u*c,V=o*d-u*l,z=o*_-u*h,X=-(s*R-n*y+a*b),H=+(r*R-n*E+a*x),q=-(r*y-s*E+a*v),W=+(r*b-s*x+n*v),K=+(s*I-n*w+a*D),Y=-(r*I-n*O+a*B),j=+(r*w-s*O+a*U),Z=-(r*D-s*B+n*U),Q=-(s*L-n*N+a*k),$=+(r*L-n*G+a*V),J=-(r*N-s*G+a*z),ee=+(r*k-s*V+n*z);return t[0]=C*F,t[1]=X*F,t[2]=K*F,t[3]=Q*F,t[4]=A*F,t[5]=H*F,t[6]=Y*F,t[7]=$*F,t[8]=P*F,t[9]=q*F,t[10]=j*F,t[11]=J*F,t[12]=M*F,t[13]=W*F,t[14]=Z*F,t[15]=ee*F,!0}(this,e.asArray())?e.markAsUpdated():e.copyFrom(this),e)}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new _(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){const e=this.m;return p.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]),this}copyFrom(e){e.copyToArray(this._m);const t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){return function(e,t,i=0){const r=e.asArray();t[i]=r[0],t[i+1]=r[1],t[i+2]=r[2],t[i+3]=r[3],t[i+4]=r[4],t[i+5]=r[5],t[i+6]=r[6],t[i+7]=r[7],t[i+8]=r[8],t[i+9]=r[9],t[i+10]=r[10],t[i+11]=r[11],t[i+12]=r[12],t[i+13]=r[13],t[i+14]=r[14],t[i+15]=r[15]}(this,e,t),this}multiply(e){const t=new p;return this.multiplyToRef(e,t),t}multiplyInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]*=i[e];return this.markAsUpdated(),this}multiplyByFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]*=e[i];return this.markAsUpdated(),this}multiplyByFloatsToRef(...e){const t=e.pop(),i=this._m,r=t._m,s=e;for(let e=0;e<16;e++)r[e]=i[e]*s[e];return t.markAsUpdated(),t}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,i){return function(e,t,i,r=0){const s=e.asArray(),n=t.asArray(),a=s[0],o=s[1],h=s[2],l=s[3],c=s[4],u=s[5],_=s[6],d=s[7],f=s[8],p=s[9],g=s[10],m=s[11],T=s[12],R=s[13],y=s[14],b=s[15],E=n[0],x=n[1],v=n[2],C=n[3],A=n[4],P=n[5],M=n[6],S=n[7],F=n[8],I=n[9],w=n[10],D=n[11],O=n[12],B=n[13],U=n[14],L=n[15];i[r]=a*E+o*A+h*F+l*O,i[r+1]=a*x+o*P+h*I+l*B,i[r+2]=a*v+o*M+h*w+l*U,i[r+3]=a*C+o*S+h*D+l*L,i[r+4]=c*E+u*A+_*F+d*O,i[r+5]=c*x+u*P+_*I+d*B,i[r+6]=c*v+u*M+_*w+d*U,i[r+7]=c*C+u*S+_*D+d*L,i[r+8]=f*E+p*A+g*F+m*O,i[r+9]=f*x+p*P+g*I+m*B,i[r+10]=f*v+p*M+g*w+m*U,i[r+11]=f*C+p*S+g*D+m*L,i[r+12]=T*E+R*A+y*F+b*O,i[r+13]=T*x+R*P+y*I+b*B,i[r+14]=T*v+R*M+y*w+b*U,i[r+15]=T*C+R*S+y*D+b*L}(this,e,t,i),this}divide(e){return this.divideToRef(e,new p)}divideToRef(e,t){const i=this._m,r=e.m,s=t._m;for(let e=0;e<16;e++)s[e]=i[e]/r[e];return t.markAsUpdated(),t}divideInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]/=i[e];return this.markAsUpdated(),this}minimizeInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]=Math.min(t[e],i[e]);return this.markAsUpdated(),this}minimizeInPlaceFromFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]=Math.min(t[i],e[i]);return this.markAsUpdated(),this}maximizeInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]=Math.min(t[e],i[e]);return this.markAsUpdated(),this}maximizeInPlaceFromFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]=Math.min(t[i],e[i]);return this.markAsUpdated(),this}negate(){return this.negateToRef(new p)}negateInPlace(){const e=this._m;for(let t=0;t<16;t++)e[t]=-e[t];return this.markAsUpdated(),this}negateToRef(e){const t=this._m,i=e._m;for(let e=0;e<16;e++)i[e]=-t[e];return e.markAsUpdated(),e}equals(e){const t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;const i=this.m,r=t.m;return i[0]===r[0]&&i[1]===r[1]&&i[2]===r[2]&&i[3]===r[3]&&i[4]===r[4]&&i[5]===r[5]&&i[6]===r[6]&&i[7]===r[7]&&i[8]===r[8]&&i[9]===r[9]&&i[10]===r[10]&&i[11]===r[11]&&i[12]===r[12]&&i[13]===r[13]&&i[14]===r[14]&&i[15]===r[15]}equalsWithEpsilon(e,t=0){const i=this._m,r=e.m;for(let e=0;e<16;e++)if(!(0,h.Mj)(i[e],r[e],t))return!1;return!0}equalsToFloats(...e){const t=this._m;for(let i=0;i<16;i++)if(t[i]!=e[i])return!1;return!0}floor(){return this.floorToRef(new p)}floorToRef(e){const t=this._m,i=e._m;for(let e=0;e<16;e++)i[e]=Math.floor(t[e]);return e.markAsUpdated(),e}fract(){return this.fractToRef(new p)}fractToRef(e){const t=this._m,i=e._m;for(let e=0;e<16;e++)i[e]=t[e]-Math.floor(t[e]);return e.markAsUpdated(),e}clone(){const e=new p;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=c(this._m[0]);for(let t=1;t<16;t++)e=397*e^c(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new f,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,i,r,s=!0){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;const n=this._m;if(i&&i.copyFromFloats(n[12],n[13],n[14]),(e=e||g.Vector3[0]).x=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),e.y=Math.sqrt(n[4]*n[4]+n[5]*n[5]+n[6]*n[6]),e.z=Math.sqrt(n[8]*n[8]+n[9]*n[9]+n[10]*n[10]),r){const t=(s?r.absoluteScaling.x:r.scaling.x)<0?-1:1,i=(s?r.absoluteScaling.y:r.scaling.y)<0?-1:1,n=(s?r.absoluteScaling.z:r.scaling.z)<0?-1:1;e.x*=t,e.y*=i,e.z*=n}else this.determinant()<=0&&(e.y*=-1);if(0===e._x||0===e._y||0===e._z)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){const i=1/e._x,r=1/e._y,s=1/e._z;p.FromValuesToRef(n[0]*i,n[1]*i,n[2]*i,0,n[4]*r,n[5]*r,n[6]*r,0,n[8]*s,n[9]*s,n[10]*s,0,0,0,0,1,g.Matrix[0]),f.FromRotationMatrixToRef(g.Matrix[0],t)}return!0}getRow(e){if(e<0||e>3)return null;const t=4*e;return new d(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<=3){const i=4*e;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3]}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){const e=new p;return p.TransposeToRef(this,e),e}transposeToRef(e){return p.TransposeToRef(this,e),e}setRowFromFloats(e,t,i,r,s){if(e<0||e>3)return this;const n=4*e;return this._m[n+0]=t,this._m[n+1]=i,this._m[n+2]=r,this._m[n+3]=s,this.markAsUpdated(),this}scale(e){const t=new p;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),t}scaleInPlace(e){const t=this._m;for(let i=0;i<16;i++)t[i]*=e;return this.markAsUpdated(),this}toNormalMatrix(e){const t=g.Matrix[0];this.invertToRef(t),t.transposeToRef(e);const i=e._m;return p.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e),e}getRotationMatrix(){const e=new p;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){const t=g.Vector3[0];if(!this.decompose(t))return p.IdentityToRef(e),e;const i=this._m,r=1/t._x,s=1/t._y,n=1/t._z;return p.FromValuesToRef(i[0]*r,i[1]*r,i[2]*r,0,i[4]*s,i[5]*s,i[6]*s,0,i[8]*n,i[9]*n,i[10]*n,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){const e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){const e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,t=0){const i=new p;return p.FromArrayToRef(e,t,i),i}static FromArrayToRef(e,t,i){for(let r=0;r<16;r++)i._m[r]=e[r+t];return i.markAsUpdated(),i}static FromFloat32ArrayToRefScaled(e,t,i,r){return r._m[0]=e[0+t]*i,r._m[1]=e[1+t]*i,r._m[2]=e[2+t]*i,r._m[3]=e[3+t]*i,r._m[4]=e[4+t]*i,r._m[5]=e[5+t]*i,r._m[6]=e[6+t]*i,r._m[7]=e[7+t]*i,r._m[8]=e[8+t]*i,r._m[9]=e[9+t]*i,r._m[10]=e[10+t]*i,r._m[11]=e[11+t]*i,r._m[12]=e[12+t]*i,r._m[13]=e[13+t]*i,r._m[14]=e[14+t]*i,r._m[15]=e[15+t]*i,r.markAsUpdated(),r}static get IdentityReadOnly(){return p._IdentityReadOnly}static FromValuesToRef(e,t,i,r,s,n,a,o,h,l,c,u,_,d,f,p,g){const m=g._m;m[0]=e,m[1]=t,m[2]=i,m[3]=r,m[4]=s,m[5]=n,m[6]=a,m[7]=o,m[8]=h,m[9]=l,m[10]=c,m[11]=u,m[12]=_,m[13]=d,m[14]=f,m[15]=p,g.markAsUpdated()}static FromValues(e,t,i,r,s,n,a,o,h,l,c,u,_,d,f,g){const m=new p,T=m._m;return T[0]=e,T[1]=t,T[2]=i,T[3]=r,T[4]=s,T[5]=n,T[6]=a,T[7]=o,T[8]=h,T[9]=l,T[10]=c,T[11]=u,T[12]=_,T[13]=d,T[14]=f,T[15]=g,m.markAsUpdated(),m}static Compose(e,t,i){const r=new p;return p.ComposeToRef(e,t,i,r),r}static ComposeToRef(e,t,i,r){const s=r._m,n=t._x,a=t._y,o=t._z,h=t._w,l=n+n,c=a+a,u=o+o,_=n*l,d=n*c,f=n*u,p=a*c,g=a*u,m=o*u,T=h*l,R=h*c,y=h*u,b=e._x,E=e._y,x=e._z;return s[0]=(1-(p+m))*b,s[1]=(d+y)*b,s[2]=(f-R)*b,s[3]=0,s[4]=(d-y)*E,s[5]=(1-(_+m))*E,s[6]=(g+T)*E,s[7]=0,s[8]=(f+R)*x,s[9]=(g-T)*x,s[10]=(1-(_+p))*x,s[11]=0,s[12]=i._x,s[13]=i._y,s[14]=i._z,s[15]=1,r.markAsUpdated(),r}static Identity(){const e=p.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){return p.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0),e}static Zero(){const e=p.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){const t=new p;return p.RotationXToRef(e,t),t}static Invert(e){const t=new p;return e.invertToRef(t),t}static RotationXToRef(e,t){const i=Math.sin(e),r=Math.cos(e);return p.FromValuesToRef(1,0,0,0,0,r,i,0,0,-i,r,0,0,0,0,1,t),t._updateIdentityStatus(1===r&&0===i),t}static RotationY(e){const t=new p;return p.RotationYToRef(e,t),t}static RotationYToRef(e,t){const i=Math.sin(e),r=Math.cos(e);return p.FromValuesToRef(r,0,-i,0,0,1,0,0,i,0,r,0,0,0,0,1,t),t._updateIdentityStatus(1===r&&0===i),t}static RotationZ(e){const t=new p;return p.RotationZToRef(e,t),t}static RotationZToRef(e,t){const i=Math.sin(e),r=Math.cos(e);return p.FromValuesToRef(r,i,0,0,-i,r,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(1===r&&0===i),t}static RotationAxis(e,t){const i=new p;return p.RotationAxisToRef(e,t,i),i}static RotationAxisToRef(e,t,i){const r=Math.sin(-t),s=Math.cos(-t),n=1-s;e=e.normalizeToRef(g.Vector3[0]);const a=i._m;return a[0]=e._x*e._x*n+s,a[1]=e._x*e._y*n-e._z*r,a[2]=e._x*e._z*n+e._y*r,a[3]=0,a[4]=e._y*e._x*n+e._z*r,a[5]=e._y*e._y*n+s,a[6]=e._y*e._z*n-e._x*r,a[7]=0,a[8]=e._z*e._x*n-e._y*r,a[9]=e._z*e._y*n+e._x*r,a[10]=e._z*e._z*n+s,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,i.markAsUpdated(),i}static RotationAlignToRef(e,t,i,s=!1){const n=_.Dot(t,e),a=i._m;if(n<-1+r.bH)a[0]=-1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=s?1:-1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=s?-1:1,a[11]=0;else{const i=_.Cross(t,e),r=1/(1+n);a[0]=i._x*i._x*r+n,a[1]=i._y*i._x*r-i._z,a[2]=i._z*i._x*r+i._y,a[3]=0,a[4]=i._x*i._y*r+i._z,a[5]=i._y*i._y*r+n,a[6]=i._z*i._y*r-i._x,a[7]=0,a[8]=i._x*i._z*r-i._y,a[9]=i._y*i._z*r+i._x,a[10]=i._z*i._z*r+n,a[11]=0}return a[12]=0,a[13]=0,a[14]=0,a[15]=1,i.markAsUpdated(),i}static RotationYawPitchRoll(e,t,i){const r=new p;return p.RotationYawPitchRollToRef(e,t,i,r),r}static RotationYawPitchRollToRef(e,t,i,r){return f.RotationYawPitchRollToRef(e,t,i,g.Quaternion[0]),g.Quaternion[0].toRotationMatrix(r),r}static Scaling(e,t,i){const r=new p;return p.ScalingToRef(e,t,i,r),r}static ScalingToRef(e,t,i,r){return p.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,r),r._updateIdentityStatus(1===e&&1===t&&1===i),r}static Translation(e,t,i){const r=new p;return p.TranslationToRef(e,t,i,r),r}static TranslationToRef(e,t,i,r){return p.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,r),r._updateIdentityStatus(0===e&&0===t&&0===i),r}static Lerp(e,t,i){const r=new p;return p.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){const s=r._m,n=e.m,a=t.m;for(let e=0;e<16;e++)s[e]=n[e]*(1-i)+a[e]*i;return r.markAsUpdated(),r}static DecomposeLerp(e,t,i){const r=new p;return p.DecomposeLerpToRef(e,t,i,r),r}static DecomposeLerpToRef(e,t,i,r){const s=g.Vector3[0],n=g.Quaternion[0],a=g.Vector3[1];e.decompose(s,n,a);const o=g.Vector3[2],h=g.Quaternion[1],l=g.Vector3[3];t.decompose(o,h,l);const c=g.Vector3[4];_.LerpToRef(s,o,i,c);const u=g.Quaternion[2];f.SlerpToRef(n,h,i,u);const d=g.Vector3[5];return _.LerpToRef(a,l,i,d),p.ComposeToRef(c,u,d,r),r}static LookAtLH(e,t,i){const r=new p;return p.LookAtLHToRef(e,t,i,r),r}static LookAtLHToRef(e,t,i,r){const s=g.Vector3[0],n=g.Vector3[1],a=g.Vector3[2];t.subtractToRef(e,a),a.normalize(),_.CrossToRef(i,a,s);const o=s.lengthSquared();0===o?s.x=1:s.normalizeFromLength(Math.sqrt(o)),_.CrossToRef(a,s,n),n.normalize();const h=-_.Dot(s,e),l=-_.Dot(n,e),c=-_.Dot(a,e);return p.FromValuesToRef(s._x,n._x,a._x,0,s._y,n._y,a._y,0,s._z,n._z,a._z,0,h,l,c,1,r),r}static LookAtRH(e,t,i){const r=new p;return p.LookAtRHToRef(e,t,i,r),r}static LookAtRHToRef(e,t,i,r){const s=g.Vector3[0],n=g.Vector3[1],a=g.Vector3[2];e.subtractToRef(t,a),a.normalize(),_.CrossToRef(i,a,s);const o=s.lengthSquared();0===o?s.x=1:s.normalizeFromLength(Math.sqrt(o)),_.CrossToRef(a,s,n),n.normalize();const h=-_.Dot(s,e),l=-_.Dot(n,e),c=-_.Dot(a,e);return p.FromValuesToRef(s._x,n._x,a._x,0,s._y,n._y,a._y,0,s._z,n._z,a._z,0,h,l,c,1,r),r}static LookDirectionLH(e,t){const i=new p;return p.LookDirectionLHToRef(e,t,i),i}static LookDirectionLHToRef(e,t,i){const r=g.Vector3[0];r.copyFrom(e),r.scaleInPlace(-1);const s=g.Vector3[1];return _.CrossToRef(t,r,s),p.FromValuesToRef(s._x,s._y,s._z,0,t._x,t._y,t._z,0,r._x,r._y,r._z,0,0,0,0,1,i),i}static LookDirectionRH(e,t){const i=new p;return p.LookDirectionRHToRef(e,t,i),i}static LookDirectionRHToRef(e,t,i){const r=g.Vector3[2];return _.CrossToRef(t,e,r),p.FromValuesToRef(r._x,r._y,r._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i),i}static OrthoLH(e,t,i,r,s){const n=new p;return p.OrthoLHToRef(e,t,i,r,n,s),n}static OrthoLHToRef(e,t,i,r,s,n){const a=2/e,o=2/t,h=2/(r-i),l=-(r+i)/(r-i);return p.FromValuesToRef(a,0,0,0,0,o,0,0,0,0,h,0,0,0,l,1,s),n&&s.multiplyToRef(T,s),s._updateIdentityStatus(1===a&&1===o&&1===h&&0===l),s}static OrthoOffCenterLH(e,t,i,r,s,n,a){const o=new p;return p.OrthoOffCenterLHToRef(e,t,i,r,s,n,o,a),o}static OrthoOffCenterLHToRef(e,t,i,r,s,n,a,o){const h=2/(t-e),l=2/(r-i),c=2/(n-s),u=-(n+s)/(n-s),_=(e+t)/(e-t),d=(r+i)/(i-r);return p.FromValuesToRef(h,0,0,0,0,l,0,0,0,0,c,0,_,d,u,1,a),o&&a.multiplyToRef(T,a),a.markAsUpdated(),a}static ObliqueOffCenterLHToRef(e,t,i,r,s,n,a,o,h,l,c){const u=-a*Math.cos(o),_=-a*Math.sin(o);return p.TranslationToRef(0,0,-h,g.Matrix[1]),p.FromValuesToRef(1,0,0,0,0,1,0,0,u,_,1,0,0,0,0,1,g.Matrix[0]),g.Matrix[1].multiplyToRef(g.Matrix[0],g.Matrix[0]),p.TranslationToRef(0,0,h,g.Matrix[1]),g.Matrix[0].multiplyToRef(g.Matrix[1],g.Matrix[0]),p.OrthoOffCenterLHToRef(e,t,i,r,s,n,l,c),g.Matrix[0].multiplyToRef(l,l),l}static OrthoOffCenterRH(e,t,i,r,s,n,a){const o=new p;return p.OrthoOffCenterRHToRef(e,t,i,r,s,n,o,a),o}static OrthoOffCenterRHToRef(e,t,i,r,s,n,a,o){return p.OrthoOffCenterLHToRef(e,t,i,r,s,n,a,o),a._m[10]*=-1,a}static ObliqueOffCenterRHToRef(e,t,i,r,s,n,a,o,h,l,c){const u=a*Math.cos(o),_=a*Math.sin(o);return p.TranslationToRef(0,0,h,g.Matrix[1]),p.FromValuesToRef(1,0,0,0,0,1,0,0,u,_,1,0,0,0,0,1,g.Matrix[0]),g.Matrix[1].multiplyToRef(g.Matrix[0],g.Matrix[0]),p.TranslationToRef(0,0,-h,g.Matrix[1]),g.Matrix[0].multiplyToRef(g.Matrix[1],g.Matrix[0]),p.OrthoOffCenterRHToRef(e,t,i,r,s,n,l,c),g.Matrix[0].multiplyToRef(l,l),l}static PerspectiveLH(e,t,i,r,s,n=0){const a=new p,o=2*i/e,h=2*i/t,l=(r+i)/(r-i),c=-2*r*i/(r-i),u=Math.tan(n);return p.FromValuesToRef(o,0,0,0,0,h,0,u,0,0,l,1,0,0,c,0,a),s&&a.multiplyToRef(T,a),a._updateIdentityStatus(!1),a}static PerspectiveFovLH(e,t,i,r,s,n=0,a=!1){const o=new p;return p.PerspectiveFovLHToRef(e,t,i,r,o,!0,s,n,a),o}static PerspectiveFovLHToRef(e,t,i,r,s,n=!0,a,o=0,h=!1){const l=i,c=r,u=1/Math.tan(.5*e),_=n?u/t:u,d=n?u:u*t,f=h&&0===l?-1:0!==c?(c+l)/(c-l):1,g=h&&0===l?2*c:0!==c?-2*c*l/(c-l):-2*l,m=Math.tan(o);return p.FromValuesToRef(_,0,0,0,0,d,0,m,0,0,f,1,0,0,g,0,s),a&&s.multiplyToRef(T,s),s._updateIdentityStatus(!1),s}static PerspectiveFovReverseLHToRef(e,t,i,r,s,n=!0,a,o=0){const h=1/Math.tan(.5*e),l=n?h/t:h,c=n?h:h*t,u=Math.tan(o);return p.FromValuesToRef(l,0,0,0,0,c,0,u,0,0,-i,1,0,0,1,0,s),a&&s.multiplyToRef(T,s),s._updateIdentityStatus(!1),s}static PerspectiveFovRH(e,t,i,r,s,n=0,a=!1){const o=new p;return p.PerspectiveFovRHToRef(e,t,i,r,o,!0,s,n,a),o}static PerspectiveFovRHToRef(e,t,i,r,s,n=!0,a,o=0,h=!1){const l=i,c=r,u=1/Math.tan(.5*e),_=n?u/t:u,d=n?u:u*t,f=h&&0===l?1:0!==c?-(c+l)/(c-l):-1,g=h&&0===l?2*c:0!==c?-2*c*l/(c-l):-2*l,m=Math.tan(o);return p.FromValuesToRef(_,0,0,0,0,d,0,m,0,0,f,-1,0,0,g,0,s),a&&s.multiplyToRef(T,s),s._updateIdentityStatus(!1),s}static PerspectiveFovReverseRHToRef(e,t,i,r,s,n=!0,a,o=0){const h=1/Math.tan(.5*e),l=n?h/t:h,c=n?h:h*t,u=Math.tan(o);return p.FromValuesToRef(l,0,0,0,0,c,0,u,0,0,-i,-1,0,0,-1,0,s),a&&s.multiplyToRef(T,s),s._updateIdentityStatus(!1),s}static GetFinalMatrix(e,t,i,r,s,n){const a=e.width,o=e.height,h=e.x,l=e.y,c=p.FromValues(a/2,0,0,0,0,-o/2,0,0,0,0,n-s,0,h+a/2,o/2+l,s,1),u=new p;return t.multiplyToRef(i,u),u.multiplyToRef(r,u),u.multiplyToRef(c,u)}static GetAsMatrix2x2(e){const t=e.m,i=[t[0],t[1],t[4],t[5]];return a.I.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(e){const t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return a.I.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(e){const t=new p;return p.TransposeToRef(e,t),t}static TransposeToRef(e,t){const i=e.m,r=i[0],s=i[4],n=i[8],a=i[12],o=i[1],h=i[5],l=i[9],c=i[13],u=i[2],_=i[6],d=i[10],f=i[14],p=i[3],g=i[7],m=i[11],T=i[15],R=t._m;return R[0]=r,R[1]=s,R[2]=n,R[3]=a,R[4]=o,R[5]=h,R[6]=l,R[7]=c,R[8]=u,R[9]=_,R[10]=d,R[11]=f,R[12]=p,R[13]=g,R[14]=m,R[15]=T,t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(e){const t=new p;return p.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();const i=e.normal.x,r=e.normal.y,s=e.normal.z,n=-2*i,a=-2*r,o=-2*s;return p.FromValuesToRef(n*i+1,a*i,o*i,0,n*r,a*r+1,o*r,0,n*s,a*s,o*s+1,0,n*e.d,a*e.d,o*e.d,1,t),t}static FromXYZAxesToRef(e,t,i,r){return p.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,r),r}static FromQuaternionToRef(e,t){const i=e._x*e._x,r=e._y*e._y,s=e._z*e._z,n=e._x*e._y,a=e._z*e._w,o=e._z*e._x,h=e._y*e._w,l=e._y*e._z,c=e._x*e._w;return t._m[0]=1-2*(r+s),t._m[1]=2*(n+a),t._m[2]=2*(o-h),t._m[3]=0,t._m[4]=2*(n-a),t._m[5]=1-2*(s+i),t._m[6]=2*(l+c),t._m[7]=0,t._m[8]=2*(o+h),t._m[9]=2*(l-c),t._m[10]=1-2*(r+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}}p._IdentityReadOnly=p.Identity(),Object.defineProperties(p.prototype,{dimension:{value:[4,4]},rank:{value:2}});class g{}g.Vector3=(0,s.ln)(11,_.Zero),g.Matrix=(0,s.ln)(2,p.Identity),g.Quaternion=(0,s.ln)(3,f.Zero);class m{}m.Vector2=(0,s.ln)(3,u.Zero),m.Vector3=(0,s.ln)(13,_.Zero),m.Vector4=(0,s.ln)(3,d.Zero),m.Quaternion=(0,s.ln)(3,f.Zero),m.Matrix=(0,s.ln)(8,p.Identity),(0,n.Y5)("BABYLON.Vector2",u),(0,n.Y5)("BABYLON.Vector3",_),(0,n.Y5)("BABYLON.Vector4",d),(0,n.Y5)("BABYLON.Matrix",p);const T=p.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1)},4100:(e,t,i)=>{i.d(t,{Z:()=>s});var r=i(4037);class s{constructor(e,t,i,s){this.normal=new r.Pq(e,t,i),this.d=s}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new s(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=397*e^this.d,e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return 0!==e&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=s._TmpMatrix;e.invertToRef(t);const i=t.m,r=this.normal.x,n=this.normal.y,a=this.normal.z,o=this.d,h=r*i[0]+n*i[1]+a*i[2]+o*i[3],l=r*i[4]+n*i[5]+a*i[6]+o*i[7],c=r*i[8]+n*i[9]+a*i[10]+o*i[11],u=r*i[12]+n*i[13]+a*i[14]+o*i[15];return new s(h,l,c,u)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){const r=t.x-e.x,s=t.y-e.y,n=t.z-e.z,a=i.x-e.x,o=i.y-e.y,h=i.z-e.z,l=s*h-n*o,c=n*a-r*h,u=r*o-s*a,_=Math.sqrt(l*l+c*c+u*u);let d;return d=0!==_?1/_:0,this.normal.x=l*d,this.normal.y=c*d,this.normal.z=u*d,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return r.Pq.Dot(this.normal,e)<=t}signedDistanceTo(e){return r.Pq.Dot(e,this.normal)+this.d}static FromArray(e){return new s(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){const r=new s(0,0,0,0);return r.copyFromPoints(e,t,i),r}static FromPositionAndNormal(e,t){const i=new s(0,0,0,0);return this.FromPositionAndNormalToRef(e,t,i)}static FromPositionAndNormalToRef(e,t,i){return i.normal.copyFrom(t),i.normal.normalize(),i.d=-e.dot(i.normal),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){const s=-(t.x*e.x+t.y*e.y+t.z*e.z);return r.Pq.Dot(i,t)+s}}s._TmpMatrix=r.uq.Identity()},4146:(e,t,i)=>{i.d(t,{Bu:()=>n,TB:()=>r,W0:()=>s});class r{}r.KEYDOWN=1,r.KEYUP=2;class s{constructor(e,t){this.type=e,this.event=t}}class n extends s{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}},4296:(e,t,i)=>{i.d(t,{A:()=>s});var r=i(6237);class s{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,t){s.Enabled&&(this._current+=e,t&&this._fetchResult())}beginMonitoring(){s.Enabled&&(this._startMonitoringTime=r.j.Now)}endMonitoring(e=!0){if(!s.Enabled)return;e&&this.fetchNewFrame();const t=r.j.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}endFrame(){this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const e=r.j.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}s.Enabled=!0},4329:(e,t,i)=>{i.d(t,{A:()=>s});var r=i(1504);class s extends r.n{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}},4420:(e,t,i)=>{i.d(t,{M:()=>h});var r=i(9848),s=i(1137),n=i(9610),a=i(7647),o=i(2940);class h{static get ShadersRepository(){return n.l.ShadersRepository}static set ShadersRepository(e){n.l.ShadersRepository=e}get isDisposed(){return this._isDisposed}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new r.cP),this._onBindObservable}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,s=null,n,o=null,l=null,c=null,u=null,_,d="",f=0,p){this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new r.cP,this.onErrorObservable=new r.cP,this._onBindObservable=null,this._isDisposed=!1,this._refCount=1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._disableParallelShaderCompilation=!1,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this._processCodeAfterIncludes=void 0,this._processFinalCode=null,this.name=e,this._key=d;const g=this._key.replace(/\r/g,"").replace(/\n/g,"|");let m;if(t.attributes){const e=t;if(this._engine=i,this._attributesNames=e.attributes,this._uniformsNames=e.uniformsNames.concat(e.samplers),this._samplerList=e.samplers.slice(),this.defines=e.defines,this.onError=e.onError,this.onCompiled=e.onCompiled,this._fallbacks=e.fallbacks,this._indexParameters=e.indexParameters,this._transformFeedbackVaryings=e.transformFeedbackVaryings||null,this._multiTarget=!!e.multiTarget,this._shaderLanguage=e.shaderLanguage??0,this._disableParallelShaderCompilation=!!e.disableParallelShaderCompilation,e.uniformBuffersNames){this._uniformBuffersNamesList=e.uniformBuffersNames.slice();for(let t=0;t<e.uniformBuffersNames.length;t++)this._uniformBuffersNames[e.uniformBuffersNames[t]]=t}this._processFinalCode=e.processFinalCode??null,this._processCodeAfterIncludes=e.processCodeAfterIncludes??void 0,p=e.extraInitializationsAsync,m=e.existingPipelineContext}else this._engine=n,this.defines=null==o?"":o,this._uniformsNames=i.concat(s),this._samplerList=s?s.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=f,this.onError=u,this.onCompiled=c,this._indexParameters=_,this._fallbacks=l;"WEBGL2"===this._engine.shaderPlatformName&&(m=(0,a.b4)(g,this._engine._gl)??m),this._attributeLocationByName={},this.uniqueId=h._UniqueIdSeed++,m?(this._pipelineContext=m,this._pipelineContext.setEngine(this._engine),this._onRenderingStateCompiled(this._pipelineContext),this._pipelineContext.program&&(this._pipelineContext.program.__SPECTOR_rebuildProgram=this._rebuildProgram.bind(this))):this._processShaderCodeAsync(null,!1,null,p),this._engine.onReleaseEffectsObservable.addOnce((()=>{this.isDisposed||this.dispose(!0)}))}async _processShaderCodeAsync(e=null,t=!1,i=null,r){r&&await r(),this._processingContext=i||this._engine._getShaderProcessingContext(this._shaderLanguage,!1);const s={defines:this.defines.split("\n"),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:e??this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:n.l.GetShadersRepository(this._shaderLanguage),includesShadersStore:n.l.GetIncludesShadersStore(this._shaderLanguage),version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:this._processCodeAfterIncludes};(0,a.JH)(s,this.name,this._processFinalCode,((e,i)=>{this._vertexSourceCode=e,this._fragmentSourceCode=i,this._prepareEffect(t)}),this._shaderLanguage,this._engine,this)}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return!!this._engine.isDisposed||!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}async whenCompiledAsync(){return await new Promise((e=>{this.executeWhenCompiled(e)}))}executeWhenCompiled(e){this.isReady()?e(this):(this.onCompileObservable.add((t=>{e(t)})),this._pipelineContext&&!this._pipelineContext.isAsync||this._checkIsReady(null))}_checkIsReady(e){(0,o.B)((()=>this._isReadyInternal()||this._isDisposed),(()=>{}),(t=>{this._processCompilationErrors(t,e)}),16,12e4,!0,` - Effect: ${"string"==typeof this.name?this.name:this.key}`)}get vertexSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:this._pipelineContext?._getVertexShaderCode()??this._vertexSourceCode}get fragmentSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:this._pipelineContext?._getFragmentShaderCode()??this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}getPipelineGenerationOptions(){return{platformName:this._engine.shaderPlatformName,shaderLanguage:this._shaderLanguage,shaderNameOrContent:this.name,key:this._key,defines:this.defines.split("\n"),addGlobalDefines:!1,extendedProcessingOptions:{indexParameters:this._indexParameters,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,supportsUniformBuffers:this._engine.supportsUniformBuffers},extendedCreatePipelineOptions:{transformFeedbackVaryings:this._transformFeedbackVaryings,createAsRaw:!(!this._vertexSourceCodeOverride||!this._fragmentSourceCodeOverride)}}}_rebuildProgram(e,t,i,r){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(e,t)=>{r&&r(t)},this.onCompiled=()=>{const e=this.getEngine().scenes;if(e)for(let t=0;t<e.length;t++)e[t].markAllMaterialsAsDirty(127);this._pipelineContext._handlesSpectorRebuildCallback?.(i)},this._fallbacks=null,this._prepareEffect()}_onRenderingStateCompiled(e){if(this._pipelineContext=e,this._pipelineContext.setEngine(this._engine),this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,this._attributesNames,this._attributes),this._attributesNames)for(let e=0;e<this._attributesNames.length;e++){const t=this._attributesNames[e];this._attributeLocationByName[t]=this._attributes[e]}this._engine.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),h.AutomaticallyClearCodeCache&&this.clearCodeCache()}_prepareEffect(e=!1){const t=this._pipelineContext;this._isReady=!1;try{const i=!(!this._vertexSourceCodeOverride||!this._fragmentSourceCodeOverride),r=i?null:this.defines,s=i?this._vertexSourceCodeOverride:this._vertexSourceCode,n=i?this._fragmentSourceCodeOverride:this._fragmentSourceCode,o=this._engine;this._pipelineContext=(0,a.uR)({existingPipelineContext:e?t:null,vertex:s,fragment:n,context:"WEBGL2"===o.shaderPlatformName||"WEBGL1"===o.shaderPlatformName?o._gl:void 0,rebuildRebind:(e,t,i,r)=>this._rebuildProgram(e,t,i,r),defines:r,transformFeedbackVaryings:this._transformFeedbackVaryings,name:this._key.replace(/\r/g,"").replace(/\n/g,"|"),createAsRaw:i,disableParallelCompilation:this._disableParallelShaderCompilation,shaderProcessingContext:this._processingContext,onRenderingStateCompiled:i=>{t&&!e&&this._engine._deletePipelineContext(t),i&&this._onRenderingStateCompiled(i)}},this._engine.createPipelineContext.bind(this._engine),this._engine._preparePipelineContextAsync.bind(this._engine),this._engine._executeWhenRenderingStateIsCompiled.bind(this._engine)),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(e){this._processCompilationErrors(e,t)}}_getShaderCodeAndErrorLine(e,t,i){const r=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let s=null;if(t&&e){const n=t.match(r);if(n&&2===n.length){const t=parseInt(n[1]),r=e.split("\n",-1);r.length>=t&&(s=`Offending line [${t}] in ${i?"fragment":"vertex"} code: ${r[t-1]}`)}}return[e,s]}_processCompilationErrors(e,t=null){this._compilationError=e.message;const i=this._attributesNames,r=this._fallbacks;if(s.V.Error("Unable to compile effect:"),s.V.Error(`Uniforms: ${this._uniformsNames.join(" ")}`),s.V.Error(`Attributes: ${i.join(" ")}`),s.V.Error("Defines:\n"+this.defines),h.LogShaderCodeOnCompilationError){let e=null,t=null,i=null;this._pipelineContext?._getVertexShaderCode()&&([i,e]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),i&&(s.V.Error("Vertex code:"),s.V.Error(i))),this._pipelineContext?._getFragmentShaderCode()&&([i,t]=this._getShaderCodeAndErrorLine(this._pipelineContext?._getFragmentShaderCode(),this._compilationError,!0),i&&(s.V.Error("Fragment code:"),s.V.Error(i))),e&&s.V.Error(e),t&&s.V.Error(t)}s.V.Error("Error: "+this._compilationError);const n=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this),this._engine.onEffectErrorObservable.notifyObservers({effect:this,errors:this._compilationError})};t&&(this._pipelineContext=t,this._isReady=!0,n()),r?(this._pipelineContext=null,r.hasMoreFallbacks?(this._allFallbacksProcessed=!1,s.V.Error("Trying next fallback."),this.defines=r.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,n(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||n())}get isSupported(){return""===this._compilationError}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){const i=e+"Ex";if(-1===this._samplerList.indexOf(i+"0")){const r=this._samplerList.indexOf(e);for(let e=1;e<t.length;e++){const t=i+(e-1).toString();this._samplerList.splice(r+e,0,t)}let s=0;for(const e of this._samplerList)this._samplers[e]=s,s+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}bindUniformBuffer(e,t){const i=this._uniformBuffersNames[t];void 0===i||h._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(h._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setInt3(e,t,i,r){return this._pipelineContext.setInt3(e,t,i,r),this}setInt4(e,t,i,r,s){return this._pipelineContext.setInt4(e,t,i,r,s),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setUInt(e,t),this}setUInt2(e,t,i){return this._pipelineContext.setUInt2(e,t,i),this}setUInt3(e,t,i,r){return this._pipelineContext.setUInt3(e,t,i,r),this}setUInt4(e,t,i,r,s){return this._pipelineContext.setUInt4(e,t,i,r,s),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,i){return this._pipelineContext.setFloat2(e,t,i),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,i,r){return this._pipelineContext.setFloat3(e,t,i,r),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,i,r,s){return this._pipelineContext.setFloat4(e,t,i,r,s),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,i){return this._pipelineContext.setColor4(e,t,i),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}clearCodeCache(){this._vertexSourceCode="",this._fragmentSourceCode="",this._fragmentSourceCodeBeforeMigration="",this._vertexSourceCodeBeforeMigration=""}dispose(e=!1){if(e)this._refCount=0;else{if(h.PersistentMode)return;this._refCount--}this._refCount>0||this._isDisposed||(this._pipelineContext&&(0,a.mO)(this._pipelineContext),this._engine._releaseEffect(this),this.clearCodeCache(),this._isDisposed=!0)}static RegisterShader(e,t,i,r=0){t&&(n.l.GetShadersStore(r)[`${e}PixelShader`]=t),i&&(n.l.GetShadersStore(r)[`${e}VertexShader`]=i)}static ResetCache(){h._BaseCache={}}}h.LogShaderCodeOnCompilationError=!0,h.PersistentMode=!1,h.AutomaticallyClearCodeCache=!1,h._UniqueIdSeed=0,h._BaseCache={},h.ShadersStore=n.l.ShadersStore,h.IncludesShadersStore=n.l.IncludesShadersStore},4494:(e,t,i)=>{i.d(t,{L:()=>r});class r{constructor(e,t,i,r){this.x=e,this.y=t,this.width=i,this.height=r}toGlobal(e,t){return new r(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new r(this.x,this.y,this.width,this.height)}}},4700:(e,t,i)=>{i.d(t,{R:()=>u});var r=i(1504),s=i(1137);function n(e,t,i,r){switch(t){case 5120:{let t=e.getInt8(i);return r&&(t=Math.max(t/127,-1)),t}case 5121:{let t=e.getUint8(i);return r&&(t/=255),t}case 5122:{let t=e.getInt16(i,!0);return r&&(t=Math.max(t/32767,-1)),t}case 5123:{let t=e.getUint16(i,!0);return r&&(t/=65535),t}case 5124:return e.getInt32(i,!0);case 5125:return e.getUint32(i,!0);case 5126:return e.getFloat32(i,!0);default:throw new Error(`Invalid component type ${t}`)}}function a(e,t,i,r,s){switch(t){case 5120:r&&(s=Math.round(127*s)),e.setInt8(i,s);break;case 5121:r&&(s=Math.round(255*s)),e.setUint8(i,s);break;case 5122:r&&(s=Math.round(32767*s)),e.setInt16(i,s,!0);break;case 5123:r&&(s=Math.round(65535*s)),e.setUint16(i,s,!0);break;case 5124:e.setInt32(i,s,!0);break;case 5125:e.setUint32(i,s,!0);break;case 5126:e.setFloat32(i,s,!0);break;default:throw new Error(`Invalid component type ${t}`)}}function o(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:throw new Error(`Invalid type '${e}'`)}}function h(e,t,i,r,s,h,l,c){const u=new Array(r),_=new Array(r);if(e instanceof Array){let s=t/4;const n=i/4;for(let t=0;t<h;t+=r){for(let t=0;t<r;t++)u[t]=_[t]=e[s+t];c(_,t);for(let t=0;t<r;t++)u[t]!==_[t]&&(e[s+t]=_[t]);s+=n}}else{const d=ArrayBuffer.isView(e)?new DataView(e.buffer,e.byteOffset,e.byteLength):new DataView(e),f=o(s);for(let e=0;e<h;e+=r){for(let e=0,i=t;e<r;e++,i+=f)u[e]=_[e]=n(d,s,i,l);c(_,e);for(let e=0,i=t;e<r;e++,i+=f)u[e]!==_[e]&&a(d,s,i,l,_[e]);t+=i}}}function l(e,t,i,r,n,a,l,c){const u=t*o(i),_=l*t;if(5126!==i||n!==u){const s=new Float32Array(_);return h(e,r,n,t,i,_,a,((e,i)=>{for(let r=0;r<t;r++)s[i+r]=e[r]})),s}if(!(e instanceof Array||e instanceof Float32Array)||0!==r||e.length!==_){if(e instanceof Array){const t=r/4;return e.slice(t,t+_)}if(e instanceof ArrayBuffer)return new Float32Array(e,r,_);{const t=e.byteOffset+r;return 3&t&&(s.V.Warn("Float array must be aligned to 4-bytes border"),c=!0),c?new Float32Array(e.buffer.slice(t,t+_*Float32Array.BYTES_PER_ELEMENT)):new Float32Array(e.buffer,t,_)}}return c?e.slice():e}class c{get isDisposed(){return this._isDisposed}constructor(e,t,i,s=0,n=!1,a=!1,o=!1,h,l){this._isAlreadyOwned=!1,this._isDisposed=!1,e&&e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=a,this._divisor=h||1,this._label=l,t instanceof r.n?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=o?s:s*Float32Array.BYTES_PER_ELEMENT,n||this.create()}createVertexBuffer(e,t,i,r,s,n=!1,a){const o=n?t:t*Float32Array.BYTES_PER_ELEMENT,h=r?n?r:r*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new u(this._engine,this,e,this._updatable,!0,h,void 0===s?this._instanced:s,o,i,void 0,void 0,!0,this._divisor||a)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data)&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e,this._label),this._data=e):this._buffer=this._engine.createVertexBuffer(e,void 0,this._label))}_rebuild(){if(this._data)this._buffer=null,this.create(this._data);else{if(!this._buffer)return;if(this._buffer.capacity>0)return void(this._updatable?this._buffer=this._engine.createDynamicVertexBuffer(this._buffer.capacity,this._label):this._buffer=this._engine.createVertexBuffer(this._buffer.capacity,void 0,this._label));s.V.Warn(`Missing data for buffer "${this._label}" ${this._buffer?"(uniqueId: "+this._buffer.uniqueId+")":""}. Buffer reconstruction failed.`),this._buffer=null}}update(e){this.create(e)}updateDirectly(e,t,i,r=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,r?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),this._data=0===t&&void 0===i?e:null)}_increaseReferences(){this._buffer&&(this._isAlreadyOwned?this._buffer.references++:this._isAlreadyOwned=!0)}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._isDisposed=!0,this._data=null,this._buffer=null)}}class u{get isDisposed(){return this._isDisposed}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=0!=e;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}get _maxVerticesCount(){const e=this.getData();return e?Array.isArray(e)?e.length/(this.byteStride/4)-this.byteOffset/4:(e.byteLength-this.byteOffset)/this.byteStride:0}constructor(e,t,i,r,s,n,a,h,l,_,d=!1,f=!1,p=1,g=!1){this._isDisposed=!1;let m=!1;if(this.engine=e,"object"==typeof r&&null!==r?(m=r.updatable??!1,s=r.postponeInternalCreation,n=r.stride,a=r.instanced,h=r.offset,l=r.size,_=r.type,d=r.normalized??!1,f=r.useBytes??!1,p=r.divisor??1,g=r.takeBufferOwnership??!1,this._label=r.label):m=!!r,t instanceof c?(this._buffer=t,this._ownsBuffer=g):(this._buffer=new c(e,t,m,n,s,a,f,p,this._label),this._ownsBuffer=!0),this.uniqueId=u._Counter++,this._kind=i,void 0===_){const e=this.getData();this.type=e?u.GetDataType(e):u.FLOAT}else this.type=_;const T=o(this.type);f?(this._size=l||(n?n/T:u.DeduceStride(i)),this.byteStride=n||this._buffer.byteStride||this._size*T,this.byteOffset=h||0):(this._size=l||n||u.DeduceStride(i),this.byteStride=n?n*T:this._buffer.byteStride||this._size*T,this.byteOffset=(h||0)*T),this.normalized=d,this._instanced=void 0!==a&&a,this._instanceDivisor=a?p:0,this._alignBuffer(),this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120|0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){this._buffer?._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const i=this.getData();return i?l(i,this._size,this.type,this.byteOffset,this.byteStride,this.normalized,e,t):null}getBuffer(){return this._buffer.getBuffer()}getWrapperBuffer(){return this._buffer}getStrideSize(){return this.byteStride/o(this.type)}getOffset(){return this.byteOffset/o(this.type)}getSize(e=!1){return e?this._size*o(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e),this._alignBuffer()}update(e){this._buffer.update(e),this._alignBuffer()}updateDirectly(e,t,i=!1){this._buffer.updateDirectly(e,t,void 0,i),this._alignBuffer()}dispose(){this._ownsBuffer&&this._buffer.dispose(),this._isDisposed=!0}forEach(e,t){h(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,((e,i)=>{for(let r=0;r<this._size;r++)t(e[r],i+r)}))}_alignBuffer(){}static DeduceStride(e){switch(e){case u.UVKind:case u.UV2Kind:case u.UV3Kind:case u.UV4Kind:case u.UV5Kind:case u.UV6Kind:return 2;case u.NormalKind:case u.PositionKind:return 3;case u.ColorKind:case u.ColorInstanceKind:case u.MatricesIndicesKind:case u.MatricesIndicesExtraKind:case u.MatricesWeightsKind:case u.MatricesWeightsExtraKind:case u.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetDataType(e){return e instanceof Int8Array?u.BYTE:e instanceof Uint8Array?u.UNSIGNED_BYTE:e instanceof Int16Array?u.SHORT:e instanceof Uint16Array?u.UNSIGNED_SHORT:e instanceof Int32Array?u.INT:e instanceof Uint32Array?u.UNSIGNED_INT:u.FLOAT}static GetTypeByteLength(e){return o(e)}static ForEach(e,t,i,r,s,n,a,o){h(e,t,i,r,s,n,a,((e,t)=>{for(let i=0;i<r;i++)o(e[i],t+i)}))}static GetFloatData(e,t,i,r,s,n,a,o){return l(e,t,i,r,s,n,a,o)}}u._Counter=0,u.BYTE=5120,u.UNSIGNED_BYTE=5121,u.SHORT=5122,u.UNSIGNED_SHORT=5123,u.INT=5124,u.UNSIGNED_INT=5125,u.FLOAT=5126,u.PositionKind="position",u.NormalKind="normal",u.TangentKind="tangent",u.UVKind="uv",u.UV2Kind="uv2",u.UV3Kind="uv3",u.UV4Kind="uv4",u.UV5Kind="uv5",u.UV6Kind="uv6",u.ColorKind="color",u.ColorInstanceKind="instanceColor",u.MatricesIndicesKind="matricesIndices",u.MatricesWeightsKind="matricesWeights",u.MatricesIndicesExtraKind="matricesIndicesExtra",u.MatricesWeightsExtraKind="matricesWeightsExtra"},4867:(e,t,i)=>{function r(e,t,i=1401298e-51){return Math.abs(e-t)<=i}function s(e,t){return e===t?e:Math.random()*(t-e)+e}function n(e,t,i){return e+(t-e)*i}function a(e,t=0,i=1){return Math.min(i,Math.max(t,e))}function o(e){return e-2*Math.PI*Math.floor((e+Math.PI)/(2*Math.PI))}function h(e){const t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()}function l(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(0===e)return-1/0;let t=0;if(e<1){for(;e<1;)t++,e*=2;t=-t}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t}i.d(t,{C0:()=>l,Db:()=>h,Mj:()=>r,OQ:()=>a,VD:()=>s,cP:()=>n,ed:()=>o})},5503:(e,t,i)=>{i.d(t,{n:()=>s});const r={};function s(e,t=!1){if(!t||!r[e])return r[e]=!0,`${e} needs to be imported before as it contains a side-effect required by your code.`}},5524:(e,t,i)=>{function r(e,t,i,r){var s,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(a=(n<3?s(a):n>3?s(t,i,a):s(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a}i.d(t,{Cg:()=>r}),Object.create,Object.create},5559:(e,t,i)=>{i.d(t,{bH:()=>n,rv:()=>r,tk:()=>s});const r=1/2.2,s=2.2,n=(Math.sqrt(5),.001)},5847:(e,t,i)=>{i.d(t,{S:()=>B});var r=i(5524),s=i(9259),n=i(4037),a=i(7931),o=i(350),h=i(9848),l=i(6315),c=i(5503),u=i(6877);class _{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new h.cP,this._onClonedObservable=new h.cP}}class d{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,r){const s=this._NodeConstructors[e];return s?s(t,i,r):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return!!this._nodeDataStorage._doNotSerialize||!!this._parentNode&&this._parentNode.doNotSerialize}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const t=this._parentNode;if(this._parentNode&&void 0!==this._parentNode._children&&null!==this._parentNode._children){const t=this._parentNode._children.indexOf(this);-1!==t&&this._parentNode._children.splice(t,1),e||this._nodeDataStorage._isDisposed||this._addToSceneRootNodes()}this._parentNode=e,this._isDirty=!0,this._parentNode&&(void 0!==this._parentNode._children&&null!==this._parentNode._children||(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){-1===this._nodeDataStorage._sceneRootNodesIndex&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(-1!==this._nodeDataStorage._sceneRootNodesIndex){const e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null,i=!0){this._isDirty=!1,this._nodeDataStorage=new _,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new h.cP,this._parentContainer=null,this.animations=[],this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=n.uq.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new h.cP,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||l.q.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache(),i&&this._addToSceneRootNodes()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return-1!==this._behaviors.indexOf(e)||(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce((()=>{e.attach(this)})):e.attach(this),this._behaviors.push(e)),this}removeBehavior(e){const t=this._behaviors.indexOf(e);return-1===t||(this._behaviors[t].detach(),this._behaviors.splice(t,1)),this}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={}}updateCache(e){!e&&this.isSynchronized()||this._updateCache()}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return!this._parentNode||!this._parentNode._isDirty&&this._parentUpdateId===this._parentNode._childUpdateId&&this._parentNode.isSynchronized()}isSynchronized(){return!(this._parentNode&&!this.isSynchronizedWithParent())&&this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return!1===e?this._nodeDataStorage._isEnabled:!!this._nodeDataStorage._isEnabled&&this._nodeDataStorage._isParentEnabled}_syncParentEnabledState(){if(this._nodeDataStorage._isParentEnabled=!this._parentNode||this._parentNode.isEnabled(),this._children)for(const e of this._children)e._syncParentEnabledState()}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return!!this.parent&&(this.parent===e||this.parent.isDescendantOf(e))}_getDescendants(e,t=!1,i){if(this._children)for(let r=0;r<this._children.length;r++){const s=this._children[r];i&&!i(s)||e.push(s),t||s._getDescendants(e,!1,i)}}getDescendants(e,t){const i=[];return this._getDescendants(i,e,t),i}getChildMeshes(e,t){const i=[];return this._getDescendants(i,e,(e=>(!t||t(e))&&void 0!==e.cullingStrategy)),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){e!==this._nodeDataStorage._isReady&&(e?(this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0):this._nodeDataStorage._isReady=!1)}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){const i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=d._AnimationRangeFactory(e,t,i);for(let r=0,s=this.animations.length;r<s;r++)this.animations[r]&&this.animations[r].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.animations.length;i<r;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}clone(e,t,i){const r=u.p.Clone((()=>new d(e,this.getScene())),this);if(t&&(r.parent=t),!i){const t=this.getDescendants(!0);for(let i=0;i<t.length;i++){const s=t[i];s.clone(e+"."+s.name,r)}}return r}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,r){const s=this.getAnimationRange(e);return s?this._scene.beginAnimation(this,s.from,s.to,t,i,r):null}serializeAnimationRanges(){const e=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const r={};r.name=t,r.from=i.from,r.to=i.to,e.push(r)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=n.uq.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){const i=this.getDescendants(!0);for(const r of i)r.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const e of this._behaviors)e.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let i=0;i<t.ranges.length;i++){const r=t.ranges[i];e.createAnimationRange(r.name,r.from,r.to)}}getHierarchyBoundingVectors(e=!0,t=null){let i,r;this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);const s=this;if(s.getBoundingInfo&&s.subMeshes){const e=s.getBoundingInfo();i=e.boundingBox.minimumWorld.clone(),r=e.boundingBox.maximumWorld.clone()}else i=new n.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new n.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const e=this.getDescendants(!1);for(const s of e){const e=s;if(e.computeWorldMatrix(!0),t&&!t(e))continue;if(!e.getBoundingInfo||0===e.getTotalVertices())continue;const a=e.getBoundingInfo().boundingBox,o=a.minimumWorld,h=a.maximumWorld;n.Pq.CheckExtends(o,i,r),n.Pq.CheckExtends(h,i,r)}}return{min:i,max:r}}}d._AnimationRangeFactory=(e,t,i)=>{throw(0,c.n)("AnimationRange")},d._NodeConstructors={},(0,r.Cg)([(0,s.lK)()],d.prototype,"name",void 0),(0,r.Cg)([(0,s.lK)()],d.prototype,"id",void 0),(0,r.Cg)([(0,s.lK)()],d.prototype,"uniqueId",void 0),(0,r.Cg)([(0,s.lK)()],d.prototype,"state",void 0),(0,r.Cg)([(0,s.lK)()],d.prototype,"metadata",void 0);var f=i(1137),p=i(6552),g=i(4494),m=i(2572);class T extends d{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){let e=0,t=0;if(this.mode===T.PERSPECTIVE_CAMERA)this.fovMode===T.FOVMODE_VERTICAL_FIXED?(t=2*this.minZ*Math.tan(this.fov/2),e=this.getEngine().getAspectRatio(this)*t):(e=2*this.minZ*Math.tan(this.fov/2),t=e/this.getEngine().getAspectRatio(this));else{const i=this.getEngine().getRenderWidth()/2,r=this.getEngine().getRenderHeight()/2;e=(this.orthoRight??i)-(this.orthoLeft??-i),t=(this.orthoTop??r)-(this.orthoBottom??-r)}return e*t}set orthoLeft(e){this._orthoLeft=e;for(const t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(const t of this._rigCameras)t.mode=e}get mode(){return this._mode}get hasMoved(){return this._hasMoved}constructor(e,t,i,r=!0){super(e,i,!1),this._position=n.Pq.Zero(),this._upVector=n.Pq.Up(),this.oblique=null,this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=T.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new g.L(0,0,1,1),this.layerMask=268435455,this.fovMode=T.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=T.RIG_MODE_NONE,this.customRenderTargets=[],this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new h.cP,this.onProjectionMatrixChangedObservable=new h.cP,this.onAfterCheckInputsObservable=new h.cP,this.onRestoreStateObservable=new h.cP,this.isRigCamera=!1,this._hasMoved=!1,this._rigCameras=new Array,this._skipRendering=!1,this._projectionMatrix=new n.uq,this._postProcesses=new Array,this._activeMeshes=new a.L(256),this._globalPosition=n.Pq.Zero(),this._computedViewMatrix=n.uq.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=n.uq.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=n.PT.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),r&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}hasStateStored(){return!!this._stateStored}_restoreStateValues(){return!!this._stateStored&&(this.fov=this._storedFov,!0)}restoreState(){return!!this._restoreStateValues()&&(this.onRestoreStateObservable.notifyObservers(this),!0)}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return-1!==this._activeMeshes.indexOf(e)}isReady(e=!1){if(e)for(const e of this._postProcesses)if(e&&!e.isReady())return!1;return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new n.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new n.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.obliqueAngle=void 0,this._cache.obliqueLength=void 0,this._cache.obliqueOffset=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return!!super._isSynchronized()&&this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent()}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;const t=this.getEngine();return this.mode===T.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:(e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),this.oblique&&(e=e&&this._cache.obliqueAngle===this.oblique.angle&&this._cache.obliqueLength===this.oblique.length&&this._cache.obliqueOffset===this.oblique.offset)),e}attachControl(e,t){}detachControl(e){}update(){this._hasMoved=!1,this._checkInputs(),this.cameraRigMode!==T.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(null!==this._postProcesses[e])return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let e=0,t=this._rigCameras.length;e<t;e++){const t=this._rigCameras[e],i=t._rigPostProcess;i?("pass"===i.getEffectName()&&(t.isIntermediate=0===this._postProcesses.length),t._postProcesses=this._postProcesses.slice(0).concat(i),i.markTextureDirty()):t._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(f.V.Error("You're trying to reuse a post process not defined as reusable."),0):(null==t||t<0?this._postProcesses.push(e):null===this._postProcesses[t]?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()||this.getViewMatrix(),this._worldMatrix}_getViewMatrix(){return n.uq.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()||(this._hasMoved=!0,this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix)),this._computedViewMatrix}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,void 0!==e&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;const t=this.getEngine(),i=this.getScene(),r=t.useReverseDepthBuffer;if(this.mode===T.PERSPECTIVE_CAMERA){let e;this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=t.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1),e=i.useRightHandedSystem?n.uq.PerspectiveFovRHToRef:n.uq.PerspectiveFovLHToRef,e(this.fov,t.getAspectRatio(this),r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===T.FOVMODE_VERTICAL_FIXED,t.isNDCHalfZRange,this.projectionPlaneTilt,r)}else{const e=t.getRenderWidth()/2,s=t.getRenderHeight()/2;i.useRightHandedSystem?this.oblique?n.uq.ObliqueOffCenterRHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-s,this.orthoTop??s,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):n.uq.OrthoOffCenterRHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-s,this.orthoTop??s,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange):this.oblique?n.uq.ObliqueOffCenterLHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-s,this.orthoTop??s,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):n.uq.OrthoOffCenterLHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-s,this.orthoTop??s,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.obliqueAngle=this.oblique?.angle,this._cache.obliqueLength=this.oblique?.length,this._cache.obliqueOffset=this.oblique?.offset,this._cache.renderWidth=t.getRenderWidth(),this._cache.renderHeight=t.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_computeObliqueDistance(e){return(this.radius||(this.target?n.Pq.Distance(this.position,this.target):this.position.length()))+e}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?m.P.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=m.P.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let t=!1;for(const i of this.rigCameras)i._updateFrustumPlanes(),t=t||e.isInFrustum(i._frustumPlanes);return t}return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw(0,c.n)("Ray")}getForwardRayToRef(e,t=100,i,r){throw(0,c.n)("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const e=this._rigCameras.pop();e&&e.dispose()}if(this._parentContainer){const e=this._parentContainer.cameras.indexOf(this);e>-1&&this._parentContainer.cameras.splice(e,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==T.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let e=this._postProcesses.length;for(;--e>=0;){const t=this._postProcesses[e];t&&t.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const e=this._rigCameras.pop();e&&e.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=o.S0.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==T.RIG_MODE_NONE){const e=this.createRigCamera(this.name+"_L",0);e&&(e._isLeftCamera=!0);const t=this.createRigCamera(this.name+"_R",1);t&&(t._isRightCamera=!0),e&&t&&(this._rigCameras.push(e),this._rigCameras.push(t))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return n.uq.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,"interaxialDistance"===e&&(this._cameraRigParams.stereoHalfAngle=o.S0.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===T.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){const e=u.p.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),u.p.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){const i=u.p.Clone(T.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){const t=n.Pq.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){n.Pq.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,r=0,s=!0){return d.Construct(e,t,i,{interaxial_distance:r,isStereoscopicSideBySide:s})||(()=>T._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){const i=e.type,r=T.GetConstructorFromName(i,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),s=u.p.Parse(r,e,t);if(void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),s.inputs&&(s.inputs.parse(e),s._setupInputs()),e.upVector&&(s.upVector=n.Pq.FromArray(e.upVector)),s.setPosition&&(s.position.copyFromFloats(0,0,0),s.setPosition(n.Pq.FromArray(e.position))),e.target&&s.setTarget&&s.setTarget(n.Pq.FromArray(e.target)),e.cameraRigMode){const t=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};s.setCameraRigMode(e.cameraRigMode,t)}if(e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],r=(0,p.n9)("BABYLON.Animation");r&&s.animations.push(r.Parse(i))}d.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&s.setEnabled(e.isEnabled),s}_calculateHandednessMultiplier(){let e=this.getScene().useRightHandedSystem?-1:1;return this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}}T._CreateDefaultParsedCamera=(e,t)=>{throw(0,c.n)("UniversalCamera")},T.PERSPECTIVE_CAMERA=0,T.ORTHOGRAPHIC_CAMERA=1,T.FOVMODE_VERTICAL_FIXED=0,T.FOVMODE_HORIZONTAL_FIXED=1,T.RIG_MODE_NONE=0,T.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,T.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,T.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,T.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,T.RIG_MODE_STEREOSCOPIC_INTERLACED=14,T.RIG_MODE_VR=20,T.RIG_MODE_CUSTOM=22,T.ForceAttachControlToAlwaysPreventDefault=!1,(0,r.Cg)([(0,s.P_)("position")],T.prototype,"_position",void 0),(0,r.Cg)([(0,s.P_)("upVector")],T.prototype,"_upVector",void 0),(0,r.Cg)([(0,s.lK)()],T.prototype,"orthoLeft",null),(0,r.Cg)([(0,s.lK)()],T.prototype,"orthoRight",null),(0,r.Cg)([(0,s.lK)()],T.prototype,"orthoBottom",null),(0,r.Cg)([(0,s.lK)()],T.prototype,"orthoTop",null),(0,r.Cg)([(0,s.lK)()],T.prototype,"fov",void 0),(0,r.Cg)([(0,s.lK)()],T.prototype,"projectionPlaneTilt",void 0),(0,r.Cg)([(0,s.lK)()],T.prototype,"minZ",void 0),(0,r.Cg)([(0,s.lK)()],T.prototype,"maxZ",void 0),(0,r.Cg)([(0,s.lK)()],T.prototype,"inertia",void 0),(0,r.Cg)([(0,s.lK)()],T.prototype,"mode",null),(0,r.Cg)([(0,s.lK)()],T.prototype,"layerMask",void 0),(0,r.Cg)([(0,s.lK)()],T.prototype,"fovMode",void 0),(0,r.Cg)([(0,s.lK)()],T.prototype,"cameraRigMode",void 0),(0,r.Cg)([(0,s.lK)()],T.prototype,"interaxialDistance",void 0),(0,r.Cg)([(0,s.lK)()],T.prototype,"isStereoscopicSideBySide",void 0);var R=i(5559),y=i(8733);d.AddNodeConstructor("TargetCamera",((e,t)=>()=>new b(e,n.Pq.Zero(),t)));class b extends T{constructor(e,t,i,r=!0){super(e,t,i,r),this.cameraDirection=new n.Pq(0,0,0),this.cameraRotation=new n.I9(0,0),this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new n.PT,this.rotation=new n.Pq(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=n.Pq.Zero(),this._initialFocalDistance=1,this._viewMatrix=n.uq.Zero(),this._camMatrix=n.uq.Zero(),this._cameraTransformMatrix=n.uq.Zero(),this._cameraRotationMatrix=n.uq.Zero(),this._referencePoint=new n.Pq(0,0,1),this._transformedReferencePoint=n.Pq.Zero(),this._deferredPositionUpdate=new n.Pq,this._deferredRotationQuaternionUpdate=new n.PT,this._deferredRotationUpdate=new n.Pq,this._deferredUpdated=!1,this._deferOnly=!1,this._defaultUp=n.Pq.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(e){this.getWorldMatrix();const t=n.AA.Vector3[0],i=n.AA.Vector3[1];return i.set(0,0,this._scene.useRightHandedSystem?-1:1),this.getDirectionToRef(i,t),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){const e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return!!super._restoreStateValues()&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0)}_initCache(){super._initCache(),this._cache.lockedTarget=new n.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new n.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new n.PT(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();const t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;const e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(100*e.getFps()))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=R.bH),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),n.uq.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);const t=e.subtract(this.position);t.x>=0?this.rotation.y=-Math.atan(t.z/t.x)+Math.PI/2:this.rotation.y=-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&n.PT.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent)return this.parent.getWorldMatrix().invertToRef(n.AA.Matrix[0]),n.Pq.TransformNormalToRef(this.cameraDirection,n.AA.Matrix[0],n.AA.Vector3[0]),this._deferredPositionUpdate.addInPlace(n.AA.Vector3[0]),void(this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate));this._deferredPositionUpdate.addInPlace(this.cameraDirection),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate)}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=this.cameraRotation.x||this.cameraRotation.y;if(this._deferredUpdated=!1,this._deferredRotationUpdate.copyFrom(this.rotation),this._deferredPositionUpdate.copyFrom(this.position),this.rotationQuaternion&&this._deferredRotationQuaternionUpdate.copyFrom(this.rotationQuaternion),t&&this._updatePosition(),i){if(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this._deferredRotationUpdate),this._deferredRotationUpdate.x+=this.cameraRotation.x*e,this._deferredRotationUpdate.y+=this.cameraRotation.y*e,!this.noRotationConstraint){const e=1.570796;this._deferredRotationUpdate.x>e&&(this._deferredRotationUpdate.x=e),this._deferredRotationUpdate.x<-e&&(this._deferredRotationUpdate.x=-e)}this._deferOnly?this._deferredUpdated=!0:this.rotation.copyFrom(this._deferredRotationUpdate),this.rotationQuaternion&&this._deferredRotationUpdate.lengthSquared()&&(n.PT.RotationYawPitchRollToRef(this._deferredRotationUpdate.y,this._deferredRotationUpdate.x,this._deferredRotationUpdate.z,this._deferredRotationQuaternionUpdate),this._deferOnly?this._deferredUpdated=!0:this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate))}t&&(Math.abs(this.cameraDirection.x)<this.speed*R.bH&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*R.bH&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*R.bH&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*R.bH&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*R.bH&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):n.uq.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return n.Pq.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),n.Pq.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?y._0.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(n.PT.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),y._0.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.getScene().useRightHandedSystem?n.uq.LookAtRHToRef(e,t,i,this._viewMatrix):n.uq.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){const e=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(e,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==T.RIG_MODE_NONE){const t=new b(e,this.position.clone(),this.getScene());return t.isRigCamera=!0,t.rigParent=this,this.cameraRigMode===T.RIG_MODE_VR&&(this.rotationQuaternion||(this.rotationQuaternion=new n.PT),t._cameraRigParams={},t.rotationQuaternion=new n.PT),t.mode=this.mode,t.orthoLeft=this.orthoLeft,t.orthoRight=this.orthoRight,t.orthoTop=this.orthoTop,t.orthoBottom=this.orthoBottom,t}return null}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case T.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case T.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case T.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case T.RIG_MODE_STEREOSCOPIC_OVERUNDER:case T.RIG_MODE_STEREOSCOPIC_INTERLACED:{const i=this.cameraRigMode===T.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,r=this.cameraRigMode===T.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*r,t);break}case T.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position)}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,b._TargetFocalPoint),b._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const i=b._TargetFocalPoint.addInPlace(this.position);n.uq.TranslationToRef(-i.x,-i.y,-i.z,b._TargetTransformMatrix),b._TargetTransformMatrix.multiplyToRef(n.uq.RotationAxis(t.upVector,e),b._RigCamTransformMatrix),n.uq.TranslationToRef(i.x,i.y,i.z,b._TargetTransformMatrix),b._RigCamTransformMatrix.multiplyToRef(b._TargetTransformMatrix,b._RigCamTransformMatrix),n.Pq.TransformCoordinatesToRef(this.position,b._RigCamTransformMatrix,t.position),t.setTarget(i)}getClassName(){return"TargetCamera"}}b._RigCamTransformMatrix=new n.uq,b._TargetTransformMatrix=new n.uq,b._TargetFocalPoint=new n.Pq,(0,r.Cg)([(0,s.lK)()],b.prototype,"updateUpVectorFromRotation",void 0),(0,r.Cg)([(0,s.P_)()],b.prototype,"rotation",void 0),(0,r.Cg)([(0,s.lK)()],b.prototype,"speed",void 0),(0,r.Cg)([(0,s.xG)("lockedTargetId")],b.prototype,"lockedTarget",void 0);var E={};class x{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){const t=e.getSimpleName();this.attached[t]?f.V.Warn("camera input of type "+t+" already exists on camera"):(this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault))}remove(e){for(const t in this.attached){const i=this.attached[t];if(i===e)return i.detachControl(),i.camera=null,delete this.attached[t],void this.rebuildInputCheck()}}removeByType(e){for(const t in this.attached){const i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){const t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=!T.ForceAttachControlToAlwaysPreventDefault&&e,this.attachedToElement=!0,this.noPreventDefault=e;for(const t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(const t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){const t={};for(const e in this.attached){const i=this.attached[e],r=u.p.Serialize(i);t[i.getClassName()]=r}e.inputsmgr=t}parse(e){const t=e.inputsmgr;if(t){this.clear();for(const e in t){const i=E[e];if(i){const r=t[e],s=u.p.Parse((()=>new i),r,null);this.add(s)}}}else for(const t in this.attached){const i=E[this.attached[t].getClassName()];if(i){const r=u.p.Parse((()=>new i),e,null);this.remove(this.attached[t]),this.add(r)}}}}var v=i(4146);class C{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=o.S0.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((t=>{const i=t.event;if(!i.metaKey)if(t.type===v.TB.KEYDOWN)-1===this.keysUp.indexOf(i.keyCode)&&-1===this.keysDown.indexOf(i.keyCode)&&-1===this.keysLeft.indexOf(i.keyCode)&&-1===this.keysRight.indexOf(i.keyCode)&&-1===this.keysUpward.indexOf(i.keyCode)&&-1===this.keysDownward.indexOf(i.keyCode)&&-1===this.keysRotateLeft.indexOf(i.keyCode)&&-1===this.keysRotateRight.indexOf(i.keyCode)&&-1===this.keysRotateUp.indexOf(i.keyCode)&&-1===this.keysRotateDown.indexOf(i.keyCode)||(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),e||i.preventDefault());else if(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysUpward.indexOf(i.keyCode)||-1!==this.keysDownward.indexOf(i.keyCode)||-1!==this.keysRotateLeft.indexOf(i.keyCode)||-1!==this.keysRotateRight.indexOf(i.keyCode)||-1!==this.keysRotateUp.indexOf(i.keyCode)||-1!==this.keysRotateDown.indexOf(i.keyCode)){const t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),e||i.preventDefault()}})))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],r=e._computeLocalCameraSpeed();-1!==this.keysLeft.indexOf(i)?e._localDirection.copyFromFloats(-r,0,0):-1!==this.keysUp.indexOf(i)?e._localDirection.copyFromFloats(0,0,r):-1!==this.keysRight.indexOf(i)?e._localDirection.copyFromFloats(r,0,0):-1!==this.keysDown.indexOf(i)?e._localDirection.copyFromFloats(0,0,-r):-1!==this.keysUpward.indexOf(i)?e._localDirection.copyFromFloats(0,r,0):-1!==this.keysDownward.indexOf(i)?e._localDirection.copyFromFloats(0,-r,0):-1!==this.keysRotateLeft.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):-1!==this.keysRotateRight.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):-1!==this.keysRotateUp.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):-1!==this.keysRotateDown.indexOf(i)&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),n.Pq.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){const e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}}(0,r.Cg)([(0,s.lK)()],C.prototype,"keysUp",void 0),(0,r.Cg)([(0,s.lK)()],C.prototype,"keysUpward",void 0),(0,r.Cg)([(0,s.lK)()],C.prototype,"keysDown",void 0),(0,r.Cg)([(0,s.lK)()],C.prototype,"keysDownward",void 0),(0,r.Cg)([(0,s.lK)()],C.prototype,"keysLeft",void 0),(0,r.Cg)([(0,s.lK)()],C.prototype,"keysRight",void 0),(0,r.Cg)([(0,s.lK)()],C.prototype,"rotationSpeed",void 0),(0,r.Cg)([(0,s.lK)()],C.prototype,"keysRotateLeft",void 0),(0,r.Cg)([(0,s.lK)()],C.prototype,"keysRotateRight",void 0),(0,r.Cg)([(0,s.lK)()],C.prototype,"keysRotateUp",void 0),(0,r.Cg)([(0,s.lK)()],C.prototype,"keysRotateDown",void 0),E.FreeCameraKeyboardMoveInput=C;var A=i(6240);class P{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new h.cP,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=o.S0.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=r=>{const s=r.event,n="touch"===s.pointerType;if(!this.touchEnabled&&n)return;if(r.type!==A.Zp.POINTERMOVE&&-1===this.buttons.indexOf(s.button))return;const a=s.target;if(r.type===A.Zp.POINTERDOWN){if(n&&-1!==this._activePointerId||!n&&-1!==this._currentActiveButton)return;this._activePointerId=s.pointerId;try{a?.setPointerCapture(s.pointerId)}catch(e){}-1===this._currentActiveButton&&(this._currentActiveButton=s.button),this._previousPosition={x:s.clientX,y:s.clientY},e||(s.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(r.event)}else if(r.type===A.Zp.POINTERUP){if(n&&this._activePointerId!==s.pointerId||!n&&this._currentActiveButton!==s.button)return;try{a?.releasePointerCapture(s.pointerId)}catch(e){}this._currentActiveButton=-1,this._previousPosition=null,e||s.preventDefault(),this._activePointerId=-1}else if(r.type===A.Zp.POINTERMOVE&&(this._activePointerId===s.pointerId||!n))if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(r.event);else if(this._previousPosition){const t=this.camera._calculateHandednessMultiplier(),i=(s.clientX-this._previousPosition.x)*t,r=s.clientY-this._previousPosition.y;this._allowCameraRotation&&(this.camera.cameraRotation.y+=i/this.angularSensibility,this.camera.cameraRotation.x+=r/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:i,offsetY:r}),this._previousPosition={x:s.clientX,y:s.clientY},e||s.preventDefault()}}),this._onMouseMove=i=>{if(!t.isPointerLock)return;const r=this.camera._calculateHandednessMultiplier(),s=i.movementX*r;this.camera.cameraRotation.y+=s/this.angularSensibility;const n=i.movementY;this.camera.cameraRotation.x+=n/this.angularSensibility,this._previousPosition=null,e||i.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,A.Zp.POINTERDOWN|A.Zp.POINTERUP|A.Zp.POINTERMOVE),i&&(this._contextMenuBind=e=>this.onContextMenu(e),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}(0,r.Cg)([(0,s.lK)()],P.prototype,"buttons",void 0),(0,r.Cg)([(0,s.lK)()],P.prototype,"angularSensibility",void 0),E.FreeCameraMouseInput=P;var M,S=i(8123);class F{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new h.cP,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=o.S0.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==A.Zp.POINTERWHEEL)return;const i=t.event,r=i.deltaMode===S.s.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*r*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*r*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*r*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,A.Zp.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}(0,r.Cg)([(0,s.lK)()],F.prototype,"wheelPrecisionX",void 0),(0,r.Cg)([(0,s.lK)()],F.prototype,"wheelPrecisionY",void 0),(0,r.Cg)([(0,s.lK)()],F.prototype,"wheelPrecisionZ",void 0),function(e){e[e.MoveRelative=0]="MoveRelative",e[e.RotateRelative=1]="RotateRelative",e[e.MoveScene=2]="MoveScene"}(M||(M={}));class I extends F{constructor(){super(...arguments),this._moveRelative=n.Pq.Zero(),this._rotateRelative=n.Pq.Zero(),this._moveScene=n.Pq.Zero(),this._wheelXAction=M.MoveRelative,this._wheelXActionCoordinate=0,this._wheelYAction=M.MoveRelative,this._wheelYActionCoordinate=2,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){null===e&&this._wheelXAction!==M.MoveRelative||(this._wheelXAction=M.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==M.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){null===e&&this._wheelYAction!==M.MoveRelative||(this._wheelYAction=M.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==M.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){null===e&&this._wheelZAction!==M.MoveRelative||(this._wheelZAction=M.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==M.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){null===e&&this._wheelXAction!==M.RotateRelative||(this._wheelXAction=M.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==M.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){null===e&&this._wheelYAction!==M.RotateRelative||(this._wheelYAction=M.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==M.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){null===e&&this._wheelZAction!==M.RotateRelative||(this._wheelZAction=M.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==M.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){null===e&&this._wheelXAction!==M.MoveScene||(this._wheelXAction=M.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==M.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){null===e&&this._wheelYAction!==M.MoveScene||(this._wheelYAction=M.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==M.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){null===e&&this._wheelZAction!==M.MoveScene||(this._wheelZAction=M.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==M.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(0===this._wheelDeltaX&&0===this._wheelDeltaY&&0==this._wheelDeltaZ)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=n.uq.Zero();this.camera.getViewMatrix().invertToRef(e);const t=n.Pq.Zero();n.Pq.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(0===e)return;if(null===t||null===i)return;let r=null;switch(t){case M.MoveRelative:r=this._moveRelative;break;case M.RotateRelative:r=this._rotateRelative;break;case M.MoveScene:r=this._moveScene}switch(i){case 0:r.set(e,0,0);break;case 1:r.set(0,e,0);break;case 2:r.set(0,0,e)}}}(0,r.Cg)([(0,s.lK)()],I.prototype,"wheelXMoveRelative",null),(0,r.Cg)([(0,s.lK)()],I.prototype,"wheelYMoveRelative",null),(0,r.Cg)([(0,s.lK)()],I.prototype,"wheelZMoveRelative",null),(0,r.Cg)([(0,s.lK)()],I.prototype,"wheelXRotateRelative",null),(0,r.Cg)([(0,s.lK)()],I.prototype,"wheelYRotateRelative",null),(0,r.Cg)([(0,s.lK)()],I.prototype,"wheelZRotateRelative",null),(0,r.Cg)([(0,s.lK)()],I.prototype,"wheelXMoveScene",null),(0,r.Cg)([(0,s.lK)()],I.prototype,"wheelYMoveScene",null),(0,r.Cg)([(0,s.lK)()],I.prototype,"wheelZMoveScene",null),E.FreeCameraMouseWheelInput=I;class w{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=o.S0.IsSafari()}attachControl(e){e=o.S0.BackCompatCameraNoPreventDefault(arguments);let t=null;if(void 0===this._pointerInput&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{const r=i.event,s="mouse"===r.pointerType||this._isSafari&&void 0===r.pointerType;if(this.allowMouse||!s)if(i.type===A.Zp.POINTERDOWN){if(e||r.preventDefault(),this._pointerPressed.push(r.pointerId),1!==this._pointerPressed.length)return;t={x:r.clientX,y:r.clientY}}else if(i.type===A.Zp.POINTERUP){e||r.preventDefault();const i=this._pointerPressed.indexOf(r.pointerId);if(-1===i)return;if(this._pointerPressed.splice(i,1),0!=i)return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===A.Zp.POINTERMOVE){if(e||r.preventDefault(),!t)return;if(0!=this._pointerPressed.indexOf(r.pointerId))return;this._offsetX=r.clientX-t.x,this._offsetY=-(r.clientY-t.y)}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,A.Zp.POINTERDOWN|A.Zp.POINTERUP|A.Zp.POINTERMOVE),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(null===this._offsetX||null===this._offsetY)return;if(0===this._offsetX&&0===this._offsetY)return;const e=this.camera,t=e._calculateHandednessMultiplier();if(e.cameraRotation.y=t*this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&1===this._pointerPressed.length||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const t=e._computeLocalCameraSpeed(),i=new n.Pq(0,0,0!==this.touchMoveSensibility?t*this._offsetY/this.touchMoveSensibility:0);n.uq.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(n.Pq.TransformCoordinates(i,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}(0,r.Cg)([(0,s.lK)()],w.prototype,"touchAngularSensibility",void 0),(0,r.Cg)([(0,s.lK)()],w.prototype,"touchMoveSensibility",void 0),E.FreeCameraTouchInput=w;class D extends x{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new C),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new P(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new I,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new w),this}clear(){super.clear(),this._mouseInput=null}}var O=i(6326);class B extends b{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new n.Pq(.5,1,.5),this.ellipsoidOffset=new n.Pq(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=n.Pq.Zero(),this._diffPosition=n.Pq.Zero(),this._newPosition=n.Pq.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(e,t,i=null)=>{this._newPosition.copyFrom(t),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>O.$.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&i&&this.onCollide(i))},this.inputs=new D(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=o.S0.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new n.Pq(0,0,0),this.cameraRotation=new n.I9(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;t=this.parent?n.Pq.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=n.Pq.Zero(),this._transformedDirection=n.Pq.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}(0,r.Cg)([(0,s.P_)()],B.prototype,"ellipsoid",void 0),(0,r.Cg)([(0,s.P_)()],B.prototype,"ellipsoidOffset",void 0),(0,r.Cg)([(0,s.lK)()],B.prototype,"checkCollisions",void 0),(0,r.Cg)([(0,s.lK)()],B.prototype,"applyGravity",void 0),(0,p.Y5)("BABYLON.FreeCamera",B)},5852:(e,t,i)=>{i.d(t,{tI:()=>_,bS:()=>R,tg:()=>f,A5:()=>d,YM:()=>p,C5:()=>T,GX:()=>u,kf:()=>l,EX:()=>c,Cm:()=>h,N5:()=>o});class r{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null,this._isDisposed=!1}get isAsync(){return this.isParallelCompiled}get isReady(){return!!this.program&&(!this.isParallelCompiled||this.engine._isRenderingStateCompiled(this))}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}setEngine(e){this.engine=e}_fillEffectInformation(e,t,i,r,s,n,a,o){const h=this.engine;if(h.supportsUniformBuffers)for(const i in t)e.bindUniformBlock(i,t[i]);let l;for(this.engine.getUniforms(this,i).forEach(((e,t)=>{r[i[t]]=e})),this._uniforms=r,l=0;l<s.length;l++)null==e.getUniform(s[l])&&(s.splice(l,1),l--);s.forEach(((e,t)=>{n[e]=t}));for(const e of h.getAttributes(this,a))o.push(e)}dispose(){this._uniforms={},this._isDisposed=!0}_cacheMatrix(e,t){const i=this._valueCache[e],r=t.updateFlag;return(void 0===i||i!==r)&&(this._valueCache[e]=r,!0)}_cacheFloat2(e,t,i){let r=this._valueCache[e];if(!r||2!==r.length)return r=[t,i],this._valueCache[e]=r,!0;let s=!1;return r[0]!==t&&(r[0]=t,s=!0),r[1]!==i&&(r[1]=i,s=!0),s}_cacheFloat3(e,t,i,r){let s=this._valueCache[e];if(!s||3!==s.length)return s=[t,i,r],this._valueCache[e]=s,!0;let n=!1;return s[0]!==t&&(s[0]=t,n=!0),s[1]!==i&&(s[1]=i,n=!0),s[2]!==r&&(s[2]=r,n=!0),n}_cacheFloat4(e,t,i,r,s){let n=this._valueCache[e];if(!n||4!==n.length)return n=[t,i,r,s],this._valueCache[e]=n,!0;let a=!1;return n[0]!==t&&(n[0]=t,a=!0),n[1]!==i&&(n[1]=i,a=!0),n[2]!==r&&(n[2]=r,a=!0),n[3]!==s&&(n[3]=s,a=!0),a}setInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this.engine.setInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this.engine.setInt4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this.engine.setUInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setUInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this.engine.setUInt4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.asArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this.engine.setFloat3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this.engine.setFloat4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}var s=i(6741);const n=new WeakMap,a={_webGLVersion:2,cachedPipelines:{}};function o(e){let t=n.get(e);if(!t){if(!e)return a;t={_webGLVersion:e.TEXTURE_BINDING_3D?2:1,_context:e,parallelShaderCompile:e.getExtension("KHR_parallel_shader_compile")||void 0,cachedPipelines:{}},n.set(e,t)}return t}function h(e){n.delete(e)}function l(e,t,i,r,s,n){const a=o(r);return n||(n=a._createShaderProgramInjection??_),n(e,m(t,"vertex",r,a._contextWasLost),m(i,"fragment",r,a._contextWasLost),r,s,a.validateShaderPrograms)}function c(e,t,i,r,s,n=null,a){const h=o(s);a||(a=h._createShaderProgramInjection??_);const l=h._webGLVersion>1?"#version 300 es\n#define WEBGL2 \n":"";return a(e,g(t,"vertex",r,l,s,h._contextWasLost),g(i,"fragment",r,l,s,h._contextWasLost),s,n,h.validateShaderPrograms)}function u(e,t){const i=new r,s=o(e);return s.parallelShaderCompile&&!s.disableParallelShaderCompile&&(i.isParallelCompiled=!0),i.context=s._context,i}function _(e,t,i,r,s=null,n){const a=r.createProgram();if(e.program=a,!a)throw new Error("Unable to create program");return r.attachShader(a,t),r.attachShader(a,i),r.linkProgram(a),e.context=r,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||f(e,r,n),a}function d(e,t,i){const r=e;if(r._isDisposed)return!1;const s=o(t);return!!(s&&s.parallelShaderCompile&&s.parallelShaderCompile.COMPLETION_STATUS_KHR&&r.program&&t.getProgramParameter(r.program,s.parallelShaderCompile.COMPLETION_STATUS_KHR))&&(f(r,t,i),!0)}function f(e,t,i){const r=e.context,s=e.vertexShader,n=e.fragmentShader,a=e.program;if(!r.getProgramParameter(a,r.LINK_STATUS)){if(!t.getShaderParameter(s,t.COMPILE_STATUS)){const i=t.getShaderInfoLog(s);if(i)throw e.vertexCompilationError=i,new Error("VERTEX SHADER "+i)}if(!t.getShaderParameter(n,t.COMPILE_STATUS)){const i=t.getShaderInfoLog(n);if(i)throw e.fragmentCompilationError=i,new Error("FRAGMENT SHADER "+i)}const i=r.getProgramInfoLog(a);if(i)throw e.programLinkError=i,new Error(i)}if(i&&(r.validateProgram(a),!r.getProgramParameter(a,r.VALIDATE_STATUS))){const t=r.getProgramInfoLog(a);if(t)throw e.programValidationError=t,new Error(t)}r.deleteShader(s),r.deleteShader(n),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)}function p(e,t,i,r,s,n,a,h,u,_="",d,f,p){const g=o(e.context);f||(f=g.createRawShaderProgramInjection??l),p||(p=g.createShaderProgramInjection??c);const m=e;m.program=r?f(m,t,i,m.context,u):p(m,t,i,h,m.context,u),m.program.__SPECTOR_rebuildProgram=a,d()}function g(e,t,i,r,n,a){return m((0,s.iL)(e,i,r),t,n,a)}function m(e,t,i,r){const s=i.createShader("vertex"===t?i.VERTEX_SHADER:i.FRAGMENT_SHADER);if(!s){let e=i.NO_ERROR,s=i.NO_ERROR;for(;(s=i.getError())!==i.NO_ERROR;)e=s;throw new Error(`Something went wrong while creating a gl ${t} shader object. gl error=${e}, gl isContextLost=${i.isContextLost()}, _contextWasLost=${r}`)}return i.shaderSource(s,e),i.compileShader(s),s}function T(e,t){t.useProgram(e)}function R(e,t){const i=e;if(!i.isParallelCompiled)return void t(e);const r=i.onCompiled;i.onCompiled=()=>{r?.(),t(e)}}},6041:(e,t,i)=>{i.d(t,{ov:()=>_,v9:()=>u});var r=i(7309),s=i(6552),n=i(5559),a=i(4867);function o(e){return Math.pow(e,n.tk)}function h(e){return e<=.04045?.0773993808*e:Math.pow(.947867299*(e+.055),2.4)}function l(e){return Math.pow(e,n.rv)}function c(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}class u{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=255*this.r|0;return e=397*e^255*this.g,e=397*e^255*this.b,e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return u.FromArrayToRef(e,t,this),this}toColor4(e=1){return new _(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return.3*this.r+.59*this.g+.11*this.b}multiply(e){return new u(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyByFloats(e,t,i){return new u(this.r*e,this.g*t,this.b*i)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.r,e.g,e.b)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.r,e.g,e.b)}minimizeInPlaceFromFloats(e,t,i){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(i,this.b),this}maximizeInPlaceFromFloats(e,t,i){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(i,this.b),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.equalsToFloats(e,t,i)}equalsToFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}equalsWithEpsilon(e,t=n.bH){return(0,a.Mj)(this.r,e.r,t)&&(0,a.Mj)(this.g,e.g,t)&&(0,a.Mj)(this.b,e.b,t)}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}scale(e){return new u(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t}clampToRef(e=0,t=1,i){return i.r=(0,a.OQ)(this.r,e,t),i.g=(0,a.OQ)(this.g,e,t),i.b=(0,a.OQ)(this.b,e,t),i}add(e){return new u(this.r+e.r,this.g+e.g,this.b+e.b)}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addInPlaceFromFloats(e,t,i){return this.r+=e,this.g+=t,this.b+=i,this}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t}subtract(e){return new u(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this}subtractFromFloats(e,t,i){return new u(this.r-e,this.g-t,this.b-i)}subtractFromFloatsToRef(e,t,i,r){return r.r=this.r-e,r.g=this.g-t,r.b=this.b-i,r}clone(){return new u(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this.r=this.g=this.b=e,this}toHexString(){const e=Math.round(255*this.r),t=Math.round(255*this.g),i=Math.round(255*this.b);return"#"+(0,a.Db)(e)+(0,a.Db)(t)+(0,a.Db)(i)}fromHexString(e){return"#"!==e.substring(0,1)||7!==e.length||(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255),this}toHSV(){return this.toHSVToRef(new u)}toHSVToRef(e){const t=this.r,i=this.g,r=this.b,s=Math.max(t,i,r),n=Math.min(t,i,r);let a=0,o=0;const h=s,l=s-n;return 0!==s&&(o=l/s),s!=n&&(s==t?(a=(i-r)/l,i<r&&(a+=6)):s==i?a=(r-t)/l+2:s==r&&(a=(t-i)/l+4),a*=60),e.r=a,e.g=o,e.b=h,e}toLinearSpace(e=!1){const t=new u;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=h(this.r),e.g=h(this.g),e.b=h(this.b)):(e.r=o(this.r),e.g=o(this.g),e.b=o(this.b)),this}toGammaSpace(e=!1){const t=new u;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=c(this.r),e.g=c(this.g),e.b=c(this.b)):(e.r=l(this.r),e.g=l(this.g),e.b=l(this.b)),this}static HSVtoRGBToRef(e,t,i,r){const s=i*t,n=e/60,a=s*(1-Math.abs(n%2-1));let o=0,h=0,l=0;n>=0&&n<=1?(o=s,h=a):n>=1&&n<=2?(o=a,h=s):n>=2&&n<=3?(h=s,l=a):n>=3&&n<=4?(h=a,l=s):n>=4&&n<=5?(o=a,l=s):n>=5&&n<=6&&(o=s,l=a);const c=i-s;return r.r=o+c,r.g=h+c,r.b=l+c,r}static FromHSV(e,t,i){const r=new u(0,0,0);return u.HSVtoRGBToRef(e,t,i,r),r}static FromHexString(e){return new u(0,0,0).fromHexString(e)}static FromArray(e,t=0){return new u(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2]}static FromInts(e,t,i){return new u(e/255,t/255,i/255)}static Lerp(e,t,i){const r=new u(0,0,0);return u.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i}static Hermite(e,t,i,r,s){const n=s*s,a=s*n,o=2*a-3*n+1,h=-2*a+3*n,l=a-2*n+s,c=a-n,_=e.r*o+i.r*h+t.r*l+r.r*c,d=e.g*o+i.g*h+t.g*l+r.g*c,f=e.b*o+i.b*h+t.b*l+r.b*c;return new u(_,d,f)}static Hermite1stDerivative(e,t,i,r,s){const n=u.Black();return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const a=s*s;n.r=6*(a-s)*e.r+(3*a-4*s+1)*t.r+6*(-a+s)*i.r+(3*a-2*s)*r.r,n.g=6*(a-s)*e.g+(3*a-4*s+1)*t.g+6*(-a+s)*i.g+(3*a-2*s)*r.g,n.b=6*(a-s)*e.b+(3*a-4*s+1)*t.b+6*(-a+s)*i.b+(3*a-2*s)*r.b}static Red(){return new u(1,0,0)}static Green(){return new u(0,1,0)}static Blue(){return new u(0,0,1)}static Black(){return new u(0,0,0)}static get BlackReadOnly(){return u._BlackReadOnly}static White(){return new u(1,1,1)}static Purple(){return new u(.5,0,.5)}static Magenta(){return new u(1,0,1)}static Yellow(){return new u(1,1,0)}static Gray(){return new u(.5,.5,.5)}static Teal(){return new u(0,1,1)}static Random(){return new u(Math.random(),Math.random(),Math.random())}}u._V8PerformanceHack=new u(.5,.5,.5),u._BlackReadOnly=u.Black(),Object.defineProperties(u.prototype,{dimension:{value:[3]},rank:{value:1}});class _{constructor(e=0,t=0,i=0,r=1){this.r=e,this.g=t,this.b=i,this.a=r}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this.a=e[t+3],this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new _(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t.a=this.a+e.a,t}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}addInPlaceFromFloats(e,t,i,r){return this.r+=e,this.g+=t,this.b+=i,this.a+=r,this}subtract(e){return new _(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this.a-=e.a,this}subtractFromFloats(e,t,i,r){return new _(this.r-e,this.g-t,this.b-i,this.a-r)}subtractFromFloatsToRef(e,t,i,r,s){return s.r=this.r-e,s.g=this.g-t,s.b=this.b-i,s.a=this.a-r,s}scale(e){return new _(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,t}clampToRef(e=0,t=1,i){return i.r=(0,a.OQ)(this.r,e,t),i.g=(0,a.OQ)(this.g,e,t),i.b=(0,a.OQ)(this.b,e,t),i.a=(0,a.OQ)(this.a,e,t),i}multiply(e){return new _(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this.a*=e.a,this}multiplyByFloats(e,t,i,r){return new _(this.r*e,this.g*t,this.b*i,this.a*r)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.r=Math.min(this.r,e.r),this.g=Math.min(this.g,e.g),this.b=Math.min(this.b,e.b),this.a=Math.min(this.a,e.a),this}maximizeInPlace(e){return this.r=Math.max(this.r,e.r),this.g=Math.max(this.g,e.g),this.b=Math.max(this.b,e.b),this.a=Math.max(this.a,e.a),this}minimizeInPlaceFromFloats(e,t,i,r){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(i,this.b),this.a=Math.min(r,this.a),this}maximizeInPlaceFromFloats(e,t,i,r){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(i,this.b),this.a=Math.max(r,this.a),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}equalsWithEpsilon(e,t=n.bH){return(0,a.Mj)(this.r,e.r,t)&&(0,a.Mj)(this.g,e.g,t)&&(0,a.Mj)(this.b,e.b,t)&&(0,a.Mj)(this.a,e.a,t)}equalsToFloats(e,t,i,r){return this.r===e&&this.g===t&&this.b===i&&this.a===r}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=255*this.r|0;return e=397*e^255*this.g,e=397*e^255*this.b,e=397*e^255*this.a,e}clone(){return(new _).copyFrom(this)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,r){return this.r=e,this.g=t,this.b=i,this.a=r,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}setAll(e){return this.r=this.g=this.b=this.a=e,this}toHexString(e=!1){const t=Math.round(255*this.r),i=Math.round(255*this.g),r=Math.round(255*this.b);if(e)return"#"+(0,a.Db)(t)+(0,a.Db)(i)+(0,a.Db)(r);const s=Math.round(255*this.a);return"#"+(0,a.Db)(t)+(0,a.Db)(i)+(0,a.Db)(r)+(0,a.Db)(s)}fromHexString(e){return"#"!==e.substring(0,1)||9!==e.length&&7!==e.length||(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255,9===e.length&&(this.a=parseInt(e.substring(7,9),16)/255)),this}toLinearSpace(e=!1){const t=new _;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=h(this.r),e.g=h(this.g),e.b=h(this.b)):(e.r=o(this.r),e.g=o(this.g),e.b=o(this.b)),e.a=this.a,this}toGammaSpace(e=!1){const t=new _;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=c(this.r),e.g=c(this.g),e.b=c(this.b)):(e.r=l(this.r),e.g=l(this.g),e.b=l(this.b)),e.a=this.a,this}static FromHexString(e){return"#"!==e.substring(0,1)||9!==e.length&&7!==e.length?new _(0,0,0,0):new _(0,0,0,1).fromHexString(e)}static Lerp(e,t,i){return _.LerpToRef(e,t,i,new _)}static LerpToRef(e,t,i,r){return r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i,r.a=e.a+(t.a-e.a)*i,r}static Hermite(e,t,i,r,s){const n=s*s,a=s*n,o=2*a-3*n+1,h=-2*a+3*n,l=a-2*n+s,c=a-n,u=e.r*o+i.r*h+t.r*l+r.r*c,d=e.g*o+i.g*h+t.g*l+r.g*c,f=e.b*o+i.b*h+t.b*l+r.b*c,p=e.a*o+i.a*h+t.a*l+r.a*c;return new _(u,d,f,p)}static Hermite1stDerivative(e,t,i,r,s){const n=new _;return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const a=s*s;n.r=6*(a-s)*e.r+(3*a-4*s+1)*t.r+6*(-a+s)*i.r+(3*a-2*s)*r.r,n.g=6*(a-s)*e.g+(3*a-4*s+1)*t.g+6*(-a+s)*i.g+(3*a-2*s)*r.g,n.b=6*(a-s)*e.b+(3*a-4*s+1)*t.b+6*(-a+s)*i.b+(3*a-2*s)*r.b,n.a=6*(a-s)*e.a+(3*a-4*s+1)*t.a+6*(-a+s)*i.a+(3*a-2*s)*r.a}static FromColor3(e,t=1){return new _(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new _(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}static FromInts(e,t,i,r){return new _(e/255,t/255,i/255,r/255)}static CheckColors4(e,t){if(e.length===3*t){const t=[];for(let i=0;i<e.length;i+=3){const r=i/3*4;t[r]=e[i],t[r+1]=e[i+1],t[r+2]=e[i+2],t[r+3]=1}return t}return e}}_._V8PerformanceHack=new _(.5,.5,.5,.5),Object.defineProperties(_.prototype,{dimension:{value:[4]},rank:{value:1}});class d{}d.Color3=(0,r.mI)(3,u.Black),d.Color4=(0,r.mI)(3,(()=>new _(0,0,0,0))),(0,s.Y5)("BABYLON.Color3",u),(0,s.Y5)("BABYLON.Color4",_)},6080:(e,t,i)=>{i.d(t,{B:()=>n,K:()=>a});const r={},s={};function n(e){const t=e.getClassName();return s[t]||(s[t]={}),s[t]}function a(e){const t=e.getClassName();if(r[t])return r[t];r[t]={};const i=r[t];let n=e,a=t;for(;a;){const e=s[a];for(const t in e)i[t]=e[t];let t,r=!1;do{if(t=Object.getPrototypeOf(n),!t.getClassName){r=!0;break}if(t.getClassName()!==a)break;n=t}while(t);if(r)break;a=t.getClassName(),n=t}return i}},6096:(e,t,i)=>{i.d(t,{X:()=>n});var r=i(4700),s=i(9848);class n{constructor(e){this._vertexBuffers={},this.onBeforeRenderObservable=new s.cP,this._scene=e}_prepareBuffers(){if(this._vertexBuffers[r.R.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[r.R.PositionKind]=new r.R(this._scene.getEngine(),e,r.R.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[r.R.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const i=this._scene.activeCamera;return!(!i||!(t=t||i._postProcesses.filter((e=>null!=e)))||0===t.length||!this._scene.postProcessesEnabled||(t[0].activate(i,e,null!=t),0))}directRender(e,t=null,i=!1,r=0,s=0,n=!1){const a=this._scene.getEngine();for(let o=0;o<e.length;o++){o<e.length-1?e[o+1].activate(this._scene.activeCamera||this._scene,t?.texture):(t?a.bindFramebuffer(t,r,void 0,void 0,i,s):n||a.restoreDefaultFramebuffer(),a._debugInsertMarker?.(`post process ${e[o].name} output`));const h=e[o],l=h.apply();l&&(h.onBeforeRenderObservable.notifyObservers(l),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,l),a.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(l))}a.setDepthBuffer(!0),a.setDepthWrite(!0)}_finalizeFrame(e,t,i,r,s=!1){const n=this._scene.activeCamera;if(!n)return;if(this.onBeforeRenderObservable.notifyObservers(this),0===(r=r||n._postProcesses.filter((e=>null!=e))).length||!this._scene.postProcessesEnabled)return;const a=this._scene.getEngine();for(let o=0,h=r.length;o<h;o++){const l=r[o];if(o<h-1?l._outputTexture=r[o+1].activate(n,t?.texture):(t?(a.bindFramebuffer(t,i,void 0,void 0,s),l._outputTexture=t):(a.restoreDefaultFramebuffer(),l._outputTexture=null),a._debugInsertMarker?.(`post process ${r[o].name} output`)),e)break;const c=l.apply();c&&(l.onBeforeRenderObservable.notifyObservers(c),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,c),a.drawElementsType(0,0,6),l.onAfterRenderObservable.notifyObservers(c))}a.setDepthBuffer(!0),a.setDepthWrite(!0),a.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[r.R.PositionKind];e&&(e.dispose(),this._vertexBuffers[r.R.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}},6181:(e,t,i)=>{i.d(t,{AV:()=>s,EL:()=>r,yS:()=>n});const r=e=>{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let i,r,s,n,a,o,h,l="",c=0;const u=ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e);for(;c<u.length;)i=u[c++],r=c<u.length?u[c++]:Number.NaN,s=c<u.length?u[c++]:Number.NaN,n=i>>2,a=(3&i)<<4|r>>4,o=(15&r)<<2|s>>6,h=63&s,isNaN(r)?o=h=64:isNaN(s)&&(h=64),l+=t.charAt(n)+t.charAt(a)+t.charAt(o)+t.charAt(h);return l},s=e=>atob(e),n=e=>{const t=s(e),i=t.length,r=new Uint8Array(new ArrayBuffer(i));for(let e=0;e<i;e++)r[e]=t.charCodeAt(e);return r.buffer}},6237:(e,t,i)=>{i.d(t,{j:()=>s});var r=i(8790);class s{static get Now(){return(0,r.BA)()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}},6240:(e,t,i)=>{i.d(t,{Zp:()=>s,mx:()=>o,tT:()=>a});var r=i(4037);class s{}s.POINTERDOWN=1,s.POINTERUP=2,s.POINTERMOVE=4,s.POINTERWHEEL=8,s.POINTERPICK=16,s.POINTERTAP=32,s.POINTERDOUBLETAP=64;class n{constructor(e,t){this.type=e,this.event=t}}class a extends n{constructor(e,t,i,s){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new r.I9(i,s)}}class o extends n{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,r=null){super(e,t),this._pickInfo=i,this._inputManager=r}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}},6315:(e,t,i)=>{i.d(t,{q:()=>s});var r=i(9848);class s{static get LastCreatedEngine(){return 0===this.Instances.length?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}s.Instances=[],s.OnEnginesDisposedObservable=new r.cP,s._LastCreatedScene=null,s.UseFallbackTexture=!0,s.FallbackTexture=""},6321:(e,t,i)=>{i.r(t),i.d(t,{ThinEngine:()=>R});var r=i(5852),s=i(1137),n=i(8790);class a{constructor(){this.shaderLanguage=0}postProcessor(e,t,i,r,s){if(s.drawBuffersExtensionDisabled){const t=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(t,"")}return e}}const o=/(flat\s)?\s*varying\s*.*/;class h{constructor(){this.shaderLanguage=0}attributeProcessor(e){return e.replace("attribute","in")}varyingCheck(e,t){return o.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const r=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i){const t=-1!==e.search(/layout *\(location *= *0\) *out/g);e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(r||t?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else if(-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;return e}}var l=i(4329),c=i(1597),u=i(6326),_=i(7716),d=i(854),f=i(4420),p=i(6741),g=i(7647),m=i(8086);class T{}class R extends u.${get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}static get ShadersRepository(){return f.M.ShadersRepository}static set ShadersRepository(e){f.M.ShadersRepository=e}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(e,t,i,n){if(i=i||{},super(t??i.antialias,i,n),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!e)return;let o=null;if(e.getContext){if(o=e,void 0===i.preserveDrawingBuffer&&(i.preserveDrawingBuffer=!1),void 0===i.xrCompatible&&(i.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const e=navigator.userAgent;for(const t of R.ExceptionList){const r=t.key,s=t.targets;if(new RegExp(r).test(e)){if(t.capture&&t.captureConstraint){const i=t.capture,r=t.captureConstraint,s=new RegExp(i).exec(e);if(s&&s.length>0&&parseInt(s[s.length-1])>=r)continue}for(const e of s)switch(e){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":i.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{(0,r.Cm)(this._gl)}:(this._onContextLost=e=>{e.preventDefault(),this._contextWasLost=!0,(0,r.Cm)(this._gl),s.V.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()))},o.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference=i.powerPreference||"high-performance"),o.addEventListener("webglcontextlost",this._onContextLost,!1),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=o.getContext("webgl2",i)||o.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(e){}if(!this._gl){if(!o)throw new Error("The provided canvas is null or undefined.");try{this._gl=o.getContext("webgl",i)||o.getContext("experimental-webgl",i)}catch(e){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,o=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const t=this._gl.getContextAttributes();t&&(i.stencil=t.stencil)}this._sharedInit(o),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==i.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let e=0;e<this._caps.maxVertexAttribs;e++)this._currentBufferPointers[e]=new T;this._shaderProcessor=this.webGLVersion>1?new h:new a;const l=`Babylon.js v${R.Version}`;s.V.Log(l+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",l);const c=(0,r.N5)(this._gl);c.validateShaderPrograms=this.validateShaderPrograms,c.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(e){return null}areAllEffectsReady(){for(const e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16")},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const e=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=e&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const e=this._gl.getExtension("WEBGL_draw_buffers");if(null!==e){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=e.drawBuffersWEBGL.bind(e),this._caps.maxDrawBuffers=this._gl.getParameter(e.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let t=0;t<16;t++)this._gl["COLOR_ATTACHMENT"+t+"_WEBGL"]=e["COLOR_ATTACHMENT"+t+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const e=this._gl.getExtension("WEBGL_depth_texture");null!=e&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=e.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const e=this._gl.getExtension("OES_vertex_array_object");null!=e&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=e.createVertexArrayOES.bind(e),this._gl.bindVertexArray=e.bindVertexArrayOES.bind(e),this._gl.deleteVertexArray=e.deleteVertexArrayOES.bind(e))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const e=this._gl.getExtension("ANGLE_instanced_arrays");null!=e?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),this._gl.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),this._gl.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const e=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),t=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);e&&t&&(this._caps.highPrecisionShaderSupported=0!==e.precision&&0!==t.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const e=this._gl.getExtension("EXT_blend_minmax");null!=e&&(this._caps.blendMinMax=!0,this._gl.MAX=e.MAX_EXT,this._gl.MIN=e.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const e=this._gl.getExtension("EXT_sRGB");null!=e&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:e.SRGB_EXT,SRGB8:e.SRGB_ALPHA_EXT,SRGB8_ALPHA8:e.SRGB_ALPHA_EXT})}if(this._creationOptions){const e=this._creationOptions.forceSRGBBufferSupportState;void 0!==e&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&e)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let e=0;e<this._maxSimultaneousTextures;e++)this._nextFreeTextureSlots.push(e);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:"undefined"==typeof HTMLImageElement,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportIBLShadows:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const e=this.getGlInfo();return e&&e.renderer?e.renderer:""}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(e,t,i,r=!1){const s=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=s;let n=0;if(t&&e){let t=!0;if(this._currentRenderTarget){const i=this._currentRenderTarget.texture?.format;if(8===i||9===i||10===i||11===i){const i=this._currentRenderTarget.texture?.type;7===i||5===i?(R._TempClearColorUint32[0]=255*e.r,R._TempClearColorUint32[1]=255*e.g,R._TempClearColorUint32[2]=255*e.b,R._TempClearColorUint32[3]=255*e.a,this._gl.clearBufferuiv(this._gl.COLOR,0,R._TempClearColorUint32),t=!1):(R._TempClearColorInt32[0]=255*e.r,R._TempClearColorInt32[1]=255*e.g,R._TempClearColorInt32[2]=255*e.b,R._TempClearColorInt32[3]=255*e.a,this._gl.clearBufferiv(this._gl.COLOR,0,R._TempClearColorInt32),t=!1)}}t&&(this._gl.clearColor(e.r,e.g,e.b,void 0!==e.a?e.a:1),n|=this._gl.COLOR_BUFFER_BIT)}i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),n|=this._gl.DEPTH_BUFFER_BIT),r&&(this._gl.clearStencil(0),n|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(n)}_viewport(e,t,i,r){e===this._viewportCached.x&&t===this._viewportCached.y&&i===this._viewportCached.z&&r===this._viewportCached.w||(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=r,this._gl.viewport(e,t,i,r))}endFrame(){super.endFrame(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(e,t=0,i,r,n,a=0,o=0){const h=e;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(h._framebuffer);const l=this._gl;e.isMulti||(e.is2DArray||e.is3D?(l.framebufferTextureLayer(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,e.texture._hardwareTexture?.underlyingResource,a,o),h._currentLOD=a):e.isCube?l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_CUBE_MAP_POSITIVE_X+t,e.texture._hardwareTexture?.underlyingResource,a):h._currentLOD!==a&&(l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,e.texture._hardwareTexture?.underlyingResource,a),h._currentLOD=a));const c=e._depthStencilTexture;if(c){e.is3D&&(e.texture.width===c.width&&e.texture.height===c.height&&e.texture.depth===c.depth||s.V.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment"));const i=e._depthStencilTextureWithStencil?l.DEPTH_STENCIL_ATTACHMENT:l.DEPTH_ATTACHMENT;e.is2DArray||e.is3D?l.framebufferTextureLayer(l.FRAMEBUFFER,i,c._hardwareTexture?.underlyingResource,a,o):e.isCube?l.framebufferTexture2D(l.FRAMEBUFFER,i,l.TEXTURE_CUBE_MAP_POSITIVE_X+t,c._hardwareTexture?.underlyingResource,a):l.framebufferTexture2D(l.FRAMEBUFFER,i,l.TEXTURE_2D,c._hardwareTexture?.underlyingResource,a)}h._MSAAFramebuffer&&this._bindUnboundFramebuffer(h._MSAAFramebuffer),this._cachedViewport&&!n?this.setViewport(this._cachedViewport,i,r):(i||(i=e.width,a&&(i/=Math.pow(2,a))),r||(r=e.height,a&&(r/=Math.pow(2,a))),this._viewport(0,0,i,r)),this.wipeCaches()}setStateCullFaceType(e,t){const i=this.cullBackFaces??e??1?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==i||t)&&(this._depthCullingState.cullFace=i)}setState(e,t=0,i,r=!1,s,n,a=0){(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e),this.setStateCullFaceType(s,i),this.setZOffset(t),this.setZOffsetUnits(a);const o=r?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==o||i)&&(this._depthCullingState.frontFace=o),this._stencilStateComposer.stencilMaterial=n}_resolveAndGenerateMipMapsFramebuffer(e,t=!1){e.disableAutomaticMSAAResolve||(e.isMulti?this.resolveMultiFramebuffer(e):this.resolveFramebuffer(e)),t||(e.isMulti?this.generateMipMapsMultiFramebuffer(e):this.generateMipMapsFramebuffer(e))}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(e){const t=this._getTextureTarget(e);this._bindTextureDirectly(t,e,!0),this._gl.generateMipmap(t),this._bindTextureDirectly(t,null)}unBindFramebuffer(e,t,i){const r=e;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(e,t),i&&(r._MSAAFramebuffer&&this._bindUnboundFramebuffer(r._framebuffer),i()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(e){e.isMulti||!e.texture?.generateMipMaps||e.isCube||this.generateMipmaps(e.texture)}resolveFramebuffer(e){const t=e,i=this._gl;if(!t._MSAAFramebuffer||t.isMulti)return;let r=t.resolveMSAAColors?i.COLOR_BUFFER_BIT:0;r|=t._generateDepthBuffer&&t.resolveMSAADepth?i.DEPTH_BUFFER_BIT:0,r|=t._generateStencilBuffer&&t.resolveMSAAStencil?i.STENCIL_BUFFER_BIT:0,i.bindFramebuffer(i.READ_FRAMEBUFFER,t._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),i.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,r,i.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e,t,i){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");const r=new l.A(i);return this.bindArrayBuffer(r),"number"!=typeof e?e instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t),r.capacity=4*e.length):(this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),r.capacity=e.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(e),t),r.capacity=e),this._resetVertexBufferBinding(),r.references=1,r}createDynamicVertexBuffer(e,t){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t,i){const r=this._gl.createBuffer(),s=new l.A(r);if(!r)throw new Error("Unable to create index buffer");this.bindIndexBuffer(s);const n=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,n,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),s.references=1,s.is32Bits=4===n.BYTES_PER_ELEMENT,s}_normalizeIndexData(e){if(2===e.BYTES_PER_ELEMENT)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let t=0;t<e.length;t++)if(e[t]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,i){const r=e.program,s=this._gl.getUniformBlockIndex(r,t);this._gl.uniformBlockBinding(r,s,i)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,i,r,s,n,a){const o=this._currentBufferPointers[t];if(!o)return;let h=!1;o.active?(o.buffer!==e&&(o.buffer=e,h=!0),o.size!==i&&(o.size=i,h=!0),o.type!==r&&(o.type=r,h=!0),o.normalized!==s&&(o.normalized=s,h=!0),o.stride!==n&&(o.stride=n,h=!0),o.offset!==a&&(o.offset=a,h=!0)):(h=!0,o.active=!0,o.index=t,o.size=i,o.type=r,o.normalized=s,o.stride=n,o.offset=a,o.buffer=e),(h||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),r===this._gl.UNSIGNED_INT||r===this._gl.INT?this._gl.vertexAttribIPointer(t,i,r,n,a):this._gl.vertexAttribPointer(t,i,r,s,n,a))}_bindIndexBufferWithCache(e){null!=e&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,i){const r=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let s=0;s<r.length;s++){const n=t.getAttributeLocation(s);if(n>=0){const t=r[s];let a=null;if(i&&(a=i[t]),a||(a=e[t]),!a)continue;this._gl.enableVertexAttribArray(n),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[n]=!0);const o=a.getBuffer();o&&(this._vertexAttribPointer(o,n,a.getSize(),a.type,a.normalized,a.byteStride,a.byteOffset),a.getIsInstanced()&&(this._gl.vertexAttribDivisor(n,a.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(o))))}}}recordVertexArrayObject(e,t,i,r){const s=this._gl.createVertexArray();if(!s)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(s),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,r),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),s}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=t&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,i,r,s){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==s){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=s;const t=s.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let n=0;for(let a=0;a<t;a++)if(a<i.length){const t=s.getAttributeLocation(a);t>=0&&(this._gl.enableVertexAttribArray(t),this._vertexAttribArraysEnabled[t]=!0,this._vertexAttribPointer(e,t,i[a],this._gl.FLOAT,!1,r,n)),n+=4*i[a]}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,i,r){this._cachedVertexBuffers===e&&this._cachedEffectForVertexBuffers===i||(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,r)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,i=this._currentInstanceLocations.length;t<i;t++){const i=this._currentInstanceBuffers[t];e!=i&&i.references&&(e=i,this.bindArrayBuffer(i));const r=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(r,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,0===e.references&&(this._deleteBuffer(e),!0)}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),void 0!==i[0].index)this.bindInstancesBuffer(e,i,!0);else for(let t=0;t<4;t++){const r=i[t];this._vertexAttribArraysEnabled[r]||(this._gl.enableVertexAttribArray(r),this._vertexAttribArraysEnabled[r]=!0),this._vertexAttribPointer(e,r,4,this._gl.FLOAT,!1,64,16*t),this._gl.vertexAttribDivisor(r,1),this._currentInstanceLocations.push(r),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,i=!0){this.bindArrayBuffer(e);let r=0;if(i)for(let e=0;e<t.length;e++)r+=4*t[e].attributeSize;for(let i=0;i<t.length;i++){const s=t[i];void 0===s.index&&(s.index=this._currentEffect.getAttributeLocationByName(s.attributeName)),s.index<0||(this._vertexAttribArraysEnabled[s.index]||(this._gl.enableVertexAttribArray(s.index),this._vertexAttribArraysEnabled[s.index]=!0),this._vertexAttribPointer(e,s.index,s.attributeSize,s.attributeType||this._gl.FLOAT,s.normalized||!1,r,s.offset),this._gl.vertexAttribDivisor(s.index,void 0===s.divisor?1:s.divisor),this._currentInstanceLocations.push(s.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t,i=!1;for(;-1!==(t=this._currentInstanceLocations.indexOf(e));)this._currentInstanceLocations.splice(t,1),this._currentInstanceBuffers.splice(t,1),i=!0,t=this._currentInstanceLocations.indexOf(e);i&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,i,r){this.drawElementsType(e?0:1,t,i,r)}drawPointClouds(e,t,i){this.drawArraysType(2,e,t,i)}drawUnIndexed(e,t,i,r){this.drawArraysType(e?0:1,t,i,r)}drawElementsType(e,t,i,r){this.applyStates(),this._reportDrawCall();const s=this._drawMode(e),n=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,a=this._uintIndicesCurrentlySet?4:2;r?this._gl.drawElementsInstanced(s,i,n,t*a,r):this._gl.drawElements(s,i,n,t*a)}drawArraysType(e,t,i,r){this.applyStates(),this._reportDrawCall();const s=this._drawMode(e);r?this._gl.drawArraysInstanced(s,t,i,r):this._gl.drawArrays(s,t,i)}_drawMode(e){switch(e){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){const t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,(0,g.mO)(t),this._gl&&(this._currentProgram===t.program&&this._setProgram(null),this._gl.deleteProgram(t.program)))}_getGlobalDefines(e){return(0,p.tj)(e,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(e,t,i,s,n,a,o,h,l,c=0,u){const _="string"==typeof e?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,d="string"==typeof e?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,p=this._getGlobalDefines(),g=void 0!==t.attributes;let m=n??t.defines??"";p&&(m+=p);const T=_+"+"+d+"@"+m;if(this._compiledEffects[T]){const e=this._compiledEffects[T];return o&&e.isReady()&&o(e),e._refCount++,e}this._gl&&(0,r.N5)(this._gl);const R=new f.M(e,t,g?this:i,s,this,n,a,o,h,l,T,t.shaderLanguage??c,t.extraInitializationsAsync??u);return this._compiledEffects[T]=R,R}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,i,s,n=null){const a=(0,r.N5)(this._gl);return a._contextWasLost=this._contextWasLost,a.validateShaderPrograms=this.validateShaderPrograms,(0,r.kf)(e,t,i,s||this._gl,n)}createShaderProgram(e,t,i,s,n,a=null){const o=(0,r.N5)(this._gl);return o._contextWasLost=this._contextWasLost,o.validateShaderPrograms=this.validateShaderPrograms,(0,r.EX)(e,t,i,s,n||this._gl,a)}inlineShaderCode(e){return e}createPipelineContext(e){this._gl&&((0,r.N5)(this._gl).parallelShaderCompile=this._caps.parallelShaderCompile);const t=(0,r.GX)(this._gl,e);return t.engine=this,t}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(e){return(0,r.tg)(e,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(e,t,i,s,n,a,o,h,l,c,u){const _=(0,r.N5)(this._gl);return _._contextWasLost=this._contextWasLost,_.validateShaderPrograms=this.validateShaderPrograms,_._createShaderProgramInjection=this._createShaderProgram.bind(this),_.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),_.createShaderProgramInjection=this.createShaderProgram.bind(this),_.loadFileInjection=this._loadFile.bind(this),(0,r.YM)(e,t,i,s,n,a,o,h,l,c,u)}_createShaderProgram(e,t,i,s,n=null){return(0,r.tI)(e,t,i,s,n)}_isRenderingStateCompiled(e){return!this._isDisposed&&(0,r.A5)(e,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(e,t){(0,r.bS)(e,t)}getUniforms(e,t){const i=new Array,r=e;for(let e=0;e<t.length;e++)i.push(this._gl.getUniformLocation(r.program,t[e]));return i}getAttributes(e,t){const i=[],r=e;for(let e=0;e<t.length;e++)try{i.push(this._gl.getAttribLocation(r.program,t[e]))}catch(e){i.push(-1)}return i}enableEffect(e){(e=null!==e&&function(e){return void 0===e.getPipelineContext}(e)?e.effect:e)&&e!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return!!e&&(this._gl.uniform1i(e,t),!0)}setInt2(e,t,i){return!!e&&(this._gl.uniform2i(e,t,i),!0)}setInt3(e,t,i,r){return!!e&&(this._gl.uniform3i(e,t,i,r),!0)}setInt4(e,t,i,r,s){return!!e&&(this._gl.uniform4i(e,t,i,r,s),!0)}setIntArray(e,t){return!!e&&(this._gl.uniform1iv(e,t),!0)}setIntArray2(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2iv(e,t),0))}setIntArray3(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3iv(e,t),0))}setIntArray4(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4iv(e,t),0))}setUInt(e,t){return!!e&&(this._gl.uniform1ui(e,t),!0)}setUInt2(e,t,i){return!!e&&(this._gl.uniform2ui(e,t,i),!0)}setUInt3(e,t,i,r){return!!e&&(this._gl.uniform3ui(e,t,i,r),!0)}setUInt4(e,t,i,r,s){return!!e&&(this._gl.uniform4ui(e,t,i,r,s),!0)}setUIntArray(e,t){return!!e&&(this._gl.uniform1uiv(e,t),!0)}setUIntArray2(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2uiv(e,t),0))}setUIntArray3(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3uiv(e,t),0))}setUIntArray4(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4uiv(e,t),0))}setArray(e,t){return!(!e||t.length<1||(this._gl.uniform1fv(e,t),0))}setArray2(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2fv(e,t),0))}setArray3(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3fv(e,t),0))}setArray4(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4fv(e,t),0))}setMatrices(e,t){return!!e&&(this._gl.uniformMatrix4fv(e,!1,t),!0)}setMatrix3x3(e,t){return!!e&&(this._gl.uniformMatrix3fv(e,!1,t),!0)}setMatrix2x2(e,t){return!!e&&(this._gl.uniformMatrix2fv(e,!1,t),!0)}setFloat(e,t){return!!e&&(this._gl.uniform1f(e,t),!0)}setFloat2(e,t,i){return!!e&&(this._gl.uniform2f(e,t,i),!0)}setFloat3(e,t,i,r){return!!e&&(this._gl.uniform3f(e,t,i,r),!0)}setFloat4(e,t,i,r,s){return!!e&&(this._gl.uniform4f(e,t,i,r,s),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){const i=this._gl;let r=i.NEAREST,s=i.NEAREST,n=!1;switch(e){case 11:r=i.LINEAR,s=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case 3:r=i.LINEAR,n=!0,s=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case 8:n=!0,r=i.NEAREST,s=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case 4:r=i.NEAREST,s=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case 5:r=i.NEAREST,s=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case 6:n=!0,r=i.NEAREST,s=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case 7:r=i.NEAREST,s=i.LINEAR;break;case 1:r=i.NEAREST,s=i.NEAREST;break;case 9:r=i.LINEAR,s=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case 10:n=!0,r=i.LINEAR,s=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case 2:r=i.LINEAR,s=i.LINEAR;break;case 12:r=i.LINEAR,s=i.NEAREST}return{min:s,mag:r,hasMipMaps:n}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new _.d(this._createTexture(),this._gl)}_createInternalTexture(e,t,i=!0,r=0){let n,a=!1,o=!1,h=0,l=3,c=5,u=!1,_=1,f=!1,p=0;void 0!==t&&"object"==typeof t?(a=!!t.generateMipMaps,o=!!t.createMipMaps,h=void 0===t.type?0:t.type,l=void 0===t.samplingMode?3:t.samplingMode,c=void 0===t.format?5:t.format,u=void 0!==t.useSRGBBuffer&&t.useSRGBBuffer,_=t.samples??1,n=t.label,f=!!t.createMSAATexture,p=t.comparisonFunction||0):a=!!t,u&&(u=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==h||this._caps.textureFloatLinearFiltering)&&(2!==h||this._caps.textureHalfFloatLinearFiltering)||(l=1),1!==h||this._caps.textureFloat||(h=0,s.V.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const g=(0,m.vl)(c),T=(0,m.$l)(c),R=this._gl,y=new d.h(this,r),b=e.width||e,E=e.height||e,x=e.depth||0,v=e.layers||0,C=this._getSamplingParameters(l,(a||o)&&!g),A=0!==v?R.TEXTURE_2D_ARRAY:0!==x?R.TEXTURE_3D:R.TEXTURE_2D,P=g?this._getInternalFormatFromDepthTextureFormat(c,!0,T):this._getRGBABufferInternalSizedFormat(h,c,u),M=g?T?R.DEPTH_STENCIL:R.DEPTH_COMPONENT:this._getInternalFormat(c),S=g?this._getWebGLTextureTypeFromDepthTextureFormat(c):this._getWebGLTextureType(h);if(this._bindTextureDirectly(A,y),0!==v?(y.is2DArray=!0,R.texImage3D(A,0,P,b,E,v,0,M,S,null)):0!==x?(y.is3D=!0,R.texImage3D(A,0,P,b,E,x,0,M,S,null)):R.texImage2D(A,0,P,b,E,0,M,S,null),R.texParameteri(A,R.TEXTURE_MAG_FILTER,C.mag),R.texParameteri(A,R.TEXTURE_MIN_FILTER,C.min),R.texParameteri(A,R.TEXTURE_WRAP_S,R.CLAMP_TO_EDGE),R.texParameteri(A,R.TEXTURE_WRAP_T,R.CLAMP_TO_EDGE),g&&this.webGLVersion>1&&(0===p?(R.texParameteri(A,R.TEXTURE_COMPARE_FUNC,515),R.texParameteri(A,R.TEXTURE_COMPARE_MODE,R.NONE)):(R.texParameteri(A,R.TEXTURE_COMPARE_FUNC,p),R.texParameteri(A,R.TEXTURE_COMPARE_MODE,R.COMPARE_REF_TO_TEXTURE))),(a||o)&&this._gl.generateMipmap(A),this._bindTextureDirectly(A,null),y._useSRGBBuffer=u,y.baseWidth=b,y.baseHeight=E,y.width=b,y.height=E,y.depth=v||x,y.isReady=!0,y.samples=_,y.generateMipMaps=a,y.samplingMode=l,y.type=h,y.format=c,y.label=n,y.comparisonFunction=p,this._internalTexturesCache.push(y),f){let e=null;if(e=(0,m.vl)(y.format)?this._setupFramebufferDepthAttachments((0,m.$l)(y.format),19!==y.format,y.width,y.height,_,y.format,!0):this._createRenderBuffer(y.width,y.height,_,-1,this._getRGBABufferInternalSizedFormat(y.type,y.format,y._useSRGBBuffer),-1),!e)throw new Error("Unable to create render buffer");y._autoMSAAManagement=!0;let t=y._hardwareTexture;t||(t=y._hardwareTexture=this._createHardwareTexture()),t.addMSAARenderBuffer(e)}return y}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||t)}createTexture(e,t,i,r,s=3,n=null,a=null,o=null,h=null,l=null,c=null,u,_,f,p){return this._createTextureBase(e,t,i,r,s,n,a,((...e)=>this._prepareWebGLTexture(...e,l)),((e,t,i,s,n,a)=>{const o=this._gl,h=i.width===e&&i.height===t;n._creationFlags=f??0;const l=this._getTexImageParametersForCreateTexture(n.format,n._useSRGBBuffer);if(h)return o.texImage2D(o.TEXTURE_2D,0,l.internalFormat,l.format,l.type,i),!1;const c=this._caps.maxTextureSize;if(i.width>c||i.height>c||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=e,this._workingCanvas.height=t,this._workingContext.drawImage(i,0,0,i.width,i.height,0,0,e,t),o.texImage2D(o.TEXTURE_2D,0,l.internalFormat,l.format,l.type,this._workingCanvas),n.width=e,n.height=t,1));{const e=new d.h(this,2);this._bindTextureDirectly(o.TEXTURE_2D,e,!0),o.texImage2D(o.TEXTURE_2D,0,l.internalFormat,l.format,l.type,i),this._rescaleTexture(e,n,r,l.format,(()=>{this._releaseTexture(e),this._bindTextureDirectly(o.TEXTURE_2D,n,!0),a()}))}return!0}),o,h,l,c,u,_,p)}_getTexImageParametersForCreateTexture(e,t){let i,r;return 1===this.webGLVersion?(i=this._getInternalFormat(e,t),r=i):(i=this._getInternalFormat(e,!1),r=this._getRGBABufferInternalSizedFormat(0,e,t)),{internalFormat:r,format:i,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(e,t,i,r,s){}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,i=!1){const r=this._getTextureTarget(t),s=this._getSamplingParameters(e,t.useMipMaps||i);this._setTextureParameterInteger(r,this._gl.TEXTURE_MAG_FILTER,s.mag,t),this._setTextureParameterInteger(r,this._gl.TEXTURE_MIN_FILTER,s.min),i&&s.hasMipMaps&&(t.generateMipMaps=!0,this._gl.generateMipmap(r)),this._bindTextureDirectly(r,null),t.samplingMode=e}updateTextureDimensions(e,t,i,r=1){}updateTextureWrappingMode(e,t,i=null,r=null){const s=this._getTextureTarget(e);null!==t&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),null!==i&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&null!==r&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(r),e),e._cachedWrapR=r),this._bindTextureDirectly(s,null)}_uploadCompressedDataToTextureDirectly(e,t,i,r,s,n=0,a=0){const o=this._gl;let h=o.TEXTURE_2D;if(e.isCube&&(h=o.TEXTURE_CUBE_MAP_POSITIVE_X+n),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=o.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=o.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=o.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=o.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=o.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=o.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=o.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1}this._gl.compressedTexImage2D(h,a,t,i,r,0,s)}_uploadDataToTextureDirectly(e,t,i=0,r=0,s,n=!1){const a=this._gl,o=this._getWebGLTextureType(e.type),h=this._getInternalFormat(e.format),l=void 0===s?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(s,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let c=a.TEXTURE_2D;e.isCube&&(c=a.TEXTURE_CUBE_MAP_POSITIVE_X+i);const u=Math.round(Math.log(e.width)*Math.LOG2E),_=Math.round(Math.log(e.height)*Math.LOG2E),d=n?e.width:Math.pow(2,Math.max(u-r,0)),f=n?e.height:Math.pow(2,Math.max(_-r,0));a.texImage2D(c,r,l,d,f,0,h,o,t)}updateTextureData(e,t,i,r,s,n,a=0,o=0,h=!1){const l=this._gl,c=this._getWebGLTextureType(e.type),u=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let _=l.TEXTURE_2D,d=l.TEXTURE_2D;e.isCube&&(d=l.TEXTURE_CUBE_MAP_POSITIVE_X+a,_=l.TEXTURE_CUBE_MAP),this._bindTextureDirectly(_,e,!0),l.texSubImage2D(d,o,i,r,s,n,u,c,t),h&&this._gl.generateMipmap(d),this._bindTextureDirectly(_,null)}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){const s=this._gl,n=e.isCube?s.TEXTURE_CUBE_MAP:s.TEXTURE_2D;this._bindTextureDirectly(n,e,!0),this._uploadDataToTextureDirectly(e,t,i,r),this._bindTextureDirectly(n,null,!0)}_prepareWebGLTextureContinuation(e,t,i,r,s){const n=this._gl;if(!n)return;const a=this._getSamplingParameters(s,!i);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,a.mag),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,a.min),i||r||n.generateMipmap(n.TEXTURE_2D),this._bindTextureDirectly(n.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,i,r,s,n,a,o,h,l){const u=this.getCaps().maxTextureSize,_=Math.min(u,this.needPOTTextures?(0,c.R)(r.width,u):r.width),d=Math.min(u,this.needPOTTextures?(0,c.R)(r.height,u):r.height),f=this._gl;f&&(e._hardwareTexture?(this._bindTextureDirectly(f.TEXTURE_2D,e,!0),this._unpackFlipY(void 0===s||!!s),e.baseWidth=r.width,e.baseHeight=r.height,e.width=_,e.height=d,e.isReady=!0,e.type=-1!==e.type?e.type:0,e.format=-1!==e.format?e.format:l??(".jpg"!==t||e._useSRGBBuffer?5:4),o(_,d,r,t,e,(()=>{this._prepareWebGLTextureContinuation(e,i,n,a,h)}))||this._prepareWebGLTextureContinuation(e,i,n,a,h)):i&&i.removePendingData(e))}_getInternalFormatFromDepthTextureFormat(e,t,i){const r=this._gl;if(!t)return r.STENCIL_INDEX8;let s=i?r.DEPTH_STENCIL:r.DEPTH_COMPONENT;return this.webGLVersion>1?15===e?s=r.DEPTH_COMPONENT16:16===e?s=r.DEPTH_COMPONENT24:17===e||13===e?s=i?r.DEPTH24_STENCIL8:r.DEPTH_COMPONENT24:14===e?s=r.DEPTH_COMPONENT32F:18===e&&(s=i?r.DEPTH32F_STENCIL8:r.DEPTH_COMPONENT32F):s=r.DEPTH_COMPONENT16,s}_getWebGLTextureTypeFromDepthTextureFormat(e){const t=this._gl;let i=t.UNSIGNED_INT;return 15===e?i=t.UNSIGNED_SHORT:17===e||13===e?i=t.UNSIGNED_INT_24_8:14===e?i=t.FLOAT:18===e?i=t.FLOAT_32_UNSIGNED_INT_24_8_REV:19===e&&(i=t.UNSIGNED_BYTE),i}_setupFramebufferDepthAttachments(e,t,i,r,s=1,n,a=!1){const o=this._gl;n=n??(e?13:14);const h=this._getInternalFormatFromDepthTextureFormat(n,t,e);return e&&t?this._createRenderBuffer(i,r,s,o.DEPTH_STENCIL,h,a?-1:o.DEPTH_STENCIL_ATTACHMENT):t?this._createRenderBuffer(i,r,s,h,h,a?-1:o.DEPTH_ATTACHMENT):e?this._createRenderBuffer(i,r,s,h,h,a?-1:o.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,i,r,s,n,a=!0){const o=this._gl.createRenderbuffer();return this._updateRenderBuffer(o,e,t,i,r,s,n,a)}_updateRenderBuffer(e,t,i,r,s,n,a,o=!0){const h=this._gl;return h.bindRenderbuffer(h.RENDERBUFFER,e),r>1&&h.renderbufferStorageMultisample?h.renderbufferStorageMultisample(h.RENDERBUFFER,r,n,t,i):h.renderbufferStorage(h.RENDERBUFFER,s,t,i),-1!==a&&h.framebufferRenderbuffer(h.FRAMEBUFFER,a,h.RENDERBUFFER,e),o&&h.bindRenderbuffer(h.RENDERBUFFER,null),e}_releaseTexture(e){this._deleteTexture(e._hardwareTexture),this.unbindAllTextures();const t=this._internalTexturesCache.indexOf(e);-1!==t&&this._internalTexturesCache.splice(t,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_deleteTexture(e){e?.release()}_setProgram(e){this._currentProgram!==e&&((0,r.C5)(e,this._gl),this._currentProgram=e)}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let t=0;t<i.length;t++){const r=e.getUniform(i[t]);r&&(this._boundUniforms[t]=r)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,i=!1,r=!1){let n=!1;const a=t&&t._associatedChannel>-1;if(i&&a&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||r){if(this._activateCurrentTexture(),t&&t.isMultiview)throw s.V.Error(["_bindTextureDirectly called with a multiview texture!",e,t]),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,t?._hardwareTexture?.underlyingResource??null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else i&&(n=!0,this._activateCurrentTexture());return a&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),n}_bindTexture(e,t,i){if(void 0===e)return;t&&(t._associatedChannel=e),this._activeChannel=e;const r=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(r,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,i,r){void 0!==e&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))}_bindSamplerUniformToChannel(e,t){const i=this._boundUniforms[e];i&&i._currentState!==t&&(this._gl.uniform1i(i,t),i._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,i=!1,r=!1,s=""){if(!t)return null!=this._boundTexturesCache[e]&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video){this._activeChannel=e;const i=t.getInternalTexture();i&&(i._associatedChannel=e),t.update()}else if(4===t.delayLoadState)return t.delayLoad(),!1;let n;n=r?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!i&&n&&(n._associatedChannel=e);let a=!0;this._boundTexturesCache[e]===n&&(i||this._bindSamplerUniformToChannel(n._associatedChannel,e),a=!1),this._activeChannel=e;const o=this._getTextureTarget(n);if(a&&this._bindTextureDirectly(o,n,i),n&&!n.isMultiview){if(n.isCube&&n._cachedCoordinatesMode!==t.coordinatesMode){n._cachedCoordinatesMode=t.coordinatesMode;const e=3!==t.coordinatesMode&&5!==t.coordinatesMode?1:0;t.wrapU=e,t.wrapV=e}n._cachedWrapU!==t.wrapU&&(n._cachedWrapU=t.wrapU,this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),n)),n._cachedWrapV!==t.wrapV&&(n._cachedWrapV=t.wrapV,this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),n)),n.is3D&&n._cachedWrapR!==t.wrapR&&(n._cachedWrapR=t.wrapR,this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),n)),this._setAnisotropicLevel(o,n,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,i,r){if(void 0!==e&&t){this._textureUnits&&this._textureUnits.length===i.length||(this._textureUnits=new Int32Array(i.length));for(let t=0;t<i.length;t++){const r=i[t].getInternalTexture();r?(this._textureUnits[t]=e+t,r._associatedChannel=e+t):this._textureUnits[t]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let e=0;e<i.length;e++)this._setTexture(this._textureUnits[e],i[e],!0)}}_setAnisotropicLevel(e,t,i){const r=this._caps.textureAnisotropicFilterExtension;11!==t.samplingMode&&3!==t.samplingMode&&2!==t.samplingMode&&(i=1),r&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)}_setTextureParameterFloat(e,t,i,r){this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameterf(e,t,i)}_setTextureParameterInteger(e,t,i,r){r&&this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameteri(e,t,i)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e)}else for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){(0,n.BA)()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose&&this._gl.getExtension("WEBGL_lose_context")?.loseContext(),(0,r.Cm)(this._gl)}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){const t=this._gl;for(;t.getError()!==t.NO_ERROR;);let i=!0;const r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const s=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,s),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0);const n=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&n===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);const e=t.RGBA,r=t.UNSIGNED_BYTE,s=new Uint8Array(4);t.readPixels(0,0,1,1,e,r,s),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(r),t.deleteFramebuffer(s),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i}_getWebGLTextureType(e){if(1===this._webGLVersion){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:i=this._gl.RED;break;case 7:case 33324:case 36761:i=this._gl.RG;break;case 4:case 32852:case 36762:i=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER}return i}_getRGBABufferInternalSizedFormat(e,t,i=!1){if(1===this._webGLVersion){if(void 0!==t)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(e,t,i,r,n=!0,a=!0,o=null){const h=n?4:3,l=n?this._gl.RGBA:this._gl.RGB,c=i*r*h;if(o){if(o.length<c)return s.V.Error(`Data buffer is too small to store the read pixels (${o.length} should be more than ${c})`),Promise.resolve(o)}else o=new Uint8Array(c);return a&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,r,l,this._gl.UNSIGNED_BYTE,o),Promise.resolve(o)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const e=u.$._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=null!=t&&!!window.WebGLRenderingContext}catch(e){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const e=u.$._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch(e){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}R._TempClearColorUint32=new Uint32Array(4),R._TempClearColorInt32=new Int32Array(4),R.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],R._ConcatenateShader=p.iL,R._IsSupported=null,R._HasMajorPerformanceCaveat=null},6326:(e,t,i)=>{i.d(t,{$:()=>R});var r=i(6315),s=i(1137),n=i(4420),a=i(215),o=i(6237);class h{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}class l{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){this.stencilMaterial=void 0,this.stencilGlobal?.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){if(!e)return;const t=!this.useStencilGlobalOnly&&!!this.stencilMaterial?.enabled;this.enabled=t?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=t?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=t?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=t?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=t?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=t?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=t?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=t?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}}class c{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=c.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=c.KEEP,this.opDepthFail=c.KEEP,this.opStencilDepthPass=c.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}c.ALWAYS=519,c.KEEP=7680,c.REPLACE=7681;class u{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,i,r){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===r||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=r,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,i,r){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===r||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=r,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}}var _=i(5503),d=i(854),f=i(8790),p=i(9848),g=i(6741),m=i(8454);function T(e,t){if((0,f.BA)()){const{requestAnimationFrame:i}=t||window;if("function"==typeof i)return i(e)}else if("function"==typeof requestAnimationFrame)return requestAnimationFrame(e);return setTimeout(e,16)}class R{get frameId(){return this._frameId}get isWebGPU(){return this._isWebGPU}_getShaderProcessor(e){return this._shaderProcessor}get shaderPlatformName(){return this._shaderPlatformName}_clearEmptyResources(){this._emptyTexture=null,this._emptyCubeTexture=null,this._emptyTexture3D=null,this._emptyTexture2DArray=null}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,this._depthCullingState.depthFunc=e?518:515)}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}_getGlobalDefines(e){if(e)return this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,void(this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS);{let e="";return this.isNDCHalfZRange&&(e+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(e&&(e+="\n"),e+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(e&&(e+="\n"),e+="#define USE_EXACT_SRGB_CONVERSIONS"),e}}_rebuildInternalTextures(){const e=this._internalTexturesCache.slice();for(const t of e)t._rebuild()}_rebuildRenderTargetWrappers(){const e=this._renderTargetWrapperCache.slice();for(const t of e)t._rebuild()}_rebuildEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e];t._pipelineContext=null,t._prepareEffect()}n.M.ResetCache()}_rebuildGraphicsResources(){this.wipeCaches(!0),this._rebuildEffects(),this._rebuildComputeEffects?.(),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0)}_flagContextRestored(){s.V.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1}_restoreEngineAfterContextLost(e){setTimeout((()=>{this._clearEmptyResources();const t=this._depthCullingState.depthTest,i=this._depthCullingState.depthFunc,r=this._depthCullingState.depthMask,s=this._stencilState.stencilTest;e(),this._rebuildGraphicsResources(),this._depthCullingState.depthTest=t,this._depthCullingState.depthFunc=i,this._depthCullingState.depthMask=r,this._stencilState.stencilTest=s,this._flagContextRestored()}),0)}get isDisposed(){return this._isDisposed}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return 0}set snapshotRenderingMode(e){}getClassName(){return"AbstractEngine"}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get activeRenderLoops(){return this._activeRenderLoops}stopRenderLoop(e){if(!e)return this._activeRenderLoops.length=0,void this._cancelFrame();const t=this._activeRenderLoops.indexOf(e);t>=0&&(this._activeRenderLoops.splice(t,1),0==this._activeRenderLoops.length&&this._cancelFrame())}_cancelFrame(){if(0!==this._frameHandler){const e=this._frameHandler;if(this._frameHandler=0,(0,f.BA)()){const{cancelAnimationFrame:t}=this.getHostWindow()||window;if("function"==typeof t)return t(e)}else if("function"==typeof cancelAnimationFrame)return cancelAnimationFrame(e);return clearTimeout(e)}}beginFrame(){this.onBeginFrameObservable.notifyObservers(this)}endFrame(){this._frameId++,this.onEndFrameObservable.notifyObservers(this)}get maxFPS(){return this._maxFPS}set maxFPS(e){this._maxFPS=e,void 0!==e&&(this._minFrameTime=e<=0?Number.MAX_VALUE:1e3/e)}_isOverFrameTime(e){if(!e||void 0===this._maxFPS)return!1;const t=e-this._lastFrameTime;return this._lastFrameTime=e,this._renderAccumulator+=t,this._renderAccumulator<this._minFrameTime||(this._renderAccumulator-=this._minFrameTime,this._renderAccumulator>this._minFrameTime&&(this._renderAccumulator=this._minFrameTime),!1)}_processFrame(e){if(this._frameHandler=0,!this._contextWasLost&&!this._isOverFrameTime(e)){let e=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e&&(this.beginFrame(),this.skipFrameRender||this._renderViews()||this._renderFrame(),this.endFrame())}}_renderLoop(e){this._processFrame(e),this._activeRenderLoops.length>0&&0===this._frameHandler&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++)(0,this._activeRenderLoops[e])()}_renderViews(){return!1}_queueNewFrame(e,t){return T(e,t)}runRenderLoop(e){-1===this._activeRenderLoops.indexOf(e)&&(this._activeRenderLoops.push(e),1===this._activeRenderLoops.length&&0===this._frameHandler&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){const e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){const e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}getHostWindow(){return(0,f.BA)()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}_rebuildTextures(){for(const e of this.scenes)e._rebuildTextures();for(const e of this._virtualScenes)e._rebuildTextures()}_releaseRenderTargetWrapper(e){const t=this._renderTargetWrapperCache.indexOf(e);-1!==t&&this._renderTargetWrapperCache.splice(t,1)}get currentViewport(){return this._cachedViewport}setViewport(e,t,i){const r=t||this.getRenderWidth(),s=i||this.getRenderHeight(),n=e.x||0,a=e.y||0;this._cachedViewport=e,this._viewport(n*r,a*s,r*e.width,s*e.height)}createCanvasImage(){return document.createElement("img")}createCanvasPath2D(e){return new Path2D(e)}get description(){let e=this.name+this.version;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}_createTextureBase(e,t,i,n,a=3,o=null,h=null,l,c,u=null,_=null,f=null,p=null,g,T,y){const b="data:"===(e=e||"").substring(0,5),E="blob:"===e.substring(0,5),x=b&&-1!==e.indexOf(";base64,"),v=_||new d.h(this,1);v!==_&&(v.label=e.substring(0,60));const C=e;!this._transformTextureUrl||x||_||u||(e=this._transformTextureUrl(e)),C!==e&&(v._originalUrl=C);const A=e.lastIndexOf(".");let P=p||(A>-1?e.substring(A).toLowerCase():"");P.indexOf("?")>-1&&(P=P.split("?")[0]);const M=(0,m.gT)(P,g);n&&n.addPendingData(v),v.url=e,v.generateMipMaps=!t,v.samplingMode=a,v.invertY=i,v._useSRGBBuffer=this._getUseSRGBBuffer(!!y,t),this._doNotHandleContextLost||(v._buffer=u);let S=null;o&&!_&&(S=v.onLoadedObservable.add(o)),_||this._internalTexturesCache.push(v);const F=(i,_)=>{n&&n.removePendingData(v),e===C?(S&&v.onLoadedObservable.remove(S),r.q.UseFallbackTexture&&e!==r.q.FallbackTexture&&this._createTextureBase(r.q.FallbackTexture,t,v.invertY,n,a,null,h,l,c,u,v),i=(i||"Unknown error")+(r.q.UseFallbackTexture?" - Fallback texture was used":""),v.onErrorObservable.notifyObservers({message:i,exception:_}),h&&h(i,_)):(s.V.Warn(`Failed to load ${e}, falling back to ${C}`),this._createTextureBase(C,t,v.invertY,n,a,o,h,l,c,u,v,f,p,g,T,y))};if(M){const t=async e=>{(await M).loadData(e,v,((e,t,i,r,s,o)=>{o?F("TextureLoader failed to load data"):l(v,P,n,{width:e,height:t},v.invertY,!i,r,(()=>(s(),!1)),a)}),T)};u?u instanceof ArrayBuffer?t(new Uint8Array(u)):ArrayBuffer.isView(u)?t(u):h&&h("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,(e=>{t(new Uint8Array(e))}),void 0,n?n.offlineProvider:void 0,!0,((e,t)=>{F("Unable to load "+(e&&e.responseURL,t))}))}else{const i=e=>{E&&!this._doNotHandleContextLost&&(v._buffer=e),l(v,P,n,e,v.invertY,t,!1,c,a)};!b||x?u&&("string"==typeof u.decoding||u.close)?i(u):R._FileToolsLoadImage(e||"",i,F,n?n.offlineProvider:null,g,v.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0,this):"string"==typeof u||u instanceof ArrayBuffer||ArrayBuffer.isView(u)||u instanceof Blob?R._FileToolsLoadImage(u,i,F,n?n.offlineProvider:null,g,v.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0,this):u&&i(u)}return v}_rebuildBuffers(){for(const e of this._uniformBuffers)e._rebuildAfterContextLost()}get _shouldUseHighPrecisionShader(){return!(!this._caps.highPrecisionShaderSupported||!this._highPrecisionShadersAllowed)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:(0,f.Nf)()?document:null}getLoadedTexturesCache(){return this._internalTexturesCache}clearInternalTexturesCache(){this._internalTexturesCache.length=0}getCaps(){return this._caps}resetTextureCache(){for(const e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}get name(){return this._name}set name(e){this._name=e}static get NpmPackage(){return"babylonjs@8.10.0"}static get Version(){return"8.10.0"}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get isStencilEnable(){return this._isStencilEnable}getCreationOptions(){return this._creationOptions}constructor(e,t,i){this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new h,this._stencilStateComposer=new l,this._stencilState=new c,this._alphaState=new u,this._alphaMode=1,this._alphaEquation=0,this._activeRequests=[],this._badOS=!1,this._badDesktopOS=!1,this._compatibilityMode=!0,this._internalTexturesCache=new Array,this._currentRenderTarget=null,this._boundTexturesCache={},this._activeChannel=0,this._currentTextureChannel=-1,this._viewportCached={x:0,y:0,z:0,w:0},this._isWebGPU=!1,this.onCanvasBlurObservable=new p.cP,this.onCanvasFocusObservable=new p.cP,this.onNewSceneAddedObservable=new p.cP,this.onResizeObservable=new p.cP,this.onCanvasPointerOutObservable=new p.cP,this.onEffectErrorObservable=new p.cP,this.disablePerformanceMonitorInBackground=!1,this.disableVertexArrayObjects=!1,this._frameId=0,this.hostInformation={isMobile:!1},this.isFullscreen=!1,this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.currentRenderPassId=0,this.isPointerLock=!1,this.postProcesses=[],this.canvasTabIndex=1,this._contextWasLost=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this._renderTargetWrapperCache=new Array,this._compiledEffects={},this._isDisposed=!1,this.scenes=[],this._virtualScenes=new Array,this.onBeforeTextureInitObservable=new p.cP,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this._frameHandler=0,this._activeRenderLoops=new Array,this._windowIsBackground=!1,this._boundRenderFunction=e=>this._renderLoop(e),this._lastFrameTime=0,this._renderAccumulator=0,this.skipFrameRender=!1,this.onBeforeShaderCompilationObservable=new p.cP,this.onAfterShaderCompilationObservable=new p.cP,this.onBeginFrameObservable=new p.cP,this.onEndFrameObservable=new p.cP,this._transformTextureUrl=null,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._highPrecisionShadersAllowed=!0,this.onContextLostObservable=new p.cP,this.onContextRestoredObservable=new p.cP,this._name="",this.premultipliedAlpha=!0,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._doNotHandleContextLost=!1,this.cullBackFaces=null,this._renderPassNames=["main"],this._fps=60,this._deltaTime=0,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this.onDisposeObservable=new p.cP,this.onReleaseEffectsObservable=new p.cP,r.q.Instances.push(this),this.startTime=o.j.Now,this._stencilStateComposer.stencilGlobal=this._stencilState,a.I.SetMatrixPrecision(!!t.useHighPrecisionMatrix),(0,f.XD)()&&navigator.userAgent&&(this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),this.adaptToDeviceRatio=i??!1,t.antialias=e??t.antialias,t.deterministicLockstep=t.deterministicLockstep??!1,t.lockstepMaxSteps=t.lockstepMaxSteps??4,t.timeStep=t.timeStep??1/60,t.stencil=t.stencil??!0,this._audioContext=t.audioEngineOptions?.audioContext??null,this._audioDestination=t.audioEngineOptions?.audioDestination??null,this.premultipliedAlpha=t.premultipliedAlpha??!0,this._doNotHandleContextLost=!!t.doNotHandleContextLost,this._isStencilEnable=!!t.stencil,this.useExactSrgbConversions=t.useExactSrgbConversions??!1;const s=(0,f.BA)()&&window.devicePixelRatio||1,n=t.limitDeviceRatio||s;i=i||t.adaptToDeviceRatio||!1,this._hardwareScalingLevel=i?1/Math.min(n,s):1,this._lastDevicePixelRatio=s,this._creationOptions=t}resize(e=!1){let t,i;if(this.adaptToDeviceRatio){const e=(0,f.BA)()&&window.devicePixelRatio||1,t=this._lastDevicePixelRatio/e;this._lastDevicePixelRatio=e,this._hardwareScalingLevel*=t}if((0,f.BA)()&&(0,f.Nf)())if(this._renderingCanvas){const e=this._renderingCanvas.getBoundingClientRect?.();t=this._renderingCanvas.clientWidth||e?.width||this._renderingCanvas.width*this._hardwareScalingLevel||100,i=this._renderingCanvas.clientHeight||e?.height||this._renderingCanvas.height*this._hardwareScalingLevel||100}else t=window.innerWidth,i=window.innerHeight;else t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100;this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e)}setSize(e,t,i=!1){if(!this._renderingCanvas)return!1;if(e|=0,t|=0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t)return!1;if(this._renderingCanvas.width=e,this._renderingCanvas.height=t,this.scenes){for(let e=0;e<this.scenes.length;e++){const t=this.scenes[e];for(let e=0;e<t.cameras.length;e++)t.cameras[e]._currentRenderId=0}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}createRawTexture(e,t,i,r,s,n,a,o,h,l,c){throw(0,_.n)("engine.rawTexture")}createRawCubeTexture(e,t,i,r,s,n,a,o){throw(0,_.n)("engine.rawTexture")}createRawTexture3D(e,t,i,r,s,n,a,o,h,l,c){throw(0,_.n)("engine.rawTexture")}createRawTexture2DArray(e,t,i,r,s,n,a,o,h,l,c){throw(0,_.n)("engine.rawTexture")}_sharedInit(e){this._renderingCanvas=e}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{const e=navigator.userAgent;this.hostInformation.isMobile=-1!==e.indexOf("Mobile")||-1!==e.indexOf("Mac")&&(0,f.Nf)()&&"ontouchend"in document},this._checkForMobile(),(0,f.BA)()&&window.addEventListener("resize",this._checkForMobile))}createVideoElement(e){return document.createElement("video")}_reportDrawCall(e=1){this._drawCalls?.addCount(e,!1)}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return 1e3*this._timeStep}_createImageBitmapFromSource(e,t){throw new Error("createImageBitmapFromSource is not implemented")}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,i){throw new Error("resizeImageBitmap is not implemented")}getFontOffset(e){throw new Error("getFontOffset is not implemented")}static _CreateCanvas(e,t){if("undefined"==typeof document)return new OffscreenCanvas(e,t);const i=document.createElement("canvas");return i.width=e,i.height=t,i}createCanvas(e,t){return R._CreateCanvas(e,t)}static _FileToolsLoadImage(e,t,i,r,s,n,a){throw(0,_.n)("FileTools")}_loadFile(e,t,i,r,s,n){const a=(0,g.sb)(e,t,i,r,s,n);return this._activeRequests.push(a),a.onCompleteObservable.add((()=>{const e=this._activeRequests.indexOf(a);-1!==e&&this._activeRequests.splice(e,1)})),a}static _FileToolsLoadFile(e,t,i,r,s,n){if(g.sg.loadFile)return g.sg.loadFile(e,t,i,r,s,n);throw(0,_.n)("FileTools")}dispose(){for(this.releaseEffects(),this._isDisposed=!0,this.stopRenderLoop(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._renderingCanvas=null,this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(;this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();this.releaseComputeEffects?.(),n.M.ResetCache();for(const e of this._activeRequests)e.abort();this._boundRenderFunction=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onNewSceneAddedObservable.clear(),this.onEffectErrorObservable.clear(),(0,f.BA)()&&window.removeEventListener("resize",this._checkForMobile);const e=r.q.Instances.indexOf(this);e>=0&&r.q.Instances.splice(e,1),r.q.Instances.length||(r.q.OnEnginesDisposedObservable.notifyObservers(this),r.q.OnEnginesDisposedObservable.clear()),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}static DefaultLoadingScreenFactory(e){throw(0,_.n)("LoadingScreen")}static MarkAllMaterialsAsDirty(e,t){for(let i=0;i<r.q.Instances.length;i++){const s=r.q.Instances[i];for(let i=0;i<s.scenes.length;i++)s.scenes[i].markAllMaterialsAsDirty(e,t)}}}R._RenderPassIdCounter=0,R._RescalePostProcessFactory=null,R.CollisionsEpsilon=.001,R.QueueNewFrame=T},6552:(e,t,i)=>{i.d(t,{Y5:()=>s,n9:()=>n});const r={};function s(e,t){r[e]=t}function n(e){return r[e]}},6741:(e,t,i)=>{i.d(t,{iL:()=>n,kZ:()=>h,sb:()=>a,sg:()=>s,tj:()=>o});var r=i(5503);i(8790);const s={};function n(e,t,i=""){return i+(t?t+"\n":"")+e}function a(e,t,i,n,a,o,h){const l=h||s.loadFile;if(l)return l(e,t,i,n,a,o);throw(0,r.n)("FileTools")}function o(e,t,i,r){if(e)return t?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,i?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,void(r?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS);{let e="";return t&&(e+="#define IS_NDC_HALF_ZRANGE"),i&&(e&&(e+="\n"),e+="#define USE_REVERSE_DEPTHBUFFER"),r&&(e&&(e+="\n"),e+="#define USE_EXACT_SRGB_CONVERSIONS"),e}}function h(e,t,i=!1,r){switch(e){case 3:{const e=(ArrayBuffer,new Int8Array(t));return r&&e.set(new Int8Array(r)),e}case 0:{const e=(ArrayBuffer,new Uint8Array(t));return r&&e.set(new Uint8Array(r)),e}case 4:{const e=t instanceof ArrayBuffer?new Int16Array(t):new Int16Array(i?t/2:t);return r&&e.set(new Int16Array(r)),e}case 5:case 8:case 9:case 10:case 2:{const e=t instanceof ArrayBuffer?new Uint16Array(t):new Uint16Array(i?t/2:t);return r&&e.set(new Uint16Array(r)),e}case 6:{const e=t instanceof ArrayBuffer?new Int32Array(t):new Int32Array(i?t/4:t);return r&&e.set(new Int32Array(r)),e}case 7:case 11:case 12:case 13:case 14:case 15:{const e=t instanceof ArrayBuffer?new Uint32Array(t):new Uint32Array(i?t/4:t);return r&&e.set(new Uint32Array(r)),e}case 1:{const e=t instanceof ArrayBuffer?new Float32Array(t):new Float32Array(i?t/4:t);return r&&e.set(new Float32Array(r)),e}}const s=(ArrayBuffer,new Uint8Array(t));return r&&s.set(new Uint8Array(r)),s}},6877:(e,t,i)=>{i.d(t,{p:()=>l});var r=i(5503),s=i(7503),n=i(6041),a=i(4037),o=i(6080);const h=function(e,t,i,r={}){const n=e();s.Y&&s.Y.HasTags(t)&&s.Y.AddTagsTo(n,s.Y.GetTags(t,!0));const a=(0,o.K)(n),h={};for(const e in a){const s=a[e],o=t[e],c=s.type;if(null!=o&&("uniqueId"!==e||l.AllowLoadingUniqueId))switch(c){case 0:case 6:case 9:case 11:n[e]=o;break;case 1:r.cloneTexturesOnlyOnce&&h[o.uniqueId]?n[e]=h[o.uniqueId]:(n[e]=i||o.isRenderTarget?o:o.clone(),h[o.uniqueId]=n[e]);break;case 2:case 3:case 4:case 5:case 7:case 8:case 10:case 12:n[e]=i?o:o.clone()}}return n};class l{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let i=0;i<e.animations.length;i++){const r=e.animations[i];t.animations.push(r.serialize())}}}static Serialize(e,t){t||(t={}),s.Y&&(t.tags=s.Y.GetTags(e));const i=(0,o.K)(e);for(const r in i){const s=i[r],n=s.sourceName||r,a=s.type,o=e[r];if(null!=o&&("uniqueId"!==r||l.AllowLoadingUniqueId))switch(a){case 0:t[n]=o;break;case 1:case 3:case 7:case 9:t[n]=o.serialize();break;case 2:case 4:case 5:case 8:case 10:case 12:t[n]=o.asArray();break;case 6:case 11:t[n]=o.id}}return t}static ParseProperties(e,t,i,r){r||(r="");const s=(0,o.K)(t);for(const o in s){const h=s[o],c=e[h.sourceName||o],u=h.type;if(null!=c&&("uniqueId"!==o||l.AllowLoadingUniqueId)){const e=t;switch(u){case 0:e[o]=c;break;case 1:i&&(e[o]=l._TextureParser(c,i,r));break;case 2:e[o]=n.v9.FromArray(c);break;case 3:e[o]=l._FresnelParametersParser(c);break;case 4:e[o]=a.I9.FromArray(c);break;case 5:e[o]=a.Pq.FromArray(c);break;case 6:i&&(e[o]=i.getLastMeshById(c));break;case 7:e[o]=l._ColorCurvesParser(c);break;case 8:e[o]=n.ov.FromArray(c);break;case 9:e[o]=l._ImageProcessingConfigurationParser(c);break;case 10:e[o]=a.PT.FromArray(c);break;case 11:i&&(e[o]=i.getCameraById(c));break;case 12:e[o]=a.uq.FromArray(c)}}}}static Parse(e,t,i,r=null){const n=e();return s.Y&&s.Y.AddTagsTo(n,t.tags),l.ParseProperties(t,n,i,r),n}static Clone(e,t,i={}){return h(e,t,!1,i)}static Instanciate(e,t){return h(e,t,!0)}}l.AllowLoadingUniqueId=!1,l._ImageProcessingConfigurationParser=e=>{throw(0,r.n)("ImageProcessingConfiguration")},l._FresnelParametersParser=e=>{throw(0,r.n)("FresnelParameters")},l._ColorCurvesParser=e=>{throw(0,r.n)("ColorCurves")},l._TextureParser=(e,t,i)=>{throw(0,r.n)("Texture")}},7309:(e,t,i)=>{function r(e,t){const i=[];for(let r=0;r<e;++r)i.push(t());return i}function s(e,t){return r(e,t)}i.d(t,{lL:()=>a,ln:()=>s,mI:()=>r});const n=["push","splice","pop","shift","unshift"];function a(e,t){const i=n.map((i=>function(e,t,i){const r=e[t];if("function"!=typeof r)return null;const s=function(){const r=e.length,n=s.previous.apply(e,arguments);return i(t,r),n};return r.next=s,s.previous=r,e[t]=s,()=>{const i=s.previous;if(!i)return;const r=s.next;r?(i.next=r,r.previous=i):(i.next=void 0,e[t]=i),s.next=void 0,s.previous=void 0}}(e,i,t)));return()=>{for(const e of i)e?.()}}},7503:(e,t,i)=>{i.d(t,{Y:()=>s});class r{static Eval(e,t){return"true"===(e=e.match(/\([^()]*\)/g)?e.replace(/\([^()]*\)/g,(e=>(e=e.slice(1,e.length-1),r._HandleParenthesisContent(e,t)))):r._HandleParenthesisContent(e,t))||"false"!==e&&r.Eval(e,t)}static _HandleParenthesisContent(e,t){let i;t=t||(e=>"true"===e);const s=e.split("||");for(const e in s)if(Object.prototype.hasOwnProperty.call(s,e)){let n=r._SimplifyNegation(s[e].trim());const a=n.split("&&");if(a.length>1)for(let e=0;e<a.length;++e){const s=r._SimplifyNegation(a[e].trim());if(i="true"!==s&&"false"!==s?"!"===s[0]?!t(s.substring(1)):t(s):"true"===s,!i){n="false";break}}if(i||"true"===n){i=!0;break}i="true"!==n&&"false"!==n?"!"===n[0]?!t(n.substring(1)):t(n):"true"===n}return i?"true":"false"}static _SimplifyNegation(e){return"!true"===(e=(e=e.replace(/^[\s!]+/,(e=>(e=e.replace(/[\s]/g,(()=>""))).length%2?"!":""))).trim())?e="false":"!false"===e&&(e="true"),e}}class s{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>s.HasTags(e),e.addTags=t=>s.AddTagsTo(e,t),e.removeTags=t=>s.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>s.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const t=e._tags;for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){const t=[];for(const i in e._tags)Object.prototype.hasOwnProperty.call(e._tags,i)&&!0===e._tags[i]&&t.push(i);return t.join(" ")}return e._tags}static AddTagsTo(e,t){if(!t)return;if("string"!=typeof t)return;const i=t.split(" ");for(const t of i)s._AddTagTo(e,t)}static _AddTagTo(e,t){""!==(t=t.trim())&&"true"!==t&&"false"!==t&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(s.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!s.HasTags(e))return;const i=t.split(" ");for(const t in i)s._RemoveTagFrom(e,i[t])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return void 0===t||(""===t?s.HasTags(e):r.Eval(t,(t=>s.HasTags(e)&&e._tags[t])))}}},7647:(e,t,i)=>{i.d(t,{JH:()=>u,b4:()=>l,mO:()=>c,uR:()=>d});var r=i(8790),s=i(5852),n=i(9610),a=i(1137),o=i(9125),h=i(6741);function l(e,t){return(0,s.N5)(t).cachedPipelines[e]}function c(e){const t=e._name,i=e.context;if(t&&i){const e=(0,s.N5)(i),r=e.cachedPipelines[t];r?.dispose(),delete e.cachedPipelines[t]}}function u(e,t,i,s,n,a,h){let l,c;const u=(0,r.BA)()?a?.getHostDocument():null;l="string"==typeof t?t:t.vertexSource?"source:"+t.vertexSource:t.vertexElement?u?.getElementById(t.vertexElement)||t.vertexElement:t.vertex||t,c="string"==typeof t?t:t.fragmentSource?"source:"+t.fragmentSource:t.fragmentElement?u?.getElementById(t.fragmentElement)||t.fragmentElement:t.fragment||t;const d=[void 0,void 0],f=()=>{if(d[0]&&d[1]){e.isFragment=!0;const[r,l]=d;(0,o.M0)(l,e,((a,l)=>{h&&(h._fragmentSourceCodeBeforeMigration=l),i&&(a=i("fragment",a));const c=(0,o.nO)(r,a,e);e=null;const u=function(e,t,i,r){return i?{vertexSourceCode:(1===r?"//":"")+"#define SHADER_NAME vertex:"+(i.vertexElement||i.vertex||i.spectorName||i)+"\n"+e,fragmentSourceCode:(1===r?"//":"")+"#define SHADER_NAME fragment:"+(i.fragmentElement||i.fragment||i.spectorName||i)+"\n"+t}:{vertexSourceCode:e,fragmentSourceCode:t}}(c.vertexCode,c.fragmentCode,t,n);s?.(u.vertexSourceCode,u.fragmentSourceCode)}),a)}};_(l,"Vertex","",(t=>{(0,o.pB)(e),(0,o.M0)(t,e,((e,r)=>{h&&(h._rawVertexSourceCode=t,h._vertexSourceCodeBeforeMigration=r),i&&(e=i("vertex",e)),d[0]=e,f()}),a)}),n),_(c,"Fragment","Pixel",(e=>{h&&(h._rawFragmentSourceCode=e),d[1]=e,f()}),n)}function _(e,t,i,s,a,o){if("undefined"!=typeof HTMLElement&&e instanceof HTMLElement)return void s((0,r.Zl)(e));if("source:"===e.substring(0,7))return void s(e.substring(7));if("base64:"===e.substring(0,7))return void s(window.atob(e.substring(7)));const l=n.l.GetShadersStore(a);if(l[e+t+"Shader"])return void s(l[e+t+"Shader"]);if(i&&l[e+i+"Shader"])return void s(l[e+i+"Shader"]);let c;if(c="."===e[0]||"/"===e[0]||e.indexOf("http")>-1?e:n.l.GetShadersRepository(a)+e,!(o=o||h.sb))throw new Error("loadFileInjection is not defined");o(c+"."+t.toLowerCase()+".fx",s)}const d=(e,t,i,r)=>{try{const n=e.context?(0,s.N5)(e.context):null;n&&(n.disableParallelShaderCompile=e.disableParallelCompilation);const a=e.existingPipelineContext||t(e.shaderProcessingContext);return a._name=e.name,e.name&&n&&(n.cachedPipelines[e.name]=a),i(a,e.vertex,e.fragment,!!e.createAsRaw,"","",e.rebuildRebind,e.defines,e.transformFeedbackVaryings,"",(()=>{r(a,(()=>{e.onRenderingStateCompiled?.(a)}))})),a}catch(e){throw a.V.Error("Error compiling effect"),e}}},7716:(e,t,i)=>{i.d(t,{d:()=>r});class r{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&!(e=t.createTexture()))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}getMSAARenderBuffer(e=0){return this._MSAARenderBuffers?.[e]??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}},7931:(e,t,i)=>{i.d(t,{L:()=>r,b:()=>s});class r{constructor(e){this.length=0,this.data=new Array(e),this._id=r._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){const t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return-1!==this.indexOf(e)}}r._GlobalId=0;class s extends r{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return!(e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId||(this.push(e),0))}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++){const i=(e.data||e)[t];this.pushNoDuplicate(i)}}}}},8086:(e,t,i)=>{function r(e){return 13===e||14===e||15===e||16===e||17===e||18===e||19===e}function s(e){return 13===e||17===e||18===e||19===e}i.d(t,{$l:()=>s,vl:()=>r})},8123:(e,t,i)=>{var r;i.d(t,{s:()=>s}),function(e){e[e.PointerMove=0]="PointerMove",e[e.PointerDown=1]="PointerDown",e[e.PointerUp=2]="PointerUp"}(r||(r={}));class s{}s.DOM_DELTA_PIXEL=0,s.DOM_DELTA_LINE=1,s.DOM_DELTA_PAGE=2},8454:(e,t,i)=>{i.d(t,{gT:()=>a});var r=i(1137);const s=new Map;function n(e,t){(function(e){return s.delete(e)})(e)&&r.V.Warn(`Extension with the name '${e}' already exists`),s.set(e,t)}function a(e,t){"image/ktx"!==t&&"image/ktx2"!==t||(e=".ktx"),s.has(e)||(e.endsWith(".ies")&&n(".ies",(async()=>await i.e(189).then(i.bind(i,8189)).then((e=>new e._IESTextureLoader)))),e.endsWith(".dds")&&n(".dds",(async()=>await Promise.all([i.e(71),i.e(281),i.e(976),i.e(994)]).then(i.bind(i,994)).then((e=>new e._DDSTextureLoader)))),e.endsWith(".basis")&&n(".basis",(async()=>await Promise.all([i.e(281),i.e(692)]).then(i.bind(i,6692)).then((e=>new e._BasisTextureLoader)))),e.endsWith(".env")&&n(".env",(async()=>await Promise.all([i.e(71),i.e(281),i.e(976),i.e(834)]).then(i.bind(i,5834)).then((e=>new e._ENVTextureLoader)))),e.endsWith(".hdr")&&n(".hdr",(async()=>await i.e(608).then(i.bind(i,5608)).then((e=>new e._HDRTextureLoader)))),(e.endsWith(".ktx")||e.endsWith(".ktx2"))&&(n(".ktx",(async()=>await i.e(788).then(i.bind(i,788)).then((e=>new e._KTXTextureLoader)))),n(".ktx2",(async()=>await i.e(788).then(i.bind(i,788)).then((e=>new e._KTXTextureLoader))))),e.endsWith(".tga")&&n(".tga",(async()=>await i.e(318).then(i.bind(i,1318)).then((e=>new e._TGATextureLoader)))),e.endsWith(".exr")&&n(".exr",(async()=>await i.e(685).then(i.bind(i,8685)).then((e=>new e._ExrTextureLoader)))));const r=s.get(e);return r?Promise.resolve(r(t)):null}},8688:(e,t,i)=>{function r(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}i.d(t,{z:()=>r})},8733:(e,t,i)=>{i.d(t,{_0:()=>a});var r,s,n=i(4037);!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD",e[e.BONE=2]="BONE"}(r||(r={}));class a{}a.X=new n.Pq(1,0,0),a.Y=new n.Pq(0,1,0),a.Z=new n.Pq(0,0,1),function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"}(s||(s={}))},8790:(e,t,i)=>{function r(){return"undefined"!=typeof window}function s(){return"undefined"!=typeof navigator}function n(){return"undefined"!=typeof document}function a(e){let t="",i=e.firstChild;for(;i;)3===i.nodeType&&(t+=i.textContent),i=i.nextSibling;return t}i.d(t,{BA:()=>r,Nf:()=>n,XD:()=>s,Zl:()=>a})},8983:(e,t,i)=>{i.d(t,{N:()=>P});var r=i(854),s=i(6315),n=i(6321),a=i(6237);class o{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new h(e)}sampleFrame(e=a.j.Now){if(this._enabled){if(null!=this._lastFrameTimeMs){const t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return 0===e?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class h{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){const e=this._samples[this._pos];t=e-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(e-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const t=this._samples.length;return(e%t+t)%t}}var l=i(4329),c=i(1137),u=i(7716);n.ThinEngine.prototype.setAlphaMode=function(e,t=!1){if(this._alphaMode!==e){switch(e){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}t||(this.depthCullingState.depthMask=0===e),this._alphaMode=e}else if(!t){const t=0===e;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}};var _=i(1597);function d(e,t,i,r){let s,n=1;1===r?s=new Float32Array(t*i*4):2===r?(s=new Uint16Array(t*i*4),n=15360):s=7===r?new Uint32Array(t*i*4):new Uint8Array(t*i*4);for(let r=0;r<t;r++)for(let a=0;a<i;a++){const i=3*(a*t+r),o=4*(a*t+r);s[o+0]=e[i+0],s[o+1]=e[i+1],s[o+2]=e[i+2],s[o+3]=n}return s}function f(e){return function(t,i,s,n,a,o,h,l,c=null,u=0){const _=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,d=e?10:11,f=new r.h(this,d);f.baseWidth=i,f.baseHeight=s,f.baseDepth=n,f.width=i,f.height=s,f.depth=n,f.format=a,f.type=u,f.generateMipMaps=o,f.samplingMode=l,e?f.is3D=!0:f.is2DArray=!0,this._doNotHandleContextLost||(f._bufferView=t),e?this.updateRawTexture3D(f,t,a,h,c,u):this.updateRawTexture2DArray(f,t,a,h,c,u),this._bindTextureDirectly(_,f,!0);const p=this._getSamplingParameters(l,o);return this._gl.texParameteri(_,this._gl.TEXTURE_MAG_FILTER,p.mag),this._gl.texParameteri(_,this._gl.TEXTURE_MIN_FILTER,p.min),o&&this._gl.generateMipmap(_),this._bindTextureDirectly(_,null),this._internalTexturesCache.push(f),f}}function p(e){return function(t,i,r,s,n=null,a=0){const o=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,h=this._getWebGLTextureType(a),l=this._getInternalFormat(r),c=this._getRGBABufferInternalSizedFormat(a,r);this._bindTextureDirectly(o,t,!0),this._unpackFlipY(void 0===s||!!s),this._doNotHandleContextLost||(t._bufferView=i,t.format=r,t.invertY=s,t._compression=n),t.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&i?this._gl.compressedTexImage3D(o,0,this.getCaps().s3tc[n],t.width,t.height,t.depth,0,i):this._gl.texImage3D(o,0,c,t.width,t.height,t.depth,0,l,h,i),t.generateMipMaps&&this._gl.generateMipmap(o),this._bindTextureDirectly(o,null),t.isReady=!0}}n.ThinEngine.prototype.updateRawTexture=function(e,t,i,r,s=null,n=0,a=!1){if(!e)return;const o=this._getRGBABufferInternalSizedFormat(n,i,a),h=this._getInternalFormat(i),l=this._getWebGLTextureType(n);this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._unpackFlipY(void 0===r||!!r),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.type=n,e.invertY=r,e._compression=s),e.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&t?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[s],e.width,e.height,0,t):this._gl.texImage2D(this._gl.TEXTURE_2D,0,o,e.width,e.height,0,h,l,t),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0},n.ThinEngine.prototype.createRawTexture=function(e,t,i,s,n,a,o,h=null,l=0,c=0,u=!1){const _=new r.h(this,3);_.baseWidth=t,_.baseHeight=i,_.width=t,_.height=i,_.format=s,_.generateMipMaps=n,_.samplingMode=o,_.invertY=a,_._compression=h,_.type=l,_._useSRGBBuffer=this._getUseSRGBBuffer(u,!n),this._doNotHandleContextLost||(_._bufferView=e),this.updateRawTexture(_,e,s,a,h,l,_._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,_,!0);const d=this._getSamplingParameters(o,n);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,d.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,d.min),n&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(_),_},n.ThinEngine.prototype.createRawCubeTexture=function(e,t,i,s,n,a,o,h=null){const l=this._gl,u=new r.h(this,8);u.isCube=!0,u.format=i,u.type=s,this._doNotHandleContextLost||(u._bufferViewArray=e);const d=this._getWebGLTextureType(s);let f=this._getInternalFormat(i);f===l.RGB&&(f=l.RGBA),d!==l.FLOAT||this._caps.textureFloatLinearFiltering?d!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?d!==l.FLOAT||this._caps.textureFloatRender?d!==l.HALF_FLOAT||this._caps.colorBufferFloat||(n=!1,c.V.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(n=!1,c.V.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(n=!1,o=1,c.V.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(n=!1,o=1,c.V.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const p=t,g=p;if(u.width=p,u.height=g,u.invertY=a,u._compression=h,!this.needPOTTextures||(0,_.L8)(u.width)&&(0,_.L8)(u.height)||(n=!1),e)this.updateRawCubeTexture(u,e,i,s,a,h);else{const e=this._getRGBABufferInternalSizedFormat(s),t=0;this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,u,!0);for(let i=0;i<6;i++)h?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+i,t,this.getCaps().s3tc[h],u.width,u.height,0,void 0):l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+i,t,e,u.width,u.height,0,f,d,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,u,!0),e&&n&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const m=this._getSamplingParameters(o,n);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,m.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,m.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),u.generateMipMaps=n,u.samplingMode=o,u.isReady=!0,u},n.ThinEngine.prototype.updateRawCubeTexture=function(e,t,i,r,s,n=null,a=0){e._bufferViewArray=t,e.format=i,e.type=r,e.invertY=s,e._compression=n;const o=this._gl,h=this._getWebGLTextureType(r);let l=this._getInternalFormat(i);const c=this._getRGBABufferInternalSizedFormat(r);let u=!1;l===o.RGB&&(l=o.RGBA,u=!0),this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(void 0===s||!!s),e.width%4!=0&&o.pixelStorei(o.UNPACK_ALIGNMENT,1);for(let i=0;i<6;i++){let s=t[i];n?o.compressedTexImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+i,a,this.getCaps().s3tc[n],e.width,e.height,0,s):(u&&(s=d(s,e.width,e.height,r)),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+i,a,c,e.width,e.height,0,l,h,s))}(!this.needPOTTextures||(0,_.L8)(e.width)&&(0,_.L8)(e.height))&&e.generateMipMaps&&0===a&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),e.isReady=!0},n.ThinEngine.prototype.createRawCubeTextureFromUrl=function(e,t,i,r,s,n,a,o,h=null,l=null,c=3,u=!1){const _=this._gl,f=this.createRawCubeTexture(null,i,r,s,!n,u,c,null);t?.addPendingData(f),f.url=e,f.isReady=!1,this._internalTexturesCache.push(f);const p=e=>{if(!f._hardwareTexture)return;const i=f.width,n=a(e);if(n){if(o){const e=this._getWebGLTextureType(s);let t=this._getInternalFormat(r);const a=this._getRGBABufferInternalSizedFormat(s);let h=!1;t===_.RGB&&(t=_.RGBA,h=!0),this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,f,!0),this._unpackFlipY(!1);const l=o(n);for(let r=0;r<l.length;r++){const n=i>>r;for(let i=0;i<6;i++){let o=l[r][i];h&&(o=d(o,n,n,s)),_.texImage2D(i,r,a,n,n,0,t,e,o)}}this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(f,n,r,s,u);f.isReady=!0,t?.removePendingData(f),f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),h&&h()}};return this._loadFile(e,(e=>{p(e)}),void 0,t?.offlineProvider,!0,((e,i)=>{t?.removePendingData(f),l&&e&&l(e.status+" "+e.statusText,i)})),f},n.ThinEngine.prototype.createRawTexture2DArray=f(!1),n.ThinEngine.prototype.createRawTexture3D=f(!0),n.ThinEngine.prototype.updateRawTexture2DArray=p(!1),n.ThinEngine.prototype.updateRawTexture3D=p(!0);var g=i(6741);n.ThinEngine.prototype._readTexturePixelsSync=function(e,t,i,r=-1,s=0,n=null,a=!0,o=!1,h=0,l=0){const c=this._gl;if(!c)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const e=c.createFramebuffer();if(!e)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=e}c.bindFramebuffer(c.FRAMEBUFFER,this._dummyFramebuffer),r>-1?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+r,e._hardwareTexture?.underlyingResource,s):c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,e._hardwareTexture?.underlyingResource,s);let u=void 0!==e.type?this._getWebGLTextureType(e.type):c.UNSIGNED_BYTE;return o?n||(n=(0,g.kZ)(e.type,4*t*i)):u===c.UNSIGNED_BYTE?(n||(n=new Uint8Array(4*t*i)),u=c.UNSIGNED_BYTE):(n||(n=new Float32Array(4*t*i)),u=c.FLOAT),a&&this.flushFramebuffer(),c.readPixels(h,l,t,i,c.RGBA,u,n),c.bindFramebuffer(c.FRAMEBUFFER,this._currentFramebuffer),n},n.ThinEngine.prototype._readTexturePixels=function(e,t,i,r=-1,s=0,n=null,a=!0,o=!1,h=0,l=0){return Promise.resolve(this._readTexturePixelsSync(e,t,i,r,s,n,a,o,h,l))},n.ThinEngine.prototype.updateDynamicIndexBuffer=function(e,t,i=0){let r;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(e),r=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,r,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},n.ThinEngine.prototype.updateDynamicVertexBuffer=function(e,t,i,r){this.bindArrayBuffer(e),void 0===i&&(i=0);const s=t.byteLength||t.length;void 0===r||r>=s&&0===i?t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,new Float32Array(t)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,t):t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,new Float32Array(t).subarray(0,r/4)):(t=t instanceof ArrayBuffer?new Uint8Array(t,0,r):new Uint8Array(t.buffer,t.byteOffset,r),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,t)),this._resetVertexBufferBinding()},n.ThinEngine.prototype._createDepthStencilCubeTexture=function(e,t){const i=new r.h(this,12);if(i.isCube=!0,1===this.webGLVersion)return c.V.Error("Depth cube texture is not supported by WebGL 1."),i;const s={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...t},n=this._gl;this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,i,!0),this._setupDepthStencilTexture(i,e,s.bilinearFiltering,s.comparisonFunction);for(let t=0;t<6;t++)s.generateStencil?n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,n.DEPTH24_STENCIL8,e,e,0,n.DEPTH_STENCIL,n.UNSIGNED_INT_24_8,null):n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,n.DEPTH_COMPONENT24,e,e,0,n.DEPTH_COMPONENT,n.UNSIGNED_INT,null);return this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(i),i},n.ThinEngine.prototype._setCubeMapTextureParams=function(e,t,i){const r=this._gl;r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,t?r.LINEAR_MIPMAP_LINEAR:r.LINEAR),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),e.samplingMode=t?3:2,t&&this.getCaps().textureMaxLevel&&void 0!==i&&i>0&&(r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAX_LEVEL,i),e._maxLodLevel=i),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null)},n.ThinEngine.prototype.createCubeTexture=function(e,t,i,r,s=null,n=null,a,o=null,h=!1,l=0,u=0,d=null,f,p=!1,g=null){const m=this._gl;return this.createCubeTextureBase(e,t,i,!!r,s,n,a,o,h,l,u,d,(e=>this._bindTextureDirectly(m.TEXTURE_CUBE_MAP,e,!0)),((e,t)=>{const i=this.needPOTTextures?(0,_.R)(t[0].width,this._caps.maxCubemapTextureSize):t[0].width,n=i,o=[m.TEXTURE_CUBE_MAP_POSITIVE_X,m.TEXTURE_CUBE_MAP_POSITIVE_Y,m.TEXTURE_CUBE_MAP_POSITIVE_Z,m.TEXTURE_CUBE_MAP_NEGATIVE_X,m.TEXTURE_CUBE_MAP_NEGATIVE_Y,m.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(m.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(!1);const h=a?this._getInternalFormat(a,e._useSRGBBuffer):e._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:m.RGBA;let l=a?this._getInternalFormat(a):m.RGBA;e._useSRGBBuffer&&1===this.webGLVersion&&(l=h);for(let e=0;e<o.length;e++)if(t[e].width!==i||t[e].height!==n){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void c.V.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=i,this._workingCanvas.height=n,this._workingContext.drawImage(t[e],0,0,t[e].width,t[e].height,0,0,i,n),m.texImage2D(o[e],0,h,l,m.UNSIGNED_BYTE,this._workingCanvas)}else m.texImage2D(o[e],0,h,l,m.UNSIGNED_BYTE,t[e]);r||m.generateMipmap(m.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(e,!r),e.width=i,e.height=n,e.isReady=!0,a&&(e.format=a),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),s&&s()}),!!p,g)},n.ThinEngine.prototype.generateMipMapsForCubemap=function(e,t=!0){if(e.generateMipMaps){const i=this._gl;this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,e,!0),i.generateMipmap(i.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)}};var m=i(8086);class T{get depthStencilTexture(){return this._depthStencilTexture}setDepthStencilTexture(e,t=!0){t&&this._depthStencilTexture&&this._depthStencilTexture.dispose(),this._depthStencilTexture=e,this._generateDepthBuffer=this._generateStencilBuffer=this._depthStencilTextureWithStencil=!1,e&&(this._generateDepthBuffer=!0,this._generateStencilBuffer=this._depthStencilTextureWithStencil=(0,m.$l)(e.format))}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width??this._size}get height(){return this._size.height??this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){return this._textures?.[0]??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}getBaseArrayLayer(e){if(!this._textures)return-1;const t=this._textures[e],i=this._layerIndices?.[e]??0,r=this._faceIndices?.[e]??0;return t.isCube?6*i+r:t.is3D?0:i}get samples(){return this._samples}setSamples(e,t=!0,i=!1){if(this.samples===e&&!i)return e;const r=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,r}resolveMSAATextures(){this.isMulti?this._engine.resolveMultiFramebuffer(this):this._engine.resolveFramebuffer(this)}generateMipMaps(){this._engine._currentRenderTarget===this&&this._engine.unBindFramebuffer(this,!0),this.isMulti?this._engine.generateMipMapsMultiFramebuffer(this):this._engine.generateMipMapsFramebuffer(this)}constructor(e,t,i,r,s){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this.disableAutomaticMSAAResolve=!1,this.resolveMSAAColors=!0,this.resolveMSAADepth=!1,this.resolveMSAAStencil=!1,this._isMulti=e,this._isCube=t,this._size=i,this._engine=r,this._depthStencilTexture=null,this.label=s}setTextures(e){Array.isArray(e)?this._textures=e:this._textures=e?[e]:null}setTexture(e,t=0,i=!0){this._textures||(this._textures=[]),this._textures[t]!==e&&(this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e)}setLayerAndFaceIndices(e,t){this._layerIndices=e,this._faceIndices=t}setLayerAndFaceIndex(e=0,t,i){this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),void 0!==t&&t>=0&&(this._layerIndices[e]=t),void 0!==i&&i>=0&&(this._faceIndices[e]=i)}createDepthStencilTexture(e=0,t=!0,i=!1,r=1,s=14,n){return this._depthStencilTexture?.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTextureLabel=n,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:r,depthTextureFormat:s,label:n},this),this._depthStencilTexture}_shareDepth(e){this.shareDepth(e)}shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,e._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){let e=null;if(this._isMulti){const t=this.textures;if(t&&t.length>0){let i=!1,r=t.length,s=-1;const n=t[t.length-1]._source;14!==n&&12!==n||(i=!0,s=t[t.length-1].format,r--);const a=[],o=[],h=[],l=[],c=[],u=[],_=[],d={};for(let e=0;e<r;++e){const i=t[e];a.push(i.samplingMode),o.push(i.type),h.push(i.format),void 0!==d[i.uniqueId]?(l.push(-1),_.push(0)):(d[i.uniqueId]=e,i.is2DArray?(l.push(35866),_.push(i.depth)):i.isCube?(l.push(34067),_.push(0)):i.is3D?(l.push(32879),_.push(i.depth)):(l.push(3553),_.push(0))),this._faceIndices&&c.push(this._faceIndices[e]??0),this._layerIndices&&u.push(this._layerIndices[e]??0)}const f={samplingModes:a,generateMipMaps:t[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:i,depthTextureFormat:s,types:o,formats:h,textureCount:r,targetTypes:l,faceIndex:c,layerIndex:u,layerCounts:_,label:this.label},p={width:this.width,height:this.height,depth:this.depth};e=this._engine.createMultipleRenderTarget(p,f);for(let i=0;i<r;++i){if(-1!==l[i])continue;const r=d[t[i].uniqueId];e.setTexture(e.textures[r],i)}}}else{const t={};if(t.generateDepthBuffer=this._generateDepthBuffer,t.generateMipMaps=this.texture?.generateMipMaps??!1,t.generateStencilBuffer=this._generateStencilBuffer,t.samplingMode=this.texture?.samplingMode,t.type=this.texture?.type,t.format=this.texture?.format,t.noColorAttachment=!this._textures,t.label=this.label,this.isCube)e=this._engine.createRenderTargetCubeTexture(this.width,t);else{const i={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?this.texture?.depth:void 0};e=this._engine.createRenderTargetTexture(i,t)}e.texture&&(e.texture.isReady=!0)}return e}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){const t=this._depthStencilTexture.samplingMode,i=this._depthStencilTexture.format,r=2===t||3===t||11===t;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,r,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,i,this._depthStencilTextureLabel)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;++e)this._textures[e].dispose();this._textures=null}dispose(e=!1){e||(this._depthStencilTexture?.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}class R extends T{setDepthStencilTexture(e,t=!0){if(super.setDepthStencilTexture(e,t),!e)return;const i=this._engine,r=this._context,s=e._hardwareTexture;if(s&&e._autoMSAAManagement&&this._MSAAFramebuffer){const t=i._currentFramebuffer;i._bindUnboundFramebuffer(this._MSAAFramebuffer),r.framebufferRenderbuffer(r.FRAMEBUFFER,(0,m.$l)(e.format)?r.DEPTH_STENCIL_ATTACHMENT:r.DEPTH_ATTACHMENT,r.RENDERBUFFER,s.getMSAARenderBuffer()),i._bindUnboundFramebuffer(t)}}constructor(e,t,i,r,s){super(e,t,i,r),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=s}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(e=0,t=!0,i=!1,r=1,s=14,n){if(this._depthStencilBuffer){const e=this._engine,t=e._currentFramebuffer,i=this._context;e._bindUnboundFramebuffer(this._framebuffer),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,null),e._bindUnboundFramebuffer(t),i.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(e,t,i,r,s,n)}shareDepth(e){super.shareDepth(e);const t=this._context,i=this._depthStencilBuffer,r=e._MSAAFramebuffer||e._framebuffer,s=this._engine;e._depthStencilBuffer&&e._depthStencilBuffer!==i&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=i;const n=e._generateStencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;s._bindUnboundFramebuffer(r),t.framebufferRenderbuffer(t.FRAMEBUFFER,n,t.RENDERBUFFER,i),s._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,i,r=0){const s=e._hardwareTexture;if(!s)return;const n=this._framebuffer,a=this._engine,o=a._currentFramebuffer;let h;if(a._bindUnboundFramebuffer(n),a.webGLVersion>1){const n=this._context;h=n["COLOR_ATTACHMENT"+t],e.is2DArray||e.is3D?(i=i??this.layerIndices?.[t]??0,n.framebufferTextureLayer(n.FRAMEBUFFER,h,s.underlyingResource,r,i)):e.isCube?(i=i??this.faceIndices?.[t]??0,n.framebufferTexture2D(n.FRAMEBUFFER,h,n.TEXTURE_CUBE_MAP_POSITIVE_X+i,s.underlyingResource,r)):n.framebufferTexture2D(n.FRAMEBUFFER,h,n.TEXTURE_2D,s.underlyingResource,r)}else{const e=this._context;h=e["COLOR_ATTACHMENT"+t+"_WEBGL"];const n=void 0!==i?e.TEXTURE_CUBE_MAP_POSITIVE_X+i:e.TEXTURE_2D;e.framebufferTexture2D(e.FRAMEBUFFER,h,n,s.underlyingResource,r)}if(e._autoMSAAManagement&&this._MSAAFramebuffer){const e=this._context;a._bindUnboundFramebuffer(this._MSAAFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,h,e.RENDERBUFFER,s.getMSAARenderBuffer())}a._bindUnboundFramebuffer(o)}setTexture(e,t=0,i=!0){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t)}setLayerAndFaceIndices(e,t){if(super.setLayerAndFaceIndices(e,t),!this.textures||!this.layerIndices||!this.faceIndices)return;const i=this._attachments?.length??this.textures.length;for(let e=0;e<i;e++){const t=this.textures[e];t&&(t.is2DArray||t.is3D?this._bindTextureRenderTarget(t,e,this.layerIndices[e]):t.isCube?this._bindTextureRenderTarget(t,e,this.faceIndices[e]):this._bindTextureRenderTarget(t,e))}}setLayerAndFaceIndex(e=0,t,i){if(super.setLayerAndFaceIndex(e,t,i),!this.textures||!this.layerIndices||!this.faceIndices)return;const r=this.textures[e];r.is2DArray||r.is3D?this._bindTextureRenderTarget(this.textures[e],e,this.layerIndices[e]):r.isCube&&this._bindTextureRenderTarget(this.textures[e],e,this.faceIndices[e])}resolveMSAATextures(){const e=this._engine,t=e._currentFramebuffer;e._bindUnboundFramebuffer(this._MSAAFramebuffer),super.resolveMSAATextures(),e._bindUnboundFramebuffer(t)}dispose(e=this._disposeOnlyFramebuffers){const t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}var y=i(6326);y.$.prototype.createDepthStencilTexture=function(e,t,i){if(t.isCube){const i=e.width||e;return this._createDepthStencilCubeTexture(i,t)}return this._createDepthStencilTexture(e,t,i)},n.ThinEngine.prototype._createHardwareRenderTargetWrapper=function(e,t,i){const r=new R(e,t,i,this,this._gl);return this._renderTargetWrapperCache.push(r),r},n.ThinEngine.prototype.createRenderTargetTexture=function(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!1,e);let r,s,n=!0,a=!1,o=!1,h=1;void 0!==t&&"object"==typeof t&&(n=t.generateDepthBuffer??!0,a=!!t.generateStencilBuffer,o=!!t.noColorAttachment,r=t.colorAttachment,h=t.samples??1,s=t.label);const l=r||(o?null:this._createInternalTexture(e,t,!0,5)),c=e.width||e,u=e.height||e,_=this._currentFramebuffer,d=this._gl,f=d.createFramebuffer();if(this._bindUnboundFramebuffer(f),i._depthStencilBuffer=this._setupFramebufferDepthAttachments(a,n,c,u),!l||l.is2DArray||l.is3D||d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,l._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(_),i.label=s??"RenderTargetWrapper",i._framebuffer=f,i._generateDepthBuffer=n,i._generateStencilBuffer=a,i.setTextures(l),r){if(i._samples=r.samples,r.samples>1){const e=r._hardwareTexture.getMSAARenderBuffer(0);i._MSAAFramebuffer=d.createFramebuffer(),this._bindUnboundFramebuffer(i._MSAAFramebuffer),d.framebufferRenderbuffer(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.RENDERBUFFER,e),this._bindUnboundFramebuffer(null)}}else this.updateRenderTargetTextureSampleCount(i,h);return i},n.ThinEngine.prototype._createDepthStencilTexture=function(e,t,i){const s=this._gl,n=e.layers||0,a=e.depth||0;let o=s.TEXTURE_2D;0!==n?o=s.TEXTURE_2D_ARRAY:0!==a&&(o=s.TEXTURE_3D);const h=new r.h(this,12);if(h.label=t.label,!this._caps.depthTextureExtension)return c.V.Error("Depth texture is not supported by your browser or hardware."),h;const l={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...t};if(this._bindTextureDirectly(o,h,!0),this._setupDepthStencilTexture(h,e,0!==l.comparisonFunction&&l.bilinearFiltering,l.comparisonFunction,l.samples),void 0!==l.depthTextureFormat){if(15!==l.depthTextureFormat&&16!==l.depthTextureFormat&&17!==l.depthTextureFormat&&13!==l.depthTextureFormat&&14!==l.depthTextureFormat&&18!==l.depthTextureFormat)return c.V.Error(`Depth texture ${l.depthTextureFormat} format is not supported.`),h;h.format=l.depthTextureFormat}else h.format=l.generateStencil?13:16;const u=(0,m.$l)(h.format),_=this._getWebGLTextureTypeFromDepthTextureFormat(h.format),d=u?s.DEPTH_STENCIL:s.DEPTH_COMPONENT,f=this._getInternalFormatFromDepthTextureFormat(h.format,!0,u);return h.is2DArray?s.texImage3D(o,0,f,h.width,h.height,n,0,d,_,null):h.is3D?s.texImage3D(o,0,f,h.width,h.height,a,0,d,_,null):s.texImage2D(o,0,f,h.width,h.height,0,d,_,null),this._bindTextureDirectly(o,null),this._internalTexturesCache.push(h),i._depthStencilBuffer&&(s.deleteRenderbuffer(i._depthStencilBuffer),i._depthStencilBuffer=null),this._bindUnboundFramebuffer(i._MSAAFramebuffer??i._framebuffer),i._generateStencilBuffer=u,i._depthStencilTextureWithStencil=u,i._depthStencilBuffer=this._setupFramebufferDepthAttachments(i._generateStencilBuffer,i._generateDepthBuffer,i.width,i.height,i.samples,h.format),this._bindUnboundFramebuffer(null),h},n.ThinEngine.prototype.updateRenderTargetTextureSampleCount=function(e,t){if(this.webGLVersion<2||!e)return 1;if(e.samples===t)return t;const i=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples),e._depthStencilBuffer&&(i.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(i.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null);const r=e.texture?._hardwareTexture;if(r?.releaseMSAARenderBuffers(),e.texture&&t>1&&"function"==typeof i.renderbufferStorageMultisample){const s=i.createFramebuffer();if(!s)throw new Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=s,this._bindUnboundFramebuffer(e._MSAAFramebuffer);const n=this._createRenderBuffer(e.texture.width,e.texture.height,t,-1,this._getRGBABufferInternalSizedFormat(e.texture.type,e.texture.format,e.texture._useSRGBBuffer),i.COLOR_ATTACHMENT0,!1);if(!n)throw new Error("Unable to create multi sampled framebuffer");r?.addMSAARenderBuffer(n)}this._bindUnboundFramebuffer(e._MSAAFramebuffer??e._framebuffer),e.texture&&(e.texture.samples=t),e._samples=t;const s=e._depthStencilTexture?e._depthStencilTexture.format:void 0;return e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.width,e.height,t,s),this._bindUnboundFramebuffer(null),t},n.ThinEngine.prototype._setupDepthStencilTexture=function(e,t,i,r,s=1){const n=t.width??t,a=t.height??t,o=t.layers||0,h=t.depth||0;e.baseWidth=n,e.baseHeight=a,e.width=n,e.height=a,e.is2DArray=o>0,e.depth=o||h,e.isReady=!0,e.samples=s,e.generateMipMaps=!1,e.samplingMode=i?2:1,e.type=0,e._comparisonFunction=r;const l=this._gl,c=this._getTextureTarget(e),u=this._getSamplingParameters(e.samplingMode,!1);l.texParameteri(c,l.TEXTURE_MAG_FILTER,u.mag),l.texParameteri(c,l.TEXTURE_MIN_FILTER,u.min),l.texParameteri(c,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(c,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===r?(l.texParameteri(c,l.TEXTURE_COMPARE_FUNC,515),l.texParameteri(c,l.TEXTURE_COMPARE_MODE,l.NONE)):(l.texParameteri(c,l.TEXTURE_COMPARE_FUNC,r),l.texParameteri(c,l.TEXTURE_COMPARE_MODE,l.COMPARE_REF_TO_TEXTURE)))},n.ThinEngine.prototype.setDepthStencilTexture=function(e,t,i,r){void 0!==e&&(t&&(this._boundUniforms[e]=t),i&&i.depthStencilTexture?this._setTexture(e,i,!1,!0,r):this._setTexture(e,null,void 0,void 0,r))},n.ThinEngine.prototype.createRenderTargetCubeTexture=function(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!0,e),s={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...t};s.generateStencilBuffer=s.generateDepthBuffer&&s.generateStencilBuffer,(1!==s.type||this._caps.textureFloatLinearFiltering)&&(2!==s.type||this._caps.textureHalfFloatLinearFiltering)||(s.samplingMode=1);const n=this._gl,a=new r.h(this,5);this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,a,!0);const o=this._getSamplingParameters(s.samplingMode,s.generateMipMaps);1!==s.type||this._caps.textureFloat||(s.type=0,c.V.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MAG_FILTER,o.mag),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MIN_FILTER,o.min),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);for(let t=0;t<6;t++)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,this._getRGBABufferInternalSizedFormat(s.type,s.format),e,e,0,this._getInternalFormat(s.format),this._getWebGLTextureType(s.type),null);const h=n.createFramebuffer();return this._bindUnboundFramebuffer(h),i._depthStencilBuffer=this._setupFramebufferDepthAttachments(s.generateStencilBuffer,s.generateDepthBuffer,e,e),s.generateMipMaps&&n.generateMipmap(n.TEXTURE_CUBE_MAP),this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),i._framebuffer=h,i._generateDepthBuffer=s.generateDepthBuffer,i._generateStencilBuffer=s.generateStencilBuffer,a.width=e,a.height=e,a.isReady=!0,a.isCube=!0,a.samples=1,a.generateMipMaps=s.generateMipMaps,a.samplingMode=s.samplingMode,a.type=s.type,a.format=s.format,this._internalTexturesCache.push(a),i.setTextures(a),i};var b=i(3327),E=i(2667);n.ThinEngine.prototype.createPrefilteredCubeTexture=function(e,t,s,n,a=null,o=null,h,l=null,u=!0){return this.createCubeTexture(e,t,null,!1,(async e=>{if(!e)return void(a&&a(null));const o=e.texture;if(u?e.info.sphericalPolynomial&&(o._sphericalPolynomial=e.info.sphericalPolynomial):o._sphericalPolynomial=new b.Q,o._source=9,this.getCaps().textureLOD)return void(a&&a(o));const h=this._gl,l=e.width;if(!l)return;const{DDSTools:_}=await Promise.all([i.e(71),i.e(281),i.e(976),i.e(249)]).then(i.bind(i,5249)),d=[];for(let i=0;i<3;i++){const a=1-i/2,u=n,f=Math.log2(l)*s+n,p=u+(f-u)*a,g=Math.round(Math.min(Math.max(p,0),f)),m=new r.h(this,2);if(m.type=o.type,m.format=o.format,m.width=Math.pow(2,Math.max(Math.log2(l)-g,0)),m.height=m.width,m.isCube=!0,m._cachedWrapU=0,m._cachedWrapV=0,this._bindTextureDirectly(h.TEXTURE_CUBE_MAP,m,!0),m.samplingMode=2,h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MAG_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MIN_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),e.isDDS){const t=e.info,i=e.data;this._unpackFlipY(t.isCompressed),_.UploadDDSLevels(this,m,i,t,!0,6,g)}else c.V.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(h.TEXTURE_CUBE_MAP,null);const T=new E.t(t);T._isCube=!0,T._texture=m,m.isReady=!0,d.push(T)}o._lodTextureHigh=d[2],o._lodTextureMid=d[1],o._lodTextureLow=d[0],a&&a(o)}),o,h,l,u,s,n)},n.ThinEngine.prototype.createUniformBuffer=function(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create uniform buffer");const r=new l.A(i);return this.bindUniformBuffer(r),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),r.references=1,r},n.ThinEngine.prototype.createDynamicUniformBuffer=function(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create dynamic uniform buffer");const r=new l.A(i);return this.bindUniformBuffer(r),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),r.references=1,r},n.ThinEngine.prototype.updateUniformBuffer=function(e,t,i,r){this.bindUniformBuffer(e),void 0===i&&(i=0),void 0===r?t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,t):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,new Float32Array(t)):t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,t.subarray(i,i+r)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(t).subarray(i,i+r)),this.bindUniformBuffer(null)},n.ThinEngine.prototype.bindUniformBuffer=function(e){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,e?e.underlyingResource:null)},n.ThinEngine.prototype.bindUniformBufferBase=function(e,t,i){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,t,e?e.underlyingResource:null)},n.ThinEngine.prototype.bindUniformBlock=function(e,t,i){const r=e.program,s=this._gl.getUniformBlockIndex(r,t);4294967295!==s&&this._gl.uniformBlockBinding(r,s,i)};var x=i(8790);function v(e){if(e.requestPointerLock){const t=e.requestPointerLock();t instanceof Promise?t.then((()=>{e.focus()})).catch((()=>{})):e.focus()}}y.$.prototype.displayLoadingUI=function(){if(!(0,x.BA)())return;const e=this.loadingScreen;e&&e.displayLoadingUI()},y.$.prototype.hideLoadingUI=function(){if(!(0,x.BA)())return;const e=this._loadingScreen;e&&e.hideLoadingUI()},Object.defineProperty(y.$.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=y.$.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(e){this._loadingScreen=e},enumerable:!0,configurable:!0}),Object.defineProperty(y.$.prototype,"loadingUIText",{set:function(e){this.loadingScreen.loadingUIText=e},enumerable:!0,configurable:!0}),Object.defineProperty(y.$.prototype,"loadingUIBackgroundColor",{set:function(e){this.loadingScreen.loadingUIBackgroundColor=e},enumerable:!0,configurable:!0}),y.$.prototype.getInputElement=function(){return this._renderingCanvas},y.$.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},y.$.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},y.$.prototype.getAspectRatio=function(e,t=!1){const i=e.viewport;return this.getRenderWidth(t)*i.width/(this.getRenderHeight(t)*i.height)},y.$.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},y.$.prototype._verifyPointerLock=function(){this._onPointerLockChange?.()},y.$.prototype.setAlphaEquation=function(e){if(this._alphaEquation!==e){switch(e){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=e}},y.$.prototype.getInputElement=function(){return this._renderingCanvas},y.$.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},y.$.prototype.setDepthFunction=function(e){this._depthCullingState.depthFunc=e},y.$.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},y.$.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},y.$.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},y.$.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},y.$.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},y.$.prototype.setDepthWrite=function(e){this._depthCullingState.depthMask=e},y.$.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},y.$.prototype.setStencilBuffer=function(e){this._stencilState.stencilTest=e},y.$.prototype.getStencilMask=function(){return this._stencilState.stencilMask},y.$.prototype.setStencilMask=function(e){this._stencilState.stencilMask=e},y.$.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},y.$.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},y.$.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},y.$.prototype.setStencilFunction=function(e){this._stencilState.stencilFunc=e},y.$.prototype.setStencilFunctionReference=function(e){this._stencilState.stencilFuncRef=e},y.$.prototype.setStencilFunctionMask=function(e){this._stencilState.stencilFuncMask=e},y.$.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},y.$.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},y.$.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},y.$.prototype.setStencilOperationFail=function(e){this._stencilState.stencilOpStencilFail=e},y.$.prototype.setStencilOperationDepthFail=function(e){this._stencilState.stencilOpDepthFail=e},y.$.prototype.setStencilOperationPass=function(e){this._stencilState.stencilOpStencilDepthPass=e},y.$.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},y.$.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},y.$.prototype.setAlphaConstants=function(e,t,i,r){this._alphaState.setAlphaBlendConstants(e,t,i,r)},y.$.prototype.getAlphaMode=function(){return this._alphaMode},y.$.prototype.getAlphaEquation=function(){return this._alphaEquation},y.$.prototype.getRenderPassNames=function(){return this._renderPassNames},y.$.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},y.$.prototype.createRenderPassId=function(e){const t=++y.$._RenderPassIdCounter;return this._renderPassNames[t]=e??"NONAME",t},y.$.prototype.releaseRenderPassId=function(e){this._renderPassNames[e]=void 0;for(let t=0;t<this.scenes.length;++t){const i=this.scenes[t];for(let t=0;t<i.meshes.length;++t){const r=i.meshes[t];if(r.subMeshes)for(let t=0;t<r.subMeshes.length;++t)r.subMeshes[t]._removeDrawWrapper(e)}}};var C=i(4296),A=i(2940);class P extends n.ThinEngine{static get NpmPackage(){return y.$.NpmPackage}static get Version(){return y.$.Version}static get Instances(){return s.q.Instances}static get LastCreatedEngine(){return s.q.LastCreatedEngine}static get LastCreatedScene(){return s.q.LastCreatedScene}static DefaultLoadingScreenFactory(e){return y.$.DefaultLoadingScreenFactory(e)}get _supportsHardwareTextureRescaling(){return!!P._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(e,t,i,r=!1){super(e,t,i,r),this.customAnimationFrameRequester=null,this._performanceMonitor=new o,this._drawCalls=new C.A,e&&(this._features.supportRenderPasses=!0,i=this._creationOptions)}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),function(e,t,i){e._onCanvasFocus=()=>{e.onCanvasFocusObservable.notifyObservers(e)},e._onCanvasBlur=()=>{e.onCanvasBlurObservable.notifyObservers(e)},e._onCanvasContextMenu=t=>{e.disableContextMenu&&t.preventDefault()},t.addEventListener("focus",e._onCanvasFocus),t.addEventListener("blur",e._onCanvasBlur),t.addEventListener("contextmenu",e._onCanvasContextMenu),e._onBlur=()=>{e.disablePerformanceMonitorInBackground&&e.performanceMonitor.disable(),e._windowIsBackground=!0},e._onFocus=()=>{e.disablePerformanceMonitorInBackground&&e.performanceMonitor.enable(),e._windowIsBackground=!1},e._onCanvasPointerOut=i=>{document.elementFromPoint(i.clientX,i.clientY)!==t&&e.onCanvasPointerOutObservable.notifyObservers(i)};const r=e.getHostWindow();r&&"function"==typeof r.addEventListener&&(r.addEventListener("blur",e._onBlur),r.addEventListener("focus",e._onFocus)),t.addEventListener("pointerout",e._onCanvasPointerOut),i.doNotHandleTouchAction||function(e){e&&e.setAttribute&&(e.setAttribute("touch-action","none"),e.style.touchAction="none",e.style.webkitTapHighlightColor="transparent")}(t),!y.$.audioEngine&&i.audioEngine&&y.$.AudioEngineFactory&&(y.$.audioEngine=y.$.AudioEngineFactory(e.getRenderingCanvas(),e.getAudioContext(),e.getAudioDestination())),(0,x.Nf)()&&(e._onFullscreenChange=()=>{e.isFullscreen=!!document.fullscreenElement,e.isFullscreen&&e._pointerLockRequested&&t&&v(t)},document.addEventListener("fullscreenchange",e._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",e._onFullscreenChange,!1),e._onPointerLockChange=()=>{e.isPointerLock=document.pointerLockElement===t},document.addEventListener("pointerlockchange",e._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",e._onPointerLockChange,!1)),e.enableOfflineSupport=void 0!==y.$.OfflineProviderFactory,e._deterministicLockstep=!!i.deterministicLockstep,e._lockstepMaxSteps=i.lockstepMaxSteps||0,e._timeStep=i.timeStep||1/60}(this,e,this._creationOptions)}resizeImageBitmap(e,t,i){return function(e,t,i,r){const s=e.createCanvas(i,r).getContext("2d");if(!s)throw new Error("Unable to get 2d context for resizeImageBitmap");return s.drawImage(t,0,0),s.getImageData(0,0,i,r).data}(this,e,t,i)}async _createImageBitmapFromSource(e,t){return await async function(e,t,i){return await new Promise(((r,s)=>{const n=new Image;n.onload=()=>{n.decode().then((()=>{e.createImageBitmap(n,i).then((e=>{r(e)}))}))},n.onerror=()=>{s(`Error loading image ${n.src}`)},n.src=t}))}(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&function(e){const t=e.requestFullscreen||e.webkitRequestFullscreen;t&&t.call(e)}(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&function(){const e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen()}()}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(e,t,i,r){const s=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,r),s}scissorClear(e,t,i,r,s){this.enableScissor(e,t,i,r),this.clear(s,!0,!0,!0),this.disableScissor()}enableScissor(e,t,i,r){const s=this._gl;s.enable(s.SCISSOR_TEST),s.scissor(e,t,i,r)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}async _loadFileAsync(e,t,i){return await new Promise(((r,s)=>{this._loadFile(e,(e=>{r(e)}),void 0,t,i,((e,t)=>{s(t)}))}))}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries();super._rebuildBuffers()}getFontOffset(e){return function(e){const t=document.createElement("span");t.textContent="Hg",t.style.font=e;const i=document.createElement("div");i.style.display="inline-block",i.style.width="1px",i.style.height="0px",i.style.verticalAlign="bottom";const r=document.createElement("div");r.style.whiteSpace="nowrap",r.appendChild(t),r.appendChild(i),document.body.appendChild(r);let s=0,n=0;try{n=i.getBoundingClientRect().top-t.getBoundingClientRect().top,i.style.verticalAlign="baseline",s=i.getBoundingClientRect().top-t.getBoundingClientRect().top}finally{document.body.removeChild(r)}return{ascent:s,height:n,descent:n-s}}(e)}_cancelFrame(){if(this.customAnimationFrameRequester){if(0!==this._frameHandler){this._frameHandler=0;const{cancelAnimationFrame:e}=this.customAnimationFrameRequester;e&&e(this.customAnimationFrameRequester.requestID)}}else super._cancelFrame()}_renderLoop(e){this._processFrame(e),this._activeRenderLoops.length>0&&0===this._frameHandler&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&v(this._renderingCanvas)}exitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}beginFrame(){this._measureFps(),super.beginFrame()}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,i,r,s,n=null){s=s||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const a=super.createShaderProgram(e,t,i,r,s,n);return this.onAfterShaderCompilationObservable.notifyObservers(this),a}_createShaderProgram(e,t,i,r,s=null){const n=r.createProgram();if(e.program=n,!n)throw new Error("Unable to create program");if(r.attachShader(n,t),r.attachShader(n,i),this.webGLVersion>1&&s){const t=this.createTransformFeedback();this.bindTransformFeedback(t),this.setTranformFeedbackVaryings(n,s),e.transformFeedback=t}return r.linkProgram(n),this.webGLVersion>1&&s&&this.bindTransformFeedback(null),e.context=r,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),n}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e);for(const t of this.scenes){for(const i of t.postProcesses)i._outputTexture===e&&(i._outputTexture=null);for(const i of t.cameras)for(const t of i._postProcesses)t&&t._outputTexture===e&&(t._outputTexture=null)}}_rescaleTexture(e,t,i,r,s){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const n=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&P._RescalePostProcessFactory&&(this._rescalePostProcess=P._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const a=()=>{this._rescalePostProcess.onApply=function(t){t._bindTexture("textureSampler",e)};let a=i;a||(a=this.scenes[this.scenes.length-1]),a.postProcessManager.directRender([this._rescalePostProcess],n,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,r,0,0,t.width,t.height,0),this.unBindFramebuffer(n),n.dispose(),s&&s()},o=this._rescalePostProcess.getEffect();o?o.executeWhenCompiled(a):this._rescalePostProcess.onEffectCreatedObservable.addOnce((e=>{e.executeWhenCompiled(a)}))}}wrapWebGLTexture(e,t=!1,i=3,s=0,n=0){const a=new u.d(e,this._gl),o=new r.h(this,0,!0);return o._hardwareTexture=a,o.baseWidth=s,o.baseHeight=n,o.width=s,o.height=n,o.isReady=!0,o.useMipMaps=t,this.updateTextureSamplingMode(i,o),o}_uploadImageToTexture(e,t,i=0,r=0){const s=this._gl,n=this._getWebGLTextureType(e.type),a=this._getInternalFormat(e.format),o=this._getRGBABufferInternalSizedFormat(e.type,a),h=e.isCube?s.TEXTURE_CUBE_MAP:s.TEXTURE_2D;this._bindTextureDirectly(h,e,!0),this._unpackFlipY(e.invertY);let l=s.TEXTURE_2D;e.isCube&&(l=s.TEXTURE_CUBE_MAP_POSITIVE_X+i),s.texImage2D(l,r,o,a,n,t),this._bindTextureDirectly(h,null,!0)}updateTextureComparisonFunction(e,t){if(1===this.webGLVersion)return void c.V.Error("WebGL 1 does not support texture comparison.");const i=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),0===t?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),0===t?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const i=new l.A(t);return i.capacity=e,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),i.references=1,i}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}async _clientWaitAsync(e,t=0,i=10){const r=this._gl;return await new Promise(((s,n)=>{(0,A.B)((()=>{const i=r.clientWaitSync(e,t,0);if(i==r.WAIT_FAILED)throw new Error("clientWaitSync failed");return i!=r.TIMEOUT_EXPIRED}),s,n,i)}))}_readPixelsAsync(e,t,i,r,s,n,a){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const o=this._gl,h=o.createBuffer();o.bindBuffer(o.PIXEL_PACK_BUFFER,h),o.bufferData(o.PIXEL_PACK_BUFFER,a.byteLength,o.STREAM_READ),o.readPixels(e,t,i,r,s,n,0),o.bindBuffer(o.PIXEL_PACK_BUFFER,null);const l=o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0);return l?(o.flush(),this._clientWaitAsync(l,0,10).then((()=>(o.deleteSync(l),o.bindBuffer(o.PIXEL_PACK_BUFFER,h),o.getBufferSubData(o.PIXEL_PACK_BUFFER,0,a),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),o.deleteBuffer(h),a)))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),function(e,t){1===s.q.Instances.length&&y.$.audioEngine&&(y.$.audioEngine.dispose(),y.$.audioEngine=null);const i=e.getHostWindow();i&&"function"==typeof i.removeEventListener&&(i.removeEventListener("blur",e._onBlur),i.removeEventListener("focus",e._onFocus)),t&&(t.removeEventListener("focus",e._onCanvasFocus),t.removeEventListener("blur",e._onCanvasBlur),t.removeEventListener("pointerout",e._onCanvasPointerOut),t.removeEventListener("contextmenu",e._onCanvasContextMenu)),(0,x.Nf)()&&(document.removeEventListener("fullscreenchange",e._onFullscreenChange),document.removeEventListener("mozfullscreenchange",e._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",e._onFullscreenChange),document.removeEventListener("msfullscreenchange",e._onFullscreenChange),document.removeEventListener("pointerlockchange",e._onPointerLockChange),document.removeEventListener("mspointerlockchange",e._onPointerLockChange),document.removeEventListener("mozpointerlockchange",e._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",e._onPointerLockChange))}(this,this._renderingCanvas),super.dispose()}}P.ALPHA_DISABLE=0,P.ALPHA_ADD=1,P.ALPHA_COMBINE=2,P.ALPHA_SUBTRACT=3,P.ALPHA_MULTIPLY=4,P.ALPHA_MAXIMIZED=5,P.ALPHA_ONEONE=6,P.ALPHA_PREMULTIPLIED=7,P.ALPHA_PREMULTIPLIED_PORTERDUFF=8,P.ALPHA_INTERPOLATE=9,P.ALPHA_SCREENMODE=10,P.DELAYLOADSTATE_NONE=0,P.DELAYLOADSTATE_LOADED=1,P.DELAYLOADSTATE_LOADING=2,P.DELAYLOADSTATE_NOTLOADED=4,P.NEVER=512,P.ALWAYS=519,P.LESS=513,P.EQUAL=514,P.LEQUAL=515,P.GREATER=516,P.GEQUAL=518,P.NOTEQUAL=517,P.KEEP=7680,P.REPLACE=7681,P.INCR=7682,P.DECR=7683,P.INVERT=5386,P.INCR_WRAP=34055,P.DECR_WRAP=34056,P.TEXTURE_CLAMP_ADDRESSMODE=0,P.TEXTURE_WRAP_ADDRESSMODE=1,P.TEXTURE_MIRROR_ADDRESSMODE=2,P.TEXTUREFORMAT_ALPHA=0,P.TEXTUREFORMAT_LUMINANCE=1,P.TEXTUREFORMAT_LUMINANCE_ALPHA=2,P.TEXTUREFORMAT_RGB=4,P.TEXTUREFORMAT_RGBA=5,P.TEXTUREFORMAT_RED=6,P.TEXTUREFORMAT_R=6,P.TEXTUREFORMAT_R16_UNORM=33322,P.TEXTUREFORMAT_RG16_UNORM=33324,P.TEXTUREFORMAT_RGB16_UNORM=32852,P.TEXTUREFORMAT_RGBA16_UNORM=32859,P.TEXTUREFORMAT_R16_SNORM=36760,P.TEXTUREFORMAT_RG16_SNORM=36761,P.TEXTUREFORMAT_RGB16_SNORM=36762,P.TEXTUREFORMAT_RGBA16_SNORM=36763,P.TEXTUREFORMAT_RG=7,P.TEXTUREFORMAT_RED_INTEGER=8,P.TEXTUREFORMAT_R_INTEGER=8,P.TEXTUREFORMAT_RG_INTEGER=9,P.TEXTUREFORMAT_RGB_INTEGER=10,P.TEXTUREFORMAT_RGBA_INTEGER=11,P.TEXTURETYPE_UNSIGNED_BYTE=0,P.TEXTURETYPE_UNSIGNED_INT=0,P.TEXTURETYPE_FLOAT=1,P.TEXTURETYPE_HALF_FLOAT=2,P.TEXTURETYPE_BYTE=3,P.TEXTURETYPE_SHORT=4,P.TEXTURETYPE_UNSIGNED_SHORT=5,P.TEXTURETYPE_INT=6,P.TEXTURETYPE_UNSIGNED_INTEGER=7,P.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,P.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,P.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,P.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,P.TEXTURETYPE_UNSIGNED_INT_24_8=12,P.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,P.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,P.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,P.TEXTURE_NEAREST_SAMPLINGMODE=1,P.TEXTURE_BILINEAR_SAMPLINGMODE=2,P.TEXTURE_TRILINEAR_SAMPLINGMODE=3,P.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,P.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,P.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,P.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,P.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,P.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,P.TEXTURE_NEAREST_LINEAR=7,P.TEXTURE_NEAREST_NEAREST=1,P.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,P.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,P.TEXTURE_LINEAR_LINEAR=2,P.TEXTURE_LINEAR_NEAREST=12,P.TEXTURE_EXPLICIT_MODE=0,P.TEXTURE_SPHERICAL_MODE=1,P.TEXTURE_PLANAR_MODE=2,P.TEXTURE_CUBIC_MODE=3,P.TEXTURE_PROJECTION_MODE=4,P.TEXTURE_SKYBOX_MODE=5,P.TEXTURE_INVCUBIC_MODE=6,P.TEXTURE_EQUIRECTANGULAR_MODE=7,P.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,P.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,P.SCALEMODE_FLOOR=1,P.SCALEMODE_NEAREST=2,P.SCALEMODE_CEILING=3},9125:(e,t,i)=>{i.d(t,{nO:()=>v,pB:()=>E,M0:()=>x,Hd:()=>F});class r{constructor(){this.children=[]}isValid(e){return!0}process(e,t,i){let r="";if(this.line){let i=this.line;const s=t.processor;if(s){s.lineProcessor&&(i=s.lineProcessor(i,t.isFragment,t.processingContext));const r=t.processor?.attributeKeywordName??"attribute",n=t.isFragment&&t.processor?.varyingFragmentKeywordName?t.processor?.varyingFragmentKeywordName:!t.isFragment&&t.processor?.varyingVertexKeywordName?t.processor?.varyingVertexKeywordName:"varying";!t.isFragment&&s.attributeProcessor&&this.line.startsWith(r)?i=s.attributeProcessor(this.line,e,t.processingContext):s.varyingProcessor&&(s.varyingCheck?.(this.line,t.isFragment)||!s.varyingCheck&&this.line.startsWith(n))?i=s.varyingProcessor(this.line,t.isFragment,e,t.processingContext):s.uniformProcessor&&s.uniformRegexp&&s.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(i=s.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):s.uniformBufferProcessor&&s.uniformBufferRegexp&&s.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(i=s.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):s.textureProcessor&&s.textureRegexp&&s.textureRegexp.test(this.line)?i=s.textureProcessor(this.line,t.isFragment,e,t.processingContext):(s.uniformProcessor||s.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?s.uniformProcessor&&(i=s.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):s.uniformBufferProcessor&&(i=s.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&-1!==this.line.indexOf("}")&&(t.lookForClosingBracketForUniformBuffer=!1,s.endOfUniformBufferProcessor&&(i=s.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}r+=i+"\n"}for(const s of this.children)r+=s.process(e,t,i);return this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true",i[this.additionalDefineKey]=e[this.additionalDefineKey]),r}}class s{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if(!t||"\r"===t)continue;if("#"===t[0]){this._lines.push(t);continue}const e=t.trim();if(!e)continue;if(e.startsWith("//")){this._lines.push(t);continue}const i=e.indexOf(";");if(-1===i)this._lines.push(e);else if(i===e.length-1)e.length>1&&this._lines.push(e);else{const e=t.split(";");for(let t=0;t<e.length;t++){let i=e[t];i&&(i=i.trim(),i&&this._lines.push(i+(t!==e.length-1?";":"")))}}}}}class n extends r{process(e,t,i){for(let r=0;r<this.children.length;r++){const s=this.children[r];if(s.isValid(e))return s.process(e,t,i)}return""}}class a extends r{isValid(e){return this.testExpression.isTrue(e)}}class o{isTrue(e){return!0}static postfixToInfix(e){const t=[];for(const i of e)if(void 0===o._OperatorPriority[i])t.push(i);else{const e=t[t.length-1],r=t[t.length-2];t.length-=2,t.push(`(${r}${i}${e})`)}return t[t.length-1]}static infixToPostfix(e){const t=o._InfixToPostfixCache.get(e);if(t)return t.accessTime=Date.now(),t.result;if(!(e.includes("&&")||e.includes("||")||e.includes(")")||e.includes("(")))return[e];const i=[];let r=-1;const s=()=>{c=c.trim(),""!==c&&(i.push(c),c="")},n=e=>{r<o._Stack.length-1&&(o._Stack[++r]=e)},a=()=>o._Stack[r],h=()=>-1===r?"!!INVALID EXPRESSION!!":o._Stack[r--];let l=0,c="";for(;l<e.length;){const t=e.charAt(l),u=l<e.length-1?e.substring(l,2+l):"";if("("===t)c="",n(t);else if(")"===t){for(s();-1!==r&&"("!==a();)i.push(h());h()}else if(o._OperatorPriority[u]>1){for(s();-1!==r&&o._OperatorPriority[a()]>=o._OperatorPriority[u];)i.push(h());n(u),l++}else c+=t;l++}for(s();-1!==r;)"("===a()?h():i.push(h());return o._InfixToPostfixCache.size>=o.InfixToPostfixCacheLimitSize&&o.ClearCache(),o._InfixToPostfixCache.set(e,{result:i,accessTime:Date.now()}),i}static ClearCache(){const e=Array.from(o._InfixToPostfixCache.entries()).sort(((e,t)=>e[1].accessTime-t[1].accessTime));for(let t=0;t<o.InfixToPostfixCacheCleanupSize;t++)o._InfixToPostfixCache.delete(e[t][0])}}o.InfixToPostfixCacheLimitSize=5e4,o.InfixToPostfixCacheCleanupSize=25e3,o._InfixToPostfixCache=new Map,o._OperatorPriority={")":0,"(":1,"||":2,"&&":3},o._Stack=["","","","","","","","","","","","","","","","","","","",""];class h extends o{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=void 0!==e[this.define];return this.not&&(t=!t),t}}class l extends o{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class c extends o{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class u extends o{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}toString(){return`${this.define} ${this.operand} ${this.testValue}`}isTrue(e){let t=!1;const i=parseInt(null!=e[this.define]?e[this.define]:this.define),r=parseInt(null!=e[this.testValue]?e[this.testValue]:this.testValue);if(isNaN(i)||isNaN(r))return!1;switch(this.operand){case">":t=i>r;break;case"<":t=i<r;break;case"<=":t=i<=r;break;case">=":t=i>=r;break;case"==":t=i===r;break;case"!=":t=i!==r}return t}}var _=i(5503),d=i(6741);const f=/defined\s*?\((.+?)\)/g,p=/defined\s*?\[(.+?)\]/g,g=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,m=/__decl__/,T=/light\{X\}.(\w*)/g,R=/\{X\}/g,y=[],b=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/;function E(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)}function x(e,t,i,n){t.processor?.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),S(e,t,(e=>{t.processCodeAfterIncludes&&(e=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",e,t.defines));const a=function(e,t,i){let n=function(e,t){if(t.processor?.noPrecision)return e;const i=t.shouldUseHighPrecisionShader;return-1===e.indexOf("precision highp float")?e=i?"precision highp float;\n"+e:"precision mediump float;\n"+e:i||(e=e.replace("precision highp float","precision mediump float")),e}(e,t);if(!t.processor)return n;if(0===t.processor.shaderLanguage&&-1!==n.indexOf("#version 3")&&(n=n.replace("#version 300 es",""),!t.processor.parseGLES3))return n;const a=t.defines,o=function(e,t){const i=e.defines,r={};for(const e of i){const t=e.replace("#define","").replace(";","").trim().split(" ");r[t[0]]=t.length>1?t[1]:""}return 0===e.processor?.shaderLanguage&&(r.GL_ES="true"),r.__VERSION__=e.version,r[e.platformName]="true",(0,d.tj)(r,t?.isNDCHalfZRange,t?.useReverseDepthBuffer,t?.useExactSrgbConversions),r}(t,i);t.processor.preProcessor&&(n=t.processor.preProcessor(n,a,o,t.isFragment,t.processingContext));const h={};return n=function(e,t,i,n){const a=new r,o=new s;return o.lineIndex=-1,o.lines=e.split("\n"),M(o,a,n),a.process(t,i,n)}(n,o,t,h),t.processor.postProcessor&&(n=t.processor.postProcessor(n,a,t.isFragment,t.processingContext,i?{drawBuffersExtensionDisabled:!i.getCaps().drawBuffersExtension}:{},o,h)),i?._features.needShaderCodeInlining&&(n=i.inlineShaderCode(n)),n}(e,t,n);i(a,e)}))}function v(e,t,i){return i.processor&&i.processor.finalizeShaders?i.processor.finalizeShaders(e,t,i.processingContext):{vertexCode:e,fragmentCode:t}}function C(e){const t=/defined\((.+)\)/.exec(e);if(t&&t.length)return new h(t[1].trim(),"!"===e[0]);const i=["==","!=",">=","<=","<",">"];let r="",s=0;for(r of i)if(s=e.indexOf(r),s>-1)break;if(-1===s)return new h(e);const n=e.substring(0,s).trim(),a=e.substring(s+r.length).trim();return new u(n,r,a)}function A(e,t){const i=new a,r=e.substring(0,t);let s=e.substring(t);return s=s.substring(0,(s.indexOf("//")+1||s.length+1)-1).trim(),i.testExpression="#ifdef"===r?new h(s):"#ifndef"===r?new h(s,!0):function(e){e=e.replace(f,"defined[$1]");const t=o.infixToPostfix(e),i=[];for(const e of t)if("||"!==e&&"&&"!==e)i.push(e);else if(i.length>=2){let t=i[i.length-1],r=i[i.length-2];i.length-=2;const s="&&"==e?new c:new l;"string"==typeof t&&(t=t.replace(p,"defined($1)")),"string"==typeof r&&(r=r.replace(p,"defined($1)")),s.leftOperand="string"==typeof r?C(r):r,s.rightOperand="string"==typeof t?C(t):t,i.push(s)}let r=i[i.length-1];return"string"==typeof r&&(r=r.replace(p,"defined($1)")),"string"==typeof r?C(r):r}(s),i}function P(e,t,i,s){let n=e.currentLine;for(;M(e,i,s);){n=e.currentLine;const a=n.substring(0,5).toLowerCase();if("#else"===a){const i=new r;return t.children.push(i),void M(e,i,s)}if("#elif"===a){const e=A(n,5);t.children.push(e),i=e}}}function M(e,t,i){for(;e.canRead;){e.lineIndex++;const s=e.currentLine;if(s.indexOf("#")>=0){const r=b.exec(s);if(r&&r.length){switch(r[0]){case"#ifdef":{const r=new n;t.children.push(r);const a=A(s,6);r.children.push(a),P(e,r,a,i);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const r=new n;t.children.push(r);const a=A(s,7);r.children.push(a),P(e,r,a,i);break}case"#if":{const r=new n,a=A(s,3);t.children.push(r),r.children.push(a),P(e,r,a,i);break}}continue}}const a=new r;if(a.line=s,t.children.push(a),"#"===s[0]&&"d"===s[1]){const e=s.replace(";","").split(" ");a.additionalDefineKey=e[1],3===e.length&&(a.additionalDefineValue=e[2])}}return!1}function S(e,t,i){let r;for(y.length=0;null!==(r=g.exec(e));)y.push(r);let s=String(e),n=[e],a=!1;for(const e of y){let r=e[1];if(-1!==r.indexOf("__decl__")&&(r=r.replace(m,""),t.supportsUniformBuffers&&(r=r.replace("Vertex","Ubo").replace("Fragment","Ubo")),r+="Declaration"),!t.includesShadersStore[r]){const e=t.shadersRepository+"ShadersInclude/"+r+".fx";return void F.loadFile(e,(e=>{t.includesShadersStore[r]=e,S(n.join(""),t,i)}))}{let i=t.includesShadersStore[r];if(e[2]){const t=e[3].split(",");for(let e=0;e<t.length;e+=2){const r=new RegExp(t[e],"g"),s=t[e+1];i=i.replace(r,s)}}if(e[4]){const r=e[5];if(-1!==r.indexOf("..")){const e=r.split(".."),s=parseInt(e[0]);let n=parseInt(e[1]),a=i.slice(0);i="",isNaN(n)&&(n=t.indexParameters[e[1]]);for(let e=s;e<n;e++)t.supportsUniformBuffers||(a=a.replace(T,((e,t)=>t+"{X}"))),i+=a.replace(R,e.toString())+"\n"}else t.supportsUniformBuffers||(i=i.replace(T,((e,t)=>t+"{X}"))),i=i.replace(R,r)}const s=[];for(const t of n){const r=t.split(e[0]);for(let e=0;e<r.length-1;e++)s.push(r[e]),s.push(i);s.push(r[r.length-1])}n=s,a=a||i.indexOf("#include<")>=0||i.indexOf("#include <")>=0}}y.length=0,s=n.join(""),a?S(s.toString(),t,i):i(s)}const F={loadFile:(e,t,i,r,s,n)=>{throw(0,_.n)("FileTools")}}},9259:(e,t,i)=>{i.d(t,{P_:()=>o,lK:()=>n,qK:()=>c,uM:()=>a,wL:()=>l,xG:()=>h});var r=i(6080);function s(e,t){return(i,s)=>{const n=(0,r.B)(i);n[s]||(n[s]={type:e,sourceName:t})}}function n(e){return s(0,e)}function a(e){return s(1,e)}function o(e){return s(5,e)}function h(e){return s(6,e)}function l(e){return s(7,e)}function c(e){return s(8,e)}function u(e,t,i,r){const s=i.value;i.value=(...i)=>{let n=s;if("undefined"!=typeof _native&&_native[t]){const e=_native[t];n=r?(...t)=>r(...t)?e(...t):s(...t):e}return e[t]=n,n(...i)}}u.filter=function(e){return(t,i,r)=>u(t,i,r,e)}},9337:(e,t,i)=>{i.d(t,{n:()=>n});var r=i(1137),s=i(6552);class n{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];const t=(0,s.n9)(e);if(t)return t;r.V.Warn(e+" not found, you may have missed an import.");const i=e.split(".");let n=window||this;for(let e=0,t=i.length;e<t;e++)n=n[i[e]];return"function"!=typeof n?null:n}}n.RegisteredExternalClasses={}},9492:(e,t,i)=>{i.d(t,{rz:()=>F,eC:()=>y,f2:()=>M,zU:()=>C,W$:()=>x,NJ:()=>v,sh:()=>A,M1:()=>b});var r=i(2366),s=i(8790),n=i(9848);class a{}a.FilesToLoad={};class o extends Error{}o._setPrototypeOf=Object.setPrototypeOf||((e,t)=>(e.__proto__=t,e));class h extends o{constructor(e,t,i){super(e),this.errorCode=t,this.innerError=i,this.name="RuntimeError",o._setPrototypeOf(this,h.prototype)}}var l=i(6181),c=i(9125),u=i(6315),_=i(1137),d=i(2940),f=i(6741),p=i(6326);const g=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class m extends h{constructor(e,t){super(e,4e3),this.name="LoadFileError",o._setPrototypeOf(this,m.prototype),t instanceof r.u?this.request=t:this.file=t}}class T extends h{constructor(e,t){super(e,4001),this.request=t,this.name="RequestFileError",o._setPrototypeOf(this,T.prototype)}}class R extends h{constructor(e,t){super(e,4002),this.file=t,this.name="ReadFileError",o._setPrototypeOf(this,R.prototype)}}const y={DefaultRetryStrategy:class{static ExponentialBackoff(e=3,t=500){return(i,r,s)=>0!==r.status||s>=e||-1!==i.indexOf("file:")?-1:Math.pow(2,s)*t}}.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:e=>e,ScriptBaseUrl:"",ScriptPreprocessUrl:e=>e,CleanUrl:e=>e.replace(/#/gm,"%23")},b=(e,t)=>{if((!e||0!==e.indexOf("data:"))&&y.CorsBehavior)if("string"==typeof y.CorsBehavior||y.CorsBehavior instanceof String)t.crossOrigin=y.CorsBehavior;else{const i=y.CorsBehavior(e);i&&(t.crossOrigin=i)}},E={getRequiredSize:null},x=(e,t,i,s,n="",o,h=u.q.LastCreatedEngine)=>{if("undefined"==typeof HTMLImageElement&&!h?._features.forceBitmapOverHTMLImageElement)return i("LoadImage is only supported in web or BabylonNative environments."),null;let c,_=!1;e instanceof ArrayBuffer||ArrayBuffer.isView(e)?"undefined"!=typeof Blob&&"undefined"!=typeof URL?(c=URL.createObjectURL(new Blob([e],{type:n})),_=!0):c=`data:${n};base64,`+(0,l.EL)(e):e instanceof Blob?(c=URL.createObjectURL(e),_=!0):(c=y.CleanUrl(e),c=y.PreprocessUrl(c));const d=t=>{if(i){const r=c||e.toString();i(`Error while trying to load image: ${0===r.indexOf("http")||r.length<=128?r:r.slice(0,128)+"..."}`,t)}};if(h?._features.forceBitmapOverHTMLImageElement)return C(c,(r=>{h.createImageBitmap(new Blob([r],{type:n}),{premultiplyAlpha:"none",...o}).then((e=>{t(e),_&&URL.revokeObjectURL(c)})).catch((t=>{i&&i("Error while trying to load image: "+e,t)}))}),void 0,s||void 0,!0,((e,t)=>{d(t)})),null;const f=new Image;if(E.getRequiredSize){const t=E.getRequiredSize(e);t.width&&(f.width=t.width),t.height&&(f.height=t.height)}b(c,f);const p=[],g=()=>{for(const e of p)e.target.removeEventListener(e.name,e.handler);p.length=0};p.push({target:f,name:"load",handler:()=>{g(),t(f),_&&f.src&&URL.revokeObjectURL(f.src)}}),p.push({target:f,name:"error",handler:e=>{g(),d(e),_&&f.src&&URL.revokeObjectURL(f.src)}}),p.push({target:document,name:"securitypolicyviolation",handler:e=>{if(e.blockedURI!==f.src||"report"===e.disposition)return;g();const t=new Error(`CSP violation of policy ${e.effectiveDirective} ${e.blockedURI}. Current policy is ${e.originalPolicy}`);u.q.UseFallbackTexture=!1,d(t),_&&f.src&&URL.revokeObjectURL(f.src),f.src=""}}),(()=>{for(const e of p)e.target.addEventListener(e.name,e.handler)})();const m="blob:"===c.substring(0,5),T="data:"===c.substring(0,5),R=()=>{m||T||!r.u.IsCustomRequestAvailable?f.src=c:C(c,((e,t,i)=>{const r=new Blob([e],{type:!n&&i?i:n}),s=URL.createObjectURL(r);_=!0,f.src=s}),void 0,s||void 0,!0,((e,t)=>{d(t)}))};if(!m&&!T&&s&&s.enableTexturesOffline)s.open((()=>{s&&s.loadImage(c,f)}),R);else{if(-1!==c.indexOf("file:")){const e=decodeURIComponent(c.substring(5).toLowerCase());if(a.FilesToLoad[e]&&"undefined"!=typeof URL){try{let t;try{t=URL.createObjectURL(a.FilesToLoad[e])}catch(i){t=URL.createObjectURL(a.FilesToLoad[e])}f.src=t,_=!0}catch(e){f.src=""}return f}}R()}return f},v=(e,t,i,r,s)=>{const a=new FileReader,o={onCompleteObservable:new n.cP,abort:()=>a.abort()};return a.onloadend=()=>o.onCompleteObservable.notifyObservers(o),s&&(a.onerror=()=>{s(new R(`Unable to read ${e.name}`,e))}),a.onload=e=>{t(e.target.result)},i&&(a.onprogress=i),r?a.readAsArrayBuffer(e):a.readAsText(e),o},C=(e,t,i,r,s,o,h)=>{if(e.name)return v(e,t,i,s,o?e=>{o(void 0,e)}:void 0);const l=e;if(-1!==l.indexOf("file:")){let e=decodeURIComponent(l.substring(5).toLowerCase());0===e.indexOf("./")&&(e=e.substring(2));const r=a.FilesToLoad[e];if(r)return v(r,t,i,s,o?e=>o(void 0,new m(e.message,e.file)):void 0)}const{match:c,type:u}=S(l);if(c){const e={onCompleteObservable:new n.cP,abort:()=>()=>{}};try{const e=s?F(l):I(l);t(e,void 0,u)}catch(e){o?o(void 0,e):_.V.Error(e.message||"Failed to parse the Data URL")}return d._.SetImmediate((()=>{e.onCompleteObservable.notifyObservers(e)})),e}return A(l,((e,i)=>{t(e,i?.responseURL,i?.getResponseHeader("content-type"))}),i,r,s,o?e=>{o(e.request,new m(e.message,e.request))}:void 0,h)},A=(e,t,i,a,o,h,l)=>{e=y.CleanUrl(e),e=y.PreprocessUrl(e);const c=y.BaseUrl+e;let u=!1;const d={onCompleteObservable:new n.cP,abort:()=>u=!0},f=()=>{let e,n=new r.u,a=null;const f=()=>{n&&(i&&n.removeEventListener("progress",i),e&&n.removeEventListener("readystatechange",e),n.removeEventListener("loadend",p))};let p=()=>{f(),d.onCompleteObservable.notifyObservers(d),d.onCompleteObservable.clear(),i=void 0,e=null,p=null,h=void 0,l=void 0,t=void 0};d.abort=()=>{u=!0,p&&p(),n&&n.readyState!==(XMLHttpRequest.DONE||4)&&n.abort(),null!==a&&(clearTimeout(a),a=null),n=null};const g=e=>{const t=e.message||"Unknown error";h&&n?h(new T(t,n)):_.V.Error(t)},m=_=>{if(n){if(n.open("GET",c),l)try{l(n)}catch(e){return void g(e)}o&&(n.responseType="arraybuffer"),i&&n.addEventListener("progress",i),p&&n.addEventListener("loadend",p),e=()=>{if(!u&&n&&n.readyState===(XMLHttpRequest.DONE||4)){if(e&&n.removeEventListener("readystatechange",e),n.status>=200&&n.status<300||0===n.status&&(!(0,s.BA)()||P())){const e=o?n.response:n.responseText;if(null!==e){try{t&&t(e,n)}catch(e){g(e)}return}}const i=y.DefaultRetryStrategy;if(i){const e=i(c,n,_);if(-1!==e)return f(),n=new r.u,void(a=setTimeout((()=>m(_+1)),e))}const l=new T("Error status: "+n.status+" "+n.statusText+" - Unable to load "+c,n);h&&h(l)}},n.addEventListener("readystatechange",e),n.send()}};m(0)};if(a&&a.enableSceneOffline){const r=e=>{e&&e.status>400?h&&h(e):f()},s=()=>{a&&a.loadFile(y.BaseUrl+e,(e=>{!u&&t&&t(e),d.onCompleteObservable.notifyObservers(d)}),i?e=>{!u&&i&&i(e)}:void 0,r,o)};a.open(s,r)}else f();return d},P=()=>"undefined"!=typeof location&&"file:"===location.protocol,M=e=>g.test(e),S=e=>{const t=g.exec(e);return null===t||0===t.length?{match:!1,type:""}:{match:!0,type:t[0].replace("data:","").replace("base64,","")}};function F(e){return(0,l.yS)(e.split(",")[1])}const I=e=>(0,l.AV)(e.split(",")[1]);let w;p.$._FileToolsLoadImage=x,f.sg.loadFile=C,c.Hd.loadFile=C,((e,t,i,r,s,n,a,o,h,l)=>{w={DecodeBase64UrlToBinary:e,DecodeBase64UrlToString:t,DefaultRetryStrategy:i.DefaultRetryStrategy,BaseUrl:i.BaseUrl,CorsBehavior:i.CorsBehavior,PreprocessUrl:i.PreprocessUrl,IsBase64DataUrl:r,IsFileURL:s,LoadFile:n,LoadImage:a,ReadFile:o,RequestFile:h,SetCorsBehavior:l},Object.defineProperty(w,"DefaultRetryStrategy",{get:function(){return i.DefaultRetryStrategy},set:function(e){i.DefaultRetryStrategy=e}}),Object.defineProperty(w,"BaseUrl",{get:function(){return i.BaseUrl},set:function(e){i.BaseUrl=e}}),Object.defineProperty(w,"PreprocessUrl",{get:function(){return i.PreprocessUrl},set:function(e){i.PreprocessUrl=e}}),Object.defineProperty(w,"CorsBehavior",{get:function(){return i.CorsBehavior},set:function(e){i.CorsBehavior=e}})})(F,I,y,M,P,C,x,v,A,b)},9610:(e,t,i)=>{i.d(t,{l:()=>r});class r{static GetShadersRepository(e=0){return 0===e?r.ShadersRepository:r.ShadersRepositoryWGSL}static GetShadersStore(e=0){return 0===e?r.ShadersStore:r.ShadersStoreWGSL}static GetIncludesShadersStore(e=0){return 0===e?r.IncludesShadersStore:r.IncludesShadersStoreWGSL}}r.ShadersRepository="src/Shaders/",r.ShadersStore={},r.IncludesShadersStore={},r.ShadersRepositoryWGSL="src/ShadersWGSL/",r.ShadersStoreWGSL={},r.IncludesShadersStoreWGSL={}},9848:(e,t,i)=>{i.d(t,{cP:()=>a});const r="undefined"!=typeof WeakRef;class s{constructor(e,t=!1,i,r){this.initialize(e,t,i,r)}initialize(e,t=!1,i,r){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=r,this}}class n{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1,this._remove=null}remove(e=!1){this._remove&&this._remove(e)}}class a{static FromPromise(e,t){const i=new a;return e.then((e=>{i.notifyObservers(e)})).catch((e=>{if(!t)throw e;t.notifyObservers(e)})),i}get observers(){return this._observers}constructor(e,t=!1){this.notifyIfTriggered=t,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new s(0),e&&(this._onObserverAdded=e)}add(e,t=-1,i=!1,s=null,a=!1){if(!e)return null;const o=new n(e,t,s);o.unregisterOnNextCall=a,i?this._observers.unshift(o):this._observers.push(o),this._onObserverAdded&&this._onObserverAdded(o),this._hasNotified&&this.notifyIfTriggered&&void 0!==this._lastNotifiedValue&&this.notifyObserver(o,this._lastNotifiedValue);const h=r?new WeakRef(this):{deref:()=>this};return o._remove=(e=!1)=>{const t=h.deref();t&&(e?t.remove(o):t._remove(o))},o}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return!!e&&(e._remove=null,-1!==this._observers.indexOf(e)&&(this._deferUnregister(e),!0))}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){const r=this._observers[i];if(!(r._willBeUnregistered||r.callback!==e||t&&t!==r.scope))return this._deferUnregister(r),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout((()=>{this._remove(e)}),0))}_remove(e,t=!0){if(!e)return!1;const i=this._observers.indexOf(e);return-1!==i&&(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(i,1),!0)}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,i,r,s){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;const n=this._eventState;n.mask=t,n.target=i,n.currentTarget=r,n.skipNextObservers=!1,n.lastReturnValue=e,n.userInfo=s;for(const i of this._observers)if(!i._willBeUnregistered&&(i.mask&t&&(i.unregisterOnNextCall&&this._deferUnregister(i),i.scope?n.lastReturnValue=i.callback.apply(i.scope,[e,n]):n.lastReturnValue=i.callback(e,n)),n.skipNextObservers))return!1;return!0}notifyObserver(e,t,i=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=t),e._willBeUnregistered)return;const r=this._eventState;r.mask=i,r.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,r)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){for(;this._observers.length;){const e=this._observers.pop();e&&(e._remove=null)}this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){const e=new a;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}}}]);(()=>{"use strict";var e,t,r,s={8536:(e,t,r)=>{var s=r(8983);class n{_canvas;_engine;_scene;_onTick;constructor(e){this._canvas=e.canvas,this._engine=e.engine,this._scene=null,this._onTick=null}static async CreateAsync(e){const t=new n(e);return t._scene=await t._initializeAsync(e.sceneBuilder),t._onTick=t._makeOnTick(),t}run(){const e=this._engine;window.addEventListener("resize",this._onResize),e.runRenderLoop(this._onTick)}dispose(){window.removeEventListener("resize",this._onResize),this._engine.dispose()}_onResize=()=>{this._engine.resize()};async _initializeAsync(e){return await e.buildAsync(this._canvas,this._engine)}_makeOnTick(){const e=this._scene;return()=>e.render()}}var a=r(5847),o=r(4037),i=r(3951);class l{_dataView;_encoder;_offset;constructor(e){this._dataView=new DataView(e),this._encoder=new TextEncoder,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}setUint8(e){this._dataView.setUint8(this._offset,e),this._offset+=1}setUint8Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setUint8(this._offset,e[r]),this._offset+=1}setInt8(e){this._dataView.setInt8(this._offset,e),this._offset+=1}setInt8Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setInt8(this._offset,e[r]),this._offset+=1}setUint16(e){this._dataView.setUint16(this._offset,e,!0),this._offset+=2}setUint16Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setUint16(this._offset,e[r],!0),this._offset+=2}setUint32(e){this._dataView.setUint32(this._offset,e,!0),this._offset+=4}setUint32Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setUint32(this._offset,e[r],!0),this._offset+=4}setInt32(e){this._dataView.setInt32(this._offset,e,!0),this._offset+=4}setInt32Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setInt32(this._offset,e[r],!0),this._offset+=4}setFloat32(e){this._dataView.setFloat32(this._offset,e,!0),this._offset+=4}setFloat32Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setFloat32(this._offset,e[r],!0),this._offset+=4}setString(e){const t=this._dataView,r=this._encoder.encode(e);t.setUint32(this._offset,r.length,!0),this._offset+=4;for(let e=0;e<r.length;++e)t.setUint8(this._offset,r[e]),this._offset+=1}get bytesAvailable(){return this._dataView.byteLength-this._offset}static Padding(e,t){return e%t===0?0:t-e%t}}class h{constructor(){}static Convert(e){const t=new TextEncoder;let r=7;{r+=4;const s=e.boneTracks.length;for(let n=0;n<s;++n){const s=e.boneTracks[n];r+=4+t.encode(s.name).length,r+=4,r+=4*s.frameNumbers.length+l.Padding(r,4),r+=16*s.frameNumbers.length+l.Padding(r,4),r+=4*s.frameNumbers.length,r+=1*s.frameNumbers.length}r+=4;const n=e.movableBoneTracks.length;for(let s=0;s<n;++s){const n=e.movableBoneTracks[s];r+=4+t.encode(n.name).length,r+=4,r+=4*n.frameNumbers.length+l.Padding(r,4),r+=12*n.frameNumbers.length+l.Padding(r,4),r+=12*n.frameNumbers.length,r+=16*n.frameNumbers.length+l.Padding(r,4),r+=4*n.frameNumbers.length,r+=1*n.frameNumbers.length}r+=4;const a=e.morphTracks.length;for(let s=0;s<a;++s){const n=e.morphTracks[s];r+=4+t.encode(n.name).length,r+=4,r+=4*n.frameNumbers.length+l.Padding(r,4),r+=4*n.frameNumbers.length+l.Padding(r,4)}r+=4,r+=4*e.propertyTrack.frameNumbers.length+l.Padding(r,4),r+=1*e.propertyTrack.frameNumbers.length+l.Padding(r,4),r+=4;const o=e.propertyTrack.ikBoneNames.length;for(let s=0;s<o;++s){const n=e.propertyTrack.ikBoneNames[s];r+=4+t.encode(n).length}r+=1*o*e.propertyTrack.frameNumbers.length,r+=4,r+=4*e.cameraTrack.frameNumbers.length+l.Padding(r,4),r+=12*e.cameraTrack.frameNumbers.length+l.Padding(r,4),r+=12*e.cameraTrack.frameNumbers.length,r+=12*e.cameraTrack.frameNumbers.length+l.Padding(r,4),r+=4*e.cameraTrack.frameNumbers.length,r+=4*e.cameraTrack.frameNumbers.length+l.Padding(r,4),r+=4*e.cameraTrack.frameNumbers.length,r+=4*e.cameraTrack.frameNumbers.length+l.Padding(r,4),r+=4*e.cameraTrack.frameNumbers.length}const s=new ArrayBuffer(r),n=new l(s);n.setUint8Array(t.encode("BVMD")),n.setInt8Array([2,1,0]);const a=e.boneTracks;n.setUint32(a.length);for(let e=0;e<a.length;++e){const t=a[e];n.setString(t.name),n.setUint32(t.frameNumbers.length),n.offset+=l.Padding(n.offset,4),n.setUint32Array(t.frameNumbers),n.offset+=l.Padding(n.offset,4),n.setFloat32Array(t.rotations),n.setUint8Array(t.rotationInterpolations),n.setUint8Array(t.physicsToggles)}const o=e.movableBoneTracks;n.setUint32(o.length);for(let e=0;e<o.length;++e){const t=o[e];n.setString(t.name),n.setUint32(t.frameNumbers.length),n.offset+=l.Padding(n.offset,4),n.setUint32Array(t.frameNumbers),n.offset+=l.Padding(n.offset,4),n.setFloat32Array(t.positions),n.setUint8Array(t.positionInterpolations),n.offset+=l.Padding(n.offset,4),n.setFloat32Array(t.rotations),n.setUint8Array(t.rotationInterpolations),n.setUint8Array(t.physicsToggles)}const i=e.morphTracks;n.setUint32(i.length);for(let e=0;e<i.length;++e){const t=i[e];n.setString(t.name),n.setUint32(t.frameNumbers.length),n.offset+=l.Padding(n.offset,4),n.setUint32Array(t.frameNumbers),n.offset+=l.Padding(n.offset,4),n.setFloat32Array(t.weights)}n.setUint32(e.propertyTrack.frameNumbers.length),n.setUint32(e.propertyTrack.ikBoneNames.length),n.offset+=l.Padding(n.offset,4),n.setUint32Array(e.propertyTrack.frameNumbers),n.setUint8Array(e.propertyTrack.visibles);const h=e.propertyTrack.ikBoneNames;for(let t=0;t<h.length;++t){const r=h[t];n.setString(r),n.setUint8Array(e.propertyTrack.getIkState(t))}return n.setUint32(e.cameraTrack.frameNumbers.length),n.offset+=l.Padding(n.offset,4),n.setUint32Array(e.cameraTrack.frameNumbers),n.offset+=l.Padding(n.offset,4),n.setFloat32Array(e.cameraTrack.positions),n.setUint8Array(e.cameraTrack.positionInterpolations),n.offset+=l.Padding(n.offset,4),n.setFloat32Array(e.cameraTrack.rotations),n.setUint8Array(e.cameraTrack.rotationInterpolations),n.offset+=l.Padding(n.offset,4),n.setFloat32Array(e.cameraTrack.distances),n.setUint8Array(e.cameraTrack.distanceInterpolations),n.offset+=l.Padding(n.offset,4),n.setFloat32Array(e.cameraTrack.fovs),n.setUint8Array(e.cameraTrack.fovInterpolations),s}}var f=r(1137),c=r(350);class m{name;boneTracks;movableBoneTracks;morphTracks;propertyTrack;cameraTrack;startFrame;endFrame;constructor(e,t,r,s,n,a){this.name=e,this.boneTracks=t,this.movableBoneTracks=r,this.morphTracks=s,this.propertyTrack=n,this.cameraTrack=a;let o=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER;for(let e=0;e<t.length;++e){const r=t[e];o=Math.min(o,r.startFrame),i=Math.max(i,r.endFrame)}for(let e=0;e<r.length;++e){const t=r[e];o=Math.min(o,t.startFrame),i=Math.max(i,t.endFrame)}for(let e=0;e<s.length;++e){const t=s[e];o=Math.min(o,t.startFrame),i=Math.max(i,t.endFrame)}o=Math.min(o,n.startFrame),i=Math.max(i,n.endFrame),o=Math.min(o,a.startFrame),i=Math.max(i,a.endFrame),this.startFrame=o,this.endFrame=i}}class y extends m{constructor(e,t,r,s,n,a){super(e,t,r,s,n,a)}validate(){const e=this.boneTracks;for(let t=0;t<e.length;++t)if(!e[t].validate())return!1;const t=this.movableBoneTracks;for(let e=0;e<t.length;++e)if(!t[e].validate())return!1;const r=this.morphTracks;for(let e=0;e<r.length;++e)if(!r[e].validate())return!1;return this.propertyTrack.validate()&&this.cameraTrack.validate()}}class g{trackType;name;frameNumbers;constructor(e,t,r,s,n){this.trackType=e,this.name=t,this.frameNumbers=void 0===s?new Uint32Array(r):new Uint32Array(s,n,r)}validate(){for(let e=1;e<this.frameNumbers.length;++e)if(this.frameNumbers[e-1]>=this.frameNumbers[e])return!1;return!0}get startFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[0]}get endFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[this.frameNumbers.length-1]}}class d extends g{rotations;rotationInterpolations;physicsToggles;constructor(e,t,r,s,n,a,o){super("bone",e,t,r,s),void 0===r?(this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t),this.physicsToggles=new Uint8Array(t)):(this.rotations=new Float32Array(r,n,4*t),this.rotationInterpolations=new Uint8Array(r,a,4*t),this.physicsToggles=void 0===o?new Uint8Array(t).fill(1):new Uint8Array(r,o,t))}}class u extends g{positions;positionInterpolations;rotations;rotationInterpolations;physicsToggles;constructor(e,t,r,s,n,a,o,i,l){super("movableBone",e,t,r,s),void 0===r?(this.positions=new Float32Array(3*t),this.positionInterpolations=new Uint8Array(12*t),this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t),this.physicsToggles=new Uint8Array(t)):(this.positions=new Float32Array(r,n,3*t),this.positionInterpolations=new Uint8Array(r,a,12*t),this.rotations=new Float32Array(r,o,4*t),this.rotationInterpolations=new Uint8Array(r,i,4*t),this.physicsToggles=void 0===l?new Uint8Array(t).fill(1):new Uint8Array(r,l,t))}}class p extends g{weights;constructor(e,t,r,s,n){super("morph",e,t,r,s),this.weights=void 0===r?new Float32Array(t):new Float32Array(r,n,t)}}class b extends g{positions;positionInterpolations;rotations;rotationInterpolations;distances;distanceInterpolations;fovs;fovInterpolations;constructor(e,t,r,s,n,a,o,i,l,h,f){super("camera","cameraTrack",e,t,r),void 0===t?(this.positions=new Float32Array(3*e),this.positionInterpolations=new Uint8Array(12*e),this.rotations=new Float32Array(3*e),this.rotationInterpolations=new Uint8Array(4*e),this.distances=new Float32Array(e),this.distanceInterpolations=new Uint8Array(4*e),this.fovs=new Float32Array(e),this.fovInterpolations=new Uint8Array(4*e)):(this.positions=new Float32Array(t,s,3*e),this.positionInterpolations=new Uint8Array(t,n,12*e),this.rotations=new Float32Array(t,a,3*e),this.rotationInterpolations=new Uint8Array(t,o,4*e),this.distances=new Float32Array(t,i,e),this.distanceInterpolations=new Uint8Array(t,l,4*e),this.fovs=new Float32Array(t,h,e),this.fovInterpolations=new Uint8Array(t,f,4*e))}}class w extends g{visibles;ikBoneNames;_ikStates;constructor(e,t,r,s,n,a){if(super("property","propertyTrack",e,r,s),void 0===r){this.visibles=new Uint8Array(e),this.ikBoneNames=t,this._ikStates=new Array(t.length);for(let r=0;r<t.length;++r)this._ikStates[r]=new Uint8Array(e)}else{this.visibles=new Uint8Array(r,n,e),this.ikBoneNames=t,this._ikStates=new Array(t.length),void 0===a&&(a=new Array(t.length));for(let s=0;s<t.length;++s)this._ikStates[s]=new Uint8Array(r,a[s],e)}}getIkState(e){return this._ikStates[e]}}class _{log(e){console.log(e)}warn(e){console.warn(e)}error(e){console.error(e)}}class F{isDeviceLittleEndian;_dataView;_decoder;_offset;constructor(e){this.isDeviceLittleEndian=this._getIsDeviceLittleEndian(),this._dataView=new DataView(e),this._decoder=null,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}_getIsDeviceLittleEndian(){const e=new Int16Array([256]);return 1===new Int8Array(e.buffer)[1]}swap16Array(e){for(let t=0;t<e.length;++t){const r=e[t];e[t]=(255&r)<<8|r>>8&255}}swap32Array(e){for(let t=0;t<e.length;++t){const r=e[t];e[t]=(255&r)<<24|(65280&r)<<8|r>>8&65280|r>>24&255}}getUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}getInt8(){const e=this._dataView.getInt8(this._offset);return this._offset+=1,e}getUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);e.set(t),this._offset+=e.byteLength}getUint16(){const e=this._dataView.getUint16(this._offset,!0);return this._offset+=2,e}getUint16Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap16Array(e)}getInt16(){const e=this._dataView.getInt16(this._offset,!0);return this._offset+=2,e}getUint32(){const e=this._dataView.getUint32(this._offset,!0);return this._offset+=4,e}getUint32Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap32Array(e)}getInt32(){const e=this._dataView.getInt32(this._offset,!0);return this._offset+=4,e}getInt32Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap32Array(e)}getFloat32(){const e=this._dataView.getFloat32(this._offset,!0);return this._offset+=4,e}getFloat32Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap32Array(e)}getFloat32Tuple(e){const t=new Array(e);for(let r=0;r<e;++r)t[r]=this._dataView.getFloat32(this._offset,!0),this._offset+=4;return t}initializeTextDecoder(e){this._decoder=new TextDecoder(e)}getDecoderString(e,t){if(null===this._decoder)throw new Error("TextDecoder is not initialized.");let r=new Uint8Array(this._dataView.buffer,this._offset,e);if(this._offset+=e,t)for(let e=0;e<r.length;++e)if(0===r[e]){r=r.subarray(0,e);break}return this._decoder.decode(r)}getSignatureString(e){const t=new TextDecoder("utf-8"),r=new Uint8Array(this._dataView.buffer,this._offset,e);return this._offset+=e,t.decode(r)}getPaddedArrayOffset(e,t){this._offset+=this._offset%e===0?0:e-this._offset%e;const r=this._offset;return this._offset+=e*t,r}get bytesAvailable(){return this._dataView.byteLength-this._offset}}class A{static _Signature="Vocaloid Motion Data 0002";static SignatureBytes=30;static ModelNameBytes=20;static BoneKeyFrameBytes=111;static MorphKeyFrameBytes=23;static CameraKeyFrameBytes=61;static LightKeyFrameBytes=28;static SelfShadowKeyFrameBytes=9;static PropertyKeyFrameBytes=5;static PropertyKeyFrameIkStateBytes=21;dataDeserializer;boneKeyFrameCount;morphKeyFrameCount;cameraKeyFrameCount;lightKeyFrameCount;selfShadowKeyFrameCount;propertyKeyFrameCount;constructor(e,t,r,s,n,a,o){this.dataDeserializer=e,this.boneKeyFrameCount=t,this.morphKeyFrameCount=r,this.cameraKeyFrameCount=s,this.lightKeyFrameCount=n,this.selfShadowKeyFrameCount=a,this.propertyKeyFrameCount=o}static CheckedCreate(e,t=new _){const r=new F(e);if(r.initializeTextDecoder("shift-jis"),r.bytesAvailable<A.SignatureBytes+A.ModelNameBytes)return null;if(r.getSignatureString(this.SignatureBytes).substring(0,this._Signature.length)!==this._Signature)return null;r.offset+=A.ModelNameBytes;let s=0,n=0,a=0,o=0,i=0,l=0;if(r.bytesAvailable<4)return null;if(s=r.getUint32(),r.bytesAvailable<s*A.BoneKeyFrameBytes)return null;if(r.offset+=s*A.BoneKeyFrameBytes,r.bytesAvailable<4)return null;if(n=r.getUint32(),r.bytesAvailable<n*A.MorphKeyFrameBytes)return null;if(r.offset+=n*A.MorphKeyFrameBytes,0!==r.bytesAvailable){if(r.bytesAvailable<4)return null;if(a=r.getUint32(),r.bytesAvailable<a*A.CameraKeyFrameBytes)return null;if(r.offset+=a*A.CameraKeyFrameBytes,r.bytesAvailable<4)return null;if(o=r.getUint32(),r.bytesAvailable<o*A.LightKeyFrameBytes)return null;r.offset+=o*A.LightKeyFrameBytes}if(0!==r.bytesAvailable){if(r.bytesAvailable<4)return null;if(i=r.getUint32(),r.bytesAvailable<i*A.SelfShadowKeyFrameBytes)return null;r.offset+=i*A.SelfShadowKeyFrameBytes}if(0!==r.bytesAvailable){if(r.bytesAvailable<4)return null;l=r.getUint32();for(let e=0;e<l;++e){if(r.bytesAvailable<A.PropertyKeyFrameBytes)return null;if(r.offset+=A.PropertyKeyFrameBytes,r.bytesAvailable<4)return null;const e=r.getUint32();if(r.bytesAvailable<e*A.PropertyKeyFrameIkStateBytes)return null;r.offset+=e*A.PropertyKeyFrameIkStateBytes}}return r.bytesAvailable>0&&t.warn(`There are ${r.bytesAvailable} bytes left after parsing`),r.offset=0,new A(r,s,n,a,o,i,l)}}class v{propertyKeyFrames;_vmdData;constructor(e,t){this._vmdData=e,this.propertyKeyFrames=t}static Parse(e){const t=e.dataDeserializer,r=[];t.offset=A.SignatureBytes+A.ModelNameBytes+4+e.boneKeyFrameCount*A.BoneKeyFrameBytes+4+e.morphKeyFrameCount*A.MorphKeyFrameBytes+4+e.cameraKeyFrameCount*A.CameraKeyFrameBytes+4+e.lightKeyFrameCount*A.LightKeyFrameBytes+4+e.selfShadowKeyFrameCount*A.SelfShadowKeyFrameBytes+4;const s=e.propertyKeyFrameCount;for(let e=0;e<s;++e){const e=t.getUint32(),s=0!==t.getUint8(),n=t.getUint32(),a=[];for(let e=0;e<n;++e){const e=t.getDecoderString(20,!0),r=0!==t.getUint8();a.push([e,r])}const o={frameNumber:e,visible:s,ikStates:a};r.push(o)}return new v(e,r)}static ParseFromBuffer(e){const t=A.CheckedCreate(e);if(null===t)throw new Error("Invalid VMD data");return v.Parse(t)}get boneKeyFrames(){const e=A.SignatureBytes+A.ModelNameBytes+4;return new v.BoneKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.boneKeyFrameCount)}get morphKeyFrames(){const e=A.SignatureBytes+A.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*A.BoneKeyFrameBytes+4;return new v.MorphKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.morphKeyFrameCount)}get cameraKeyFrames(){const e=A.SignatureBytes+A.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*A.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*A.MorphKeyFrameBytes+4;return new v.CameraKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.cameraKeyFrameCount)}get lightKeyFrames(){const e=A.SignatureBytes+A.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*A.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*A.MorphKeyFrameBytes+4+this._vmdData.cameraKeyFrameCount*A.CameraKeyFrameBytes+4;return new v.LightKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.lightKeyFrameCount)}get selfShadowKeyFrames(){const e=A.SignatureBytes+A.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*A.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*A.MorphKeyFrameBytes+4+this._vmdData.cameraKeyFrameCount*A.CameraKeyFrameBytes+4+this._vmdData.lightKeyFrameCount*A.LightKeyFrameBytes+4;return new v.SelfShadowKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.selfShadowKeyFrameCount)}}!function(e){class t{_dataDeserializer;_startOffset;_length;constructor(e,t,r){this._dataDeserializer=e,this._startOffset=t,this._length=r}get length(){return this._length}}e.BufferArrayReader=t,e.BoneKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*A.BoneKeyFrameBytes;return new r(this._dataDeserializer,t)}};class r{boneName;frameNumber;position;rotation;interpolation;constructor(e,t){e.offset=t,this.boneName=e.getDecoderString(15,!0),this.frameNumber=e.getUint32(),this.position=e.getFloat32Tuple(3),this.rotation=e.getFloat32Tuple(4),this.interpolation=new Uint8Array(64);for(let t=0;t<64;++t)this.interpolation[t]=e.getUint8()}}let s;e.BoneKeyFrame=r,function(e){e[e.Off=25359]="Off",e[e.On=0]="On"}(s=e.BoneKeyFramePhysicsInfoKind||(e.BoneKeyFramePhysicsInfoKind={})),e.MorphKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*A.MorphKeyFrameBytes;return new n(this._dataDeserializer,t)}};class n{morphName;frameNumber;weight;constructor(e,t){e.offset=t,this.morphName=e.getDecoderString(15,!0),this.frameNumber=e.getUint32(),this.weight=e.getFloat32()}}e.MorphKeyFrame=n,e.CameraKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*A.CameraKeyFrameBytes;return new a(this._dataDeserializer,t)}};class a{frameNumber;distance;position;rotation;interpolation;fov;perspective;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.distance=e.getFloat32(),this.position=e.getFloat32Tuple(3),this.rotation=e.getFloat32Tuple(3),this.interpolation=new Uint8Array(24);for(let t=0;t<24;++t)this.interpolation[t]=e.getUint8();this.fov=e.getUint32(),this.perspective=0!==e.getUint8()}}e.CameraKeyFrame=a,e.LightKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*A.LightKeyFrameBytes;return new o(this._dataDeserializer,t)}};class o{frameNumber;color;direction;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.color=e.getFloat32Tuple(3),this.direction=e.getFloat32Tuple(3)}}e.LightKeyFrame=o,e.SelfShadowKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*A.SelfShadowKeyFrameBytes;return new i(this._dataDeserializer,t)}};class i{frameNumber;mode;distance;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.mode=e.getUint8(),this.distance=e.getFloat32()}}e.SelfShadowKeyFrame=i}(v||(v={}));class k{optimizeEmptyTracks;_scene;_loggingEnabled;log;warn;error;constructor(e){this.optimizeEmptyTracks=!0,this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._scene=e}loadFromVmdObject(e,t,r,s){this.loadFromVmdObjectAsync(e,t,s).then(r)}async loadFromVmdObjectAsync(e,t,r){const s=this.optimizeEmptyTracks;Array.isArray(t)||(t=[t]);let n=0,a=0,o=0,i=0;for(let e=0;e<t.length;++e){const r=t[e];n+=r.boneKeyFrames.length,a+=r.morphKeyFrames.length,o+=r.propertyKeyFrames.length,i+=r.cameraKeyFrames.length}const l={lengthComputable:!0,loaded:0,total:n+a+o+i};let h=0,f=performance.now();const m=[];{const e=new Map,s=[],n=[],a=[];for(let e=0;e<t.length;++e){const r=t[e].boneKeyFrames,s=r.length;for(let e=0;e<s;++e)a.push(r.get(e))}100<performance.now()-f&&(await c.S0.DelayAsync(0),f=performance.now());const o=a.length;for(let t=0;t<o;++t){const r=a[t].boneName;let o=e.get(r);void 0===o&&(o=e.size,e.set(r,o),s.push(0),n.push(r)),s[o]+=1}a.sort(((e,t)=>e.frameNumber-t.frameNumber));for(let t=0;t<e.size;++t)m.push(new u(n[t],s[t]));100<performance.now()-f&&(await c.S0.DelayAsync(0),f=performance.now());const i=new Uint32Array(e.size);for(let t=0;t<o;++t){const s=a[t],n=e.get(s.boneName),o=m[n],y=i[n],g=s.interpolation;o.frameNumbers[y]=s.frameNumber;const d=o.positions,u=s.position;d[3*y+0]=u[0],d[3*y+1]=u[1],d[3*y+2]=u[2];const p=o.positionInterpolations;p[12*y+0]=g[0],p[12*y+1]=g[8],p[12*y+2]=g[4],p[12*y+3]=g[12],p[12*y+4]=g[16],p[12*y+5]=g[24],p[12*y+6]=g[20],p[12*y+7]=g[28],p[12*y+8]=g[32],p[12*y+9]=g[40],p[12*y+10]=g[36],p[12*y+11]=g[44];const b=o.rotations,w=s.rotation;b[4*y+0]=w[0],b[4*y+1]=w[1],b[4*y+2]=w[2],b[4*y+3]=w[3];const _=o.rotationInterpolations;_[4*y+0]=g[48],_[4*y+1]=g[56],_[4*y+2]=g[52],_[4*y+3]=g[60];const F=g[2]<<8|g[3];switch(F){case v.BoneKeyFramePhysicsInfoKind.On:o.physicsToggles[y]=1;break;case v.BoneKeyFramePhysicsInfoKind.Off:o.physicsToggles[y]=0;break;default:this.warn(`Unknown physics toggle info: ${F}`)}i[n]+=1,t%1e3==0&&100<performance.now()-f&&(l.loaded=h+t,r?.({...l}),await c.S0.DelayAsync(0),f=performance.now())}}const g=[],_=[];if(s)for(let e=0;e<m.length;++e){const t=m[e];let r=!0;for(let e=0;e<t.frameNumbers.length;++e){const s=t.positions;if(0!==s[3*e+0]||0!==s[3*e+1]||0!==s[3*e+2]){r=!1;break}const n=t.rotations;if(0!==n[4*e+0]||0!==n[4*e+1]||0!==n[4*e+2]||1!==n[4*e+3]){r=!1;break}if(0===t.physicsToggles[e]){r=!1;break}}if(r)continue;let s=!1;for(let e=0;e<t.positions.length;++e)if(0!==t.positions[e]){s=!0;break}if(s)_.push(t);else{const e=new d(t.name,t.frameNumbers.length);e.frameNumbers.set(t.frameNumbers),e.rotations.set(t.rotations),e.rotationInterpolations.set(t.rotationInterpolations),e.physicsToggles.set(t.physicsToggles),g.push(e)}}else _.push(...m);if(m.length=0,1<t.length){const e=new Int32Array(g.length).fill(-1);for(let t=0;t<g.length;++t){const r=g[t].frameNumbers;let s=0,n=r[0];for(let e=1;e<=r.length;++e){const t=r[e];n!==t&&(s+=1,n=t)}r.length!==s&&(e[t]=s)}for(let t=0;t<g.length;++t){const r=e[t];if(-1===r)continue;const s=g[t],n=s.frameNumbers,a=s.rotations,o=s.rotationInterpolations,i=s.physicsToggles,l=new d(s.name,r);let h=0,f=n[0];for(let e=1;e<=n.length;++e){const t=n[e];if(f!==t){const r=e-1;l.frameNumbers[h]=f;const s=l.rotations;s[4*h+0]=a[4*r+0],s[4*h+1]=a[4*r+1],s[4*h+2]=a[4*r+2],s[4*h+3]=a[4*r+3];const n=l.rotationInterpolations;n[4*h+0]=o[4*r+0],n[4*h+1]=o[4*r+1],n[4*h+2]=o[4*r+2],n[4*h+3]=o[4*r+3],l.physicsToggles[h]=i[r],h+=1,f=t}}g[t]=l}const t=new Int32Array(_.length).fill(-1);for(let e=0;e<_.length;++e){const r=_[e].frameNumbers;let s=0,n=r[0];for(let e=1;e<=r.length;++e){const t=r[e];n!==t&&(s+=1,n=t)}r.length!==s&&(t[e]=s)}for(let e=0;e<_.length;++e){const r=t[e];if(-1===r)continue;const s=_[e],n=s.frameNumbers,a=s.positions,o=s.positionInterpolations,i=s.rotations,l=s.rotationInterpolations,h=s.physicsToggles,f=new u(s.name,r);let c=0,m=n[0];for(let e=1;e<=n.length;++e){const t=n[e];if(m!==t){const r=e-1;f.frameNumbers[c]=m;const s=f.positions;s[3*c+0]=a[3*r+0],s[3*c+1]=a[3*r+1],s[3*c+2]=a[3*r+2];const n=f.positionInterpolations;n[12*c+0]=o[12*r+0],n[12*c+1]=o[12*r+1],n[12*c+2]=o[12*r+2],n[12*c+3]=o[12*r+3],n[12*c+4]=o[12*r+4],n[12*c+5]=o[12*r+5],n[12*c+6]=o[12*r+6],n[12*c+7]=o[12*r+7],n[12*c+8]=o[12*r+8],n[12*c+9]=o[12*r+9],n[12*c+10]=o[12*r+10],n[12*c+11]=o[12*r+11];const y=f.rotations;y[4*c+0]=i[4*r+0],y[4*c+1]=i[4*r+1],y[4*c+2]=i[4*r+2],y[4*c+3]=i[4*r+3];const g=f.rotationInterpolations;g[4*c+0]=l[4*r+0],g[4*c+1]=l[4*r+1],g[4*c+2]=l[4*r+2],g[4*c+3]=l[4*r+3],f.physicsToggles[c]=h[r],c+=1,m=t}}_[e]=f}}l.loaded=h+n,r?.({...l}),h+=n;const F=[];{const e=new Map,s=[],n=[],a=[];for(let e=0;e<t.length;++e){const r=t[e].morphKeyFrames,s=r.length;for(let e=0;e<s;++e)a.push(r.get(e))}100<performance.now()-f&&(await c.S0.DelayAsync(0),f=performance.now());const o=a.length;for(let t=0;t<o;++t){const r=a[t].morphName;let o=e.get(r);void 0===o&&(o=e.size,e.set(r,o),s.push(0),n.push(r)),s[o]+=1}a.sort(((e,t)=>e.frameNumber-t.frameNumber));for(let t=0;t<e.size;++t)F.push(new p(n[t],s[t]));100<performance.now()-f&&(await c.S0.DelayAsync(0),f=performance.now());const i=new Uint32Array(e.size);for(let t=0;t<o;++t){const s=a[t],n=e.get(s.morphName),o=F[n],m=i[n];o.frameNumbers[m]=s.frameNumber,o.weights[m]=s.weight,i[n]+=1,t%1e3==0&&100<performance.now()-f&&(l.loaded=h+t,r?.({...l}),await c.S0.DelayAsync(0),f=performance.now())}}const A=[];if(s)for(let e=0;e<F.length;++e){const t=F[e];let r=!0;for(let e=0;e<t.weights.length;++e)if(0!==t.weights[e]){r=!1;break}r||A.push(t)}else A.push(...F);if(F.length=0,1<t.length){const e=new Int32Array(A.length).fill(-1);for(let t=0;t<A.length;++t){const r=A[t].frameNumbers;let s=0,n=r[0];for(let e=1;e<=r.length;++e){const t=r[e];n!==t&&(s+=1,n=t)}r.length!==s&&(e[t]=s)}for(let t=0;t<A.length;++t){const r=e[t];if(-1===r)continue;const s=A[t],n=s.frameNumbers,a=s.weights,o=new p(s.name,r);let i=0,l=n[0];for(let e=1;e<=n.length;++e){const t=n[e];l!==t&&(o.frameNumbers[i]=l,o.weights[i]=a[e-1],i+=1,l=t)}A[t]=o}}l.loaded=h+a,r?.({...l}),h+=a;const k=[];for(let e=0;e<t.length;++e){const r=t[e].propertyKeyFrames;for(let e=0;e<r.length;++e)k.push(r[e])}let N;if(k.sort(((e,t)=>e.frameNumber-t.frameNumber)),1<t.length)N=k;else{N=[];let e=k[0]?.frameNumber;for(let t=1;t<=k.length;++t){const r=k[t]?.frameNumber;e!==r&&(N.push(k[t-1]),e=r)}}const U=new Set;for(let e=0;e<t.length;++e){const r=t[e].propertyKeyFrames;for(let e=0;e<r.length;++e){const t=r[e];for(let e=0;e<t.ikStates.length;++e)U.add(t.ikStates[e][0])}}const K=new Array(U.size),T=new Map;{let e=0;for(const t of U)T.set(t,e),K[e]=t,e+=1}const B=new w(N.length,K);{const e=new Uint8Array(U.size);for(let t=0;t<N.length;++t){const r=N[t];B.frameNumbers[t]=r.frameNumber,B.visibles[t]=r.visible?1:0;const s=r.ikStates;e.fill(0);for(let r=0;r<s.length;++r){const n=s[r],a=T.get(n[0]);B.getIkState(a)[t]=n[1]?1:0,e[a]=1}for(let r=0;r<e.length;++r)if(0===e[r]){const e=B.getIkState(r)[t-1];B.getIkState(r)[t]=void 0===e?0:e}}}l.loaded=h+o,r?.({...l}),h+=o;const S=[];for(let e=0;e<t.length;++e){const r=t[e].cameraKeyFrames;for(let e=0;e<r.length;++e)S.push(r.get(e))}let D;if(S.sort(((e,t)=>e.frameNumber-t.frameNumber)),1<t.length)D=S;else{D=[];let e=S[0]?.frameNumber;for(let t=1;t<=S.length;++t){const r=S[t]?.frameNumber;e!==r&&(D.push(S[t-1]),e=r)}}const I=new b(D.length);for(let e=0;e<D.length;++e){const t=D[e],s=t.interpolation;I.frameNumbers[e]=t.frameNumber;const n=I.positions,a=t.position;n[3*e+0]=a[0],n[3*e+1]=a[1],n[3*e+2]=a[2];const o=I.positionInterpolations;o[12*e+0]=s[0],o[12*e+1]=s[1],o[12*e+2]=s[2],o[12*e+3]=s[3],o[12*e+4]=s[4],o[12*e+5]=s[5],o[12*e+6]=s[6],o[12*e+7]=s[7],o[12*e+8]=s[8],o[12*e+9]=s[9],o[12*e+10]=s[10],o[12*e+11]=s[11];const i=I.rotations,m=t.rotation;i[3*e+0]=m[0],i[3*e+1]=m[1],i[3*e+2]=m[2];const y=I.rotationInterpolations;y[4*e+0]=s[12],y[4*e+1]=s[13],y[4*e+2]=s[14],y[4*e+3]=s[15],I.distances[e]=t.distance;const g=I.distanceInterpolations;g[4*e+0]=s[16],g[4*e+1]=s[17],g[4*e+2]=s[18],g[4*e+3]=s[19],I.fovs[e]=t.fov;const d=I.fovInterpolations;d[4*e+0]=s[20],d[4*e+1]=s[21],d[4*e+2]=s[22],d[4*e+3]=s[23],e%1e3==0&&100<performance.now()-f&&(l.loaded=h+e,r?.({...l}),await c.S0.DelayAsync(0),f=performance.now())}return l.loaded=h+i,r?.({...l}),h+=i,new y(e,g,_,A,B,I)}loadFromVmdData(e,t,r,s){Array.isArray(t)||(t=[t]);const n=[];for(let e=0;e<t.length;++e)n.push(v.Parse(t[e]));this.loadFromVmdObject(e,n,r,s)}loadFromVmdDataAsync(e,t,r){return new Promise((s=>{this.loadFromVmdData(e,t,s,r)}))}loadFromBuffer(e,t,r,s,n){Array.isArray(t)||(t=[t]);const a=[];for(let e=0;e<t.length;++e){const r=A.CheckedCreate(t[e]);if(null===r)return void n?.(new Error("VMD data validation failed."));a.push(r)}this.loadFromVmdData(e,a,r,s)}loadFromBufferAsync(e,t,r){return new Promise(((s,n)=>{this.loadFromBuffer(e,t,s,r,n)}))}load(e,t,r,s,n){Array.isArray(t)||(t=[t]);const a=this._scene,o=[],i=[];for(let l=0;l<t.length;++l){const h=t[l];i.push(a._loadFile(h,((a,i)=>{try{o.push(a),o.length===t.length&&this.loadFromBuffer(e,o,r,s,(e=>{n?.(void 0,e)}))}catch(e){n?.(void 0,e)}}),s,!0,!0,n))}return 1===t.length?i[0]:i}loadAsync(e,t,r){return new Promise(((s,n)=>{this.load(e,t,s,r,((e,t)=>n({request:e,exception:t})))}))}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){f.V.Log(e)}_logDisabled(){}_warnEnabled(e){f.V.Warn(e)}_warnDisabled(){}_errorEnabled(e){f.V.Error(e)}_errorDisabled(){}}const N=document.createElement("canvas");N.style.width="100%",N.style.height="100%",N.style.display="block",document.body.appendChild(N);const U=new s.N(N,!1,{preserveDrawingBuffer:!1,stencil:!1,antialias:!0,alpha:!0,premultipliedAlpha:!1,powerPreference:"high-performance",doNotHandleTouchAction:!0,doNotHandleContextLost:!0,audioEngine:!1,disableWebGL2Support:!1},!0);n.CreateAsync({canvas:N,engine:U,sceneBuilder:new class{async buildAsync(e,t){t.setHardwareScalingLevel(1e3);const r=new i.Z(t);new a.S("camera1",new o.Pq(0,5,-10),r);const s=document.createElement("div");s.style.position="absolute",s.style.top="0",s.style.left="0",s.style.backgroundColor="white",s.style.width="100%",s.style.height="100%",s.style.display="flex",s.style.flexDirection="column",s.style.justifyContent="center",s.style.alignItems="center",s.style.fontFamily="sans-serif",e.parentElement.appendChild(s);const n=document.createElement("div");n.style.width="auto",n.style.height="100%",n.style.display="flex",n.style.flexDirection="column",n.style.justifyContent="center",n.style.alignItems="start",s.appendChild(n);const l=new k(r);l.loggingEnabled=!0;const f=[],c=document.createElement("h1");c.textContent="VMD to BVMD Converter",c.style.width="350px",c.style.fontSize="24px",c.style.textAlign="center",n.appendChild(c);const m=document.createElement("ul");n.appendChild(m),m.style.width="100%",m.style.height="auto",m.style.fontSize="20px";const y=()=>{m.innerHTML="";for(const e of f){const t=document.createElement("li");t.textContent=e.name,m.appendChild(t)}};y();const g=document.createElement("input");g.style.width="100%",g.style.height="80px",g.style.display="block",g.style.backgroundColor="black",g.style.color="white",g.style.marginBottom="10px",g.style.fontSize="20px",g.type="file",g.accept=".vmd",g.multiple=!0,g.onchange=()=>{if(null!==g.files){for(const e of g.files)e.name.endsWith(".vmd")&&f.push(e);y()}},n.appendChild(g);const d=document.createElement("button");return d.textContent="Convert",d.style.width="100%",d.style.height="60px",d.style.border="none",d.style.fontSize="20px",d.onclick=async()=>{if(0===f.length)return void alert("Please select a VMD file");d.textContent="Converting...";const e=await l.loadAsync(f[0].name,f),t=h.Convert(e),r=new Blob([t],{type:"application/octet-stream"}),s=URL.createObjectURL(r),n=document.createElement("a");n.href=s,n.download=`${f[0].name.substring(0,f[0].name.lastIndexOf("."))}.bvmd`,n.click(),URL.revokeObjectURL(s),n.remove(),f.length=0,y(),d.textContent="Convert"},n.appendChild(d),r}}}).then((e=>e.run()))}},n={};function a(e){var t=n[e];if(void 0!==t)return t.exports;var r=n[e]={exports:{}};return s[e](r,r.exports,a),r.exports}a.m=s,e=[],a.O=(t,r,s,n)=>{if(!r){var o=1/0;for(f=0;f<e.length;f++){for(var[r,s,n]=e[f],i=!0,l=0;l<r.length;l++)(!1&n||o>=n)&&Object.keys(a.O).every((e=>a.O[e](r[l])))?r.splice(l--,1):(i=!1,n<o&&(o=n));if(i){e.splice(f--,1);var h=s();void 0!==h&&(t=h)}}return t}n=n||0;for(var f=e.length;f>0&&e[f-1][2]>n;f--)e[f]=e[f-1];e[f]=[r,s,n]},a.d=(e,t)=>{for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},a.f={},a.e=e=>Promise.all(Object.keys(a.f).reduce(((t,r)=>(a.f[r](e,t),t)),[])),a.u=e=>(({71:"glslShaders",126:"wgslShaders"}[e]||e)+".bundle.js"),a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),t={},r="babylon-mmd:",a.l=(e,s,n,o)=>{if(t[e])t[e].push(s);else{var i,l;if(void 0!==n)for(var h=document.getElementsByTagName("script"),f=0;f<h.length;f++){var c=h[f];if(c.getAttribute("src")==e||c.getAttribute("data-webpack")==r+n){i=c;break}}i||(l=!0,(i=document.createElement("script")).charset="utf-8",i.timeout=120,a.nc&&i.setAttribute("nonce",a.nc),i.setAttribute("data-webpack",r+n),i.src=e),t[e]=[s];var m=(r,s)=>{i.onerror=i.onload=null,clearTimeout(y);var n=t[e];if(delete t[e],i.parentNode&&i.parentNode.removeChild(i),n&&n.forEach((e=>e(s))),r)return r(s)},y=setTimeout(m.bind(null,void 0,{type:"timeout",target:i}),12e4);i.onerror=m.bind(null,i.onerror),i.onload=m.bind(null,i.onload),l&&document.head.appendChild(i)}},a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;a.g.importScripts&&(e=a.g.location+"");var t=a.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var s=r.length-1;s>-1&&(!e||!/^http(s?):/.test(e));)e=r[s--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),a.p=e})(),(()=>{var e={792:0};a.f.j=(t,r)=>{var s=a.o(e,t)?e[t]:void 0;if(0!==s)if(s)r.push(s[2]);else{var n=new Promise(((r,n)=>s=e[t]=[r,n]));r.push(s[2]=n);var o=a.p+a.u(t),i=new Error;a.l(o,(r=>{if(a.o(e,t)&&(0!==(s=e[t])&&(e[t]=void 0),s)){var n=r&&("load"===r.type?"missing":r.type),o=r&&r.target&&r.target.src;i.message="Loading chunk "+t+" failed.\n("+n+": "+o+")",i.name="ChunkLoadError",i.type=n,i.request=o,s[1](i)}}),"chunk-"+t,t)}},a.O.j=t=>0===e[t];var t=(t,r)=>{var s,n,[o,i,l]=r,h=0;if(o.some((t=>0!==e[t]))){for(s in i)a.o(i,s)&&(a.m[s]=i[s]);if(l)var f=l(a)}for(t&&t(r);h<o.length;h++)n=o[h],a.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return a.O(f)},r=self.webpackChunkbabylon_mmd=self.webpackChunkbabylon_mmd||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();var o=a.O(void 0,[63],(()=>a(8536)));o=a.O(o)})();