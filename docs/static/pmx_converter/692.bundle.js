"use strict";(self.webpackChunkbabylon_mmd=self.webpackChunkbabylon_mmd||[]).push([[692],{3155:(e,t,a)=>{var s=a(7008),r=a(854),n=a(1137),i=a(1597);s.w.prototype._createDepthStencilCubeTexture=function(e,t){const a=new r.h(this,12);if(a.isCube=!0,1===this.webGLVersion)return n.V.Error("Depth cube texture is not supported by WebGL 1."),a;const s={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...t},i=this._gl;this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,a,!0),this._setupDepthStencilTexture(a,e,s.bilinearFiltering,s.comparisonFunction);for(let t=0;t<6;t++)s.generateStencil?i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,i.DEPTH24_STENCIL8,e,e,0,i.DEPTH_STENCIL,i.UNSIGNED_INT_24_8,null):i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,i.DEPTH_COMPONENT24,e,e,0,i.DEPTH_COMPONENT,i.UNSIGNED_INT,null);return this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(a),a},s.w.prototype._setCubeMapTextureParams=function(e,t,a){const s=this._gl;s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,t?s.LINEAR_MIPMAP_LINEAR:s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),e.samplingMode=t?3:2,t&&this.getCaps().textureMaxLevel&&void 0!==a&&a>0&&(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAX_LEVEL,a),e._maxLodLevel=a),this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null)},s.w.prototype.createCubeTexture=function(e,t,a,s,r=null,o=null,c,l=null,T=!1,_=0,d=0,u=null,E,h=!1,p=null){const g=this._gl;return this.createCubeTextureBase(e,t,a,!!s,r,o,c,l,T,_,d,u,(e=>this._bindTextureDirectly(g.TEXTURE_CUBE_MAP,e,!0)),((e,t)=>{const a=this.needPOTTextures?(0,i.R)(t[0].width,this._caps.maxCubemapTextureSize):t[0].width,o=a,l=[g.TEXTURE_CUBE_MAP_POSITIVE_X,g.TEXTURE_CUBE_MAP_POSITIVE_Y,g.TEXTURE_CUBE_MAP_POSITIVE_Z,g.TEXTURE_CUBE_MAP_NEGATIVE_X,g.TEXTURE_CUBE_MAP_NEGATIVE_Y,g.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(g.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(!1);const T=c?this._getInternalFormat(c,e._useSRGBBuffer):e._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:g.RGBA;let _=c?this._getInternalFormat(c):g.RGBA;e._useSRGBBuffer&&1===this.webGLVersion&&(_=T);for(let e=0;e<l.length;e++)if(t[e].width!==a||t[e].height!==o){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void n.V.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=a,this._workingCanvas.height=o,this._workingContext.drawImage(t[e],0,0,t[e].width,t[e].height,0,0,a,o),g.texImage2D(l[e],0,T,_,g.UNSIGNED_BYTE,this._workingCanvas)}else g.texImage2D(l[e],0,T,_,g.UNSIGNED_BYTE,t[e]);s||g.generateMipmap(g.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(e,!s),e.width=a,e.height=o,e.isReady=!0,c&&(e.format=c),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),r&&r()}),!!h,p)},s.w.prototype.generateMipMapsForCubemap=function(e,t=!0){if(e.generateMipMaps){const a=this._gl;this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,e,!0),a.generateMipmap(a.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,null)}}},6692:(e,t,a)=>{a.r(t),a.d(t,{_BasisTextureLoader:()=>p});var s,r=a(998),n=a(2781),i=a(854);function o(){let e=null;function t(e,t,a,s,r){const n=e.getImageTranscodedSizeInBytes(t,a,s);let i=new Uint8Array(n);return e.transcodeImage(i,t,a,s,1,0)?(r&&(i=function(e,t,a,s){const r=new Uint16Array(4),n=new Uint16Array(a*s),i=a/4,o=s/4;for(let t=0;t<o;t++)for(let s=0;s<i;s++){const o=0+8*(t*i+s);r[0]=e[o]|e[o+1]<<8,r[1]=e[o+2]|e[o+3]<<8,r[2]=(2*(31&r[0])+1*(31&r[1]))/3|(2*(2016&r[0])+1*(2016&r[1]))/3&2016|(2*(63488&r[0])+1*(63488&r[1]))/3&63488,r[3]=(2*(31&r[1])+1*(31&r[0]))/3|(2*(2016&r[1])+1*(2016&r[0]))/3&2016|(2*(63488&r[1])+1*(63488&r[0]))/3&63488;for(let i=0;i<4;i++){const c=e[o+4+i];let l=(4*t+i)*a+4*s;n[l++]=r[3&c],n[l++]=r[c>>2&3],n[l++]=r[c>>4&3],n[l++]=r[c>>6&3]}}return n}(i,0,e.getImageWidth(t,a)+3&-4,e.getImageHeight(t,a)+3&-4)),i):null}onmessage=a=>{if("init"===a.data.action){if(a.data.url)try{importScripts(a.data.url)}catch(e){postMessage({action:"error",error:e})}e||(e=BASIS({wasmBinary:a.data.wasmBinary})),null!==e&&e.then((e=>{BASIS=e,e.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===a.data.action){const e=a.data.config,s=a.data.imageData,r=new BASIS.BasisFile(s),n=function(e){const t=e.getHasAlpha(),a=e.getNumImages(),s=[];for(let t=0;t<a;t++){const a={levels:[]},r=e.getNumLevels(t);for(let s=0;s<r;s++){const r={width:e.getImageWidth(t,s),height:e.getImageHeight(t,s)};a.levels.push(r)}s.push(a)}return{hasAlpha:t,images:s}}(r);let i=a.data.ignoreSupportedFormats?null:function(e,t){let a=null;return e.supportedCompressionFormats&&(a=e.supportedCompressionFormats.astc?10:e.supportedCompressionFormats.bc7?6:e.supportedCompressionFormats.s3tc?t.hasAlpha?3:2:e.supportedCompressionFormats.pvrtc?t.hasAlpha?9:8:e.supportedCompressionFormats.etc2?1:e.supportedCompressionFormats.etc1?0:14),a}(a.data.config,n),o=!1;null===i&&(o=!0,i=n.hasAlpha?3:2);let c=!0;r.startTranscoding()||(c=!1);const l=[];for(let a=0;a<n.images.length&&c;a++){const s=n.images[a];if(void 0===e.loadSingleImage||e.loadSingleImage===a){let n=s.levels.length;!1===e.loadMipmapLevels&&(n=1);for(let e=0;e<n;e++){const n=s.levels[e],T=t(r,a,e,i,o);if(!T){c=!1;break}n.transcodedPixels=T,l.push(n.transcodedPixels.buffer)}}}r.close(),r.delete(),o&&(i=-1),c?postMessage({action:"transcode",success:c,id:a.data.id,fileInfo:n,format:i},l):postMessage({action:"transcode",success:c,id:a.data.id})}}}!function(e){e[e.cTFETC1=0]="cTFETC1",e[e.cTFETC2=1]="cTFETC2",e[e.cTFBC1=2]="cTFBC1",e[e.cTFBC3=3]="cTFBC3",e[e.cTFBC4=4]="cTFBC4",e[e.cTFBC5=5]="cTFBC5",e[e.cTFBC7=6]="cTFBC7",e[e.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",e[e.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",e[e.cTFASTC_4x4=10]="cTFASTC_4x4",e[e.cTFATC_RGB=11]="cTFATC_RGB",e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e.cTFRGBA32=13]="cTFRGBA32",e[e.cTFRGB565=14]="cTFRGB565",e[e.cTFBGR565=15]="cTFBGR565",e[e.cTFRGBA4444=16]="cTFRGBA4444",e[e.cTFFXT1_RGB=17]="cTFFXT1_RGB",e[e.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",e[e.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",e[e.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",e[e.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(s||(s={}));const c={JSModuleURL:`${r.S0._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${r.S0._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let l=null,T=null,_=0;const d=(e,t)=>{const a=e instanceof ArrayBuffer?new Uint8Array(e):e;return new Promise(((e,s)=>{(l||(l=new Promise(((e,t)=>{T?e(T):r.S0.LoadFileAsync(r.S0.GetBabylonScriptURL(c.WasmModuleURL)).then((a=>{if("function"!=typeof URL)return t("Basis transcoder requires an environment with a URL constructor");const s=URL.createObjectURL(new Blob([`(${o})()`],{type:"application/javascript"}));T=new Worker(s),function(e,t,a){return new Promise(((s,n)=>{const i=t=>{"init"===t.data.action?(e.removeEventListener("message",i),s(e)):"error"===t.data.action&&n(t.data.error||"error initializing worker")};e.addEventListener("message",i),e.postMessage({action:"init",url:a?r.S0.GetBabylonScriptURL(a):void 0,wasmBinary:t},[t])}))}(T,a,c.JSModuleURL).then(e,t)})).catch(t)}))),l).then((()=>{const r=_++,n=t=>{"transcode"===t.data.action&&t.data.id===r&&(T.removeEventListener("message",n),t.data.success?e(t.data):s("Transcode is not supported on this device"))};T.addEventListener("message",n);const i=new Uint8Array(a.byteLength);i.set(new Uint8Array(a.buffer,a.byteOffset,a.byteLength)),T.postMessage({action:"transcode",id:r,imageData:i,config:t,ignoreSupportedFormats:!1},[i.buffer])}),(e=>{s(e)}))}))},u=(e,t)=>{let a=t._gl?.TEXTURE_2D;e.isCube&&(a=t._gl?.TEXTURE_CUBE_MAP),t._bindTextureDirectly(a,e,!0)},E=(e,t)=>{const a=e.getEngine();for(let o=0;o<t.fileInfo.images.length;o++){const c=t.fileInfo.images[o].levels[0];if(e._invertVScale=e.invertY,-1===t.format||t.format===s.cTFRGB565)if(e.type=10,e.format=4,!a._features.basisNeedsPOT||Math.log2(c.width)%1==0&&Math.log2(c.height)%1==0)e._invertVScale=!e.invertY,e.width=c.width+3&-4,e.height=c.height+3&-4,e.samplingMode=2,u(e,a),a._uploadDataToTextureDirectly(e,new Uint16Array(c.transcodedPixels.buffer),o,0,4,!0);else{const t=new i.h(a,2);e._invertVScale=e.invertY,t.type=10,t.format=4,t.width=c.width+3&-4,t.height=c.height+3&-4,u(t,a),a._uploadDataToTextureDirectly(t,new Uint16Array(c.transcodedPixels.buffer),o,0,4,!0),a._rescaleTexture(t,e,a.scenes[0],a._getInternalFormat(4),(()=>{a._releaseTexture(t),u(e,a)}))}else{e.width=c.width,e.height=c.height,e.generateMipMaps=t.fileInfo.images[o].levels.length>1;const s=h.GetInternalFormatFromBasisFormat(t.format,a);e.format=s,u(e,a),t.fileInfo.images[o].levels.forEach(((t,r)=>{a._uploadCompressedDataToTextureDirectly(e,s,t.width,t.height,t.transcodedPixels,o,r)})),!a._features.basisNeedsPOT||Math.log2(e.width)%1==0&&Math.log2(e.height)%1==0||(r.S0.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),e._cachedWrapU=n.g.CLAMP_ADDRESSMODE,e._cachedWrapV=n.g.CLAMP_ADDRESSMODE)}}},h={JSModuleURL:c.JSModuleURL,WasmModuleURL:c.WasmModuleURL,GetInternalFormatFromBasisFormat:(e,t)=>{let a;switch(e){case s.cTFETC1:a=36196;break;case s.cTFBC1:a=33776;break;case s.cTFBC4:a=33779;break;case s.cTFASTC_4x4:a=37808;break;case s.cTFETC2:a=37496;break;case s.cTFBC7:a=36492}if(void 0===a)throw"The chosen Basis transcoder format is not currently supported";return a},TranscodeAsync:d,LoadTextureFromTranscodeResult:E};Object.defineProperty(h,"JSModuleURL",{get:function(){return c.JSModuleURL},set:function(e){c.JSModuleURL=e}}),Object.defineProperty(h,"WasmModuleURL",{get:function(){return c.WasmModuleURL},set:function(e){c.WasmModuleURL=e}}),a(3155);class p{constructor(){this.supportCascades=!1}loadCubeData(e,t,a,s,n){if(Array.isArray(e))return;const i=t.getEngine().getCaps(),o={supportedCompressionFormats:{etc1:!!i.etc1,s3tc:!!i.s3tc,pvrtc:!!i.pvrtc,etc2:!!i.etc2,astc:!!i.astc,bc7:!!i.bptc}};d(e,o).then((e=>{const a=e.fileInfo.images[0].levels.length>1&&t.generateMipMaps;E(t,e),t.getEngine()._setCubeMapTextureParams(t,a),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()})).catch((e=>{r.S0.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),t.isReady=!0,n&&n(e)}))}loadData(e,t,a){const s=t.getEngine().getCaps(),n={supportedCompressionFormats:{etc1:!!s.etc1,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,astc:!!s.astc,bc7:!!s.bptc}};d(e,n).then((e=>{const s=e.fileInfo.images[0].levels[0],r=e.fileInfo.images[0].levels.length>1&&t.generateMipMaps;a(s.width,s.height,r,-1!==e.format,(()=>{E(t,e)}))})).catch((e=>{r.S0.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),r.S0.Warn(`Failed to transcode Basis file: ${e}`),a(0,0,!1,!1,(()=>{}),!0)}))}}}}]);